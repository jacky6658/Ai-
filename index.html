<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ReelMind</title>
    
    <!-- Markdown 和語法高亮函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/html.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <!-- Font Awesome 圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
      :root { 
        color-scheme: light; 
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --safe-area-inset-left: env(safe-area-inset-left);
        --safe-area-inset-right: env(safe-area-inset-right);
      }
      body { 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
        background:#ffffff; 
        color:#1a1a1a; 
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        overflow-x: hidden; /* 防止整個頁面左右滑動 */
        width: 100%; /* 確保寬度固定 */
        max-width: 100vw; /* 限制最大寬度為視窗寬度 */
      }
      
      /* 頁面容器 */
      .app-container {
        display: flex;
        min-height: 100vh;
      }
      
      /* 主內容區域 */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: margin-right 0.3s ease;
      }
      
      .main-content.sidebar-open {
        margin-right: 300px;
      }
      
      /* 頂部導航欄 */
      .top-navbar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding-top: calc(16px + var(--safe-area-inset-top));
        min-height: 60px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .navbar-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }
      
      .navbar-title {
        font-size: 30px;
        font-weight: 600;
        color: #1f2937;
        margin-right: auto;
      }
      
      .clickable-title {
        cursor: pointer;
        transition: color 0.2s ease;
      }
      
      .clickable-title:hover {
        color: #3b82f6;
      }
      
      .navbar-tabs {
        display: flex;
        gap: 8px;
      }
      
      .navbar-tab {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: #6b7280;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
      }
      
      .navbar-tab.active {
        background: #3b82f6;
        color: white;
      }
      
      .navbar-tab:hover:not(.active) {
        background: #f3f4f6;
      }
      
      .navbar-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }
      
      .logout-btn {
        padding: 6px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
      }
      
      .logout-btn:hover {
        background: #dc2626;
      }
      
      /* 頁面內容區域 */
      .page-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* mode2頁面特殊樣式 - 滿版顯示 */
      .mode2 .page-content {
        padding: 0;
        max-width: none;
        width: 100%;
      }
      
      /* 首頁樣式 */
      .homepage {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        text-align: center;
      }
      
      .homepage-title {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
      }
      
      .homepage-subtitle {
        font-size: 18px;
        color: #6b7280;
        margin-bottom: 48px;
        max-width: 600px;
        line-height: 1.6;
      }
      
      .mode-cards {
        display: flex;
        gap: 24px;
        max-width: 800px;
      }
      
      .mode-card {
        flex: 1;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 32px 24px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        user-select: none;
      }
      
      .mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
      }
      
      .mode-card-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      
      .mode-card-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
      }
      
      .mode-card-desc {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 模式1：一鍵生成頁面 */
      .mode1-page {
        display: flex;
        gap: 24px;
        height: calc(100vh - 120px);
      }
      
      .mode1-left {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .mode1-right {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* 模式2：AI顧問對話頁面 */
      .mode2-page {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        min-height: 600px;
        position: relative;
        max-width: none;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      
      /* 說明按鈕 */
      .instructions-toggle-btn {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.2s ease;
        z-index: 1000;
      }
      
      .instructions-toggle-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      
      .btn-icon {
        font-size: 16px;
      }
      
      .btn-text {
        font-size: 13px;
      }
      
      /* 抽屜背景遮罩 */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .drawer-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      /* 說明抽屜 */
      .instructions-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1001;
        display: flex;
        flex-direction: column;
      }
      
      .instructions-drawer.open {
        right: 0;
      }
      
      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      
      .drawer-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }
      
      .drawer-close-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .drawer-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .drawer-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      
      .drawer-content p {
        margin: 0 0 16px 0;
        font-size: 14px;
        line-height: 1.6;
        color: #374151;
      }
      
      .drawer-content p:last-child {
        margin-bottom: 0;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        font-size: 13px;
        color: #6b7280;
      }
      
      .chat-container {
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      /* 側邊欄樣式 */
      .sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e5e7eb;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
      }
      
      .sidebar.open {
        right: 0;
      }
      
      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .sidebar-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
      
      .sidebar-menu {
        padding: 20px 0;
      }
      
      .sidebar-item {
        display: block;
        width: 100%;
        padding: 12px 20px;
        border: none;
        background: none;
        text-align: left;
        color: #6b7280;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .sidebar-item:hover {
        background: #f3f4f6;
        color: #1f2937;
      }
      
      .sidebar-item.active {
        background: #3b82f6;
        color: white;
      }
      
      
      /* 側邊欄頁面樣式 */
      .sidebar-page-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .sidebar-page-container {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90%;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      
      .sidebar-page-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
      }
      
      .sidebar-page-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .sidebar-page-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .sidebar-page-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .sidebar-page-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* 側邊欄頁面內容樣式 */
      .profile-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      
      .profile-section h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .user-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .detail-item label {
        font-weight: 500;
        color: #6b7280;
        min-width: 80px;
      }
      
      .detail-item span {
        color: #1f2937;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }
      
      .stat-item {
        text-align: center;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      
      .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 4px;
      }
      
      .stat-label {
        font-size: 12px;
        color: #6b7280;
      }
      
      .scripts-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .script-item {
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f8fafc;
      }
      
      .script-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .script-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .script-date {
        font-size: 12px;
        color: #6b7280;
      }
      
      .script-preview {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 12px;
        line-height: 1.4;
      }
      
      .script-actions {
        display: flex;
        gap: 8px;
      }
      
      .btn-primary {
        padding: 6px 12px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .btn-danger {
        padding: 6px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .help-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      
      .help-section {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      
      .help-section h3,
      .help-section h4 {
        margin: 0 0 12px 0;
        color: #1f2937;
      }
      
      .help-section h3 {
        font-size: 20px;
        font-weight: 600;
      }
      
      .help-section h4 {
        font-size: 16px;
        font-weight: 500;
      }
      
      .help-section p {
        margin: 8px 0;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 一鍵生成使用說明樣式 */
      .one-click-instructions {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }
      
      .one-click-instructions h3 {
        margin: 0 0 16px 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .instruction-steps {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .step {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      
      .step-number {
        width: 24px;
        height: 24px;
        background: #3b82f6;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
      }
      
      .step-content {
        flex: 1;
      }
      
      .step-content strong {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
      }
      
      .step-content p {
        margin: 0;
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
      }
      
      /* 頁面隱藏/顯示 */
      .page {
        display: none;
      }
      
      .page.active {
        display: block;
      }
      
      /* 響應式設計 */
      @media (max-width: 768px) {
        .mode1-page {
          flex-direction: column;
          height: auto;
        }
        
        .mode1-left,
        .mode1-right {
          flex: none;
        }
        
        .mode-cards {
          flex-direction: column;
        }
        
        .main-content.sidebar-open {
          margin-right: 0;
        }
        
        .sidebar {
          width: 100%;
          right: -100%;
        }
        
        .user-name { display: none !important; }
        .navbar-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .user-info { padding: 6px 8px; }
        .user-avatar { margin: 0; }
        .logout-btn { margin: 0; }
        .top-navbar { justify-content: space-between; }
        .navbar-left { flex: 1; }
        .navbar-title { margin-left: auto; }
        /* 一鍵生成/AI顧問/IP人設卡片加寬 */
        .mode-cards { grid-template-columns: 1fr; }
        .mode-card { width: 100%; max-width: none; }
      }
      
      .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
      
      /* 確保原有功能在新佈局中正常顯示 */
      .userSettingsContainer,
      .oneClickGenerationContainer,
      .chatContainer {
        width: 100%;
        height: 100%;
      }
      
      /* 用戶需求設定樣式調整 */
      .settings-block {
        margin-bottom: 20px;
      }
      
      .settings-content {
        margin-top: 16px;
      }
      
      /* 一鍵生成頁面布局 */
      .mode1-page {
        display: flex;
        gap: 24px;
        min-height: calc(100vh - 120px);
      }
      
      .mode1-left {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .mode1-right {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* 一鍵生成結果區塊樣式調整 */
      .result-tabs {
        margin-bottom: 0;
      }
      
      .results-container {
        flex: 1;
        min-height: 400px;
      }
      
      /* 聊天容器樣式調整 - ChatGPT 風格 */
      .chat-container {
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        max-width: 800px !important;
        margin: 0 auto !important;
        width: 100% !important;
        background: #f7f7f8 !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
      }
      
      #chatMessages {
        flex: 1 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important; /* 防止水平滾動 */
        padding: 20px !important;
        min-height: 500px !important;
        background: #f7f7f8 !important;
        scroll-behavior: smooth !important;
        overscroll-behavior: contain !important;
        display: flex !important;
        flex-direction: column !important;
        max-height: calc(100vh - 200px) !important;
        padding-bottom: 120px !important; /* 為固定輸入框留出空間 */
        width: 100% !important; /* 確保寬度固定 */
        max-width: 100% !important; /* 防止超出容器 */
        box-sizing: border-box !important; /* 包含邊框在內 */
      }
      
      /* 當說明收起時，聊天訊息區延長高度 */
      .instruction-list.collapsed + #chatContainer #chatMessages {
        min-height: 600px;
      }

      /* ===== AI顧問聊天訊息樣式 - ChatGPT 風格 ===== */
      
      /* 聊天訊息容器 - 採用更簡潔的設計 */
      .message {
        display: flex !important;
        padding: 20px 0 !important;
        border-bottom: 1px solid #e5e7eb !important;
        width: 100% !important;
        max-width: 100% !important; /* 防止超出容器 */
        margin: 0 !important;
        box-sizing: border-box !important; /* 包含邊框在內 */
        overflow: hidden !important; /* 防止內容溢出 */
      }

      .message:last-child {
        border-bottom: none !important;
      }

      /* 用戶訊息背景 */
      .message.user {
        background: white !important;
      }

      /* AI 訊息背景 */
      .message.assistant {
        background: #f7f7f8 !important;
        border-top: 1px solid #e5e7eb !important;
      }

      .message-avatar {
        width: 30px !important;
        height: 30px !important;
        min-width: 30px !important;
        border-radius: 4px !important;
        background: #10a37f !important;
        color: white !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        font-size: 16px !important;
        font-weight: bold !important;
        margin-right: 15px !important;
        flex-shrink: 0 !important;
      }

      .user .message-avatar {
        background: transparent !important;
        color: #374151 !important;
      }

      .assistant .message-avatar {
        background: #10a37f !important;
        color: white !important;
      }

      .message-content {
        flex: 1 !important;
        padding: 0 !important;
        margin: 0 !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        white-space: pre-wrap !important;
        max-width: 100% !important; /* 防止超出容器 */
        overflow: hidden !important; /* 防止內容溢出 */
        box-sizing: border-box !important; /* 包含邊框在內 */
      }

      /* 訊息內容的樣式重置 */
      .message-content p:first-child {
        margin-top: 0 !important;
      }
      .message-content p:last-child {
        margin-bottom: 0 !important;
      }

      /* Markdown 渲染樣式 - ChatGPT 風格 */
      .message-content pre {
        background: #202123 !important;
        color: #f8f8f2 !important;
        padding: 10px !important;
        border-radius: 6px !important;
        overflow-x: auto !important;
        position: relative !important;
        margin: 15px 0 !important;
      }

      .message-content pre code {
        display: block !important;
        padding: 0 !important;
        background: none !important;
        color: inherit !important;
      }

      .message-content table {
        border-collapse: collapse !important;
        width: 100% !important;
        margin: 15px 0 !important;
      }

      .message-content th, 
      .message-content td {
        border: 1px solid #ddd !important;
        padding: 8px !important;
        text-align: left !important;
      }

      .message-content th {
        background-color: #f2f2f2 !important;
      }

      .message-content blockquote {
        border-left: 4px solid #ccc !important;
        padding-left: 15px !important;
        margin: 15px 0 !important;
        color: #666 !important;
      }

      .message-content ul, 
      .message-content ol {
        margin: 15px 0 !important;
        padding-left: 20px !important;
      }

      .message-content h1,
      .message-content h2,
      .message-content h3,
      .message-content h4,
      .message-content h5,
      .message-content h6 {
        margin: 16px 0 8px 0 !important;
        font-weight: 600 !important;
        line-height: 1.3 !important;
      }

      .message-content p {
        margin: 8px 0 !important;
        line-height: 1.6 !important;
      }

      .message-content code {
        background: #f1f3f4 !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
        font-size: 0.9em !important;
      }

      /* AI 思考中動畫 - ChatGPT 風格 */
      .typing-indicator {
        display: flex !important;
        align-items: center !important;
        font-style: italic !important;
        color: #6b7280 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .typing-dots {
        display: flex !important;
        margin-left: 10px !important;
      }

      .typing-dot {
        width: 6px !important;
        height: 6px !important;
        margin: 0 2px !important;
        background-color: #3b82f6 !important;
        border-radius: 50% !important;
        animation: dot-flashing 1s infinite alternate !important;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s !important;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s !important;
      }

      @keyframes dot-flashing {
        0% {
          opacity: 0.2;
        }
        100% {
          opacity: 1;
        }
      }

      /* 串流文字效果 */
      .streaming-text {
        position: relative;
      }

      .streaming-cursor {
        display: inline-block;
        width: 2px;
        height: 1.2em;
        background: #374151;
        animation: blink 1s infinite;
        margin-left: 2px;
      }

      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }

      .message-content p {
        margin: 0 0 8px 0;
        line-height: 1.5;
      }

      .message-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .message-content li {
        margin: 4px 0;
      }

      .message-content:last-child p:last-child {
        margin-bottom: 0;
      }
      
      /* AI思考中載入動畫 */
      .ai-loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }

      .ai-loading-dots {
        display: flex;
        gap: 4px;
      }

      .ai-loading-dot {
        width: 6px;
        height: 6px;
        background: #3b82f6;
        border-radius: 50%;
        animation: ai-bounce 1.4s infinite ease-in-out both;
      }

      .ai-loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .ai-loading-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes ai-bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      
      .input-row {
        padding: 16px;
        margin-top: 0;
        border-top: 1px solid #e5e7eb;
        background: transparent;
        border-radius: 0;
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }
      
      /* 優化聊天訊息樣式 */
      .msg {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
        max-width: 85%;
      }
      
      .msg.user {
        margin-left: auto;
        flex-direction: row-reverse;
      }
      
      .msg.assistant {
        margin-right: auto;
      }
      
      .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        margin: 0 8px;
        flex-shrink: 0;
      }
      
      .msg.user .msg-avatar {
        background: #3b82f6;
        color: white;
      }
      
      .msg.assistant .msg-avatar {
        background: #f3f4f6;
        color: #374151;
      }
      
      .msg-bubble {
        flex: 1;
        background: #f8fafc;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        line-height: 1.5;
        font-size: 15px;
        box-sizing: border-box;
        overflow: hidden;
      }
      
      .msg.user .msg-bubble {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
        max-width: 100%;
        word-wrap: break-word;
      }
      
      .msg.assistant .msg-bubble {
        background: #f8fafc;
        border-color: #e5e7eb;
        color: #1f2937;
        max-width: 100%;
        word-wrap: break-word;
      }
      
      .msg-bubble p {
        margin: 0 0 4px 0;
        line-height: 1.3;
      }
      
      .msg-bubble ul {
        margin: 4px 0;
        padding-left: 20px;
      }
      
      .msg-bubble li {
        margin: 2px 0;
        line-height: 1.3;
      }
      
      .msg-bubble:last-child p:last-child {
        margin-bottom: 0;
      }
      
      .msg-label {
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 6px;
        color: #6b7280;
      }
      
      /* 優化輸入框樣式 */
      #messageInput {
        flex: 1;
        height: 44px; /* 固定高度與送出按鈕一致 */
        min-height: 44px;
        max-height: 44px; /* 限制最大高度與最小高度一致 */
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 22px;
        font-size: 15px;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
        line-height: 1.2; /* 調整行高確保文字垂直居中 */
      }
      
      #messageInput:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      #sendBtn {
        padding: 12px 20px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 22px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        min-width: 80px;
      }
      
      #sendBtn:hover {
        background: #2563eb;
      }
      
      #sendBtn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      
      /* 快速提問按鈕樣式（套用IP模式設計） */
      .quick-questions {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      
      .quick-question-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        color: #6b7280;
        transition: all 0.2s;
      }
      
      .quick-question-btn:hover {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      /* ChatGPT 風格快速按鈕 */
      .quick-buttons { 
        display: flex !important; 
        gap: 8px !important; 
        margin-bottom: 12px !important; 
        flex-wrap: wrap !important;
        padding: 0 !important;
        background: transparent !important;
        border: none !important;
        position: relative !important;
        bottom: auto !important;
        z-index: auto !important;
        flex-shrink: 0 !important;
        height: auto !important;
      }

      .quick-btn {
        background: #ffffff !important;
        border: 1px solid #d1d5db !important;
        color: #374151 !important;
        padding: 8px 16px !important;
        border-radius: 16px !important;
        font-size: 14px !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        font-weight: 400 !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
      }

      .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }
      
      /* 主要布局：左右分欄 5:5 */
      .main-layout { 
        display: flex; 
        gap: 20px; 
        min-height: calc(100vh - 100px);
      }
      
      /* 左側面板 - 5份 */
      .left-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* 右側面板 - 5份 */
      .right-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* 左側內容區域 */
      .left-content {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      /* 結果區塊標籤切換 */
      .result-tabs {
        display: flex;
        background: white;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-bottom: none;
        overflow: hidden;
      }
      
      .result-tab {
        flex: 1;
        padding: 16px 20px;
        background: #f8fafc;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-right: 1px solid #e5e7eb;
      }
      
      .result-tab:last-child {
        border-right: none;
      }
      
      .result-tab.active {
        background: white;
        color: #1f2937;
        border-bottom: 2px solid #3b82f6;
      }
      
      .result-tab:hover {
        background: #f1f5f9;
      }
      
      /* 結果區塊容器 */
      .results-container {
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-top: none;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .result-content {
        flex: 1;
        padding: 20px;
        min-height: 400px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-content.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      /* 結果區塊新樣式 */
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      
      .result-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
      }
      
      .generate-btn {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .generate-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }
      
      .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      
      .result-body {
        min-height: 200px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-body.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      .result-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }
      
      .save-btn, .regenerate-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .save-btn {
        background: #10b981;
        color: white;
        border-color: #10b981;
      }
      
      .save-btn:hover {
        background: #059669;
        border-color: #059669;
      }
      
      .regenerate-btn {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
      }
      
      .regenerate-btn:hover {
        background: #d97706;
        border-color: #d97706;
      }
      
      /* 聊天區域樣式 */
      .chat-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 20px;
        min-height: 600px;
        flex: 1;
      }
      
      .chat-messages {
        background: white;
        border-radius: 12px;
        padding: 16px;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex: 1;
      }
      
      .message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      
      .message.user {
        background: #dbeafe;
        color: #1e40af;
        margin-left: 20px;
      }
      
      .message.ai {
        background: #f0f9ff;
        color: #0c4a6e;
        margin-right: 20px;
      }
      
      
      
      
      
      /* 聊天訊息區域 */
      #chatMessages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden; /* 防止水平滾動 */
        padding: 16px 24px 140px 24px; /* 內距更貼近圖1 */
        min-height: calc(100vh - 200px);
        background: #ffffff; /* 對話畫布白底 */
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #e5e7eb; /* 細邊框 */
        border-radius: 8px;       /* 略圓角 */
      }
      
      /* 聊天訊息樣式 */
      .message {
        display: flex;
        margin-bottom: 0;
        align-items: flex-start;
        padding: 20px 0;
        border-bottom: 1px solid #e5e7eb;
        width: 100%; /* 確保寬度固定 */
        max-width: 100%; /* 防止超出容器 */
        box-sizing: border-box; /* 包含邊框在內 */
        overflow: hidden; /* 防止內容溢出 */
      }

      .message:last-child {
        border-bottom: none;
      }

      .message-avatar {
        width: 30px;
        height: 30px;
        min-width: 30px;
        border-radius: 50%;
        background: transparent;
        color: #374151;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        font-weight: bold;
        margin-right: 15px;
        flex-shrink: 0;
        overflow: hidden;
      }

      .user .message-avatar {
        background: transparent;
      }

      .message-content {
        flex: 1;
        padding: 20px 40px;
        margin: 0;
        line-height: 1.6;
        color: #374151;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
        max-width: 100%; /* 限制最大寬度 */
        width: 100%;
        box-sizing: border-box; /* 包含邊框在內 */
        overflow: hidden; /* 防止內容溢出 */
      }

      .message-content p:first-child {
        margin-top: 0;
      }
      .message-content p:last-child {
        margin-bottom: 0;
      }

      /* Mode2 頁面固定設計 - 防止左右滑動 */
      .mode2 {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      .mode2-page {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* 快速按鈕列 */
      .mode2.fig1 .quick-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding: 8px 0 12px 0; /* 與輸入框留白 */
        margin: 0;
        background: transparent;
        border: none;
        justify-content: flex-start;
      }

      .mode2.fig1 .quick-btn {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 8px 16px;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        font-weight: 400;
        box-shadow: none;
        backdrop-filter: none;
      }

      .mode2.fig1 .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }

      /* 輸入區域（貼近圖1：寬、扁、右側送出） */
      .mode2.fig1 .input-row {
        background: transparent;
        border: none;
        padding: 0; /* 由外層留白控制 */
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .mode2.fig1 .chat-input {
        flex: 1;
        height: 44px;
        min-height: 44px;
        max-height: 44px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        background: #ffffff;
      }

      .mode2.fig1 .send-btn {
        height: 44px;
        min-width: 44px;
        border-radius: 10px;
        background: #3b82f6;
        color: #ffffff;
        border: none;
        padding: 0 18px;
      }

      /* 手機版微調 */
      @media (max-width: 768px) {
        .mode2.fig1 #chatMessages {
          padding: 12px 12px 130px 12px !important;
          border-radius: 8px !important;
        }
        .mode2.fig1 .quick-buttons { gap: 6px !important; }
        .mode2.fig1 .chat-input { font-size: 15px !important; }
      }

      /* fig1 強制覆寫（提高優先級） */
      .mode2.fig1 .mode2-page {
        display: flex !important;
        flex-direction: column !important;
        min-height: 100vh !important;
      }

      .mode2.fig1 #chatMessages {
        padding: 80px 24px 140px 24px !important; /* 上方留出導航列高度，避免被遮住 */
        background: #ffffff !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        flex: 1 1 auto !important;
        min-height: 0 !important; /* 允許子元素正確捲動 */
        height: auto !important;
        -webkit-overflow-scrolling: touch !important; /* iOS 慣性捲動 */
        overscroll-behavior: contain !important;
        touch-action: pan-y !important;
        scroll-padding-top: 80px !important; /* 滾動到頂時保留可視區 */
      }

      .mode2.fig1 .quick-buttons {
        gap: 8px !important;
        padding: 8px 0 12px 0 !important;
        margin: 0 !important;
        justify-content: flex-start !important;
      }

      .mode2.fig1 .input-row {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        gap: 12px !important;
        align-items: center !important;
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
      }

      .mode2.fig1 .chat-input {
        flex: 1 !important;
        height: 44px !important;
        min-height: 44px !important;
        max-height: 44px !important;
        border: 1px solid #d1d5db !important;
        border-radius: 10px !important;
        padding: 10px 12px !important;
        font-size: 14px !important;
        background: #ffffff !important;
      }

      .mode2.fig1 .send-btn {
        height: 44px !important;
        min-width: 44px !important;
        border-radius: 10px !important;
        background: #3b82f6 !important;
        color: #ffffff !important;
        border: none !important;
        padding: 0 18px !important;
        width: auto !important; /* 覆寫先前手機樣式的 100% 寬 */
      }
      
      /* 載入動畫樣式 */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #ffffff;
        border-radius: 18px 18px 18px 4px;
        border: 1px solid #e5e7eb;
        margin: 8px 0;
      }
      
      .typing-dots {
        display: flex;
        gap: 4px;
      }
      
      .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
      }
      
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      
      @keyframes typing {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* 輸入區域 */
      .input-row {
        padding: 20px;
        background: #f7f7f8;
        border: none;
        flex-shrink: 0;
        z-index: 100;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* 快速按鈕區域 */
      .quick-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding: 20px;
        background: #f7f7f8;
        border: none;
        z-index: 99;
        justify-content: center;
      }
      
      .input-container {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 8px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: border-color 0.2s;
      }

      .input-container:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .chat-input {
        flex: 1;
        border: none;
        resize: none;
        outline: none;
        padding: 8px 0;
        font-size: 16px;
        line-height: 1.5;
        max-height: 200px;
        overflow-y: auto;
        background: transparent;
        font-family: inherit;
        min-height: 24px;
      }
      
      .chat-input:focus {
        outline: none;
      }
      
      .send-btn {
        background: #3b82f6;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 16px;
        transition: all 0.2s;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        height: 40px;
      }
      
      .send-btn:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-1px);
      }
      
      .send-btn:disabled {
        color: #d1d5db;
        cursor: not-allowed;
      }

      /* Markdown 渲染樣式 */
      .message-content pre {
        background: #202123;
        color: #f8f8f2;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 16px 0;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 14px;
        line-height: 1.5;
      }

      .message-content pre code {
        background: none;
        padding: 0;
        color: inherit;
        font-size: inherit;
      }

      .message-content code {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
        color: #d63384;
      }

      .message-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
        font-size: 14px;
      }

      .message-content th,
      .message-content td {
        border: 1px solid #e5e7eb;
        padding: 12px;
        text-align: left;
      }

      .message-content th {
        background: #f8f9fa;
        font-weight: 600;
      }

      .message-content blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 16px;
        margin: 16px 0;
        color: #6b7280;
        font-style: italic;
      }

      .message-content ul,
      .message-content ol {
        margin: 16px 0;
        padding-left: 24px;
      }

      .message-content li {
        margin: 8px 0;
        line-height: 1.6;
      }

      .message-content h1,
      .message-content h2,
      .message-content h3,
      .message-content h4,
      .message-content h5,
      .message-content h6 {
        margin: 24px 0 16px 0;
        font-weight: 600;
        line-height: 1.3;
        color: #1f2937;
      }

      .message-content h1 { font-size: 1.5em; }
      .message-content h2 { font-size: 1.3em; }
      .message-content h3 { font-size: 1.1em; }

      /* 載入動畫 */
      .typing-indicator {
        display: flex;
        align-items: center;
        font-style: italic;
        color: #6b7280;
        margin: 0;
        padding: 0;
      }

      .typing-dots {
        display: flex;
        margin-left: 10px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        margin: 0 2px;
        background-color: #3b82f6;
        border-radius: 50%;
        animation: dot-flashing 1s infinite alternate;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dot-flashing {
        0% {
          opacity: 0.2;
        }
        100% {
          opacity: 1;
        }
      }
      
      .input-container button:hover {
        background: #2563eb;
      }
      
      /* 用戶抽屜樣式 - 左右兩欄彈出式視窗 */
      .user-drawer {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        width: 800px;
        max-width: 95vw;
        height: 600px;
        max-height: 90vh;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
      }
      
      .user-drawer.open {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        visibility: visible;
      }
      
      .user-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      
      .user-drawer-overlay.open {
        display: block;
      }
      
      .user-drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        flex-shrink: 0;
      }
      
      .user-drawer-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .app-logo {
        font-size: 20px;
        font-weight: bold;
        color: #3b82f6;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .app-name {
        font-size: 16px;
        color: #374151;
        font-weight: 500;
      }
      
      .user-drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .user-drawer-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      /* 左右兩欄布局 */
      .user-drawer-body {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      /* 左側選單欄 */
      .user-drawer-sidebar {
        width: 250px;
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      
      .user-profile {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .user-drawer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
      }
      
      .user-drawer-info h3 {
        margin: 0;
        font-size: 16px;
        color: #1f2937;
        font-weight: 600;
      }
      
      .user-drawer-info p {
        margin: 4px 0 0 0;
        font-size: 14px;
        color: #6b7280;
      }
      
      /* 右側內容區域 */
      .user-drawer-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: white;
      }
      
      
      .user-drawer-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
      }
      
      .user-drawer-menu li {
        margin: 0;
      }
      
      .user-drawer-menu a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #374151;
        text-decoration: none;
        border-radius: 0;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        font-weight: 500;
      }
      
      .user-drawer-menu a:hover {
        background: #f3f4f6;
        color: #1f2937;
      }
      
      .user-drawer-menu a.active {
        background: #dbeafe;
        color: #1d4ed8;
        border-left-color: #3b82f6;
        font-weight: 600;
      }
      
      .user-drawer-menu .icon {
        width: 20px;
        height: 20px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h2 {
        margin: 0 0 24px 0;
        font-size: 24px;
        color: #1f2937;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 12px;
      }
      
      .user-info-detail {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      
      .info-item label {
        font-weight: 600;
        color: #374151;
        min-width: 80px;
      }
      
      .info-item span {
        color: #6b7280;
        word-break: break-all;
      }
      
      .generations-list, .conversations-list, .memory-content {
        max-height: 500px;
        overflow-y: auto;
      }
      
      .generation-item, .conversation-item {
        background: #f9fafb;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid #3b82f6;
      }
      
      /* 腳本列表樣式 */
      .script-item {
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }
      
      .script-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        cursor: pointer;
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
      }
      
      .script-header:hover {
        background: #f9fafb;
      }
      
      .script-info {
        display: flex;
        align-items: center;
        gap: 16px;
        flex: 1;
      }
      
      .script-number {
        background: #3b82f6;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        min-width: 40px;
        text-align: center;
      }
      
      .script-name {
        font-weight: 500;
        color: #1f2937;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      
      .script-name:hover {
        background: #e5e7eb;
      }
      
      .script-date {
        color: #6b7280;
        font-size: 14px;
      }
      
      .script-toggle {
        color: #6b7280;
        font-size: 14px;
      }
      
      .script-content {
        padding: 16px;
        background: #fff;
        border-top: 1px solid #e5e7eb;
      }
      
      .script-table {
        overflow-x: auto;
      }
      
      .script-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      
      .script-table th,
      .script-table td {
        border: 1px solid #e5e7eb;
        padding: 8px 12px;
        text-align: left;
      }
      
      .script-table th {
        background: #f3f4f6;
        font-weight: 600;
        color: #374151;
      }
      
      .script-table td {
        color: #4b5563;
      }
      
      .script-actions {
        display: flex;
        gap: 8px;
        padding: 16px;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .download-pdf-btn {
        background: #dc2626;
        color: white;
      }
      
      .download-pdf-btn:hover {
        background: #b91c1c;
      }
      .download-csv-btn {
        background: #059669;
        color: white;
      }
      
      .download-csv-btn:hover {
        background: #047857;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform, .generation-topic {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      
      .generation-content, .conversation-summary {
        color: #374151;
        line-height: 1.5;
        margin-bottom: 8px;
      }
      
      .generation-date, .conversation-date {
        font-size: 12px;
        color: #9ca3af;
      }
      
      .loading-text {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 20px;
      }
      
      /* 底部導航欄默認隱藏（桌面版） */
      .bottom-navbar {
        display: none;
      }
      
      /* 帳號定位記錄樣式 */
      .positioning-record-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s ease;
      }
      
      .positioning-record-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }
      
      .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .record-number {
        font-weight: 600;
        color: #3b82f6;
        font-size: 14px;
      }
      
      .record-date {
        color: #6b7280;
        font-size: 12px;
      }
      
      .record-preview {
        color: #374151;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 12px;
        background: white;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #3b82f6;
      }
      
      .record-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* 彈出視窗樣式 */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      
      .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8f9fa;
      }
      
      .modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }
      
      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }
      
      .modal-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }
      
      .record-detail {
        line-height: 1.6;
      }
      
      .detail-meta {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-label {
        font-weight: 600;
        color: #374151;
        margin-right: 8px;
      }
      
      .detail-value {
        color: #6b7280;
      }
      
      .detail-content {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
      }
      
      .content-text {
        color: #1f2937;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      
      .modal-footer {
        padding: 20px;
        border-top: 1px solid #e5e7eb;
        background: #f8f9fa;
        text-align: right;
      }
      
      /* 抽屜內容區域樣式 */
      .drawer-content {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      
      .user-info-detail {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }
      
      .info-item {
        display: flex;
        margin-bottom: 10px;
      }
      
      .info-item label {
        font-weight: bold;
        min-width: 80px;
        color: #666;
      }
      
      .info-item span {
        color: #333;
      }
      
      .generations-list,
      .conversations-list,
      .memory-content {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .generation-item,
      .conversation-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 3px solid #007bff;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-topic {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-content,
      .conversation-summary {
        color: #333;
        margin-bottom: 5px;
        line-height: 1.4;
      }
      
      .generation-date,
      .conversation-date {
        color: #666;
        font-size: 12px;
      }
      
      .loading-text {
        text-align: center;
        color: #666;
        font-style: italic;
      }
      
      /* 設定區塊樣式 */
      .settings-block {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      
      .settings-block h3 {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .setting-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .setting-item label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }
      
      .setting-item input,
      .setting-item select {
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      
      .setting-item input:focus,
      .setting-item select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .apply-btn {
        width: 100%;
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .apply-btn:hover {
        background: #2563eb;
      }
      
      /* AI 說明區塊樣式 */
      .ai-instructions {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 20px;
      }
      
      .instructions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        cursor: pointer;
        border-radius: 12px 12px 0 0;
        transition: background-color 0.2s;
      }
      
      .instructions-header:hover {
        background-color: #f8fafc;
      }
      
      .instructions-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      
      .instructions-toggle {
        font-size: 16px;
        color: #6b7280;
        transition: transform 0.2s ease;
      }
      
      .instruction-list {
        padding: 0 20px 20px 20px;
        transition: all 0.3s ease;
        overflow: hidden;
        display: none;
      }
      
      .instruction-list.collapsed {
        padding: 0 20px;
        max-height: 0;
        display: none;
      }
      
      .instruction-list.show {
        display: block;
      }
      
      .instruction-list p {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 簡潔說明樣式 */
      .instruction-list p {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.6;
      }
      
      .instruction-list p:last-child {
        margin-bottom: 0;
        padding-top: 8px;
        border-top: 1px solid #e5e7eb;
        font-size: 13px;
        color: #9ca3af;
      }
      
      /* 控制區域樣式 */
      .controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .controls .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .control-btn, .secondary-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
      }
      
      .control-btn {
        background: #10b981;
        color: white;
      }
      
      .control-btn:hover {
        background: #059669;
      }
      
      .secondary-btn {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }
      
      .secondary-btn:hover {
        background: #e5e7eb;
      }
      
      .controls textarea {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 50px;
        font-family: inherit;
      }
      
      .controls textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .send-btn {
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      
      .send-btn:hover {
        background: #2563eb;
      }
      
      /* 手機版優化 */
      @media (max-width: 768px) {
        .container { padding: 12px; }
        .main-layout { 
          flex-direction: column; 
          gap: 16px;
        }
        .left-panel { 
          order: 1;
        }
        .right-panel { 
          order: 2;
        }
        .left-content {
          padding: 16px;
        }
        .settings-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .chat-messages {
          min-height: 300px;
          max-height: 400px;
        }
        .result-tabs {
          flex-direction: column;
        }
        .result-tab {
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
        }
        .result-tab:last-child {
          border-bottom: none;
        }
        .result-content {
          min-height: 200px;
        }
        .user-drawer {
          width: 280px;
          right: -280px;
        }
        .input-row {
          flex-direction: column;
          gap: 8px;
        }
        
        .input-container {
          flex-direction: row;
          gap: 8px;
          align-items: flex-end;
        }
        .input-container button {
          width: auto;
          min-width: 80px;
          flex-shrink: 0;
        }
        h1 { font-size: 16px; margin-bottom: 12px; }
        .chat { height: 50vh; padding: 12px; }
        .msg-bubble { max-width: 90%; padding: 10px 14px; font-size: 14px; }
        .settings-block { padding: 16px; margin-bottom: 12px; }
        .settings-block h3 { font-size: 14px; margin-bottom: 12px; }
        .settings-grid { grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
        .setting-item input, .setting-item select { padding: 10px 12px; font-size: 16px; }
        .apply-btn { padding: 12px 16px; font-size: 14px; }
        .controls { flex-direction: column; gap: 10px; }
        .controls .row { flex-direction: row !important; justify-content: space-between; }
        .controls .row button { flex: 1; margin: 0 4px; }
        textarea { min-height: 40px; font-size: 16px; }
        button { padding: 12px 16px; font-size: 14px; }
        .results-block { padding: 16px; }
        .results-block h3 { font-size: 14px; }
        .result-item h4 { font-size: 13px; }
        .result-item .content { padding: 10px; font-size: 14px; }
        .toast { top: 10px; right: 10px; left: 10px; max-width: none; font-size: 13px; }
      }
      h1 { font-size: 18px; font-weight: 600; color:#2563eb; margin: 0 0 16px; }
      
      /* 用戶認證樣式 */
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 16px; 
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-info { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .user-info:hover {
        background: #f3f4f6;
      }
      .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #e5ecef; }
      .user-name { font-size: 14px; font-weight: 500; color: #374151; }
      .auth-buttons { display: flex; gap: 8px; }
      .login-btn, .logout-btn { 
        padding: 8px 16px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.2s;
      }
      .login-btn { 
        background: #4285f4; 
        color: white; 
      }
      .login-btn:hover { background: #3367d6; }
      .logout-btn { 
        background: #f3f4f6; 
        color: #374151; 
        border: 1px solid #d1d5db;
      }
      .logout-btn:hover { background: #e5e7eb; }
      
      /* 彈跳視窗登入樣式 */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      
      .popup-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }
      
      .popup-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      
      .popup-message {
        font-size: 16px;
        color: #2c3e50;
        margin-bottom: 20px;
      }
      
      .popup-btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 10px;
      }
      
      .popup-btn:hover {
        background: #2980b9;
      }
      
      .popup-btn.secondary {
        background: #95a5a6;
      }
      
      .popup-btn.secondary:hover {
        background: #7f8c8d;
      }
      
      /* 手機版用戶認證優化 */
      @media (max-width: 768px) {
        .header { flex-direction: column; align-items: flex-start; gap: 12px; }
        .user-info { width: 100%; justify-content: space-between; }
        .auth-buttons { width: 100%; justify-content: flex-end; }
        .login-btn, .logout-btn { padding: 10px 16px; font-size: 16px; }
      }
      .chat { border: 1px solid #e5e7eb; background: #f9fafb; border-radius: 12px; height: 60vh; overflow: auto; padding: 16px; }
      .msg { margin: 12px 0; line-height: 1.6; display: flex; }
      .msg.user { justify-content: flex-end; }
      .msg.assistant { justify-content: flex-start; }
      .msg-bubble { max-width: 80%; padding: 12px 16px; border-radius: 18px; white-space: pre-wrap; word-wrap: break-word; }
      .msg.user .msg-bubble { background: #3b82f6; color: #ffffff; border-bottom-right-radius: 4px; }
      .msg.assistant .msg-bubble { background: #f3f4f6; color: #374151; border-bottom-left-radius: 4px; }
      .msg-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
      .msg.user .msg-label { text-align: right; }
      .msg.assistant .msg-label { text-align: left; }
      
      /* 載入動畫 */
      .loading { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        padding: 8px 12px;
        background: #f0f9ff;
        color: #0c4a6e;
        border-radius: 8px;
        margin-right: 20px;
        max-width: 70%;
        position: relative;
      }
      
      .loading::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid #f0f9ff;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
      }
      .spinner { 
        width: 16px; 
        height: 16px; 
        border: 2px solid #e5e7eb; 
        border-top: 2px solid #3b82f6; 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .controls { display: flex; gap: 8px; margin-top: 12px; align-items:center; }
      textarea { flex: 1; min-height: 40px; max-height: 140px; resize: vertical; border-radius: 10px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding: 10px 12px; line-height: 1.4; -webkit-appearance: none; }
      button { padding: 10px 14px; border-radius: 10px; border:1px solid #d1d5db; background:#f9fafb; color:#374151; cursor:pointer; -webkit-appearance: none; }
      button:disabled { opacity: .6; cursor:not-allowed; }
      .row { display:flex; gap:8px; flex-direction:column; }
      .meta { display:flex; gap:8px; margin-bottom:8px; align-items:center; flex-wrap:wrap; }
      .meta input, .meta select { flex:1; min-width: 200px; border-radius: 8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding:8px 10px; }
      .small { font-size:12px; color:#6b7280; }
      .tag { display:inline-block; padding:4px 8px; border:1px solid #d1d5db; border-radius:999px; font-size:12px; color:#6b7280; background:#f3f4f6; }
      
      /* 設定區塊樣式 */
      .settings-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; }
      .settings-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; cursor:pointer; user-select:none; display:flex; align-items:center; gap:8px; }
      .settings-block h3:hover { color:#1d4ed8; }
      .settings-toggle { font-size:12px; transition:transform 0.2s ease; }
      .settings-content { transition:all 0.3s ease; overflow:hidden; }
      .settings-content.collapsed { max-height:0; margin:0; padding:0; }
      .settings-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px; }
      .setting-item { display:flex; flex-direction:column; gap:6px; }
      .setting-item label { font-size:12px; color:#6b7280; font-weight:500; }
      .setting-item input, .setting-item select { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; -webkit-appearance: none; }
      .apply-btn { background:#3b82f6; border:1px solid #2563eb; color:#ffffff; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; }
      .apply-btn:hover { background:#2563eb; }
      .applied-tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
      
      /* 結果區塊樣式 */
      .results-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-top:16px; display:none; }
      .results-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; }
      .result-item { margin-bottom:16px; }
      .result-item h4 { margin:0 0 8px; color:#374151; font-size:14px; font-weight:500; }
      .result-item .content { background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:12px; color:#374151; white-space:pre-wrap; line-height:1.6; }
      
      /* 彈出框樣式 */
      .toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px; max-width: 300px; word-wrap: break-word; }
      .toast.show { animation: slideIn 0.3s ease-out; }
      .toast.hide { animation: slideOut 0.3s ease-in; }
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
      
      /* iOS Safari 特定優化 */
      @supports (-webkit-touch-callout: none) {
        .chat { -webkit-overflow-scrolling: touch; }
        textarea { -webkit-user-select: text; }
        input, select { -webkit-user-select: text; }
        .msg-bubble { -webkit-user-select: text; }
        .result-item .content { -webkit-user-select: text; }
      }
      
      /* 防止 iOS Safari 縮放 */
      input[type="text"], input[type="email"], input[type="password"], textarea, select { font-size: 16px; }
      
      /* 快速按鈕樣式 */
      .quick-buttons { 
        display: flex; 
        gap: 8px; 
        margin-bottom: 12px; 
        flex-wrap: wrap;
        justify-content: center;
      }
      .quick-btn { 
        padding: 10px 18px; 
        border-radius: 20px; 
        border: 1px solid #3b82f6; 
        background: #ffffff; 
        color: #3b82f6; 
        cursor: pointer; 
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .quick-btn:hover { 
        background: #3b82f6; 
        color: #ffffff; 
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }
      .quick-btn:active { 
        transform: translateY(0); 
        box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
      }
      
      /* 手機版快速按鈕優化 */
      @media (max-width: 768px) {
        .quick-buttons { 
          display: flex !important;
          gap: 6px; 
          margin-bottom: 8px;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: auto !important;
          padding: 0 !important;
          background: transparent !important;
        }
        .quick-btn { 
          padding: 6px 8px; 
          font-size: 12px;
          flex: 1;
          min-width: 0;
          text-align: center;
        }
        .input-row {
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: 80px !important;
        }
      }
      
      /* 帳號定位記錄列表樣式 */
      .positioning-history-content {
        padding: 10px;
        max-height: 500px;
        overflow-y: auto;
      }
      
      .positioning-records {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .positioning-record-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
      }
      
      .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .record-number {
        font-weight: 600;
        color: #3b82f6;
        font-size: 14px;
      }
      
      .record-date {
        font-size: 12px;
        color: #6b7280;
      }
      
      .record-preview {
        color: #374151;
        font-size: 14px;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      
      .record-actions {
        display: flex;
        gap: 8px;
      }
      
      .view-btn, .delete-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* 詳細內容彈出視窗樣式 */
      .detail-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      
      .detail-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      
      .detail-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #111827;
      }
      
      .close-detail-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }
      
      .close-detail-btn:hover {
        background: #f3f4f6;
        color: #111827;
      }
      
      .detail-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }
      
      .detail-info {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-info span {
        font-size: 14px;
        color: #6b7280;
      }
      
      .detail-info strong {
        color: #111827;
        font-weight: 600;
      }
      
      .detail-content {
        color: #374151;
        line-height: 1.8;
        font-size: 15px;
      }
      
      
      /* 擴大用戶抽屜視窗 */
      .user-drawer {
        width: 85%;
        max-width: 1000px;
        height: 85vh;
        max-height: 700px;
      }
      
      /* 個人資料庫頁面樣式 */
      .user-db-page {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 24px;
        text-align: center;
      }
      
      .user-db-container {
        display: flex;
        gap: 24px;
        min-height: 600px;
      }
      
      .user-db-sidebar {
        width: 280px;
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      .sidebar-header {
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
      }
      
      .profile-info h3 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .profile-info p {
        margin: 0;
        font-size: 14px;
        color: #6b7280;
      }
      
      .sidebar-menu {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        background: none;
        text-align: left;
        font-size: 14px;
        color: #6b7280;
      }
      
      .menu-item:hover {
        background: #e5e7eb;
        color: #1f2937;
      }
      
      .menu-item.active {
        background: #3b82f6;
        color: white;
      }
      
      .menu-icon {
        font-size: 16px;
      }
      
      .menu-text {
        font-weight: 500;
      }
      
      .menu-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 12px 0;
      }
      
      .logout-item {
        color: #dc2626;
      }
      
      .logout-item:hover {
        background: #fef2f2;
        color: #dc2626;
      }
      
      .user-db-content {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      .db-section {
        display: none;
      }
      
      .db-section.active {
        display: block;
      }
      
      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
      }
      
      .section-content {
        color: #6b7280;
        line-height: 1.6;
      }
      
      .profile-details {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
      }
      
      .detail-item label {
        font-weight: 600;
        color: #374151;
        min-width: 80px;
      }
      
      .detail-item span {
        color: #6b7280;
      }

      /* ===== 模式3：IP人設規劃模式樣式 ===== */
      .mode3-page {
        min-height: 100vh;
        background: #f8fafc;
        padding: 0;
      }

      .mode3-container {
        display: flex;
        height: calc(100vh - 60px);
        gap: 0;
      }

      .mode3-left-panel {
        flex: 1;
        background: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }

      .mode3-right-panel {
        flex: 1;
        background: white;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }

      /* 說明欄位 */
      .mode3-instructions {
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }

      .mode3-instructions-header {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f1f5f9;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
      }

      .mode3-instructions-header:hover {
        background: #e2e8f0;
      }

      .mode3-instructions-title {
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }

      .mode3-instructions-toggle {
        font-size: 12px;
        color: #6b7280;
        transition: transform 0.2s;
      }

      .mode3-instructions.collapsed .mode3-instructions-toggle {
        transform: rotate(-90deg);
      }

      .mode3-instructions-content {
        padding: 16px;
        font-size: 13px;
        line-height: 1.6;
        color: #4b5563;
        max-height: 300px;
        overflow-y: auto;
        transition: max-height 0.3s ease;
      }

      .mode3-instructions.collapsed .mode3-instructions-content {
        max-height: 0;
        padding: 0 16px;
        overflow: hidden;
      }

      .mode3-instructions-content p {
        margin: 0 0 12px 0;
      }

      .mode3-instructions-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .mode3-instructions-content li {
        margin: 4px 0;
      }

      /* 聊天容器 */
      .mode3-chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .mode3-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        min-height: 200px;
        transition: min-height 0.3s ease;
      }

      .mode3-chat-messages.expanded {
        min-height: 400px;
      }

      .mode3-message {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
      }

      .mode3-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .mode3-user-message .mode3-message-avatar {
        background: #3b82f6;
        color: white;
      }

      .mode3-assistant-message .mode3-message-avatar {
        background: #f3f4f6;
        color: #374151;
      }

      .mode3-message-content {
        flex: 1;
        background: #f8fafc;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .mode3-user-message .mode3-message-content {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
      }

      .mode3-message-content p {
        margin: 0 0 8px 0;
        line-height: 1.5;
      }

      .mode3-message-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .mode3-message-content li {
        margin: 4px 0;
      }

      .mode3-message-content:last-child p:last-child {
        margin-bottom: 0;
      }

      /* 快速按鈕 */
      .mode3-quick-buttons {
        padding: 12px 16px;
        border-top: 1px solid #e5e7eb;
        background: #f8fafc;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .mode3-quick-btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .mode3-quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }

      /* 輸入區域 */
      .mode3-input-container {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        background: white;
      }

      .mode3-input-wrapper {
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }

      .mode3-message-input {
        flex: 1;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 12px;
        font-size: 14px;
        resize: vertical;
        min-height: 44px;
        max-height: 120px;
        font-family: inherit;
      }

      .mode3-message-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .mode3-send-btn {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        flex-shrink: 0;
      }

      .mode3-send-btn:hover {
        background: #2563eb;
      }

      .mode3-send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .mode3-send-icon {
        font-size: 16px;
      }

      /* 結果面板 */
      .mode3-results-header {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .mode3-results-header h3 {
        margin: 0;
        font-size: 16px;
        color: #374151;
      }

      .mode3-result-actions {
        display: flex;
        gap: 8px;
      }

      .mode3-action-btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #6b7280;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .mode3-action-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #374151;
      }

      /* 標籤 */
      .mode3-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        background: white;
      }

      .mode3-tab {
        flex: 1;
        background: none;
        border: none;
        padding: 12px 16px;
        cursor: pointer;
        font-size: 13px;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .mode3-tab:hover {
        background: #f8fafc;
        color: #374151;
      }

      .mode3-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
        background: #f8fafc;
      }

      /* 結果內容 */
      .mode3-results-content {
        flex: 1;
        overflow-y: auto;
        background: white;
      }

      .mode3-result-block {
        display: none;
        padding: 16px;
        height: 100%;
      }

      .mode3-result-block.active {
        display: block;
      }
      .mode3-result-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #6b7280;
      }

      .mode3-placeholder-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .mode3-placeholder-icon h4 {
        margin: 0 0 8px 0;
        color: #374151;
        font-size: 18px;
      }

      .mode3-placeholder-icon p {
        margin: 0 0 24px 0;
        font-size: 14px;
        line-height: 1.5;
      }

      .mode3-generate-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mode3-generate-btn:hover {
        background: #2563eb;
      }

      .mode3-generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* 結果內容樣式 */
      .mode3-result-content {
        line-height: 1.6;
        color: #374151;
      }

      .mode3-result-content h1,
      .mode3-result-content h2,
      .mode3-result-content h3,
      .mode3-result-content h4 {
        color: #1f2937;
        margin: 16px 0 8px 0;
      }

      .mode3-result-content h1:first-child,
      .mode3-result-content h2:first-child,
      .mode3-result-content h3:first-child,
      .mode3-result-content h4:first-child {
        margin-top: 0;
      }

      .mode3-result-content p {
        margin: 8px 0;
      }

      .mode3-result-content ul,
      .mode3-result-content ol {
        margin: 8px 0;
        padding-left: 20px;
      }

      .mode3-result-content li {
        margin: 4px 0;
      }

      .mode3-result-content strong {
        color: #1f2937;
        font-weight: 600;
      }

      .mode3-result-content em {
        color: #6b7280;
        font-style: italic;
      }

      /* 載入動畫 */
      .mode3-loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }

      .mode3-loading-dots {
        display: flex;
        gap: 4px;
      }

      .mode3-loading-dot {
        width: 6px;
        height: 6px;
        background: #3b82f6;
        border-radius: 50%;
        animation: mode3-bounce 1.4s infinite ease-in-out both;
      }

      .mode3-loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .mode3-loading-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes mode3-bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        .mode3-container {
          flex-direction: column;
          height: auto;
          padding-top: 70px;
        }

        .mode3-left-panel,
        .mode3-right-panel {
          min-height: 50vh;
        }

        .mode3-tabs {
          flex-wrap: wrap;
        }

        .mode3-tab {
          flex: none;
          min-width: 120px;
        }
      }
      
      /* 桌面版樣式 */
      @media (min-width: 769px) {
        .desktop-only {
          display: block !important;
        }
      }
      
      /* 手機版抽屜導航樣式 */
      .mobile-drawer-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 20px;
        color: #374151;
        cursor: pointer;
        padding: 8px;
        margin-right: 12px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .mobile-drawer-toggle:hover {
        background-color: #f3f4f6;
      }

      .mobile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }

      .mobile-drawer {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100%;
        background: white;
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .mobile-drawer.open {
        left: 0;
      }

      .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }

      .mobile-drawer-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }

      .mobile-drawer-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .mobile-drawer-close:hover {
        background-color: #e5e7eb;
      }

      .mobile-drawer-content {
        padding: 20px 0;
      }

      .mobile-drawer-item {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        color: #374151;
        text-decoration: none;
        transition: background-color 0.2s;
        border-left: 3px solid transparent;
      }

      .mobile-drawer-item:hover {
        background-color: #f8fafc;
        color: #1f2937;
      }

      .mobile-drawer-item.active {
        background-color: #eff6ff;
        color: #3b82f6;
        border-left-color: #3b82f6;
      }

      .mobile-drawer-icon {
        font-size: 20px;
        margin-right: 12px;
        width: 24px;
        text-align: center;
      }

      .mobile-drawer-text {
        font-size: 16px;
        font-weight: 500;
      }

      /* ChatGPT 風格響應式設計 */
      @media (max-width: 768px) {
        /* 手機版抽屜按鈕顯示 */
        .mobile-drawer-toggle {
          display: block !important;
        }

        /* 隱藏桌面版導航標籤 */
        .navbar-tabs {
          display: none !important;
        }

        /* 隱藏底部導覽列 */
        .bottom-navbar {
          display: none !important;
        }

        .chat-container {
          max-width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        
        .message {
          padding: 15px 0 !important;
          margin-bottom: 0 !important;
        }
        
        .message-avatar {
          width: 28px !important;
          height: 28px !important;
          min-width: 28px !important;
          font-size: 14px !important;
          margin-right: 12px !important;
        }
        
        .message-content {
          max-width: calc(100% - 40px) !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
        }
        
        .input-row {
          padding: 20px !important;
          background: #f7f7f8 !important;
          border: none !important;
          box-shadow: none !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 6px !important;
          z-index: auto !important;
        }
        
        .input-container {
          background: white !important;
          border: 1px solid #e5e7eb !important;
          border-radius: 12px !important;
          padding: 8px 12px !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        .input-container textarea {
          font-size: 16px !important; /* 防止iOS縮放 */
          padding: 8px 0 !important;
          min-height: 24px !important;
          max-height: 120px !important;
          line-height: 1.5 !important;
          resize: none !important;
        }
        
        .input-container button {
          background: #3b82f6 !important;
          color: white !important;
          border: none !important;
          border-radius: 8px !important;
          padding: 8px 12px !important;
          font-size: 16px !important;
          min-width: 40px !important;
          height: 40px !important;
        }
        
        .quick-buttons {
          gap: 6px !important;
          padding: 20px !important;
          background: #f7f7f8 !important;
          border: none !important;
          z-index: auto !important;
          display: flex !important;
          flex-wrap: wrap !important;
          justify-content: center !important;
        }
        
        .quick-btn {
          padding: 8px 16px !important;
          font-size: 14px !important;
          border-radius: 12px !important;
          background: white !important;
          border: 1px solid #d1d5db !important;
          white-space: nowrap !important;
          min-width: fit-content !important;
          flex-shrink: 0 !important;
        }
        
        
        /* 手機版聊天容器調整 */
        .chat-container {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          max-width: 100% !important;
          margin: 0 !important;
          display: flex !important;
          flex-direction: column !important;
        }
        
        .chat-messages {
          flex: 1 !important;
          padding: 0 !important;
          padding-top: 80px !important; /* 添加頂部間距避免被頁首遮住 */
          padding-bottom: 0 !important; /* 移除底部padding，讓訊息緊貼輸入區域 */
          overflow-y: auto !important;
          min-height: 0 !important;
          max-width: none !important;
          width: 100% !important;
        }
        
        /* 手機版快速按鈕獨立顯示 - 已在上方定義 */
        
        .input-row {
          padding: 15px !important;
          margin-top: 0 !important;
          background: white !important;
          border: none !important;
          box-shadow: none !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 6px !important;
          z-index: auto !important;
        }
        
        .message {
          padding: 15px 0 !important;
        }
        
        .message-content {
          padding: 15px 20px !important;
          max-width: none !important;
          width: 100% !important;
        }
        
        .message-avatar {
          width: 28px !important;
          height: 28px !important;
          min-width: 28px !important;
          font-size: 14px !important;
          margin-right: 12px !important;
        }
        
        .quick-btn {
          padding: 6px 12px !important;
          font-size: 13px !important;
        }
        
        
        .input-container {
          padding: 6px 10px !important;
          border-radius: 10px !important;
        }
        
        .chat-input {
          font-size: 16px !important; /* 防止iOS縮放 */
          padding: 6px 0 !important;
        }
        
        .send-btn {
          font-size: 16px !important;
          padding: 6px !important;
        }
      }
      
      @media (min-width: 769px) and (max-width: 1024px) {
        .chat-container {
          max-width: 700px;
        }
      }
      
      @media (min-width: 1025px) {
        .chat-container {
          max-width: 800px;
        }
      }

      /* 桌面版樣式 - 隱藏手機版抽屜 */
      @media (min-width: 769px) {
        .mobile-drawer-toggle {
          display: none !important;
        }
        
        .mobile-drawer {
          display: none !important;
        }
        
        .mobile-drawer-overlay {
          display: none !important;
        }
        
        .bottom-navbar {
          display: none !important;
        }
      }
      
      /* 響應式設計 - 手機版 */
      @media (max-width: 768px) {
        /* 頂部導航欄手機版 */
        .top-navbar {
          padding: 12px 16px;
          padding-top: calc(12px + var(--safe-area-inset-top));
          flex-wrap: wrap;
          gap: 12px;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 1000;
        }
        
        .navbar-left {
          gap: 16px;
          flex: 1;
          min-width: 0;
        }
        
        .navbar-title {
          font-size: 25px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .navbar-tabs {
          display: none; /* 手機版隱藏標籤，改用底部導航 */
        }
        
        /* 主內容區域為固定頁首留出空間 */
        .main-content {
          padding-top: 80px;
          padding-bottom: 80px;
          height: calc(100vh - 80px - 80px);
          overflow: hidden;
        }
        
        /* 首頁內容區域獨立滾動 */
        #homepage {
          height: 100%;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          padding: 20px 16px;
        }
        
        /* 首頁卡片容器調整 */
        #homepage .mode-cards {
          padding-top: 20px;
          padding-bottom: 20px;
        }
        
        /* 首頁標題區域調整 */
        #homepage .homepage-title {
          margin-top: 40px;
          margin-bottom: 16px;
        }
        
        #homepage .homepage-subtitle {
          margin-bottom: 20px;
        }
        
        .navbar-right {
          gap: 8px;
        }
        
        .user-info {
          padding: 6px 12px;
          font-size: 14px;
        }
        
        .user-avatar {
          width: 28px !important;
          height: 28px !important;
        }
        
        .user-name {
          font-size: 14px;
        }
        
        .login-btn, .logout-btn {
          padding: 8px 16px;
          font-size: 14px;
        }
        
        /* 主內容區域手機版 - 滿版設計 */
        .main-content {
          width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          height: auto !important;
          min-height: calc(100vh - 60px) !important;
          min-height: calc(100dvh - 60px) !important;
          overflow: visible !important;
        }
        
        .main-content.sidebar-open {
          margin-right: 0 !important;
        }
        
        /* 首頁手機版 - 滿版設計 */
        .homepage {
          width: 100% !important;
          max-width: 100vw !important;
          height: auto !important;
          min-height: calc(100vh - 60px) !important;
          min-height: calc(100dvh - 60px) !important;
          margin: 0 !important;
          padding: 20px 0 !important;
          overflow-x: hidden !important; /* 防止水平滾動 */
          overflow-y: auto !important; /* 允許垂直滾動 */
          display: flex !important;
          flex-direction: column !important;
          box-sizing: border-box !important;
        }
        
        .homepage-title {
          font-size: 24px !important;
          margin-bottom: 16px !important;
          text-align: center !important;
          padding: 0 20px !important;
          line-height: 1.2 !important;
          color: #1f2937 !important;
          font-weight: 700 !important;
          white-space: normal !important;
          word-wrap: break-word !important;
        }
        
        /* 手機版標題換行效果 */
        .homepage-title .mobile-break {
          display: block;
          margin-top: 4px;
        }
        
        .homepage-subtitle {
          font-size: 16px !important;
          margin-bottom: 24px !important;
          text-align: center !important;
          padding: 0 20px !important;
          line-height: 1.5 !important;
          color: #6b7280 !important;
          font-weight: 400 !important;
          white-space: normal !important;
          word-wrap: break-word !important;
        }
        
        .mode-cards {
          display: flex !important;
          flex-direction: column !important;
          gap: 8px !important;
          padding: 0 16px !important;
          width: 100% !important;
          max-width: 100% !important;
          height: auto !important;
          overflow: hidden !important;
          flex: none !important;
          margin: 0 0 20px 0 !important;
          box-sizing: border-box !important;
        }
        
        .mode-card {
          width: 100% !important;
          max-width: 90% !important;
          height: auto !important;
          min-height: 100% !important;
          margin: 0 !important;
          padding: 16px 12px !important;
          border-radius: 12px !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
          background: white !important;
          border: 1px solid #e5e7eb !important;
          display: flex !important;
          flex-direction: column !important;
          justify-content: center !important;
          align-items: center !important;
          text-align: center !important;
          overflow: visible !important;
          cursor: pointer !important;
          position: relative !important;
          z-index: 1 !important;
          user-select: none !important;
          transition: all 0.2s ease !important;
        }
        
        .mode-card h3 {
          font-size: 14px !important;
          margin-bottom: 3px !important;
          font-weight: 600 !important;
          line-height: 1.1 !important;
          color: #1f2937 !important;
          text-align: center !important;
          width: 100% !important;
          white-space: normal !important;
          word-wrap: break-word !important;
        }
        
        .mode-card p {
          font-size: 11px !important;
          line-height: 1.2 !important;
          color: #374151 !important;
          text-align: center !important;
          width: 100% !important;
          white-space: normal !important;
          word-wrap: break-word !important;
          display: block !important;
          margin-bottom: 0 !important;
        }
        
        /* 確保模式卡片描述文字顯示 */
        .mode-card-desc {
          font-size: 11px !important;
          line-height: 1.2 !important;
          color: #374151 !important;
          text-align: center !important;
          width: 100% !important;
          white-space: normal !important;
          word-wrap: break-word !important;
          display: block !important;
          margin-bottom: 0 !important;
        }
        
        /* 所有模式卡片標題字體統一調整 */
        .mode-card:nth-child(1) .mode-card-title {
          font-size: 20px !important;
          font-weight: 700 !important;
        }
        .mode-card:nth-child(2) .mode-card-title {
          font-size: 20px !important;
          font-weight: 700 !important;
        }
        .mode-card:nth-child(3) .mode-card-title {
          font-size: 20px !important;
          font-weight: 700 !important;
        }
        
        /* 手機版模式卡片懸停效果 - 更靈敏的設計 */
        .mode-card {
          transition: all 0.1s ease !important;
        }
        .mode-card:active {
          transform: scale(0.95) !important;
          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
          border-color: #3b82f6 !important;
          background: #f0f9ff !important;
        }
        .mode-card:hover {
          transform: scale(1.02) !important;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2) !important;
          border-color: #3b82f6 !important;
        }
        
        /* 一鍵生成手機版 */
        .mode1-page {
          flex-direction: column;
          gap: 20px;
          padding: 0 8px;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .mode1-left {
          width: 100%;
          max-width: 100%;
          padding: 16px;
          box-sizing: border-box;
        }
        
        .mode1-right {
          width: 100%;
          max-width: 100%;
          padding: 16px;
          box-sizing: border-box;
        }
        
        
        
        .results-section {
          width: 100%;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        /* 結果區塊手機版優化 */
        .results-container {
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .result-content {
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-body {
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        
        .form-group {
          margin-bottom: 16px;
        }
        
        .form-group label {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
          padding: 10px;
          font-size: 16px; /* 防止iOS縮放 */
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        
        .generate-btn {
          padding: 10px 20px;
          font-size: 16px;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        
        .result-content {
          padding: 12px;
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-header h3 {
          font-size: 18px;
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-body {
          font-size: 14px;
          line-height: 1.6;
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-actions {
          flex-direction: column;
          gap: 8px;
          max-width: 100%;
        }
        
        .save-btn, .regenerate-btn {
          padding: 10px 16px;
          font-size: 14px;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        
        /* AI顧問手機版 */
        .mode2-container {
          padding: 16px;
          padding-top: 50px;
        }
        
        /* 手機版說明按鈕 */
        .instructions-toggle-btn {
          top: 70px;
          right: 16px;
          padding: 6px 12px;
          font-size: 13px;
        }
        
        .btn-text {
          font-size: 12px;
        }
        
        /* 手機版抽屜背景遮罩 */
        .drawer-overlay {
          z-index: 999;
        }
        
        /* 手機版說明抽屜 */
        .instructions-drawer {
          width: 100%;
          right: -100%;
        }
        
        .drawer-header {
          padding: 16px;
        }
        
        .drawer-header h3 {
          font-size: 16px;
        }
        
        .drawer-content {
          padding: 16px;
        }
        
        .drawer-content p {
          font-size: 13px;
          margin-bottom: 12px;
        }
        
        .ai-instructions {
          margin-bottom: 20px;
        }
        
        .instructions-header {
          padding: 16px;
        }
        
        .instructions-header h3 {
          font-size: 16px;
        }
        
        .instruction-list {
          padding: 16px;
        }
        
        .instruction-list li {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        .chat-container {
          height: calc(100vh - 80px - 80px);
          min-height: 500px;
          display: flex !important;
          flex-direction: column !important;
          overflow: hidden !important;
          margin-bottom: 0;
          margin-top: 10px !important;
          position: fixed !important;
          top: 80px !important;
          left: 0 !important;
          right: 0 !important;
          z-index: 100 !important;
        }
        
        #chatContainer {
          display: flex !important;
          flex-direction: column !important;
          flex: 1 !important;
          height: 100% !important;
          overflow: visible !important;
        }
        
        .chat-messages {
          padding: 16px;
          flex: 1;
          overflow-y: auto;
          height: calc(100vh - 160px); /* 簡化高度計算 */
          min-height: 400px;
          max-height: calc(100vh - 160px);
          -webkit-overflow-scrolling: touch;
          scroll-behavior: smooth;
          overscroll-behavior: contain;
        }
        
        .message {
          margin-bottom: 16px;
          max-width: 85%;
        }
        
        .message.user {
          margin-left: auto;
        }
        
        .message-content {
          padding: 12px 16px;
          font-size: 14px;
          line-height: 1.5;
        }
        
        .chat-input-container {
          padding: 16px;
          flex-direction: column;
          gap: 12px;
        }
        
        .chat-input {
          width: 100%;
          padding: 12px 16px;
          font-size: 16px;
          border-radius: 25px;
        }
        
        .send-btn {
          padding: 12px 24px;
          font-size: 16px;
          border-radius: 25px;
          width: 100%;
        }
        
        /* AI顧問模式的輸入區域手機版優化 */
        .input-row {
          padding: 16px !important;
          flex-direction: column !important;
          gap: 12px !important;
          display: flex !important;
          border-top: 1px solid #e5e7eb !important;
          background: #f7f7f8 !important;
          border-radius: 0 !important;
          flex-shrink: 0 !important;
          position: sticky !important;
          bottom: 0 !important;
          z-index: 100 !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: auto !important;
          margin: 0 !important;
        }
        
        .input-row textarea {
          width: 100% !important;
          padding: 12px 16px !important;
          font-size: 16px !important;
          border-radius: 25px !important;
          resize: none !important;
          border: 1px solid #d1d5db !important;
          height: 44px !important; /* 固定高度與送出按鈕一致 */
          min-height: 44px !important;
          max-height: 44px !important; /* 限制最大高度與最小高度一致 */
          line-height: 1.2 !important; /* 調整行高確保文字垂直居中 */
        }
        
        .input-row .send-btn {
          padding: 12px 24px !important;
          font-size: 16px !important;
          border-radius: 25px !important;
          width: 100% !important;
          background: #3b82f6 !important;
          color: white !important;
          border: none !important;
        }
        
        .quick-buttons {
          display: flex !important;
          flex-direction: column !important;
          gap: 8px !important;
          padding: 16px !important;
          background: transparent !important;
          border: none !important;
          flex-shrink: 0 !important;
          position: relative !important;
          z-index: 10 !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: 60px !important;
          margin: 0 !important;
        }
        
        /* 強制顯示AI顧問模式的快速按鈕和輸入區域 */
        .mode2 .quick-buttons,
        .mode2 .input-row {
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          position: relative !important;
          z-index: 100 !important;
        }
        
        .mode2 .quick-buttons {
          min-height: auto !important;
          background: transparent !important;
          border: none !important;
          padding: 0 !important;
          flex-direction: row !important;
          gap: 8px !important;
          margin-bottom: 12px !important;
          position: relative !important;
          bottom: auto !important;
          left: auto !important;
          right: auto !important;
          z-index: auto !important;
          flex-wrap: wrap !important;
          justify-content: flex-start !important;
          height: auto !important;
          display: flex !important;
        }
        
        /* 手機版快速按鈕文字對齊調整 */
        .mode2 .quick-btn {
          text-align: left !important; /* 強制文字左對齊 */
          padding: 8px 12px !important; /* 調整左右padding，左邊少一點 */
        }
        
        /* 手機版Mode2頁面固定設計 - 防止左右滑動 */
        .mode2 {
          width: 100% !important;
          max-width: 100vw !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
      .mode2-page {
        width: 100% !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
      }
        
        .mode2 #chatMessages {
          width: 100% !important;
          max-width: 100% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        .mode2 .message {
          width: 100% !important;
          max-width: 100% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        .mode2 .message-content {
          width: 100% !important;
          max-width: 100% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        .mode2 .input-row {
          min-height: auto !important;
          background: transparent !important;
          border: none !important;
          padding: 12px 16px !important;
          flex-direction: column !important;
          gap: 0 !important;
          position: fixed !important;
          bottom: 80px !important;
          left: 16px !important;
          right: 16px !important;
          z-index: 1001 !important;
          box-shadow: none !important;
          margin: 0 !important;
          height: auto !important; /* 完全自適應高度 */
          border-radius: 0 !important;
          max-height: none !important; /* 移除最大高度限制 */
        }
        
        .mode2 .input-container {
          flex-direction: row !important;
          gap: 8px !important;
          align-items: flex-end !important;
        }
        
        .mode2 .input-container button {
          width: auto !important;
          min-width: 80px !important;
          flex-shrink: 0 !important;
        }
        
        .mode2 .input-container textarea {
          height: 44px !important; /* 固定高度與送出按鈕一致 */
          min-height: 44px !important;
          max-height: 44px !important; /* 限制最大高度與最小高度一致 */
          resize: none !important; /* 禁止調整大小保持固定高度 */
          line-height: 1.2 !important; /* 調整行高確保文字垂直居中 */
        }
        
        /* 創作者資料庫手機版 */
        .user-db-page {
          padding: 16px;
          padding-top: 50px;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .user-db-container {
          flex-direction: column;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .user-db-sidebar {
          width: 100%;
          margin-bottom: 20px;
          border-radius: 12px;
          max-width: 100%;
        }
        
        .user-db-content {
          width: 100%;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        /* 個人資料卡片手機版優化 */
        .db-section {
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .section-content {
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .user-info-detail {
          max-width: 100%;
          overflow-x: hidden;
          width: 100%;
          padding: 20px;
        }
        
        .info-item {
          max-width: 100%;
          overflow-x: hidden;
          white-space: nowrap;
          display: flex;
          align-items: center;
        }
        
        .info-item label {
          flex-shrink: 0;
          margin-right: 8px;
        }
        
        .info-item span {
          flex: 1;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        /* 強制防止資料庫頁面水平滾動 */
        #userDB {
          overflow-x: hidden !important;
          max-width: 100vw !important;
        }
        
        .user-db-page * {
          box-sizing: border-box !important;
        }
        
        .user-db-page input,
        .user-db-page span,
        .user-db-page div {
          max-width: 100% !important;
          overflow-x: hidden !important;
        }
        
        .user-db-page .info-item {
          white-space: nowrap !important;
          display: flex !important;
          align-items: center !important;
        }
        
        .user-db-page .info-item span {
          text-overflow: ellipsis !important;
          overflow: hidden !important;
        }
        
        /* 強制拉長個人資料灰底寬度 */
        .user-db-page .user-info-detail {
          width: 100% !important;
          max-width: 100% !important;
          padding: 50px !important;
          margin: 0 !important;
        }
        
        .user-db-page .section-content {
          width: 100% !important;
          max-width: 100% !important;
          padding: 0 !important;
        }
        
        .user-db-page .db-section {
          width: 100% !important;
          max-width: 100% !important;
        }
        
        /* 個人資料灰底寬度手機版 */
        .user-db-page .detail-item {
          width: 100% !important;
          max-width: 100% !important;
          padding: 16px !important;
        }
        
        .user-db-page .profile-details {
          width: 100% !important;
          max-width: 100% !important;
        }
        
        .sidebar-header {
          padding: 16px;
        }
        
        .user-profile {
          flex-direction: column;
          text-align: center;
          gap: 12px;
        }
        
        .profile-avatar {
          width: 60px;
          height: 60px;
        }
        
        .profile-info h3 {
          font-size: 18px;
        }
        
        .profile-info p {
          font-size: 14px;
        }
        
        .sidebar-menu {
          padding: 16px;
        }
        
        .menu-item {
          padding: 12px 16px;
          margin-bottom: 8px;
          border-radius: 8px;
        }
        
        .menu-text {
          font-size: 14px;
        }
        
        .user-db-content {
          width: 100%;
        }
        
        .db-section {
          padding: 16px;
        }
        
        .section-title {
          font-size: 18px;
          margin-bottom: 16px;
        }
        
        /* 腳本表格手機版 */
        .script-table {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }
        
        .script-table table {
          min-width: 600px;
          font-size: 12px;
        }
        
        .script-table th,
        .script-table td {
          padding: 8px 6px;
          white-space: nowrap;
        }
        
        .script-actions {
          flex-direction: column;
          gap: 8px;
        }
        
        .action-btn {
          padding: 10px 16px;
          font-size: 14px;
          width: 100%;
        }
        
        /* 用戶抽屜手機版 */
        .user-drawer {
          width: 100%;
          max-width: 100vw;
          right: 0;
          border-radius: 0;
        }
        
        .user-drawer-header {
          padding: 20px 16px;
          padding-top: calc(20px + var(--safe-area-inset-top));
        }
        
        .user-drawer-content {
          padding: 16px;
        }
        
        .drawer-section h3 {
          font-size: 16px;
          margin-bottom: 12px;
        }
        
        .drawer-section p {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        /* 底部導航欄（手機版專用） */
        .bottom-navbar {
          display: flex !important;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          border-top: 1px solid #e5e7eb;
          padding: 8px 0;
          padding-bottom: calc(8px + var(--safe-area-inset-bottom));
          z-index: 1000;
        }
        
        .bottom-nav-item {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 8px 4px;
          text-decoration: none;
          color: #6b7280;
          font-size: 12px;
          transition: color 0.2s;
        }
        
        .bottom-nav-item.active {
          color: #3b82f6;
        }
        
        .bottom-nav-item span {
          margin-top: 4px;
        }
        
        /* 隱藏桌面版導航 */
        .navbar-tabs {
          display: none;
        }
      }
      
      /* 超小螢幕手機 */
      @media (max-width: 480px) {
        .homepage-title {
          font-size: 20px;
        }
        
        .homepage-subtitle {
          font-size: 14px;
        }
        
        .mode-card {
          padding: 20px 16px;
        }
        
        .mode-card h3 {
          font-size: 18px;
        }
        
        .mode-card p {
          font-size: 13px;
        }
        
        .chat-container {
          height: calc(100vh - 180px);
        }
        
        .script-table table {
          font-size: 11px;
        }
        
        .script-table th,
        .script-table td {
          padding: 6px 4px;
        }
      }
      
      /* iOS Safari 特殊處理 */
      @supports (-webkit-touch-callout: none) {
        .chat-container {
          height: calc(100vh - 220px);
          height: calc(100dvh - 220px);
        }
        
        .main-content {
          min-height: calc(100vh - 60px);
          min-height: calc(100dvh - 60px);
        }
        
        .app-container {
          min-height: 100vh;
          min-height: 100dvh;
        }
      }
      
      /* 登入頁面樣式 */
      .login-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffffff;
        background-image: 
          radial-gradient(circle at 20% 20%, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
          radial-gradient(circle at 40% 40%, rgba(0, 0, 0, 0.08) 1px, transparent 1px),
          radial-gradient(circle at 60% 60%, rgba(0, 0, 0, 0.06) 1px, transparent 1px),
          radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
          radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
          radial-gradient(circle at 70% 30%, rgba(0, 0, 0, 0.07) 1px, transparent 1px);
        background-size: 50px 50px, 60px 60px, 40px 40px, 70px 70px, 30px 30px, 80px 80px;
        animation: starField 15s linear infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        overflow: hidden;
      }
      
      /* 星星動畫 */
      @keyframes starField {
        0% {
          background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%;
        }
        25% {
          background-position: 25% 25%, 25% 25%, 25% 25%, 25% 25%, 25% 25%;
        }
        50% {
          background-position: 50% 50%, 50% 50%, 50% 50%, 50% 50%, 50% 50%;
        }
        75% {
          background-position: 75% 75%, 75% 75%, 75% 75%, 75% 75%, 75% 75%;
        }
        100% {
          background-position: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
        }
      }
      
      /* 登入容器動畫 */
      .login-container {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 400px;
        width: 90%;
        text-align: center;
        animation: fadeInUp 0.8s ease-out;
        position: relative;
        overflow: hidden;
      }
      
      .login-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.03), transparent);
        animation: shimmer 3s ease-in-out infinite;
        pointer-events: none;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes shimmer {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }
      
      .login-header {
        margin-bottom: 32px;
      }
      
      .login-title {
        font-size: 28px;
        font-weight: bold;
        color: #1f2937;
        margin: 0 0 8px 0;
        animation: titleGlow 2s ease-in-out infinite alternate;
      }
      
      @keyframes titleGlow {
        from {
          text-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
        }
        to {
          text-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4);
        }
      }
      
      .login-subtitle {
        font-size: 16px;
        color: #6b7280;
        margin: 0 0 16px 0;
      }
      
      .login-prompt {
        font-size: 14px;
        color: #9ca3af;
        margin: 0;
      }
      
      .login-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 24px;
      }
      
      .login-btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .skip-btn {
        background: #fbbf24;
        color: #1f2937;
      }
      
      .skip-btn:hover {
        background: #f59e0b;
      }
      
      .google-btn {
        background: #3b82f6;
        color: white;
      }
      
      .google-btn:hover {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(59, 130, 246, 0.3);
      }
      
      .google-btn:active {
        transform: translateY(0);
      }
      
      .line-btn {
        background: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
      }
      
      .google-icon, .line-icon {
        width: 18px;
        height: 18px;
      }
      
      .login-note {
        font-size: 12px;
        color: #9ca3af;
        margin: 0 0 24px 0;
      }
      
      .language-selector {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
      
      .lang-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .lang-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }
      
      .lang-btn:hover:not(.active) {
        background: #f9fafb;
      }
      
      /* 手機版登入頁面 */
      @media (max-width: 768px) {
        .login-container {
          padding: 32px 24px;
          margin: 16px;
        }
        
        /* 手機版隱藏登出按鈕 */
        .logout-btn {
          display: none !important;
        }
        
        /* 防止整個頁面水平滾動 */
        body {
          overflow-x: hidden !important;
        }
        
        .main-content {
          overflow-x: hidden !important;
        }
        
        /* 一鍵生成模式防止水平滾動 */
        #mode1 {
          overflow-x: hidden !important;
          max-width: 100vw !important;
        }
        
        .mode1-page {
          overflow-x: hidden !important;
          max-width: 100% !important;
        }
        
        .mode1-left,
        .mode1-right {
          overflow-x: hidden !important;
          word-wrap: break-word !important;
        }
        
        .login-title {
          font-size: 24px;
        }
        
        .login-subtitle {
          font-size: 14px;
        }
        
        .login-btn {
          padding: 14px 20px;
          font-size: 15px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 登入頁面 -->
    <div id="loginPage" class="login-page">
      <div class="login-container">
        <div class="login-header">
          <h1 class="login-title">ReelMind體</h1>
          <p class="login-subtitle">您的個人化短影音創作專家</p>
          <p class="login-prompt">請登入以繼續</p>
        </div>
        
        <div class="login-buttons">
          <button class="login-btn google-btn" onclick="login()">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE3LjY0IDkuMjA0NTVDMTcuNjQgOC41NjY0MSAxNy41ODI3IDcuOTUyMjcgMTcuNDc3MyA3LjM2MzY0SDkuMTgzNjRWMTAuODQ1NUgxMy44NDA5QzEzLjYzNjQgMTIuMzI1IDEyLjgxODIgMTMuNTU0NSAxMS42MzY0IDE0LjM0NTVDMTEuNjM2NCAxNC4zNDU1IDExLjYzNjQgMTQuMzQ1NSAxMS42MzY0IDE0LjM0NTVMMTMuNDU0NSAxNS45OTU1QzE0LjkwOTEgMTQuNjU0NSAxNy42NCAxMi4zMjUgMTcuNjQgOS4yMDQ1NVoiIGZpbGw9IjQyODVGNCIvPgo8cGF0aCBkPSJNOS4xODM2NCAxOC4wMDAyQzExLjQzMTggMTguMDAwMiAxMy4yNzI3IDE3LjI3MjcgMTQuNjM2NCAxNi4wOTU1TDEyLjgxODIgMTQuNDQ1NUMxMi4wOTU1IDE1LjAwOTEgMTEuMTU0NSAxNS40MzE4IDEwLjAwOTEgMTUuNDMxOEM3Ljc0NTQ1IDE1LjQzMTggNS44NDU0NSAxMy45NTQ1IDUuMTU0NTUgMTEuOTU0NUwzLjI3MjczIDEzLjU0NTVDNC42MzYzNiAxNi4wOTU1IDYuNzI3MjcgMTguMDAwMiA5LjE4MzY0IDE4LjAwMDJaIiBmaWxsPSIzNEE4NTMiLz4KPHBhdGggZD0iTTMuMjcyNzMgMTEuOTU0NUMzLjAwOTA5IDExLjE4MTggMi44NzI3MyAxMC4zNjM2IDIuODcyNzMgOS41MDAwMkMyLjg3MjczIDguNjM2MzYgMy4wMDkwOSA3LjgxODE4IDMuMjcyNzMgNy4wNDU0NUw1LjE1NDU1IDguNjM2MzZDNC45NTQ1NSA5LjM2MzY0IDQuODcyNzMgMTAuMTM2NCA0Ljg3MjczIDEwLjk1NDVDNC44NzI3MyAxMS43NzI3IDQuOTU0NTUgMTIuNTQ1NSAzLjI3MjczIDEzLjU0NTVMMy4yNzI3MyAxMS45NTQ1WiIgZmlsbD0iRkJCQzA0Ii8+CjxwYXRoIGQ9Ik05LjE4MzY0IDMuNTY4MThDMTEuMTU0NSAzLjU2ODE4IDEyLjYzNjQgNC4zNDA5MSAxMy40NTQ1IDUuMDQ1NDVMMTQuNjM2NCAzLjkwOTA5QzEzLjI3MjcgMi42MzYzNiAxMS40MzE4IDEuOTk5OTggOS4xODM2NCAxLjk5OTk4QzYuNzI3MjcgMS45OTk5OCA0LjYzNjM2IDMuOTA5MDkgMy4yNzI3MyA2LjQ1OTA5TDUuMTU0NTUgOC4wNDU0NUM1Ljg0NTQ1IDYuMDQ1NDUgNy43NDU0NSA0LjU2ODE4IDkuMTgzNjQgMy41NjgxOFoiIGZpbGw9IjM0QTg1MyIvPgo8L3N2Zz4K" alt="Google" class="google-icon">
            使用 Google 登入
          </button>
        </div>
      </div>
    </div>

    <!-- 主應用程式容器 -->
    <div id="appContainer" class="app-container" style="display: none;">
      <!-- 主內容區域 -->
      <div class="main-content" id="mainContent">
        <!-- 頂部導航欄 -->
        <div class="top-navbar">
          <div class="navbar-left">
            <!-- 手機版抽屜按鈕 -->
            <button class="mobile-drawer-toggle" onclick="toggleMobileDrawer()">
              <span class="hamburger-icon">☰</span>
            </button>
            <div class="navbar-title clickable-title" onclick="switchPage('homepage')">ReelMind</div>
            <div class="navbar-tabs">
              <a href="#homepage" class="navbar-tab" onclick="switchPage('homepage'); return false;">首頁</a>
              <a href="#mode1" class="navbar-tab" onclick="switchPage('mode1'); return false;">一鍵生成</a>
              <a href="#mode2" class="navbar-tab" onclick="switchPage('mode2'); return false;">AI顧問</a>
              <a href="#mode3" class="navbar-tab" onclick="switchPage('mode3'); return false;">IP人設規劃</a>
              <a href="#userDB" id="userDBTab" class="navbar-tab" onclick="switchPage('userDB'); return false;" style="display:none;">創作者資料庫</a>
            </div>
          </div>
          <div class="navbar-right">
            <div class="user-info" id="userInfo" style="display: none;" onclick="switchPage('userDB')">
              <img id="userAvatar" class="user-avatar" src="" alt="用戶頭像" style="width: 32px; height: 32px; border-radius: 50%;">
            <span id="userName" class="user-name"></span>
          </div>
          <div class="auth-buttons" style="display: none;">
              <button id="loginBtn" class="login-btn" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">🔐 登入</button>
          </div>
        </div>
      </div>

        <!-- 頁面內容區域 -->
        <div class="page-content">
          <!-- 首頁 -->
          <div id="homepage" class="page active">
            <div class="homepage">
              <h1 class="homepage-title">歡迎使用AIJob<span class="mobile-break">短影音智能體</span></h1>
              <p class="homepage-subtitle">選擇您偏好的使用模式，開始創作精彩的短影音內容</p>
              <div class="mode-cards">
                <div class="mode-card" onclick="switchPage('mode1'); console.log('Mode1 card clicked');">
                  <div class="mode-card-icon">⚡</div>
                  <h3 class="mode-card-title">一鍵生成模式</h3>
                  <p class="mode-card-desc">快速設定需求，依序生成帳號定位、選題和腳本，適合效率導向的用戶</p>
                </div>
                <div class="mode-card" onclick="switchPage('mode2'); console.log('Mode2 card clicked');">
                  <div class="mode-card-icon">💬</div>
                  <h3 class="mode-card-title">AI顧問對話模式</h3>
                  <p class="mode-card-desc">與AI進行深度對話，靈活討論內容策略，適合需要創意討論的用戶</p>
                </div>
                <div class="mode-card" onclick="switchPage('mode3'); console.log('Mode3 card clicked');">
                  <div class="mode-card-icon">🎭</div>
                  <h3 class="mode-card-title">IP人設規劃模式</h3>
                  <p class="mode-card-desc">透過聊天記錄人生曲線，AI協助擬定個人化IP Profile、14天規劃和腳本</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 模式1：一鍵生成頁面 -->
          <div id="mode1" class="page">
            <div class="mode1-page">
              <!-- 左半部：用戶需求設定 -->
              <div class="mode1-left">
                <h2 class="section-title">
                  <span>⚙️</span>
                  用戶需求設定
                </h2>
                <!-- 這裡將放置原有的用戶需求設定表單 -->
                <div id="userSettingsContainer">
                  <!-- 原有的用戶需求設定內容將移動到這裡 -->
                </div>
                
                <!-- 一鍵生成使用說明 -->
                <div class="one-click-instructions" id="oneClickInstructions" style="display: none;">
                  <h3>🚀 一鍵生成使用說明</h3>
                  <div class="instruction-steps">
                    <div class="step">
                      <div class="step-number">1</div>
                      <div class="step-content">
                        <strong>設定需求</strong>
                        <p>選擇平台、輸入主題、設定秒數和帳號定位，然後點擊「套用設定」</p>
                      </div>
                    </div>
                    <div class="step">
                      <div class="step-number">2</div>
                      <div class="step-content">
                        <strong>生成帳號定位</strong>
                        <p>點擊右側「一鍵生成帳號定位」按鈕，AI將分析您的帳號定位</p>
                      </div>
                    </div>
                    <div class="step">
                      <div class="step-number">3</div>
                      <div class="step-content">
                        <strong>生成選題</strong>
                        <p>點擊「一鍵生成選題」按鈕，AI將為您推薦適合的腳本主題</p>
                      </div>
                    </div>
                    <div class="step">
                      <div class="step-number">4</div>
                      <div class="step-content">
                        <strong>生成腳本</strong>
                        <p>點擊「一鍵生成腳本」按鈕，AI將生成完整的短影音腳本</p>
                      </div>
                    </div>
                    <div class="step">
                      <div class="step-number">5</div>
                      <div class="step-content">
                        <strong>儲存或重新生成</strong>
                        <p>滿意結果可點擊「儲存」，不滿意可點擊「再換一個」重新生成</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 右半部：一鍵生成結果區塊 -->
              <div class="mode1-right">
                <h2 class="section-title">
                  <span>🚀</span>
                  一鍵生成腳本
                </h2>
                <!-- 這裡將放置原有的一鍵生成功能 -->
                <div id="oneClickGenerationContainer">
                  <!-- 原有的一鍵生成內容將移動到這裡 -->
                </div>
              </div>
            </div>
          </div>

          <!-- 模式2：AI顧問對話頁面 -->
          <div id="mode2" class="page mode2 fig1">
            <div class="mode2-page">
              <!-- 說明按鈕 -->
              <div class="instructions-toggle-btn" onclick="toggleInstructionsDrawer()">
                <span class="btn-icon">📋</span>
                <span class="btn-text">使用說明</span>
              </div>
              
              <!-- 說明抽屜背景遮罩 -->
              <div id="drawerOverlay" class="drawer-overlay" onclick="toggleInstructionsDrawer()"></div>
              
              <!-- 說明抽屜 -->
              <div id="instructionsDrawer" class="instructions-drawer">
                <div class="drawer-header">
                  <h3>如何使用 AI 短影音顧問 🚀</h3>
                  <button class="drawer-close-btn" onclick="toggleInstructionsDrawer()">✕</button>
                </div>
                <div class="drawer-content">
                  <p><strong>💬 直接對話</strong><br>點擊下方按鈕開始與AI進行深度對話討論</p>
                  <p><strong>🎯 專業建議</strong><br>AI會根據你的需求提供帳號定位、選題建議和腳本創作指導</p>
                  <p><strong>🔄 持續優化</strong><br>透過多輪對話不斷調整和完善內容，直到滿意為止</p>
                  <p><strong>💡 小提醒：</strong>詳細描述你的需求能讓AI提供更精準的建議 🎯</p>
                </div>
              </div>
              
              <!-- 聊天訊息區域 -->
              <div id="chatMessages" class="chat-messages">
                <!-- 聊天訊息將在這裡動態插入 -->
              </div>
              
              <!-- 快速按鈕區域 -->
              <div class="quick-buttons" id="quickButtons">
                <button class="quick-btn" data-text="我要如何開始？">我要如何開始？</button>
                <button class="quick-btn" data-text="我要怎麼帳號定位">我要怎麼帳號定位</button>
                <button class="quick-btn" data-text="什麼是腳本選題">什麼是腳本選題</button>
              </div>
              
              <!-- 輸入區域 -->
              <div class="input-row">
                <textarea id="messageInput" class="chat-input" placeholder="向AI顧問提問..." rows="1"></textarea>
                <button id="sendBtn" class="send-btn" disabled>
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
              
              </div>
            </div>
          </div>

          <!-- 模式3：IP人設規劃頁面 -->
          <div id="mode3" class="page">
            <div class="mode3-page">
              <div class="mode3-container">
                <!-- 左側聊天面板 -->
                <div class="mode3-left-panel">
                  <!-- 說明欄位 -->
                  <div class="mode3-instructions">
                    <div class="mode3-instructions-header" onclick="toggleMode3Instructions()">
                      <span class="mode3-instructions-title">📋 使用說明</span>
                      <span class="mode3-instructions-toggle">▼</span>
                    </div>
                    <div class="mode3-instructions-content">
                      <p><strong>🎯 IP人設規劃模式</strong></p>
                      <p>透過與AI深度對話，記錄您的人生曲線和個人特色，讓AI協助您建立完整的IP人設。</p>
                      
                      <p><strong>💬 對話流程：</strong></p>
                      <ul>
                        <li>分享您的背景、經歷、專長</li>
                        <li>討論您的價值觀和人生目標</li>
                        <li>描述您的個性和溝通風格</li>
                        <li>探索您的內容創作方向</li>
                      </ul>
                      
                      <p><strong>📊 生成內容：</strong></p>
                      <ul>
                        <li><strong>IP Profile：</strong>完整的個人品牌檔案</li>
                        <li><strong>14天規劃：</strong>詳細的短影音內容規劃</li>
                        <li><strong>今日腳本：</strong>3支即時可用的腳本</li>
                      </ul>
                      
                      <p><strong>💡 使用技巧：</strong></p>
                      <ul>
                        <li>點擊快速按鈕快速開始對話</li>
                        <li>詳細描述您的想法和需求</li>
                        <li>可以隨時要求重新生成內容</li>
                        <li>生成的內容可儲存到個人資料庫</li>
                      </ul>
                    </div>
                  </div>

                  <!-- 聊天區域 -->
                  <div class="mode3-chat-container">
                    <div class="mode3-chat-messages" id="mode3-chat-messages">
                      <div class="mode3-message mode3-assistant-message">
                        <div class="mode3-message-avatar">🤖</div>
                        <div class="mode3-message-content">
                          <p>您好！我是您的IP人設規劃顧問。讓我們開始建立您的個人品牌檔案吧！</p>
                          <p>請告訴我：</p>
                          <ul>
                            <li>您的職業背景和專長領域</li>
                            <li>您希望分享的價值觀或理念</li>
                            <li>您的目標受眾是誰</li>
                            <li>您希望在短影音中展現什麼樣的形象</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <!-- 快速按鈕 -->
                    <div class="mode3-quick-buttons">
                      <button class="mode3-quick-btn" onclick="sendMode3Message('我想分享我的專業經驗')">專業經驗</button>
                      <button class="mode3-quick-btn" onclick="sendMode3Message('我想建立個人品牌')">個人品牌</button>
                      <button class="mode3-quick-btn" onclick="sendMode3Message('我想分享生活故事')">生活故事</button>
                      <button class="mode3-quick-btn" onclick="sendMode3Message('我想做知識分享')">知識分享</button>
                    </div>

                    <!-- 輸入區域 -->
                    <div class="mode3-input-container">
                      <div class="mode3-input-wrapper">
                        <textarea 
                          id="mode3-message-input" 
                          class="mode3-message-input" 
                          placeholder="請描述您的背景、專長、價值觀或目標..."
                          rows="3"
                        ></textarea>
                        <button class="mode3-send-btn" onclick="sendMode3Message()">
                          <span class="mode3-send-icon">📤</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 右側結果面板 -->
                <div class="mode3-right-panel">
                  <div class="mode3-results-header">
                    <h3>📊 生成結果</h3>
                    <div class="mode3-result-actions">
                      <button class="mode3-action-btn" onclick="saveMode3Result()" title="儲存結果">
                        <span>💾</span>
                      </button>
                      <button class="mode3-action-btn" onclick="regenerateMode3Result()" title="重新生成">
                        <span>🔄</span>
                      </button>
                      <button class="mode3-action-btn" onclick="exportMode3Result()" title="匯出結果">
                        <span>📤</span>
                      </button>
                    </div>
                  </div>

                  <!-- 結果標籤 -->
                  <div class="mode3-tabs">
                    <button class="mode3-tab active" onclick="switchMode3Tab('profile')">《IP Profile》</button>
                    <button class="mode3-tab" onclick="switchMode3Tab('plan')">《14天短影音規劃表》</button>
                    <button class="mode3-tab" onclick="switchMode3Tab('scripts')">《今日3支腳本》</button>
                  </div>

                  <!-- 結果內容 -->
                  <div class="mode3-results-content">
                    <!-- IP Profile 結果 -->
                    <div id="mode3-profile-result" class="mode3-result-block active">
                      <div class="mode3-result-placeholder">
                        <div class="mode3-placeholder-icon">🎭</div>
                        <h4>IP Profile</h4>
                        <p>與AI對話後，將在此顯示您的個人品牌檔案</p>
                        <button class="mode3-generate-btn" onclick="generateMode3IPProfile()">
                          <span>🚀</span> 生成IP Profile
                        </button>
                      </div>
                    </div>

                    <!-- 14天規劃結果 -->
                    <div id="mode3-plan-result" class="mode3-result-block">
                      <div class="mode3-result-placeholder">
                        <div class="mode3-placeholder-icon">📅</div>
                        <h4>14天短影音規劃</h4>
                        <p>基於您的IP Profile，生成詳細的內容規劃</p>
                        <button class="mode3-generate-btn" onclick="generateMode314DayPlan()">
                          <span>🚀</span> 生成14天規劃
                        </button>
                      </div>
                    </div>

                    <!-- 今日腳本結果 -->
                    <div id="mode3-scripts-result" class="mode3-result-block">
                      <div class="mode3-result-placeholder">
                        <div class="mode3-placeholder-icon">📝</div>
                        <h4>今日3支腳本</h4>
                        <p>根據您的規劃，生成今日可用的腳本</p>
                        <button class="mode3-generate-btn" onclick="generateMode3TodayScripts()">
                          <span>🚀</span> 生成今日腳本
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 個人資料庫頁面 -->
          <div id="userDB" class="page">
            <div class="user-db-page">
              <h2 class="page-title">👤 個人資料庫</h2>
              <div class="user-db-container">
                <!-- 左側功能選單 -->
                <div class="user-db-sidebar">
                  <div class="sidebar-header">
                    <div class="user-profile">
                      <img id="dbUserAvatar" class="profile-avatar" src="" alt="用戶頭像">
                      <div class="profile-info">
                        <h3 id="dbUserName">用戶名稱</h3>
                        <p id="dbUserEmail">user@example.com</p>
                      </div>
                    </div>
                  </div>
                  <nav class="sidebar-menu">
                    <div class="menu-item" onclick="showDbSection('personalInfo')">
                      <span class="menu-icon">👤</span>
                      <span class="menu-text">個人資料</span>
                    </div>
                    <div class="menu-item" onclick="showDbSection('myScripts')">
                      <span class="menu-icon">💾</span>
                      <span class="menu-text">我的腳本</span>
                    </div>
                    <div class="menu-item" onclick="showDbSection('accountPositioning')">
                      <span class="menu-icon">🎯</span>
                      <span class="menu-text">帳號定位</span>
                    </div>
                    <div class="menu-item" onclick="showDbSection('topicRecords')">
                      <span class="menu-icon">💡</span>
                      <span class="menu-text">選題記錄</span>
                    </div>
                    <div class="menu-item" onclick="showDbSection('settings')">
                      <span class="menu-icon">⚙️</span>
                      <span class="menu-text">設定</span>
                    </div>
                    <div class="menu-item" onclick="showDbSection('usageStats')">
                      <span class="menu-icon">📊</span>
                      <span class="menu-text">使用統計</span>
                    </div>
                    <div class="menu-item" onclick="showDbSection('helpCenter')">
                      <span class="menu-icon">❓</span>
                      <span class="menu-text">幫助中心</span>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-item logout-item" onclick="logout()">
                      <span class="menu-icon">🚪</span>
                      <span class="menu-text">登出</span>
                    </div>
                  </nav>
                </div>
                <!-- 右側內容區域 -->
                <div class="user-db-content">
                  <!-- 個人資料 -->
                  <div id="db-personalInfo" class="db-section active">
                    <h3 class="section-title">👤 個人資料</h3>
                    <div class="section-content">
                      <p>個人資料功能開發中...</p>
                    </div>
                  </div>
                  <!-- 我的腳本 -->
                  <div id="db-myScripts" class="db-section">
                    <h3 class="section-title">💾 我的腳本</h3>
                    <div class="section-content">
                      <p>我的腳本功能開發中...</p>
                    </div>
                  </div>
                  <!-- 帳號定位 -->
                  <div id="db-accountPositioning" class="db-section">
                    <h3 class="section-title">🎯 帳號定位</h3>
                    <div class="section-content">
                      <p>帳號定位功能開發中...</p>
                    </div>
                  </div>
                  <!-- 選題記錄 -->
                  <div id="db-topicRecords" class="db-section">
                    <h3 class="section-title">💡 選題記錄</h3>
                    <div class="section-content">
                      <p>選題記錄功能開發中...</p>
                    </div>
                  </div>
                  <!-- 設定 -->
                  <div id="db-settings" class="db-section">
                    <h3 class="section-title">⚙️ 設定</h3>
                    <div class="section-content">
                      <p>設定功能開發中...</p>
                    </div>
                  </div>
                  <!-- 使用統計 -->
                  <div id="db-usageStats" class="db-section">
                    <h3 class="section-title">📊 使用統計</h3>
                    <div class="section-content">
                      <p>使用統計功能開發中...</p>
                    </div>
                  </div>
                  <!-- 幫助中心 -->
                  <div id="db-helpCenter" class="db-section">
                    <h3 class="section-title">❓ 幫助中心</h3>
                    <div class="section-content">
                      <p>幫助中心功能開發中...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 側邊欄 -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h3 class="sidebar-title">功能選單</h3>
          <button class="sidebar-close" onclick="toggleSidebar()">×</button>
        </div>
        <div class="sidebar-menu">
          <button class="sidebar-item" onclick="showSidebarPage('profile')">👤 個人資料</button>
          <button class="sidebar-item" onclick="showSidebarPage('scripts')">📝 我的腳本</button>
          <button class="sidebar-item" onclick="showSidebarPage('positioning')">🎯 帳號定位</button>
          <button class="sidebar-item" onclick="showSidebarPage('topics')">💡 選題記錄</button>
          <button class="sidebar-item" onclick="showSidebarPage('settings')">⚙️ 設定</button>
          <button class="sidebar-item" onclick="showSidebarPage('statistics')">📊 使用統計</button>
          <button class="sidebar-item" onclick="showSidebarPage('help')">❓ 幫助中心</button>
        </div>
      </div>

      <!-- 側邊欄頁面容器 -->
      <div class="sidebar-page-overlay" id="sidebarPageOverlay" style="display: none;">
        <div class="sidebar-page-container">
          <div class="sidebar-page-header">
            <h2 id="sidebarPageTitle">頁面標題</h2>
            <button class="sidebar-page-close" onclick="closeSidebarPage()">×</button>
          </div>
          <div class="sidebar-page-content" id="sidebarPageContent">
            <!-- 頁面內容將動態載入到這裡 -->
          </div>
        </div>
      </div>

    </div>
          <div class="left-content">
            <!-- 用戶需求設定區塊 -->
      <div class="settings-block">
              <h3 id="settingsToggle">📋 用戶需求設定 <span class="settings-toggle">▼</span></h3>
        <div class="settings-content" id="settingsContent">
          <div class="settings-grid">
          <div class="setting-item">
            <label>平台</label>
                    <select id="platformSelect">
              <option value="">選擇平台</option>
              <option value="TikTok">TikTok</option>
                      <option value="Instagram">Instagram Reels</option>
                      <option value="YouTube">YouTube Shorts</option>
                      <option value="Facebook">Facebook Reels</option>
            </select>
          </div>
          <div class="setting-item">
            <label>主題</label>
                    <input type="text" id="topicInput" placeholder="例如:夏季變白挑戰/美白保養">
          </div>
          <div class="setting-item">
            <label>腳本秒數</label>
                    <select id="durationInput">
                      <option value="15秒">15秒</option>
                      <option value="30秒" selected>30秒</option>
                      <option value="45秒">45秒</option>
                      <option value="60秒">60秒</option>
            </select>
          </div>
          <div class="setting-item">
            <label>帳號定位</label>
                    <input type="text" id="positioningInput" placeholder="如:健康×加密,輕鬆幽默">
          </div>
        </div>
                <button id="applyBtn" class="apply-btn">套用設定</button>
          </div>
            </div>

          </div>
        </div>

        <!-- 右側面板：結果區塊（可切換） -->
        <div class="right-panel">
          <!-- 結果標籤切換 -->
          <div class="result-tabs">
            <button class="result-tab active" data-tab="positioning">🎯 帳號定位</button>
            <button class="result-tab" data-tab="topics">💡 腳本選題</button>
            <button class="result-tab" data-tab="script">📝 短影音腳本</button>
          </div>
          
          <!-- 結果區塊容器 -->
          <div class="results-container">
            <!-- 帳號定位結果 -->
            <div id="positioningResult" class="result-content" style="display: block;">
              <div class="result-header">
                <h3>帳號定位分析</h3>
                <button class="generate-btn" onclick="generatePositioning()">一鍵生成帳號定位</button>
              </div>
              <div id="positioningContent" class="result-body">
                點擊「一鍵生成帳號定位」按鈕開始分析...
              </div>
              <div class="result-actions" id="positioningActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('positioning')">儲存</button>
                <button class="regenerate-btn" onclick="regenerateResult('positioning')">再換一個</button>
              </div>
            </div>
            
            <!-- 腳本選題結果 -->
            <div id="topicSelectionResult" class="result-content" style="display: none;">
              <div class="result-header">
                <h3>腳本選題推薦</h3>
                <button class="generate-btn" onclick="generateTopics()">一鍵生成選題</button>
              </div>
              <div id="topicContent" class="result-body">
                請先完成帳號定位，再進行選題推薦...
              </div>
              <div class="result-actions" id="topicActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('topics')">儲存</button>
                <button class="regenerate-btn" onclick="regenerateResult('topics')">再換一個</button>
              </div>
            </div>
            
            <!-- 短影音腳本結果 -->
            <div id="scriptResult" class="result-content" style="display: none;">
              <div class="result-header">
                <h3>短影音腳本生成</h3>
                <button class="generate-btn" onclick="generateScript()">一鍵生成腳本</button>
              </div>
              <div id="scriptContent" class="result-body">
                請先完成帳號定位和選題，再生成腳本...
              </div>
              <div class="result-actions" id="scriptActions" style="display: none;">
                <button class="save-btn" onclick="saveScript()">儲存</button>
                <button class="regenerate-btn" onclick="regenerateResult('script')">再換一個</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 用戶抽屜 -->
      <div id="userDrawerOverlay" class="user-drawer-overlay" onclick="closeUserDrawer()"></div>
      <div id="userDrawer" class="user-drawer">
        <!-- 標題欄 -->
        <div class="user-drawer-header">
          <div class="user-drawer-title">
            <div class="app-logo">AIJob</div>
            <span class="app-name">短影音顧問</span>
          </div>
          <button class="user-drawer-close" onclick="closeUserDrawer()">×</button>
        </div>
        
        <!-- 左右兩欄布局 -->
        <div class="user-drawer-body">
          <!-- 左側選單 -->
          <div class="user-drawer-sidebar">
            <div class="user-profile">
              <img id="drawerAvatar" class="user-drawer-avatar" src="" alt="用戶頭像">
              <div class="user-drawer-info">
                <h3 id="drawerName">用戶名稱</h3>
                <p id="drawerEmail">user@example.com</p>
              </div>
            </div>
            
            <ul class="user-drawer-menu">
              <li><a href="#" class="active" data-section="personalInfo" onclick="switchDrawerContent('personalInfo')"><span class="icon">👤</span>個人資料</a></li>
              <li><a href="#" data-section="myScripts" onclick="switchDrawerContent('myScripts')"><span class="icon">💾</span>我的腳本</a></li>
              <li><a href="#" data-section="accountPositioning" onclick="switchDrawerContent('accountPositioning')"><span class="icon">🎯</span>帳號定位</a></li>
              <li><a href="#" data-section="topicHistory" onclick="switchDrawerContent('topicHistory')"><span class="icon">💡</span>選題記錄</a></li>
              <li><a href="#" data-section="settings" onclick="switchDrawerContent('settings')"><span class="icon">⚙️</span>設定</a></li>
              <li><a href="#" data-section="usageStats" onclick="switchDrawerContent('usageStats')"><span class="icon">📊</span>使用統計</a></li>
              <li><a href="#" data-section="helpCenter" onclick="switchDrawerContent('helpCenter')"><span class="icon">❓</span>幫助中心</a></li>
            </ul>
          </div>
          
          <!-- 右側內容區域 -->
          <div class="user-drawer-content">
            <!-- 個人資料 -->
            <div id="personalInfo" class="content-section active">
              <h2>個人資料</h2>
              <div class="user-info-detail">
                <div class="info-item">
                  <label>姓名：</label>
                  <span id="userNameDetail">-</span>
                </div>
                <div class="info-item">
                  <label>信箱：</label>
                  <span id="userEmailDetail">-</span>
                </div>
                <div class="info-item">
                  <label>用戶ID：</label>
                  <span id="userIdDetail">-</span>
                </div>
              </div>
            </div>
            
            <!-- 我的腳本 -->
            <div id="myScripts" class="content-section">
              <h2>我的腳本</h2>
              <div id="generationsList" class="generations-list">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 帳號定位 -->
            <div id="accountPositioning" class="content-section">
              <h2>帳號定位記錄</h2>
              <div id="positioningHistoryContent" class="positioning-history-content">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 選題記錄 -->
            <div id="topicHistory" class="content-section">
              <h2>選題記錄</h2>
              <div id="conversationsList" class="conversations-list">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 設定 -->
            <div id="settings" class="content-section">
              <h2>設定</h2>
              <div class="settings-content">
                <p>設定功能開發中...</p>
              </div>
            </div>
            
            <!-- 使用統計 -->
            <div id="usageStats" class="content-section">
              <h2>使用統計</h2>
              <div class="stats-content">
                <p>統計功能開發中...</p>
              </div>
            </div>
            
            <!-- 幫助中心 -->
            <div id="helpCenter" class="content-section">
              <h2>幫助中心</h2>
              <div class="help-content">
                <p>幫助功能開發中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 彈跳視窗登入覆蓋層 -->
      <div id="popupOverlay" class="popup-overlay">
        <div class="popup-content">
          <div id="popupSpinner" class="popup-spinner"></div>
          <div id="popupMessage" class="popup-message">正在開啟 Google 登入視窗...</div>
          <div id="popupButtons" style="display: none;">
            <button id="popupRetry" class="popup-btn">重試</button>
            <button id="popupCancel" class="popup-btn secondary">取消</button>
          </div>
        </div>
      </div>


      <div id="status" class="small"></div>
      
      <!-- 結果區塊 -->
      <div id="results" class="results-block">
        <h3>📝 短影音腳本結果</h3>
        <div class="result-item">
          <h4>🎯 主題</h4>
          <div id="result-title" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>📜 腳本內容</h4>
          <div id="result-script" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>🎬 畫面感</h4>
          <div id="result-visual" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>📱 文案</h4>
          <div id="result-copy" class="content">尚未生成</div>
        </div>
      </div>
      
      <div class="small">2025 AIJob學院版權所有</div>
    </div>

    <!-- 彈出提示框 -->
    <div id="toast" class="toast" style="display: none;"></div>
    <script>
      // 頁面控制函數
      function switchPage(pageId) {
        console.log('switchPage called with:', pageId);
        
        // 隱藏所有頁面
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // 顯示選中的頁面
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.add('active');
          console.log('Switched to page:', pageId);
        } else {
          console.error('Page not found:', pageId);
        }
        
        // 更新導航標籤狀態
        document.querySelectorAll('.navbar-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 根據頁面ID設置對應標籤為active
        const tabMap = {
          'homepage': 0,
          'mode1': 1,
          'mode2': 2,
          'mode3': 3,
          'userDB': 4
        };
        
        if (tabMap[pageId] !== undefined) {
          document.querySelectorAll('.navbar-tab')[tabMap[pageId]].classList.add('active');
        }
      }
      
      
      // AI說明區塊控制函數（舊版，保留以防需要）
      function toggleInstructions() {
        const instructionList = document.querySelector('.instruction-list');
        const toggleIcon = document.querySelector('.instructions-toggle');
        const chatMessages = document.getElementById('chatMessages');
        
        if (instructionList && toggleIcon) {
          instructionList.classList.toggle('show');
          
          if (instructionList.classList.contains('show')) {
            toggleIcon.textContent = '▼';
            // 顯示時恢復原始高度
            if (chatMessages) chatMessages.style.minHeight = '600px';
          } else {
            toggleIcon.textContent = '▶';
            // 隱藏時延長聊天訊息區高度
            if (chatMessages) chatMessages.style.minHeight = '800px';
          }
        }
      }
      
      // 抽屜式說明欄位控制函數
      function toggleInstructionsDrawer() {
        const drawer = document.getElementById('instructionsDrawer');
        const overlay = document.getElementById('drawerOverlay');
        
        if (drawer && overlay) {
          const isOpen = drawer.classList.contains('open');
          
          if (isOpen) {
            // 關閉抽屜
            drawer.classList.remove('open');
            overlay.classList.remove('show');
          } else {
            // 打開抽屜
            drawer.classList.add('open');
            overlay.classList.add('show');
          }
        }
      }
      
      // 側邊欄頁面顯示函數
      function showSidebarPage(pageType) {
        const overlay = document.getElementById('sidebarPageOverlay');
        const title = document.getElementById('sidebarPageTitle');
        const content = document.getElementById('sidebarPageContent');
        
        // 設置頁面標題
        const pageTitles = {
          'profile': '個人資料',
          'scripts': '我的腳本',
          'positioning': '帳號定位記錄',
          'topics': '選題記錄',
          'settings': '系統設定',
          'statistics': '使用統計',
          'help': '幫助中心'
        };
        
        title.textContent = pageTitles[pageType] || '功能頁面';
        
        // 根據頁面類型載入相應內容
        switch(pageType) {
          case 'profile':
            loadProfilePage(content);
            break;
          case 'scripts':
            loadScriptsPage(content);
            break;
          case 'positioning':
            loadPositioningPage(content);
            break;
          case 'topics':
            loadTopicsPage(content);
            break;
          case 'settings':
            loadSettingsPage(content);
            break;
          case 'statistics':
            loadStatisticsPage(content);
            break;
          case 'help':
            loadHelpPage(content);
            break;
          default:
            content.innerHTML = '<p>功能開發中...</p>';
        }
        
        // 顯示頁面
        overlay.style.display = 'flex';
        
        // 關閉側邊欄
        toggleSidebar();
      }
      
      // 關閉側邊欄頁面
      function closeSidebarPage() {
        document.getElementById('sidebarPageOverlay').style.display = 'none';
      }
      
      // 載入個人資料頁面
      function loadProfilePage(container) {
        container.innerHTML = `
          <div class="profile-content">
            <div class="profile-section">
              <h3>用戶資訊</h3>
              <div class="user-details">
                <div class="detail-item">
                  <label>姓名：</label>
                  <span id="profileName">${currentUser?.name || '未設定'}</span>
                </div>
                <div class="detail-item">
                  <label>Email：</label>
                  <span id="profileEmail">${currentUser?.email || '未設定'}</span>
                </div>
                <div class="detail-item">
                  <label>註冊時間：</label>
                  <span id="profileDate">${currentUser?.created_at || '未知'}</span>
                </div>
              </div>
            </div>
            <div class="profile-section">
              <h3>使用統計</h3>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number">${getLocalScripts().length}</div>
                  <div class="stat-label">已生成腳本</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${getLocalPositioning().length}</div>
                  <div class="stat-label">帳號定位</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${getLocalTopics().length}</div>
                  <div class="stat-label">選題記錄</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 載入我的腳本頁面
      function loadScriptsPage(container) {
        const scripts = getLocalScripts();
        if (scripts.length === 0) {
          container.innerHTML = '<p>尚未生成任何腳本</p>';
          return;
        }
        
        let html = '<div class="scripts-list">';
        scripts.forEach(script => {
          const date = new Date(script.created_at).toLocaleDateString('zh-TW');
          html += `
            <div class="script-item">
              <div class="script-header">
                <h4>${script.name || '未命名腳本'}</h4>
                <span class="script-date">${date}</span>
              </div>
              <div class="script-preview">${script.content ? script.content.substring(0, 100) + '...' : '無內容'}</div>
              <div class="script-actions">
                <button onclick="viewScript(${script.id})" class="btn-primary">查看</button>
                <button onclick="deleteScript(${script.id})" class="btn-danger">刪除</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      }
      
      // 載入帳號定位頁面
      function loadPositioningPage(container) {
        container.innerHTML = '<p>帳號定位記錄功能開發中...</p>';
      }
      
      // 載入選題記錄頁面
      function loadTopicsPage(container) {
        container.innerHTML = '<p>選題記錄功能開發中...</p>';
      }
      
      // 載入設定頁面
      function loadSettingsPage(container) {
        container.innerHTML = '<p>系統設定功能開發中...</p>';
      }
      
      // 載入統計頁面
      function loadStatisticsPage(container) {
        container.innerHTML = '<p>使用統計功能開發中...</p>';
      }
      
      // 載入幫助頁面
      function loadHelpPage(container) {
        container.innerHTML = `
          <div class="help-content">
            <h3>使用指南</h3>
            <div class="help-section">
              <h4>一鍵生成模式</h4>
              <p>1. 在左側設定您的需求（平台、主題、秒數、帳號定位）</p>
              <p>2. 點擊「套用設定」</p>
              <p>3. 在右側依序點擊生成按鈕</p>
              <p>4. 儲存或重新生成</p>
            </div>
            <div class="help-section">
              <h4>AI顧問對話模式</h4>
              <p>1. 直接與AI進行對話</p>
              <p>2. 討論內容策略和創意</p>
              <p>3. AI協助生成腳本</p>
            </div>
            <div class="help-section">
              <h4>常見問題</h4>
              <p><strong>Q: 如何儲存腳本？</strong></p>
              <p>A: 生成完成後點擊「儲存」按鈕即可</p>
              <p><strong>Q: 如何查看已儲存的腳本？</strong></p>
              <p>A: 點擊右側功能按鈕，選擇「我的腳本」</p>
            </div>
          </div>
        `;
      }
      
      // 初始化頁面
      document.addEventListener('DOMContentLoaded', function() {
        // 檢查是否已經登入
        checkLoginStatus();
        
        // 移動原有內容到新容器
        moveExistingContent();
        
        // 初始化手機版一鍵生成標籤切換
        initializeMode1MobileTabs();
        
        // 調試AI顧問模式元素
        setTimeout(debugAIConsultantElements, 2000);
      });
      
      // 初始化手機版一鍵生成標籤切換功能
      function initializeMode1MobileTabs() {
        const tabs = document.querySelectorAll('.mode1-mobile-tab');
        const panels = document.querySelectorAll('.mode1-mobile-panel');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const targetTab = tab.getAttribute('data-tab');
            
            // 移除所有active類
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('show'));
            
            // 添加active類到點擊的標籤
            tab.classList.add('active');
            
            // 顯示對應的面板
            const targetPanel = document.getElementById(`mode1-mobile-${targetTab}`);
            if (targetPanel) {
              targetPanel.classList.add('show');
            }
          });
        });
      }
      
      // 檢查登入狀態
      function checkLoginStatus() {
        const accessToken = localStorage.getItem('accessToken');
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        
        if (accessToken && currentUser) {
          // 已經登入，顯示主應用程式
          showMainApp();
        } else {
          // 未登入，顯示登入頁面
          showLoginPage();
        }
      }
      
      // 顯示登入頁面
      function showLoginPage() {
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
      }
      
      // 顯示主應用程式
      function showMainApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        
        // 設置默認頁面為首頁
        switchPage('homepage');
        
        // 更新用戶頭像和資訊
        if (currentUser) {
          updateUserInfo();
        }
      }
      
      // 跳過登入
      function skipLogin() {
        showMainApp();
      }
      
      // 設置語言
      function setLanguage(lang) {
        // 更新語言按鈕狀態
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // 這裡可以添加語言切換邏輯
        console.log('Language set to:', lang);
      }
      
      // 調試函數：檢查AI顧問模式元素狀態
      function debugAIConsultantElements() {
        console.log('=== 調試AI顧問模式元素 ===');
        
        const quickButtons = document.querySelector('.quick-buttons');
        const inputRow = document.querySelector('.input-row');
        const chatContainer = document.querySelector('#chatContainer');
        
        console.log('快速按鈕元素:', quickButtons);
        console.log('輸入區域元素:', inputRow);
        console.log('聊天容器元素:', chatContainer);
        
        if (quickButtons) {
          console.log('快速按鈕樣式:', {
            display: getComputedStyle(quickButtons).display,
            visibility: getComputedStyle(quickButtons).visibility,
            opacity: getComputedStyle(quickButtons).opacity,
            height: getComputedStyle(quickButtons).height,
            position: getComputedStyle(quickButtons).position,
            zIndex: getComputedStyle(quickButtons).zIndex
          });
        }
        
        if (inputRow) {
          console.log('輸入區域樣式:', {
            display: getComputedStyle(inputRow).display,
            visibility: getComputedStyle(inputRow).visibility,
            opacity: getComputedStyle(inputRow).opacity,
            height: getComputedStyle(inputRow).height,
            position: getComputedStyle(inputRow).position,
            zIndex: getComputedStyle(inputRow).zIndex
          });
        }
        
        if (chatContainer) {
          console.log('聊天容器樣式:', {
            display: getComputedStyle(chatContainer).display,
            height: getComputedStyle(chatContainer).height,
            overflow: getComputedStyle(chatContainer).overflow,
            flexDirection: getComputedStyle(chatContainer).flexDirection
          });
        }
      }
      
      // 移動現有內容到新容器
      function moveExistingContent() {
        // 移動用戶需求設定內容
        const settingsBlock = document.querySelector('.settings-block');
        if (settingsBlock) {
          const container = document.getElementById('userSettingsContainer');
          if (container) {
            container.appendChild(settingsBlock);
            
            // 設置使用說明顯示控制
            setupInstructionsToggle();
          }
          
          // 複製到手機版容器
          const mobileSettingsContainer = document.querySelector('#mode1-mobile-setup #userSettingsContainer');
          if (mobileSettingsContainer) {
            const mobileSettingsBlock = settingsBlock.cloneNode(true);
            mobileSettingsContainer.appendChild(mobileSettingsBlock);
          }
        }
        
        // 移動一鍵生成內容
        const resultTabs = document.querySelector('.result-tabs');
        const resultsContainer = document.querySelector('.results-container');
        if (resultTabs && resultsContainer) {
          const container = document.getElementById('oneClickGenerationContainer');
          if (container) {
            container.appendChild(resultTabs);
            container.appendChild(resultsContainer);
          }
          
          // 複製到手機版容器
          const mobileContainer = document.getElementById('oneClickGenerationContainerMobile');
          if (mobileContainer) {
            const mobileResultTabs = resultTabs.cloneNode(true);
            const mobileResultsContainer = resultsContainer.cloneNode(true);
            
            // 修正手機版按鈕的onclick事件
            const mobileButtons = mobileResultsContainer.querySelectorAll('.generate-btn');
            mobileButtons.forEach(btn => {
              const text = btn.textContent.trim();
              if (text.includes('帳號定位')) {
                btn.setAttribute('onclick', 'generatePositioning()');
              } else if (text.includes('選題')) {
                btn.setAttribute('onclick', 'generateTopics()');
              } else if (text.includes('腳本')) {
                btn.setAttribute('onclick', 'generateScript()');
              }
            });
            
            mobileContainer.appendChild(mobileResultTabs);
            mobileContainer.appendChild(mobileResultsContainer);
          }
        }
        
        // 聊天內容已經在正確位置，不需要移動
        // 只需要確保快速按鈕功能正常
        setupQuickButtons();
      }
      
      // 設置使用說明顯示控制
      function setupInstructionsToggle() {
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');
        const instructions = document.getElementById('oneClickInstructions');
        
        if (settingsToggle && settingsContent && instructions) {
          // 監聽設定區塊的展開/收合
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const isExpanded = settingsContent.style.display !== 'none';
                instructions.style.display = isExpanded ? 'block' : 'none';
              }
            });
          });
          
          observer.observe(settingsContent, { attributes: true });
          
          // 初始狀態檢查
          const isExpanded = settingsContent.style.display !== 'none';
          instructions.style.display = isExpanded ? 'block' : 'none';
        }
      }
      
      // 設置快速按鈕功能
      function setupQuickButtons() {
        // 快速按鈕功能
        document.querySelectorAll('.quick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            if (text) {
              const messageInput = document.getElementById('messageInput');
              if (messageInput) {
                messageInput.value = text;
                messageInput.focus();
                
                // 添加視覺反饋
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                  btn.style.transform = 'scale(1)';
                }, 150);
              }
            }
          });
        });
      }

      // 新的元素引用
      const chatEl = document.getElementById('chatMessages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const applyBtn = document.getElementById('applyBtn');
      const platformSelect = document.getElementById('platformSelect');
      const topicInput = document.getElementById('topicInput');
      const durationInput = document.getElementById('durationInput');
      const positioningInput = document.getElementById('positioningInput');
      
      // 結果區塊元素
      const resultsEl = document.getElementById('results');
      const resultTitleEl = document.getElementById('result-title');
      const resultScriptEl = document.getElementById('result-script');
      const resultVisualEl = document.getElementById('result-visual');
      const resultCopyEl = document.getElementById('result-copy');
      const scriptResult = document.getElementById('scriptResult');
      const positioningResult = document.getElementById('positioningResult');
      const topicSelectionResult = document.getElementById('topicSelectionResult');
      
      // 控制按鈕（已移除，功能整合到快速按鈕中）
      
      // 用戶抽屜元素
      const userDrawer = document.getElementById('userDrawer');
      const userDrawerOverlay = document.getElementById('userDrawerOverlay');
      const drawerAvatar = document.getElementById('drawerAvatar');
      const drawerName = document.getElementById('drawerName');
      const drawerEmail = document.getElementById('drawerEmail');
      
      // 認證相關元素
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // 彈跳視窗元素
      const popupOverlay = document.getElementById('popupOverlay');
      const popupSpinner = document.getElementById('popupSpinner');
      const popupMessage = document.getElementById('popupMessage');
      const popupButtons = document.getElementById('popupButtons');
      const popupRetry = document.getElementById('popupRetry');
      const popupCancel = document.getElementById('popupCancel');
      
      // 提示框
      const toastEl = document.getElementById('toast');
      
      // 設定區塊元素
      const settingsToggleEl = document.getElementById('settingsToggle');
      const settingsContentEl = document.getElementById('settingsContent');
      
      // 全局變數
      let accessToken = null;
      let currentUser = null;
      let currentPlatform = null;
      let currentTopic = null;
      let currentProfile = null;
      const styleInstruction = '格式要求：分段清楚，短句，每段換行，適度加入表情符號（如：✅✨🔥📌），避免口頭禪。絕對不要使用 ** 或任何 Markdown 格式符號，所有內容必須是純文字格式。';
      
      // 生成隨機用戶ID
      function generateUserId() {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substring(2, 8);
        return `user_${timestamp}_${randomStr}`;
      }
      
      // 用戶抽屜功能
      function toggleUserDrawer() {
        userDrawer.classList.toggle('open');
        userDrawerOverlay.classList.toggle('open');
        
        // 如果抽屜打開，載入用戶歷史資訊
        if (userDrawer.classList.contains('open') && currentUser) {
          loadUserHistory();
        }
      }
      
      function closeUserDrawer() {
        userDrawer.classList.remove('open');
        userDrawerOverlay.classList.remove('open');
      }
      
      // 更新用戶抽屜資訊
      function updateUserDrawer(user) {
        if (user) {
          // 確保用戶有ID
          if (!user.user_id) {
            user.user_id = generateUserId();
            currentUser = user; // 更新當前用戶
            localStorage.setItem('currentUser', JSON.stringify(user));
            console.log('在updateUserDrawer中為用戶生成新ID:', user.user_id);
          }
          
          // 更新抽屜內的資訊
          drawerAvatar.src = user.picture || 'https://via.placeholder.com/50';
          drawerName.textContent = user.name || '用戶';
          drawerEmail.textContent = user.email || '';
          
          // 更新頂部 header 中的用戶資訊
          userAvatar.src = user.picture || 'https://via.placeholder.com/32';
          userName.textContent = user.name || '用戶';
          
          // 更新個人資料顯示
          updatePersonalInfo();
          
          // 載入用戶的過往資訊
          loadUserHistory();
        }
      }

      // 載入用戶歷史資訊
      async function loadUserHistory() {
        // 確保用戶有ID
        if (!currentUser?.user_id) {
          console.log('沒有用戶ID，嘗試生成...');
          if (currentUser) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('為用戶生成新ID:', currentUser.user_id);
          } else {
            console.log('沒有當前用戶，跳過載入歷史');
            return;
          }
        }
        
        console.log('開始載入用戶歷史，用戶ID:', currentUser.user_id);
        
        try {
          // 載入對話記錄
          console.log('正在載入對話記錄...');
          const conversationsResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/conversations/${currentUser.user_id}`);
          console.log('對話記錄響應狀態:', conversationsResponse.status);
          if (conversationsResponse.ok) {
            const conversationsData = await conversationsResponse.json();
            console.log('對話記錄數據:', conversationsData);
            updateConversationsDisplay(conversationsData.conversations);
          } else {
            console.error('載入對話記錄失敗:', conversationsResponse.status, conversationsResponse.statusText);
          }
          
          // 載入生成記錄
          console.log('正在載入生成記錄...');
          const generationsResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/generations/${currentUser.user_id}`);
          console.log('生成記錄響應狀態:', generationsResponse.status);
          if (generationsResponse.ok) {
            const generationsData = await generationsResponse.json();
            console.log('生成記錄數據:', generationsData);
            updateGenerationsDisplay(generationsData.generations);
          } else {
            console.error('載入生成記錄失敗:', generationsResponse.status, generationsResponse.statusText);
          }
          
          // 載入帳號定位記錄
          console.log('正在載入帳號定位記錄...');
          await loadPositioningRecords();
          
          // 載入用戶記憶
          console.log('正在載入用戶記憶...');
          const memoryResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/memory/${currentUser.user_id}`);
          console.log('用戶記憶響應狀態:', memoryResponse.status);
          if (memoryResponse.ok) {
            const memoryData = await memoryResponse.json();
            console.log('用戶記憶數據:', memoryData);
            updateMemoryDisplay(memoryData.memory);
          } else {
            console.error('載入用戶記憶失敗:', memoryResponse.status, memoryResponse.statusText);
          }
          
        } catch (error) {
          console.error('載入用戶歷史資訊時出錯:', error);
        }
      }

      // 更新對話記錄顯示
      function updateConversationsDisplay(conversations) {
        const conversationsList = document.getElementById('conversationsList');
        if (!conversationsList) return;
        
        conversationsList.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div');
          item.className = 'conversation-item';
          item.innerHTML = `
            <div class="conversation-summary">${conv.summary}</div>
            <div class="conversation-date">${new Date(conv.created_at).toLocaleDateString()}</div>
          `;
          conversationsList.appendChild(item);
        });
      }

      // 更新生成記錄顯示
      function updateGenerationsDisplay(generations) {
        const generationsList = document.getElementById('generationsList');
        if (!generationsList) return;
        
        generationsList.innerHTML = '';
        generations.forEach(gen => {
          const item = document.createElement('div');
          item.className = 'generation-item';
          item.innerHTML = `
            <div class="generation-header">
              <span class="generation-platform">${gen.platform}</span>
              <span class="generation-topic">${gen.topic}</span>
            </div>
            <div class="generation-content">${gen.content}</div>
            <div class="generation-date">${new Date(gen.created_at).toLocaleDateString()}</div>
          `;
          generationsList.appendChild(item);
        });
      }

      // 更新記憶顯示
      function updateMemoryDisplay(memory) {
        const memoryContent = document.getElementById('memoryContent');
        if (!memoryContent) return;
        
        memoryContent.innerHTML = memory || '暫無記憶資訊';
      }
      
      // 載入帳號定位記錄
      async function loadPositioningRecords() {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            updatePositioningDisplay(data.records || []);
          }
        } catch (error) {
          console.error('載入帳號定位記錄失敗:', error);
        }
      }
      
      // 更新帳號定位顯示
      function updatePositioningDisplay(records) {
        const positioningContent = document.getElementById('positioningHistoryContent');
        if (!positioningContent) return;
        
        if (records.length === 0) {
          positioningContent.innerHTML = '<p style="color: #666;">尚無帳號定位記錄</p>';
          return;
        }
        
        let html = '<div class="positioning-records">';
        records.forEach(record => {
          const date = new Date(record.created_at).toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const preview = record.content.substring(0, 50) + (record.content.length > 50 ? '...' : '');
          
          html += `
            <div class="positioning-record-item">
              <div class="record-header">
                <span class="record-number">編號 ${record.record_number}</span>
                <span class="record-date">${date}</span>
              </div>
              <div class="record-preview">${preview}</div>
              <div class="record-actions">
                <button class="view-btn" onclick="viewPositioningDetail(${record.id}, '${record.record_number}')">查看完整結果</button>
                <button class="delete-btn" onclick="deletePositioningRecord(${record.id})">刪除</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        positioningContent.innerHTML = html;
      }
      
      // 查看帳號定位詳細內容
      async function viewPositioningDetail(recordId, recordNumber) {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const record = data.records.find(r => r.id === recordId);
            
            if (record) {
              // 顯示詳細內容在彈出視窗
              showDetailModal(recordNumber, record.created_at, record.content);
            }
          }
        } catch (error) {
          console.error('載入詳細內容失敗:', error);
          showToast('載入失敗', 3000);
        }
      }
      
      // 顯示詳細內容彈出視窗
      function showDetailModal(recordNumber, createdAt, content) {
        const date = new Date(createdAt).toLocaleString('zh-TW');
        const modal = document.createElement('div');
        modal.className = 'detail-modal-overlay';
        modal.innerHTML = `
          <div class="detail-modal">
            <div class="detail-modal-header">
              <h3>帳號定位詳細內容</h3>
              <button class="close-detail-btn" onclick="this.closest('.detail-modal-overlay').remove()">✕</button>
            </div>
            <div class="detail-modal-body">
              <div class="detail-info">
                <span><strong>編號：</strong>${recordNumber}</span>
                <span><strong>生成日期：</strong>${date}</span>
              </div>
              <div class="detail-content">
                ${content.replace(/\n/g, '<br>')}
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // 點擊背景關閉
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }
      
      // 刪除帳號定位記錄
      async function deletePositioningRecord(recordId) {
        if (!confirm('確定要刪除這筆記錄嗎？')) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${recordId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            showToast('記錄已刪除', 2000);
            await loadPositioningRecords();
          } else {
            throw new Error('刪除失敗');
          }
        } catch (error) {
          console.error('刪除錯誤:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }

      // 切換抽屜內容區域
      function switchDrawerContent(sectionId) {
        // 隱藏所有內容區域
        const allSections = document.querySelectorAll('.content-section');
        allSections.forEach(section => {
          section.classList.remove('active');
        });
        
        // 移除所有按鈕的 active 狀態
        const allMenuItems = document.querySelectorAll('.user-drawer-menu a');
        allMenuItems.forEach(item => {
          item.classList.remove('active');
        });
        
        // 顯示選中的內容區域
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // 添加對應按鈕的 active 狀態
        const targetMenuItem = document.querySelector(`[data-section="${sectionId}"]`);
        if (targetMenuItem) {
          targetMenuItem.classList.add('active');
        }
        
        // 根據不同的區域載入相應的數據
        switch(sectionId) {
          case 'myScripts':
            loadMyScripts();
            break;
          case 'accountPositioning':
            loadPositioningRecords();
            break;
          case 'topicHistory':
            loadTopicHistory();
            break;
        }
      }

      // 更新個人資料顯示
      function updatePersonalInfo() {
        if (currentUser) {
          // 確保用戶有ID，如果沒有則生成一個
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('在updatePersonalInfo中為用戶生成新ID:', currentUser.user_id);
          }
          
          const userNameDetail = document.getElementById('userNameDetail');
          const userEmailDetail = document.getElementById('userEmailDetail');
          const userIdDetail = document.getElementById('userIdDetail');
          
          if (userNameDetail) userNameDetail.textContent = currentUser.name || currentUser.displayName || '未設定';
          if (userEmailDetail) userEmailDetail.textContent = currentUser.email || '未設定';
          if (userIdDetail) userIdDetail.textContent = currentUser.user_id || '未生成';
          
          console.log('更新個人資料:', {
            name: currentUser.name,
            email: currentUser.email,
            user_id: currentUser.user_id
          });
        }
      }
      
      // 更新用戶資訊顯示
      function updateUserInfo() {
        if (currentUser) {
          // 更新頭像
          if (userAvatar) {
            userAvatar.src = currentUser.picture || 'https://via.placeholder.com/32';
          }
          // 更新用戶名
          if (userName) {
            userName.textContent = currentUser.name || currentUser.displayName || '用戶';
          }
          // 顯示用戶資訊區域
          if (userInfo) {
            userInfo.style.display = 'flex';
          }
          console.log('用戶資訊已更新:', currentUser);
        }
      }
      
      // 更新認證 UI
      function updateAuthUI(isLoggedIn) {
        if (isLoggedIn) {
          // 更新用戶資訊顯示
          updateUserInfo();
          loginBtn.style.display = 'none';
          updateUserDrawer(currentUser);
          // 顯示個人資料庫分頁
          const userDBTab = document.getElementById('userDBTab');
          if (userDBTab) {
            userDBTab.style.display = 'inline-block';
          }
          // 同時更新底部導航欄
          const bottomUserDBTab = document.getElementById('bottomUserDBTab');
          if (bottomUserDBTab) {
            bottomUserDBTab.style.display = 'flex';
          }
          // 更新個人資料庫用戶資訊
          updateDbUserInfo();
        } else {
          userInfo.style.display = 'none';
          loginBtn.style.display = 'block';
          closeUserDrawer();
          // 隱藏個人資料庫分頁
          const userDBTab = document.getElementById('userDBTab');
          if (userDBTab) {
            userDBTab.style.display = 'none';
          }
          // 同時隱藏底部導航欄
          const bottomUserDBTab = document.getElementById('bottomUserDBTab');
          if (bottomUserDBTab) {
            bottomUserDBTab.style.display = 'none';
          }
        }
      }
      
      // 登出功能
      function logout() {
        accessToken = null;
        currentUser = null;
        localStorage.removeItem('accessToken');
        localStorage.removeItem('currentUser');
        updateAuthUI(false);
        showToast('已登出', 3000);
        closeUserDrawer();
        
        // 回到登入頁面
        showLoginPage();
      }
      // 更新個人資料庫用戶資訊
      function updateDbUserInfo() {
        if (currentUser) {
          const dbUserAvatar = document.getElementById('dbUserAvatar');
          const dbUserName = document.getElementById('dbUserName');
          const dbUserEmail = document.getElementById('dbUserEmail');
          
          if (dbUserAvatar) dbUserAvatar.src = currentUser.picture || 'https://via.placeholder.com/48';
          if (dbUserName) dbUserName.textContent = currentUser.name || '用戶';
          if (dbUserEmail) dbUserEmail.textContent = currentUser.email || 'user@example.com';
        }
      }
      
      // 顯示個人資料庫分區
      function showDbSection(sectionName) {
        // 隱藏所有分區
        document.querySelectorAll('.db-section').forEach(section => {
          section.classList.remove('active');
        });
        
        // 移除所有選單項的active狀態
        document.querySelectorAll('.menu-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // 顯示選中的分區
        const targetSection = document.getElementById(`db-${sectionName}`);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // 添加對應選單項的active狀態
        const targetMenuItem = document.querySelector(`[onclick="showDbSection('${sectionName}')"]`);
        if (targetMenuItem) {
          targetMenuItem.classList.add('active');
        }
        
        // 根據分區載入相應數據
        switch(sectionName) {
          case 'personalInfo':
            loadPersonalInfoForUserDB();
            break;
          case 'myScripts':
            loadMyScriptsForUserDB();
            break;
          case 'accountPositioning':
            loadPositioningRecordsForUserDB();
            break;
          case 'topicRecords':
            loadTopicHistoryForUserDB();
            break;
        }
      }
      
      // 載入個人資料庫的個人資料
      function loadPersonalInfoForUserDB() {
        const content = document.querySelector('#db-personalInfo .section-content');
        if (currentUser) {
          content.innerHTML = `
            <div class="profile-details">
              <div class="detail-item">
                <label>姓名：</label>
                <span>${currentUser.name || '未設定'}</span>
              </div>
              <div class="detail-item">
                <label>Email：</label>
                <span>${currentUser.email || '未設定'}</span>
              </div>
              <div class="detail-item">
                <label>用戶ID：</label>
                <span>${currentUser.user_id || '未生成'}</span>
              </div>
              <div class="detail-item">
                <label>註冊時間：</label>
                <span>${currentUser.created_at || '未知'}</span>
              </div>
            </div>
          `;
        } else {
          content.innerHTML = '<p>請先登入以查看個人資料</p>';
        }
      }
      
      // 載入創作者資料庫的我的腳本
      async function loadMyScriptsForUserDB() {
        const content = document.querySelector('#db-myScripts .section-content');
        
        if (!accessToken || !currentUser || !currentUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看腳本記錄</div>';
          return;
        }
        
        content.innerHTML = '<div class="loading-text">正在載入腳本記錄...</div>';
        
        console.log('正在載入腳本列表...', {
          accessToken: accessToken ? 'present' : 'missing',
          userId: currentUser.user_id
        });
        
        // 先檢查本地儲存的腳本
        const localScripts = getLocalScripts();
        console.log('本地腳本數量:', localScripts.length);
        console.log('本地腳本內容:', localScripts);
        
        if (localScripts.length > 0) {
          console.log('載入本地腳本:', localScripts);
          displayScriptsForUserDB(localScripts);
          return;
        }
        
        // 如果沒有本地腳本，顯示提示
        content.innerHTML = '<div class="loading-text">還沒有儲存的腳本，請先使用一鍵生成功能創建腳本</div>';
        return; // 直接返回，不繼續執行API請求
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/scripts/my', {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          console.log('腳本列表響應狀態:', response.status);
          
          if (response.ok) {
            const data = await response.json();
            console.log('腳本列表數據:', data);
            displayScriptsForUserDB(data.scripts || []);
          } else if (response.status === 401) {
            console.log('腳本載入失敗: 認證錯誤');
            content.innerHTML = '<div class="loading-text">請先登入</div>';
          } else if (response.status === 404) {
            console.log('腳本載入失敗: API不存在');
            content.innerHTML = '<div class="loading-text">腳本功能即將上線，請稍後再試</div>';
          } else {
            const errorData = await response.json();
            console.log('腳本載入失敗:', errorData);
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load scripts error:', error);
          content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // ===== ChatGPT 風格功能函數 =====
      
      // 初始化 Markdown 渲染器
      function initMarkdownRenderer() {
        if (typeof marked !== 'undefined') {
          marked.setOptions({
            highlight: function(code, lang) {
              if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return code;
            },
            breaks: true,
            gfm: true
          });
        }
      }
      
      // Markdown 渲染函數
      function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
          return marked.parse(text);
        }
        return text.replace(/\n/g, '<br>');
      }
      
      // 創建 ChatGPT 風格的訊息元素
      function createChatGPTMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        if (role === 'user') {
          // 載入Google用戶頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = '👤';
          }
        } else {
          avatarDiv.textContent = '🤖';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (role === 'assistant') {
          contentDiv.innerHTML = renderMarkdown(content);
        } else {
          contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }
      
      // 創建載入動畫
      function createTypingIndicator() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = '🤖';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = `
          <div class="typing-indicator">
            <span>AI正在思考中</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }
      
      // 串流顯示文字
      function streamText(element, text, speed = 30) {
        return new Promise((resolve) => {
          let index = 0;
          element.innerHTML = '';
          
          const stream = () => {
            if (index < text.length) {
              element.innerHTML += text[index];
              index++;
              setTimeout(stream, speed);
            } else {
              // 添加閃爍游標
              const cursor = document.createElement('span');
              cursor.className = 'streaming-cursor';
              element.appendChild(cursor);
              resolve();
            }
          };
          
          stream();
        });
      }
      
      // 自動調整輸入框高度
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
      }
      
      // 發送訊息函數（ChatGPT 風格，兼容現有後端）
      async function sendMessageChatGPT(message) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        // 添加用戶訊息
        const userMessage = createChatGPTMessage('user', message);
        chatMessages.appendChild(userMessage);
        
        // 添加載入動畫
        const typingIndicator = createTypingIndicator();
        chatMessages.appendChild(typingIndicator);
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
          // 使用現有的後端API端點和參數
          const endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          // 安全地獲取設定值，避免未定義變數錯誤
          const safeSettingsApplied = typeof settingsApplied !== 'undefined' ? settingsApplied : false;
          const safeAppliedSettings = typeof appliedSettings !== 'undefined' ? appliedSettings : {};
          const safeStyleInstruction = typeof styleInstruction !== 'undefined' ? styleInstruction : null;
          
          const response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message: message,
              platform: safeSettingsApplied ? safeAppliedSettings.platform : null,
              topic: safeSettingsApplied ? safeAppliedSettings.topic : null,
              duration: safeSettingsApplied ? safeAppliedSettings.duration : null,
              style: safeStyleInstruction,
              profile: safeSettingsApplied ? safeAppliedSettings.positioning : null,
              history: [], // 保持現有的歷史記錄格式
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // 移除載入動畫
          chatMessages.removeChild(typingIndicator);
          
          // 創建AI回應容器
          const aiMessage = createChatGPTMessage('assistant', '');
          chatMessages.appendChild(aiMessage);
          
          const contentDiv = aiMessage.querySelector('.message-content');
          
          // 處理串流回應
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let fullContent = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop(); // 保留最後一行（可能不完整）
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') {
                  // 移除閃爍游標
                  const cursor = contentDiv.querySelector('.streaming-cursor');
                  if (cursor) cursor.remove();
                  
                  // 檢查是否需要顯示結果區塊
                  if (fullContent) {
                    checkIfScriptRequest(fullContent);
                  }
                  return;
                }
                
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.content) {
                    fullContent += parsed.content;
                    contentDiv.innerHTML = renderMarkdown(fullContent);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  }
                } catch (e) {
                  // 忽略解析錯誤
                }
              }
            }
          }
          
        } catch (error) {
          console.error('發送訊息錯誤:', error);
          
          // 移除載入動畫
          if (chatMessages.contains(typingIndicator)) {
            chatMessages.removeChild(typingIndicator);
          }
          
          // 顯示錯誤訊息
          const errorMessage = createChatGPTMessage('assistant', `抱歉，發生了錯誤：${error.message}`);
          chatMessages.appendChild(errorMessage);
        }
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // 強制清除快取並重新載入樣式
      function forceReloadStyles() {
        // 強制重新載入CSS
        const links = document.querySelectorAll('link[rel="stylesheet"]');
        links.forEach(link => {
          const href = link.href;
          link.href = href + '?v=' + Date.now();
        });
        
        // 強制重新載入內聯樣式
        const style = document.querySelector('style');
        if (style) {
          style.innerHTML = style.innerHTML;
        }
      }
      
      // ===== ChatGPT 風格 AI 顧問功能 =====
      
      // 初始化 Markdown 渲染器
      function initMarkdownRenderer() {
        if (typeof marked !== 'undefined') {
          marked.setOptions({
            renderer: new marked.Renderer(),
            gfm: true,
            breaks: true,
            sanitize: false,
            langPrefix: 'hljs language-',
            highlight: function(code, lang) {
              if (typeof hljs !== 'undefined' && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return code;
            }
          });
        }
      }

      // 渲染 Markdown 內容
      function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
          return marked.parse(text);
        }
        return text.replace(/\n/g, '<br>');
      }

      // 創建聊天訊息元素
      function createMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        if (role === 'user') {
          // 嘗試載入Google用戶頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = '👤';
          }
        } else {
          avatarDiv.textContent = '🤖';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (role === 'assistant' && content) {
          contentDiv.innerHTML = renderMarkdown(content);
          // 對代碼塊進行語法高亮
          if (typeof hljs !== 'undefined') {
            contentDiv.querySelectorAll('pre code').forEach((block) => {
              hljs.highlightElement(block);
            });
          }
        } else if (role === 'user') {
          contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }

      // 創建載入動畫
      function createTypingIndicator() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = '🤖';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = `
          <div class="typing-indicator">
            <span>AI正在思考中</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }

      // 自動調整輸入框高度
      function autoResizeTextarea() {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
          
          // 更新發送按鈕狀態
          const sendBtn = document.getElementById('sendBtn');
          if (sendBtn) {
            sendBtn.disabled = textarea.value.trim() === '';
          }
        }
      }

      // 發送訊息（整合原有後端和LLM設定）
      async function sendMessage(message) {
        if (!message || !message.trim()) return;
        
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const quickButtons = document.getElementById('quickButtons');
        
        // 添加用戶訊息
        const userMessage = createMessage('user', message);
        chatMessages.appendChild(userMessage);
        
        // 隱藏快速按鈕
        if (quickButtons) {
          quickButtons.style.display = 'none';
        }
        
        // 清空輸入框並禁用
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        autoResizeTextarea();
        
        // 添加載入動畫
        const typingIndicator = createTypingIndicator();
        chatMessages.appendChild(typingIndicator);
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
          // 使用原有的後端API和LLM設定
          const endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          // 安全地獲取設定值
          const safeSettingsApplied = typeof settingsApplied !== 'undefined' ? settingsApplied : false;
          const safeAppliedSettings = typeof appliedSettings !== 'undefined' ? appliedSettings : {};
          const safeStyleInstruction = typeof styleInstruction !== 'undefined' ? styleInstruction : null;
          
          const response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message: message,
              platform: safeSettingsApplied ? safeAppliedSettings.platform : null,
              topic: safeSettingsApplied ? safeAppliedSettings.topic : null,
              duration: safeSettingsApplied ? safeAppliedSettings.duration : null,
              style: safeStyleInstruction,
              profile: safeSettingsApplied ? safeAppliedSettings.positioning : null,
              history: [], // 保持現有的歷史記錄格式
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // 移除載入動畫
          chatMessages.removeChild(typingIndicator);
          
          // 創建AI回應容器
          const aiMessage = createMessage('assistant', '');
          chatMessages.appendChild(aiMessage);
          
          const contentDiv = aiMessage.querySelector('.message-content');
          
          // 處理串流回應
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let fullContent = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') {
                  // 檢查是否需要顯示結果區塊
                  if (fullContent) {
                    checkIfScriptRequest(fullContent);
                  }
                  break;
                }
                
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.content) {
                    fullContent += parsed.content;
                    contentDiv.innerHTML = renderMarkdown(fullContent);
                    
                    // 對代碼塊進行語法高亮
                    if (typeof hljs !== 'undefined') {
                      contentDiv.querySelectorAll('pre code').forEach((block) => {
                        if (!block.classList.contains('hljs')) {
                          hljs.highlightElement(block);
                        }
                      });
                    }
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  }
                } catch (e) {
                  // 忽略解析錯誤
                }
              }
            }
          }
          
        } catch (error) {
          console.error('發送訊息錯誤:', error);
          
          // 移除載入動畫
          if (chatMessages.contains(typingIndicator)) {
            chatMessages.removeChild(typingIndicator);
          }
          
          // 顯示錯誤訊息
          const errorMessage = createMessage('assistant', `抱歉，發生了錯誤：${error.message}`);
          chatMessages.appendChild(errorMessage);
        }
        
        // 恢復輸入框和按鈕
        messageInput.disabled = false;
        sendBtn.disabled = false;
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 初始化 ChatGPT 風格功能
      function initChatGPTFeatures() {
        try {
          // 只在AI顧問模式頁面才初始化
          const currentPage = document.querySelector('.page.active');
          if (!currentPage || currentPage.id !== 'mode2') {
            return;
          }
          
          
          // 強制清除快取
          forceReloadStyles();
          
          // 初始化 Markdown 渲染器
          initMarkdownRenderer();
        
          // 設置輸入框事件監聽器
          const messageInput = document.getElementById('messageInput');
          const sendBtn = document.getElementById('sendBtn');
          
          if (messageInput) {
            // 自動調整高度
            messageInput.addEventListener('input', autoResizeTextarea);
            
            // 鍵盤事件：Enter換行，Ctrl+Enter發送
            messageInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (message) {
                  sendMessage(message);
                }
              }
            });
          }
          
          // 設置發送按鈕事件
          if (sendBtn) {
            sendBtn.addEventListener('click', () => {
              const message = messageInput.value.trim();
              if (message) {
                sendMessage(message);
              }
            });
          }
          
          // 設置快速按鈕事件
          const quickButtons = document.getElementById('quickButtons');
          if (quickButtons) {
            const quickBtns = quickButtons.querySelectorAll('.quick-btn');
            quickBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-text');
                if (text) {
                  sendMessage(text);
                }
              });
            });
          }
        } catch (error) {
          console.error('ChatGPT功能初始化錯誤:', error);
        }
      }
      
      // 顯示腳本列表（創作者資料庫版本）
      function displayScriptsForUserDB(scripts) {
        const container = document.querySelector('#db-myScripts .section-content');
        
        if (scripts.length === 0) {
          container.innerHTML = '<div class="loading-text">還沒有儲存的腳本</div>';
          return;
        }
        
        container.innerHTML = scripts.map((script, index) => `
          <div class="script-item" data-script-id="${script.id}">
            <div class="script-header" onclick="toggleScriptForUserDB(${script.id})">
              <div class="script-info">
                <span class="script-number">編號${String(index + 1).padStart(2, '0')}</span>
                <span class="script-name" onclick="editScriptNameForUserDB(${script.id}, event)">${script.name || script.title || '未命名腳本'}</span>
                <span class="script-date">${formatTaiwanTime(script.created_at)}</span>
              </div>
              <div class="script-toggle">
                <span class="toggle-icon">▼</span>
              </div>
            </div>
            <div class="script-content" id="script-${script.id}" style="display: none;">
              <div class="script-details">
                <div class="script-table">
                  <table>
                    <thead>
                      <tr>
                        <th>時間</th>
                        <th>段落</th>
                        <th>鏡頭/畫面</th>
                        <th>台詞 (演員口白)</th>
                        <th>字幕文字 (可動畫)</th>
                        <th>音效與轉場</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${generateScriptTable(script.script_data || script.content || script)}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="script-actions" id="actions-${script.id}" style="display: none;">
              <button class="action-btn view-btn" onclick="viewFullScriptForUserDB(${script.id})">查看完整結果</button>
              <button class="action-btn download-pdf-btn" onclick="downloadScriptPDF(${script.id})">下載PDF檔案</button>
              <button class="action-btn download-csv-btn" onclick="downloadScriptCSV(${script.id})">下載CSV檔案</button>
              <button class="action-btn delete-btn" onclick="deleteScriptForUserDB(${script.id})">刪除</button>
            </div>
          </div>
        `).join('');
      }
      
      // 切換腳本顯示（創作者資料庫版本）
      function toggleScriptForUserDB(scriptId) {
        const scriptContent = document.getElementById(`script-${scriptId}`);
        const scriptActions = document.getElementById(`actions-${scriptId}`);
        const toggleIcon = document.querySelector(`[data-script-id="${scriptId}"] .toggle-icon`);
        
        if (scriptContent.style.display === 'none') {
          scriptContent.style.display = 'block';
          scriptActions.style.display = 'flex';
          toggleIcon.textContent = '▲';
        } else {
          scriptContent.style.display = 'none';
          scriptActions.style.display = 'none';
          toggleIcon.textContent = '▼';
        }
      }
      
      // 編輯腳本名稱（創作者資料庫版本）
      function editScriptNameForUserDB(scriptId, event) {
        event.stopPropagation();
        const scriptNameElement = document.querySelector(`[data-script-id="${scriptId}"] .script-name`);
        const currentName = scriptNameElement.textContent;
        
        const newName = prompt('請輸入新的腳本名稱:', currentName);
        if (newName && newName.trim() !== '' && newName !== currentName) {
          updateScriptNameForUserDB(scriptId, newName.trim());
        }
      }
      
      // 更新腳本名稱（創作者資料庫版本）
      async function updateScriptNameForUserDB(scriptId, newName) {
        try {
          // 先更新本地顯示
          const scriptNameElement = document.querySelector(`[data-script-id="${scriptId}"] .script-name`);
          scriptNameElement.textContent = newName;
          
          // 更新本地儲存
          const localScripts = getLocalScripts();
          const scriptIndex = localScripts.findIndex(script => script.id == scriptId);
          if (scriptIndex !== -1) {
            localScripts[scriptIndex].name = newName;
            localStorage.setItem('user_scripts', JSON.stringify(localScripts));
          }
          
          // 嘗試更新後端（如果API存在）
          try {
            const response = await fetch(`https://aivideobackend.zeabur.app/api/scripts/${scriptId}/name`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ name: newName })
            });
            
            if (response.ok) {
              showToast('腳本名稱已更新', 3000);
            } else {
              console.log('後端更新失敗，但本地已更新');
              showToast('腳本名稱已更新（本地）', 3000);
            }
          } catch (apiError) {
            console.log('API不存在或網路錯誤，但本地已更新');
            showToast('腳本名稱已更新（本地）', 3000);
          }
          
        } catch (error) {
          console.error('Update script name error:', error);
          showToast('更新失敗，請稍後再試', 3000);
        }
      }
      
      // 查看完整腳本（創作者資料庫版本）
      function viewFullScriptForUserDB(scriptId) {
        // 這裡可以實現查看完整腳本的功能
        showToast('查看完整腳本功能開發中...', 3000);
      }
      
      // 刪除腳本（創作者資料庫版本）
      async function deleteScriptForUserDB(scriptId) {
        if (!confirm('確定要刪除這個腳本嗎？此操作無法復原。')) {
          return;
        }
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/scripts/${scriptId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            // 從本地儲存中移除
            const localScripts = getLocalScripts();
            const updatedScripts = localScripts.filter(script => script.id != scriptId);
            localStorage.setItem('user_scripts', JSON.stringify(updatedScripts));
            
            // 重新載入腳本列表
            loadMyScriptsForUserDB();
            showToast('腳本已刪除', 3000);
          } else {
            throw new Error('刪除失敗');
          }
        } catch (error) {
          console.error('Delete script error:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }
      
      // 載入個人資料庫的帳號定位記錄
      async function loadPositioningRecordsForUserDB() {
        const content = document.querySelector('#db-accountPositioning .section-content');
        
        if (!accessToken || !currentUser || !currentUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看帳號定位記錄</div>';
          return;
        }
        
        content.innerHTML = '<div class="loading-text">正在載入帳號定位記錄...</div>';
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            displayPositioningRecordsForUserDB(data.records || []);
          } else if (response.status === 401) {
            content.innerHTML = '<div class="loading-text">請先登入</div>';
          } else if (response.status === 404) {
            content.innerHTML = '<div class="loading-text">帳號定位功能即將上線，請稍後再試</div>';
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load positioning records error:', error);
          content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 顯示帳號定位記錄（創作者資料庫版本）
      function displayPositioningRecordsForUserDB(records) {
        const container = document.querySelector('#db-accountPositioning .section-content');
        
        if (records.length === 0) {
          container.innerHTML = '<div class="loading-text">尚無帳號定位記錄</div>';
          return;
        }
        
        container.innerHTML = records.map(record => {
          const date = new Date(record.created_at).toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const preview = record.content.substring(0, 100) + (record.content.length > 100 ? '...' : '');
          
          return `
            <div class="positioning-record-item" data-record-id="${record.id}">
              <div class="record-header">
                <span class="record-number">編號 ${record.record_number}</span>
                <span class="record-date">${date}</span>
              </div>
              <div class="record-preview">${preview}</div>
              <div class="record-actions">
                <button class="action-btn view-btn" onclick="viewPositioningDetailForUserDB(${record.id}, '${record.record_number}')">查看完整結果</button>
                <button class="action-btn delete-btn" onclick="deletePositioningRecordForUserDB(${record.id})">刪除</button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // 查看帳號定位詳細內容（創作者資料庫版本）
      async function viewPositioningDetailForUserDB(recordId, recordNumber) {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const record = data.records.find(r => r.id === recordId);
            
            if (record) {
              // 創建彈出視窗顯示完整內容
              const modal = document.createElement('div');
              modal.className = 'modal-overlay';
              modal.innerHTML = `
                <div class="modal-content">
                  <div class="modal-header">
                    <h3>帳號定位詳細內容 - 編號 ${recordNumber}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                  </div>
                  <div class="modal-body">
                    <div class="record-detail">
                      <div class="detail-meta">
                        <span class="detail-label">建立時間：</span>
                        <span class="detail-value">${new Date(record.created_at).toLocaleString('zh-TW', {
                          timeZone: 'Asia/Taipei',
                          year: 'numeric',
                          month: '2-digit',
                          day: '2-digit',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}</span>
                      </div>
                      <div class="detail-content">
                        <div class="content-text">${record.content.replace(/\n/g, '<br>')}</div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="action-btn" onclick="this.closest('.modal-overlay').remove()">關閉</button>
                  </div>
                </div>
              `;
              
              document.body.appendChild(modal);
            } else {
              showToast('找不到該記錄', 3000);
            }
          } else {
            throw new Error('載入失敗');
          }
        } catch (error) {
          console.error('View positioning detail error:', error);
          showToast('載入失敗，請稍後再試', 3000);
        }
      }
      
      // 刪除帳號定位記錄（創作者資料庫版本）
      async function deletePositioningRecordForUserDB(recordId) {
        if (!confirm('確定要刪除這筆帳號定位記錄嗎？')) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}/${recordId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            showToast('記錄已刪除', 2000);
            // 重新載入列表
            await loadPositioningRecordsForUserDB();
          } else {
            throw new Error('刪除失敗');
          }
        } catch (error) {
          console.error('Delete positioning record error:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }
      
      // 載入個人資料庫的選題記錄
      function loadTopicHistoryForUserDB() {
        const content = document.querySelector('#db-topicRecords .section-content');
        if (currentUser && currentUser.user_id) {
          content.innerHTML = '<p>正在載入選題記錄...</p>';
          // 這裡可以調用API載入用戶的選題記錄
          setTimeout(() => {
            content.innerHTML = '<p>選題記錄功能開發中...</p>';
          }, 1000);
        } else {
          content.innerHTML = '<p>請先登入以查看選題記錄</p>';
        }
      }
      
      // 結果區塊功能
      function updateResultBlock(blockId, content, hasContent = true) {
        const block = document.getElementById(blockId);
        if (block) {
          block.textContent = content;
          if (hasContent) {
            block.classList.add('has-content');
          } else {
            block.classList.remove('has-content');
          }
        }
      }
      
      // 標籤切換功能
      function switchTab(tabName) {
        // 移除所有標籤的 active 類別
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 隱藏所有結果內容
        document.querySelectorAll('.result-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // 激活選中的標籤
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
        }
        
        // 顯示對應的結果內容
        let contentId = '';
        if (tabName === 'positioning') {
          contentId = 'positioningResult';
        } else if (tabName === 'topics') {
          contentId = 'topicSelectionResult';
        } else if (tabName === 'script') {
          contentId = 'scriptResult';
        }
        
        const activeContent = document.getElementById(contentId);
        if (activeContent) {
          activeContent.style.display = 'block';
        }
      }
      
      // 添加聊天訊息（套用IP模式設計）
      function addMessage(content, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        
        // 添加頭像
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        
        if (isUser) {
          // 用戶頭像：使用 Gmail 頭像或默認頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatar.appendChild(img);
          } else {
            avatar.textContent = '👤';
          }
        } else {
          // AI 頭像：使用表情符號
          avatar.textContent = '🤖';
        }
        
        messageDiv.appendChild(avatar);
        
        // 添加訊息內容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // 如果是 AI 回覆，清理 Markdown 格式
        if (!isUser) {
          const cleanText = cleanMarkdownFormat(content);
          messageContent.innerHTML = cleanText;
        } else {
          messageContent.textContent = content;
        }
        
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // 發送聊天訊息
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // 添加用戶訊息
        addMessage(message, true);
        messageInput.value = '';
        
        // 顯示 AI 回覆中的載入狀態
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'message ai';
        thinkingDiv.id = 'thinking-message';
        
        // 添加 AI 頭像
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = '🤖';
        thinkingDiv.appendChild(avatar);
        
        // 添加載入動畫內容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'ai-loading';
        loadingDiv.innerHTML = `
          <span>AI正在思考中</span>
          <div class="ai-loading-dots">
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
          </div>
        `;
        messageContent.appendChild(loadingDiv);
        thinkingDiv.appendChild(messageContent);
        
        document.getElementById('chatMessages').appendChild(thinkingDiv);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: message,
              platform: platformSelect.value || null,
              topic: topicInput.value || null,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioningInput.value || null,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('發送失敗');
          }
          
          // 準備接收 AI 回應
          const reader = response.body.getReader();
          let aiResponse = '';
          let aiDiv = null;
          let bubble = null;
          
          let buffer = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += new TextDecoder().decode(value, { stream: true });
            
            // 處理完整的 JSON 行
            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              
              if (!frame.startsWith('data:')) continue;
              
              try {
                const jsonStr = frame.slice(5).trim();
                const data = JSON.parse(jsonStr);
                
                if (data.type === 'token' && data.content) {
                  // 如果是第一次收到 token，創建 AI 回應 div 並移除載入動畫
                  if (!aiDiv) {
                    const thinkingMsg = document.getElementById('thinking-message');
                    if (thinkingMsg) {
                      thinkingMsg.remove();
                    }
                    
                    // 創建 AI 回應 div
                    aiDiv = document.createElement('div');
                    aiDiv.className = 'msg assistant';
                    aiDiv.id = 'ai-response';
                    
                    // 添加 AI 頭像
                    const aiAvatar = document.createElement('div');
                    aiAvatar.className = 'msg-avatar';
                    aiAvatar.textContent = '🤖';
                    aiDiv.appendChild(aiAvatar);
                    
                    // 添加氣泡
                    bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    aiDiv.appendChild(bubble);
                    
                    document.getElementById('chatMessages').appendChild(aiDiv);
                  }
                  
                  aiResponse += data.content;
                  bubble.innerHTML = cleanMarkdownFormat(aiResponse);
                } else if (data.type === 'end') {
                  // 回應結束
                  // 新增：智能判斷 AI 回應類型並顯示到結果區塊
                  if (aiResponse && currentUser?.user_id) {
                    detectAndDisplayResult(message, aiResponse);
                  }
                  break;
                }
              } catch (e) {
                // 忽略解析錯誤
                continue;
              }
            }
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }
        } catch (error) {
          // 移除載入動畫，顯示錯誤訊息
          const thinkingMsg = document.getElementById('thinking-message');
          if (thinkingMsg) {
            thinkingMsg.remove();
          }
          
          addMessage('抱歉，發送失敗，請稍後再試', false);
        }
      }
      
      // 生成腳本功能
      async function generateScript() {
        // 動態查找輸入元素，優先使用手機版
        const platformEl = document.querySelector('#mode1-mobile-setup #platformSelect') || document.getElementById('platformSelect');
        const topicEl = document.querySelector('#mode1-mobile-setup #topicInput') || document.getElementById('topicInput');
        const positioningEl = document.querySelector('#mode1-mobile-setup #positioningInput') || document.getElementById('positioningInput');
        
        const platform = platformEl ? platformEl.value : '';
        const topic = topicEl ? topicEl.value : '';
        const positioning = positioningEl ? positioningEl.value : '';
        
        // 檢查是否已完成帳號定位和選題（只檢查是否為預設提示文字）
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const topicContent = document.getElementById('topicContent').textContent.trim();
        
        const isPositioningDefault = positioningContent.includes('點擊「一鍵生成帳號定位」') || 
                                     positioningContent.includes('開始分析');
        const isTopicDefault = topicContent.includes('完成帳號定位') || 
                              topicContent.includes('進行選題') ||
                              topicContent.includes('點擊「一鍵生成選題」');
        
        if (!positioningContent || isPositioningDefault) {
          showToast('請先完成帳號定位', 3000);
          return;
        }
        
        if (!topicContent || isTopicDefault) {
          showToast('請先完成選題推薦', 3000);
          return;
        }
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('scriptContent', '正在生成腳本...', false);
        
        // 立即顯示操作按鈕
        document.getElementById('scriptActions').style.display = 'flex';
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/script', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: '請幫我生成完整腳本',
              platform: platform,
              topic: topic,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('scriptContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 自動切換到腳本標籤
          switchTab('script');
          
        } catch (error) {
          updateResultBlock('scriptContent', '生成失敗，請稍後再試', false);
          showToast('生成腳本失敗', 3000);
        }
      }
      // 一鍵生成帳號定位
      async function generatePositioning() {
        // 動態查找輸入元素，優先使用手機版
        const platformEl = document.querySelector('#mode1-mobile-setup #platformSelect') || document.getElementById('platformSelect');
        const topicEl = document.querySelector('#mode1-mobile-setup #topicInput') || document.getElementById('topicInput');
        const positioningEl = document.querySelector('#mode1-mobile-setup #positioningInput') || document.getElementById('positioningInput');
        
        const platform = platformEl ? platformEl.value : '';
        const topic = topicEl ? topicEl.value : '';
        const positioning = positioningEl ? positioningEl.value : '';
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('positioningContent', '正在分析帳號定位...', false);
        
        // 立即顯示操作按鈕
        document.getElementById('positioningActions').style.display = 'flex';
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/positioning', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: '請幫我進行帳號定位分析',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('positioningContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 自動切換到帳號定位標籤
          switchTab('positioning');
          
        } catch (error) {
          updateResultBlock('positioningContent', '生成失敗，請稍後再試', false);
          showToast('生成帳號定位失敗', 3000);
        }
      }
      
      // 智能判斷 AI 回應類型並顯示到結果區塊
      function detectAndDisplayResult(userMessage, aiResponse) {
        // 判斷是否為明確的帳號定位總結
        const isPositioningSummary = aiResponse.includes('📌 你的帳號定位建議') ||
                                     aiResponse.includes('帳號定位建議：') ||
                                     aiResponse.includes('定位總結：') ||
                                     (aiResponse.includes('定位建議') && aiResponse.length > 200);
        
        // 判斷是否為明確的選題推薦結果
        const isTopicsSummary = aiResponse.includes('📌 選題推薦') ||
                               aiResponse.includes('選題建議：') ||
                               aiResponse.includes('推薦選題：') ||
                               (aiResponse.includes('選題') && 
                                (aiResponse.includes('1.') || aiResponse.includes('一、')) &&
                                aiResponse.length > 200);
        
        // 判斷是否為完整腳本（必須包含結構化內容）
        const isCompletScript = (aiResponse.includes('Hook') || aiResponse.includes('開場')) && 
                               (aiResponse.includes('Value') || aiResponse.includes('核心')) && 
                               (aiResponse.includes('CTA') || aiResponse.includes('行動呼籲')) &&
                               aiResponse.length > 300;
        
        // 根據判斷結果顯示到對應區塊（只顯示明確的總結/結果）
        if (isCompletScript) {
          // 完整腳本：顯示到腳本區塊
          updateResultBlock('scriptContent', aiResponse, true);
          document.getElementById('scriptActions').style.display = 'flex';
          switchTab('script');
        } else if (isTopicsSummary) {
          // 選題推薦：顯示到選題區塊
          updateResultBlock('topicContent', aiResponse, true);
          document.getElementById('topicActions').style.display = 'flex';
          switchTab('topics');
        } else if (isPositioningSummary) {
          // 帳號定位總結：顯示到定位區塊
          updateResultBlock('positioningContent', aiResponse, true);
          document.getElementById('positioningActions').style.display = 'flex';
          switchTab('positioning');
        }
        // 如果都不符合（一般討論、問答），就不顯示到結果區（保留在對話框中）
      }
      
      // 一鍵生成選題
      async function generateTopics() {
        // 動態查找輸入元素，優先使用手機版
        const platformEl = document.querySelector('#mode1-mobile-setup #platformSelect') || document.getElementById('platformSelect');
        const topicEl = document.querySelector('#mode1-mobile-setup #topicInput') || document.getElementById('topicInput');
        const positioningEl = document.querySelector('#mode1-mobile-setup #positioningInput') || document.getElementById('positioningInput');
        
        const platform = platformEl ? platformEl.value : '';
        const topic = topicEl ? topicEl.value : '';
        const positioning = positioningEl ? positioningEl.value : '';
        
        // 檢查是否已完成帳號定位（只檢查是否為預設提示文字）
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const isDefaultText = positioningContent.includes('點擊「一鍵生成帳號定位」') || 
                             positioningContent.includes('開始分析');
        
        if (!positioningContent || isDefaultText) {
          showToast('請先完成帳號定位', 3000);
          return;
        }
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('topicContent', '正在推薦選題...', false);
        
        // 立即顯示操作按鈕
        document.getElementById('topicActions').style.display = 'flex';
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/topics', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: '請幫我推薦選題',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('topicContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 自動切換到選題標籤
          switchTab('topics');
          
        } catch (error) {
          updateResultBlock('topicContent', '生成失敗，請稍後再試', false);
          showToast('生成選題失敗', 3000);
        }
      }
      
      // 儲存結果
      async function saveResult(type) {
        if (!currentUser || !currentUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        let content = '';
        let contentElement = null;
        
        switch(type) {
          case 'positioning':
            contentElement = document.getElementById('positioningContent');
            break;
          case 'topics':
            contentElement = document.getElementById('topicContent');
            break;
          case 'script':
            contentElement = document.getElementById('scriptContent');
            break;
        }
        
        if (contentElement) {
          content = contentElement.textContent;
          
          // 只有帳號定位需要保存到資料庫
          if (type === 'positioning') {
            try {
              const response = await fetch('https://aivideobackend.zeabur.app/api/user/positioning/save', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                  user_id: currentUser.user_id,
                  content: content
                })
              });
              
              if (response.ok) {
                const data = await response.json();
                showToast(`帳號定位已儲存（編號：${data.record_number}）`, 3000);
                // 重新載入帳號定位列表
                await loadPositioningRecords();
              } else {
                throw new Error('儲存失敗');
              }
            } catch (error) {
              console.error('儲存錯誤:', error);
              showToast('儲存失敗，請稍後再試', 3000);
            }
          } else {
            // 其他類型暫時儲存到 localStorage
            localStorage.setItem(`saved_${type}`, content);
            showToast(`${type === 'topics' ? '選題' : '腳本'}已儲存`, 2000);
          }
        }
      }
      
      // 腳本儲存功能
      async function saveScript() {
        if (!currentUser || !currentUser.user_id || !accessToken) {
          showToast('請先登入', 3000);
          return;
        }
        
        const content = document.getElementById('scriptContent').textContent;
        if (!content || content.includes('請先完成')) {
          showToast('沒有可儲存的內容', 3000);
          return;
        }
        
        console.log('開始儲存腳本...', {
          userId: currentUser.user_id,
          contentLength: content.length
        });
        
        try {
          // 提取腳本內容的結構化數據
          const scriptData = extractScriptData(content);
          console.log('提取的腳本數據:', scriptData);
          
          const response = await fetch('https://aivideobackend.zeabur.app/api/scripts/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              user_id: currentUser.user_id,
              content: content,
              script_data: scriptData,
              platform: currentPlatform || '未設定',
              topic: currentTopic || '未設定',
              profile: currentProfile || '未設定'
            })
          });
          
          console.log('腳本儲存響應狀態:', response.status);
          
          if (response.ok) {
            const result = await response.json();
            console.log('腳本儲存成功:', result);
            
            // 同時儲存到本地
            const localScriptData = {
              name: scriptData.title || '未命名腳本',
              title: scriptData.title || '',
              content: content,
              script_data: scriptData,
              platform: currentPlatform || '未設定',
              topic: currentTopic || '未設定',
              profile: currentProfile || '未設定'
            };
            saveScriptToLocal(localScriptData);
            
            showToast('腳本儲存成功！', 3000);
            // 延遲一下再載入腳本列表，確保後端處理完成
            setTimeout(() => {
              loadMyScripts();
              loadMyScriptsForUserDB(); // 同時載入資料庫頁面的腳本
            }, 1000);
          } else if (response.status === 401) {
            console.log('腳本儲存失敗: 認證錯誤');
            showToast('請先登入', 3000);
          } else if (response.status === 404) {
            console.log('腳本儲存失敗: API不存在，使用本地儲存');
            // 後端API不存在時，使用本地儲存
            const localScriptData = {
              name: scriptData.title || '未命名腳本',
              title: scriptData.title || '',
              content: content,
              script_data: scriptData,
              platform: currentPlatform || '未設定',
              topic: currentTopic || '未設定',
              profile: currentProfile || '未設定'
            };
            saveScriptToLocal(localScriptData);
            showToast('腳本已儲存到本地！', 3000);
            setTimeout(() => {
              loadMyScripts();
              loadMyScriptsForUserDB(); // 同時載入資料庫頁面的腳本
            }, 500);
          } else {
            const errorData = await response.json();
            console.log('腳本儲存失敗:', errorData);
            throw new Error(errorData.error || '儲存失敗');
          }
        } catch (error) {
          console.error('Save script error:', error);
          // 網路錯誤時，也使用本地儲存
          console.log('網路錯誤，使用本地儲存');
          const localScriptData = {
            name: scriptData.title || '未命名腳本',
            title: scriptData.title || '',
            content: content,
            script_data: scriptData,
            platform: currentPlatform || '未設定',
            topic: currentTopic || '未設定',
            profile: currentProfile || '未設定'
          };
          saveScriptToLocal(localScriptData);
          showToast('腳本已儲存到本地！', 3000);
          setTimeout(() => {
            loadMyScripts();
            loadMyScriptsForUserDB(); // 同時載入資料庫頁面的腳本
          }, 500);
        }
      }
      
      // 提取腳本數據 - 按照規範格式解析
      function extractScriptData(content) {
        console.log('開始解析腳本內容:', content);
        
        try {
          // 清理內容，移除HTML標籤
          const cleanContent = content.replace(/<[^>]*>/g, '').trim();
          console.log('清理後的內容:', cleanContent);
          
          // 按照規範解析腳本
          const scriptData = parseScriptToJSON(cleanContent);
          console.log('解析結果:', scriptData);
          return scriptData;
          
        } catch (error) {
          console.error('腳本解析失敗:', error);
          return {
            error: "PARSE_FAILED",
            message: "腳本格式解析失敗，請檢查內容格式"
          };
        }
      }
      
      // 按照規範將腳本解析為JSON格式
      function parseScriptToJSON(content) {
        const lines = content.split('\n').map(line => line.trim()).filter(line => line);
        
        // 1. 提取主題標題
        let title = '';
        for (let line of lines) {
          if (line.includes('主題') || line.includes('標題') || line.match(/^[1-9]\.?\s*[^0-9]/)) {
            title = line.replace(/^[1-9]\.?\s*/, '').replace(/[：:]\s*/, '').trim();
            break;
          }
        }
        
        // 如果沒找到主題，使用第一行
        if (!title && lines.length > 0) {
          title = lines[0].replace(/^[1-9]\.?\s*/, '').replace(/[：:]\s*/, '').trim();
        }
        
        // 2. 解析腳本分段
        const rows = [];
        let currentSegment = null;
        let valueCount = 0;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // 檢查時間模式
          const timeMatch = line.match(/(\d+)-(\d+)s?/i);
          if (timeMatch) {
            // 保存上一個段落
            if (currentSegment) {
              rows.push(currentSegment);
            }
            
            // 開始新段落
            const startSec = parseInt(timeMatch[1]);
            const endSec = parseInt(timeMatch[2]);
            
            // 確定段落類型
            let section = '';
            if (line.toLowerCase().includes('hook')) {
              section = 'Hook';
            } else if (line.toLowerCase().includes('value') || line.toLowerCase().includes('價值')) {
              valueCount++;
              section = `Value ${valueCount}`;
            } else if (line.toLowerCase().includes('cta') || line.toLowerCase().includes('行動呼籲')) {
              section = 'CTA';
            } else {
              // 根據時間推測段落類型
              if (startSec === 0) {
                section = 'Hook';
              } else if (valueCount < 3) {
                valueCount++;
                section = `Value ${valueCount}`;
              } else {
                section = 'CTA';
              }
            }
            
            currentSegment = {
              start_sec: startSec,
              end_sec: endSec,
              section: section,
              shot_desc: '',
              dialogue: '',
              subtitle: '',
              sfx: ''
            };
            
            continue;
          }
          
          // 解析段落內容
          if (currentSegment) {
            // 檢查是否為台詞
            if (line.includes('台詞') || line.includes('口白') || line.match(/^「.*」$/) || line.match(/^".*"$/)) {
              currentSegment.dialogue = line.replace(/^[台詞口白：:]\s*/, '').replace(/^["「]|["」]$/g, '').trim();
            }
            // 檢查是否為鏡頭描述
            else if (line.includes('鏡頭') || line.includes('畫面') || line.includes('CU') || line.includes('MS') || line.includes('LS')) {
              currentSegment.shot_desc = line.replace(/^[鏡頭畫面：:]\s*/, '').trim();
            }
            // 檢查是否為字幕
            else if (line.includes('字幕') || line.includes('大字卡')) {
              currentSegment.subtitle = line.replace(/^[字幕大字卡：:]\s*/, '').trim();
            }
            // 檢查是否為音效
            else if (line.includes('音效') || line.includes('轉場') || line.includes('音樂')) {
              currentSegment.sfx = line.replace(/^[音效轉場音樂：:]\s*/, '').trim();
            }
            // 如果沒有標籤，根據內容推測
            else if (line.length > 0) {
              // 如果台詞為空，可能是台詞
              if (!currentSegment.dialogue) {
                currentSegment.dialogue = line;
              }
              // 如果鏡頭描述為空，可能是鏡頭描述
              else if (!currentSegment.shot_desc) {
                currentSegment.shot_desc = line;
              }
            }
          }
        }
        
        // 保存最後一個段落
        if (currentSegment) {
          rows.push(currentSegment);
        }
        
        // 3. 排序並確保時間正確
        rows.sort((a, b) => a.start_sec - b.start_sec);
        
        // 4. 清理數據
        rows.forEach(row => {
          // 移除末尾空白和標點符號（保留表情符號）
          row.dialogue = cleanText(row.dialogue);
          row.shot_desc = cleanText(row.shot_desc);
          row.subtitle = cleanText(row.subtitle);
          row.sfx = cleanText(row.sfx);
          
          // 確保end_sec > start_sec
          if (row.end_sec <= row.start_sec) {
            row.end_sec = row.start_sec + 1;
          }
        });
        
        // 5. 構建最終JSON
        const result = {
          creator_id: currentUser ? currentUser.user_id : 'unknown',
          project_id: null,
          title: title,
          rows: rows
        };
        
        return result;
      }
      
      // 清理文本數據
      function cleanText(text) {
        if (!text) return '';
        
        // 移除末尾空白和標點符號（保留表情符號）
        return text.replace(/\s+$/, '').replace(/[。，、；：！？]$/, '');
      }
      
      // 載入我的腳本
      async function loadMyScripts() {
        if (!accessToken || !currentUser || !currentUser.user_id) {
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          return;
        }
        
        console.log('正在載入腳本列表...', {
          accessToken: accessToken ? 'present' : 'missing',
          userId: currentUser.user_id
        });
        
        // 先檢查本地儲存的腳本
        const localScripts = getLocalScripts();
        if (localScripts.length > 0) {
          console.log('載入本地腳本:', localScripts);
          displayScripts(localScripts);
          return;
        }
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/scripts/my', {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          console.log('腳本列表響應狀態:', response.status);
          
          if (response.ok) {
            const data = await response.json();
            console.log('腳本列表數據:', data);
            displayScripts(data.scripts || []);
          } else if (response.status === 401) {
            console.log('腳本載入失敗: 認證錯誤');
            document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          } else if (response.status === 404) {
            console.log('腳本載入失敗: API不存在');
            document.getElementById('generationsList').innerHTML = '<div class="loading-text">腳本功能即將上線，請稍後再試</div>';
          } else {
            const errorData = await response.json();
            console.log('腳本載入失敗:', errorData);
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load scripts error:', error);
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 獲取本地儲存的腳本
      function getLocalScripts() {
        try {
          const scripts = localStorage.getItem('user_scripts');
          return scripts ? JSON.parse(scripts) : [];
        } catch (error) {
          console.error('Error loading local scripts:', error);
          return [];
        }
      }
      
      // 儲存腳本到本地
      function saveScriptToLocal(scriptData) {
        try {
          const scripts = getLocalScripts();
          const newScript = {
            id: Date.now(),
            ...scriptData,
            created_at: new Date().toISOString()
          };
          scripts.unshift(newScript);
          localStorage.setItem('user_scripts', JSON.stringify(scripts));
          console.log('腳本已儲存到本地:', newScript);
        } catch (error) {
          console.error('Error saving script locally:', error);
        }
      }
      
      // 載入選題記錄
      async function loadTopicHistory() {
        if (!accessToken || !currentUser || !currentUser.user_id) {
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          return;
        }
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generations', {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            displayTopicHistory(data.generations || []);
          } else if (response.status === 401) {
            document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load topic history error:', error);
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 顯示選題記錄
      function displayTopicHistory(topics) {
        const container = document.getElementById('generationsList');
        
        if (topics.length === 0) {
          container.innerHTML = '<div class="loading-text">還沒有選題記錄</div>';
          return;
        }
        
        container.innerHTML = topics.map((topic, index) => `
          <div class="generation-item">
            <div class="generation-header">
              <span class="generation-number">記錄 ${index + 1}</span>
              <span class="generation-date">${formatTaiwanTime(topic.created_at)}</span>
            </div>
            <div class="generation-content">${topic.content}</div>
          </div>
        `).join('');
      }
      
      // 顯示腳本列表
      function displayScripts(scripts) {
        const container = document.getElementById('generationsList');
        
        if (scripts.length === 0) {
          container.innerHTML = '<div class="loading-text">還沒有儲存的腳本</div>';
          return;
        }
        
        container.innerHTML = scripts.map((script, index) => `
          <div class="script-item" data-script-id="${script.id}">
            <div class="script-header" onclick="toggleScript(${script.id})">
              <div class="script-info">
                <span class="script-number">編號${String(index + 1).padStart(2, '0')}</span>
                <span class="script-name" onclick="editScriptName(${script.id}, event)">${script.name || script.title || '未命名腳本'}</span>
                <span class="script-date">${formatTaiwanTime(script.created_at)}</span>
              </div>
              <div class="script-toggle">
                <span class="toggle-icon">▼</span>
              </div>
            </div>
            <div class="script-content" id="script-${script.id}" style="display: none;">
              <div class="script-details">
                <div class="script-table">
                  <table>
                    <thead>
                      <tr>
                        <th>時間</th>
                        <th>段落</th>
                        <th>鏡頭/畫面</th>
                        <th>台詞 (演員口白)</th>
                        <th>字幕文字 (可動畫)</th>
                        <th>音效與轉場</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${generateScriptTable(script.script_data)}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="script-actions" id="actions-${script.id}" style="display: none;">
              <button class="action-btn view-btn" onclick="viewFullScript(${script.id})">查看完整結果</button>
              <button class="action-btn download-pdf-btn" onclick="downloadScriptPDF(${script.id})">下載PDF檔案</button>
              <button class="action-btn download-csv-btn" onclick="downloadScriptCSV(${script.id})">下載CSV檔案</button>
              <button class="action-btn delete-btn" onclick="deleteScript(${script.id})">刪除</button>
            </div>
          </div>
        `).join('');
      }
      // 根據台詞內容生成畫面描述
      function generateVisualDescription(dialogue) {
        if (!dialogue || dialogue.trim() === '') return '-';
        
        const content = dialogue.toLowerCase();
        
        // 時間相關
        if (content.includes('時間') || content.includes('⏳') || content.includes('時鐘')) {
          return '時鐘特寫，指針快速轉動';
        }
        
        // 工作/加班相關
        if (content.includes('加班') || content.includes('工作') || content.includes('疲憊')) {
          return '疲憊的上班族在辦公室加班';
        }
        
        // AI/科技相關
        if (content.includes('ai') || content.includes('智能') || content.includes('✨')) {
          return '高效工作者使用AI工具，螢幕發光';
        }
        
        // 驚訝/震驚相關
        if (content.includes('😲') || content.includes('不知道') || content.includes('out')) {
          return '驚訝表情特寫';
        }
        
        // 決策/思考相關
        if (content.includes('決策') || content.includes('聰明') || content.includes('🧠')) {
          return '大腦圖案與數據分析圖表結合';
        }
        
        // 機會/目標相關
        if (content.includes('機會') || content.includes('抓住') || content.includes('🎯')) {
          return '箭頭射中靶心';
        }
        
        // 競爭相關
        if (content.includes('競爭') || content.includes('超車') || content.includes('🔥')) {
          return '賽車超越對手，火焰特效';
        }
        
        // 未來/趨勢相關
        if (content.includes('未來') || content.includes('趨勢') || content.includes('入場券')) {
          return '一張通往未來世界的門票';
        }
        
        // 成功/成就相關
        if (content.includes('成功') || content.includes('掌握') || content.includes('🏆')) {
          return '一人自信地操作AI工具，獎盃特寫';
        }
        
        // 角色相關
        if (content.includes('學生') || content.includes('上班族') || content.includes('創業者')) {
          return '學生、上班族、創業者三種不同角色的蒙太奇畫面';
        }
        
        // 上升/進步相關
        if (content.includes('上升') || content.includes('搭上') || content.includes('列車')) {
          return '一人登上快速行駛的列車或電梯';
        }
        
        // 金錢相關
        if (content.includes('金錢') || content.includes('💰') || content.includes('省下')) {
          return '時鐘與金錢符號的疊加動畫';
        }
        
        // 文件/資料相關
        if (content.includes('文件') || content.includes('資料') || content.includes('分析')) {
          return '動畫展示文件自動歸類、數據圖表自動生成';
        }
        
        // 操作相關
        if (content.includes('指令') || content.includes('下指令') || content.includes('💡')) {
          return '手指輕點螢幕，任務快速完成的進度條';
        }
        
        // 問題/疑問相關
        if (content.includes('?') || content.includes('？') || content.includes('如何') || content.includes('什麼')) {
          return '疑問表情特寫，思考狀態';
        }
        
        // 強調/重要相關
        if (content.includes('重要') || content.includes('關鍵') || content.includes('注意')) {
          return '重要資訊高亮顯示，強調效果';
        }
        
        // 對比相關
        if (content.includes('vs') || content.includes('對比') || content.includes('比較')) {
          return '左右分屏對比畫面';
        }
        
        // 步驟/流程相關
        if (content.includes('步驟') || content.includes('流程') || content.includes('第一') || content.includes('第二')) {
          return '步驟指示圖，流程動畫';
        }
        
        // 預設描述
        return '根據台詞內容的相關畫面';
      }
      
      // 生成腳本表格
      function generateScriptTable(scriptData) {
        console.log('生成腳本表格，數據:', scriptData);
        
        // 檢查是否有錯誤
        if (scriptData && scriptData.error) {
          console.log('腳本數據有錯誤:', scriptData.message);
          return `<tr><td colspan="6">解析失敗: ${scriptData.message}</td></tr>`;
        }
        
        // 處理新格式（有rows欄位）
        if (scriptData && scriptData.rows && scriptData.rows.length > 0) {
          let tableRows = '';
          
          // 按照規範格式生成表格行
          scriptData.rows.forEach((row, index) => {
            const timeRange = `${row.start_sec}-${row.end_sec}s`;
            const section = row.section || '-';
            const shotDesc = row.shot_desc || '-';
            const dialogue = row.dialogue || '-';
            const subtitle = row.subtitle || '-';
            const sfx = row.sfx || '-';
            
            tableRows += `
              <tr>
                <td>${timeRange}</td>
                <td>${section}</td>
                <td title="${shotDesc}">${shotDesc}</td>
                <td title="${dialogue}">${dialogue}</td>
                <td title="${subtitle}">${subtitle}</td>
                <td title="${sfx}">${sfx}</td>
              </tr>
            `;
          });
          
          console.log('生成的表格行:', tableRows);
          return tableRows || '<tr><td colspan="6">無數據</td></tr>';
        }
        
        // 處理舊格式（有sections欄位）
        if (scriptData && scriptData.sections && scriptData.sections.length > 0) {
        let tableRows = '';
        let timeIndex = 0;
        const timeRanges = ['0-3s', '3-7s', '7-15s', '15-25s', '25-30s'];
        
          // 檢查是否有畫面感資料
          const hasVisualData = scriptData.visual && scriptData.visual.trim() !== '';
          let visualLines = [];
          
          if (hasVisualData) {
            // 解析畫面感內容，按行分割
            visualLines = scriptData.visual.split('\n').map(line => line.trim()).filter(line => line);
            console.log('畫面感資料:', visualLines);
          }
          
          scriptData.sections.forEach((section, sectionIndex) => {
            console.log(`處理段落 ${sectionIndex}:`, section);
            
            // 如果段落有內容
            if (section.content && section.content.length > 0) {
          section.content.forEach((content, contentIndex) => {
            const timeRange = timeRanges[timeIndex] || '-';
            const sectionType = section.type || '內容段落';
                
                // 清理內容，移除多餘的空白
                const cleanContent = content.trim();
                
                // 限制顯示長度，超過30個字符就截斷並加上省略號
                const displayContent = cleanContent.length > 30 ? 
                  cleanContent.substring(0, 30) + '...' : cleanContent;
              
                // 獲取對應的畫面描述
                let visualDescription = '-';
                if (hasVisualData && visualLines[timeIndex]) {
                  // 使用實際的畫面感內容
                  visualDescription = visualLines[timeIndex].length > 50 ? 
                    visualLines[timeIndex].substring(0, 50) + '...' : visualLines[timeIndex];
                } else {
                  // 如果沒有畫面感資料，使用智能生成
                  visualDescription = generateVisualDescription(cleanContent);
                }
            
            tableRows += `
              <tr>
                <td>${timeRange}</td>
                <td>${sectionType}</td>
                    <td title="${hasVisualData && visualLines[timeIndex] ? visualLines[timeIndex] : visualDescription}">${visualDescription}</td>
                    <td title="${cleanContent}">${displayContent}</td>
                <td>-</td>
                    <td>-</td>
                  </tr>
                `;
                timeIndex++;
              });
            } else {
              // 如果段落沒有內容，但段落類型存在
              const timeRange = timeRanges[timeIndex] || '-';
              const sectionType = section.type || '內容段落';
              
              // 獲取對應的畫面描述
              let visualDescription = '-';
              if (hasVisualData && visualLines[timeIndex]) {
                visualDescription = visualLines[timeIndex].length > 50 ? 
                  visualLines[timeIndex].substring(0, 50) + '...' : visualLines[timeIndex];
              }
              
              tableRows += `
                <tr>
                  <td>${timeRange}</td>
                  <td>${sectionType}</td>
                  <td title="${hasVisualData && visualLines[timeIndex] ? visualLines[timeIndex] : ''}">${visualDescription}</td>
                  <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
            `;
            timeIndex++;
            }
        });
        
          console.log('生成的表格行:', tableRows);
        return tableRows || '<tr><td colspan="6">無數據</td></tr>';
        }
        
        // 如果都沒有，返回無數據
        console.log('沒有腳本數據，返回無數據行');
        return '<tr><td colspan="6">無數據</td></tr>';
      }
      
      // 切換腳本展開/收起
      function toggleScript(scriptId) {
        const content = document.getElementById(`script-${scriptId}`);
        const actions = document.getElementById(`actions-${scriptId}`);
        const toggleIcon = document.querySelector(`[data-script-id="${scriptId}"] .toggle-icon`);
        
        if (content.style.display === 'none') {
          content.style.display = 'block';
          actions.style.display = 'flex';
          toggleIcon.textContent = '▲';
        } else {
          content.style.display = 'none';
          actions.style.display = 'none';
          toggleIcon.textContent = '▼';
        }
      }
      
      // 編輯腳本名稱
      function editScriptName(scriptId, event) {
        event.stopPropagation();
        const nameElement = event.target;
        const currentName = nameElement.textContent;
        
        const newName = prompt('請輸入新的腳本名稱:', currentName);
        if (newName && newName !== currentName) {
          updateScriptName(scriptId, newName);
        }
      }
      
      // 更新腳本名稱
      async function updateScriptName(scriptId, newName) {
        if (!accessToken || !currentUser || !currentUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/scripts/${scriptId}/name`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ name: newName })
          });
          
          if (response.ok) {
            showToast('腳本名稱更新成功！', 3000);
            loadMyScripts(); // 重新載入列表
          } else if (response.status === 401) {
            showToast('請先登入', 3000);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '更新失敗');
          }
        } catch (error) {
          console.error('Update script name error:', error);
          showToast('更新失敗，請稍後再試', 3000);
        }
      }
      
      // 查看完整腳本
      function viewFullScript(scriptId) {
        // 找到對應的腳本數據
        const scripts = getLocalScripts();
        const script = scripts.find(s => s.id == scriptId);
        
        if (!script) {
          showToast('找不到腳本數據', 3000);
          return;
        }
        
        // 創建彈出視窗
        const modal = document.createElement('div');
        modal.className = 'script-modal-overlay';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 24px;
          max-width: 90%;
          max-height: 90%;
          overflow-y: auto;
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        `;
        
        // 生成完整腳本內容
        let fullContent = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 16px;">
            <h2 style="margin: 0; color: #1f2937; font-size: 20px;">${script.name || '未命名腳本'}</h2>
            <button onclick="this.closest('.script-modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
          </div>
        `;
        
        if (script.script_data && script.script_data.sections) {
          fullContent += '<div style="margin-bottom: 20px;">';
          script.script_data.sections.forEach((section, index) => {
            fullContent += `
              <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                <h3 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">${section.type || '內容段落'}</h3>
                <div style="color: #4b5563; line-height: 1.6;">
                  ${section.content ? section.content.map(content => `<p style="margin: 8px 0;">${content}</p>`).join('') : '<p>無內容</p>'}
                </div>
              </div>
            `;
          });
          fullContent += '</div>';
        } else {
          // 如果沒有結構化數據，顯示原始內容
          fullContent += `
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; color: #4b5563;">
              ${script.content || '無內容'}
            </div>
          `;
        }
        
        modalContent.innerHTML = fullContent;
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // 點擊背景關閉
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }
      
      // 下載PDF
      function downloadScriptPDF(scriptId) {
        showToast('PDF下載功能開發中...', 3000);
      }
      
      // 下載CSV
      function downloadScriptCSV(scriptId) {
        showToast('CSV下載功能開發中...', 3000);
      }
      
      // 刪除腳本
      async function deleteScript(scriptId) {
        if (!accessToken || !currentUser || !currentUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        if (!confirm('確定要刪除這個腳本嗎？')) {
          return;
        }
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/scripts/${scriptId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            showToast('腳本刪除成功！', 3000);
            loadMyScripts(); // 重新載入列表
          } else if (response.status === 401) {
            showToast('請先登入', 3000);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '刪除失敗');
          }
        } catch (error) {
          console.error('Delete script error:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }
      
      // 格式化台灣時間
      function formatTaiwanTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW', {
          timeZone: 'Asia/Taipei',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      // 重新生成結果
      async function regenerateResult(type) {
        switch(type) {
          case 'positioning':
            await generatePositioning();
            break;
          case 'topics':
            await generateTopics();
            break;
          case 'script':
            await generateScript();
            break;
        }
      }
      
      // 更新結果區塊內容
      function updateResultBlock(elementId, content, hasContent) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          if (hasContent) {
            element.classList.add('has-content');
          } else {
            element.classList.remove('has-content');
          }
        }
      }
      
      // 帳號定位功能
      async function analyzePositioning() {
        const positioning = positioningInput.value;
        
        if (!positioning) {
          showToast('請先輸入帳號定位', 3000);
          return;
        }
        
        updateResultBlock('positioningResult', '正在分析帳號定位...', false);
        
        try {
          // 這裡可以調用後端 API 進行帳號定位分析
          // 暫時使用模擬數據
          setTimeout(() => {
            const analysis = `根據您的帳號定位"${positioning}"，建議：\n\n1. 內容風格：輕鬆幽默\n2. 目標受眾：健康愛好者\n3. 內容主題：加密貨幣與健康結合\n4. 發布時間：晚上8-10點\n5. 互動策略：多使用問答形式`;
            updateResultBlock('positioningResult', analysis, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('positioningResult', '分析失敗，請稍後再試', false);
          showToast('分析失敗', 3000);
        }
      }
      
      // 腳本選題功能
      async function selectTopics() {
        const platform = platformSelect.value;
        const topic = topicInput.value;
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('topicSelectionResult', '正在為您選題...', false);
        
        try {
          // 這裡可以調用後端 API 進行選題
          // 暫時使用模擬數據
          setTimeout(() => {
            const topics = `為${platform}平台推薦以下選題${topic ? `（基於"${topic}"主題）` : ''}：\n\n1. 夏季美白保養的5個小技巧\n2. 30天美白挑戰實測\n3. 美白產品成分大解析\n4. 天然美白方法分享\n5. 美白誤區你中了幾個？`;
            updateResultBlock('topicSelectionResult', topics, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('topicSelectionResult', '選題失敗，請稍後再試', false);
          showToast('選題失敗', 3000);
        }
      }
      
      // 事件監聽器
      document.addEventListener('DOMContentLoaded', async () => {
        // 確保抽屜初始狀態為關閉
        closeUserDrawer();
        
        // 檢查是否有認證回調
        await handleAuthCallback();
        
        // 檢查本地存儲的認證資訊
        accessToken = localStorage.getItem('accessToken');
        currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        
        if (accessToken && currentUser) {
          updateAuthUI(true);
        } else {
          updateAuthUI(false);
        }
        
        // 按鈕功能已整合到快速按鈕中
        
        // 標籤切換事件
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
        
        // 設定區塊摺疊/展開功能
        settingsToggleEl.addEventListener('click', () => {
          const isCollapsed = settingsContentEl.classList.contains('collapsed');
          const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
          
          if (isCollapsed) {
            settingsContentEl.classList.remove('collapsed');
            toggleIcon.textContent = '▼';
          } else {
            settingsContentEl.classList.add('collapsed');
            toggleIcon.textContent = '▶';
          }
        });
        
        // 登入按鈕功能
        loginBtn.addEventListener('click', login);
        
        // 聊天功能
        sendBtn.addEventListener('click', sendMessage);
        
        // 輸入框事件監聽器
        messageInput.addEventListener('input', autoResizeTextarea);
        
        // 初始化發送按鈕狀態
        autoResizeTextarea();
        
        // 快速按鈕功能
        document.querySelectorAll('.quick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            if (text) {
              messageInput.value = text;
              messageInput.focus();
              
              // 添加視覺反饋
              btn.style.transform = 'scale(0.95)';
              setTimeout(() => {
                btn.style.transform = '';
              }, 150);
              
              // 根據按鈕類型切換到對應的結果標籤
              if (text.includes('生成腳本')) {
                switchTab('script');
              } else if (text.includes('腳本選題')) {
                switchTab('topics');
              } else if (text.includes('帳號定位')) {
                switchTab('positioning');
              }
              
              // 自動發送訊息
              setTimeout(() => {
                sendMessage();
              }, 500);
            }
          });
        });
        
        // 設定已套用的標記
        let settingsApplied = false;
        let appliedSettings = {
          platform: null,
          topic: null,
          duration: null,
          positioning: null
        };

        applyBtn.addEventListener('click', () => {
          const platform = platformSelect.value;
          const topic = topicInput.value;
          const positioning = positioningInput.value;
          const duration = durationInput.value;
          
          if (platform) {
            // 記錄已套用的設定
            settingsApplied = true;
            appliedSettings = {
              platform: platform,
              topic: topic,
              duration: duration,
              positioning: positioning
            };
            
            showToast('設定已套用', 2000);
            
            // 自動收合設定區塊
            settingsContentEl.classList.add('collapsed');
            const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
            toggleIcon.textContent = '▶';
          } else {
            showToast('請選擇平台', 3000);
          }
        });
        
        // 測試連線和顯示結果功能已整合到其他按鈕中
        
        // 綁定彈跳視窗按鈕事件
        popupRetry.addEventListener('click', () => {
          hidePopupOverlay();
          login();
        });
        
        popupCancel.addEventListener('click', () => {
          hidePopupOverlay();
        });
        
        // 鍵盤快捷鍵 - 已移至 initChatGPTFeatures 中處理
      });
      
      // 登入功能
      async function login() {
        try {
          console.log('DEBUG: Login function called');
          
          // 獲取 Google 認證 URL
          console.log('DEBUG: Fetching auth URL from backend...');
          const response = await fetch('https://aivideobackend.zeabur.app/api/auth/google');
          const data = await response.json();
          
          console.log('DEBUG: Auth URL received:', data.auth_url);
          
          // 檢測是否為手機版
          const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          
          if (isMobile) {
            // 手機版：直接跳轉到Google登入頁面
            console.log('DEBUG: Mobile detected, redirecting to Google auth page');
            window.location.href = data.auth_url;
          } else {
            // 桌面版：使用彈跳視窗
            console.log('DEBUG: Desktop detected, opening popup window');
            
            // 顯示彈跳視窗覆蓋層
            showPopupOverlay('正在開啟 Google 登入視窗...');
          
          // 使用彈跳視窗進行 Google 認證
          console.log('DEBUG: Opening popup window with URL:', data.auth_url);
          const popup = window.open(
            data.auth_url,
            'googleAuth',
            'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
          );
          
          console.log('DEBUG: Popup window object:', popup);
          
          if (!popup) {
            console.error('DEBUG: Popup window blocked or failed to open');
            hidePopupOverlay();
            showPopupError('請允許彈跳視窗以完成登入', true);
            return;
          }
          
          console.log('DEBUG: Popup window opened successfully');
          
          // 更新覆蓋層訊息
          updatePopupMessage('請在彈跳視窗中完成 Google 登入...');
          
          // 監聽彈跳視窗關閉
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              clearInterval(checkClosed);
              hidePopupOverlay();
              // 檢查是否有認證結果
              checkAuthResult();
            }
          }, 1000);
          
          // 監聽來自彈跳視窗的訊息
          window.addEventListener('message', handleAuthMessage);
          }
          
        } catch (error) {
          console.error('Login error:', error);
          hidePopupOverlay();
          showToast('登入失敗，請稍後再試', 5000);
        }
      }
      
      function showPopupOverlay(message) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'block';
        popupButtons.style.display = 'none';
        popupOverlay.style.display = 'flex';
      }
      
      function updatePopupMessage(message) {
        popupMessage.textContent = message;
      }
      
      function showPopupError(message, showRetry = false) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'none';
        if (showRetry) {
          popupButtons.style.display = 'block';
        } else {
          popupButtons.style.display = 'none';
        }
        popupOverlay.style.display = 'flex';
      }
      
      function hidePopupOverlay() {
        popupOverlay.style.display = 'none';
      }
      
      function handleAuthMessage(event) {
        console.log('DEBUG: Received message from popup:', event.data);
        
        // 接受來自後端網域的訊息
        if (event.origin !== 'https://aivideobackend.zeabur.app' && event.origin !== window.location.origin) {
          console.log('DEBUG: Ignoring message from unknown origin:', event.origin);
          return;
        }
        
        if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
          console.log('DEBUG: Auth success message received');
          // 認證成功，更新 UI
          accessToken = event.data.accessToken;
          currentUser = event.data.user;
          
          // 保存到本地存儲
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          hidePopupOverlay();
          updateAuthUI(true);
          showToast('登入成功！', 3000);
          
          // 顯示主應用程式
          showMainApp();
          
          // 移除事件監聽器
          window.removeEventListener('message', handleAuthMessage);
        } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
          console.log('DEBUG: Auth error message received:', event.data.error);
          hidePopupOverlay();
          showToast('認證失敗：' + event.data.error, 5000);
          window.removeEventListener('message', handleAuthMessage);
        }
      }
      
      async function checkAuthResult() {
        // 檢查本地存儲中是否有新的認證資訊
        const storedToken = localStorage.getItem('accessToken');
        const storedUser = localStorage.getItem('currentUser');
        
        if (storedToken && storedUser && storedToken !== accessToken) {
          accessToken = storedToken;
          currentUser = JSON.parse(storedUser);
          
          // 為用戶生成隨機ID（如果沒有）
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('頁面載入時為用戶生成新ID:', currentUser.user_id);
          }
          
          updateAuthUI(true);
          updatePersonalInfo();
          showToast('登入成功！', 3000);
        }
      }
      async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userId = urlParams.get('user_id');
        const email = urlParams.get('email');
        const name = urlParams.get('name');
        const picture = urlParams.get('picture');
        const error = urlParams.get('error');
        
        console.log('DEBUG: Checking auth callback parameters:', {
          token: token ? 'present' : 'missing',
          userId: userId ? 'present' : 'missing',
          email: email ? 'present' : 'missing',
          name: name ? 'present' : 'missing',
          picture: picture ? 'present' : 'missing',
          error: error || 'none'
        });
        
        // 處理錯誤
        if (error) {
          console.error('DEBUG: Auth error received:', error);
          showToast('認證失敗：' + decodeURIComponent(error), 5000);
          updateAuthUI(false);
          // 清除 URL 中的錯誤參數
          window.history.replaceState({}, document.title, window.location.pathname);
          return;
        }
        
        // 處理成功認證
        if (token && userId && email && name) {
          console.log('DEBUG: Auth success parameters received');
          
          // 構建用戶物件
          currentUser = {
            id: userId,
            email: email,
            name: name,
            picture: picture || ''
          };
          accessToken = token;
          
          // 保存到本地存儲
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          updateAuthUI(true);
          showToast('登入成功！', 3000);
          
          // 顯示主應用程式
          showMainApp();
          
          // 清除 URL 中的認證參數
          window.history.replaceState({}, document.title, window.location.pathname);
          
          console.log('DEBUG: Auth completed successfully');
        }
      }

      async function fetchUserInfo() {
        if (!accessToken) return;
        
        const response = await fetch('https://aivideobackend.zeabur.app/api/auth/me', {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (response.ok) {
          const userData = await response.json();
          currentUser = userData;
          
          // 為用戶生成隨機ID（如果沒有）
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            console.log('為用戶生成新ID:', currentUser.user_id);
          }
          
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          updateAuthUI(true);
          
          // 立即更新個人資料顯示
          updatePersonalInfo();
        } else {
          throw new Error('Failed to fetch user info');
        }
      }

      // 彈出提示框函數
      function showToast(message, duration = 3000) {
        toastEl.textContent = message;
        toastEl.style.display = 'block';
        toastEl.className = 'toast show';
        
        setTimeout(() => {
          toastEl.className = 'toast hide';
          setTimeout(() => {
            toastEl.style.display = 'none';
          }, 300);
        }, duration);
      }

      // 這個事件監聽器已經合併到上面的 DOMContentLoaded 中

      // 滾動到底部的函數
      function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          // 使用 requestAnimationFrame 確保 DOM 更新後再滾動
          requestAnimationFrame(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            // 強制滾動到最底部
            setTimeout(() => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
          });
        }
      }

      // 強制滾動到底部的函數
      function forceScrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          // 立即滾動到底部
          chatMessages.scrollTop = chatMessages.scrollHeight;
          // 延遲再次滾動確保到達底部
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 50);
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 200);
        }
      }

      // 初始化聊天滾動功能
      function initChatScroll() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          // 確保聊天區域可以滾動
          chatMessages.style.overflowY = 'auto';
          chatMessages.style.scrollBehavior = 'smooth';
          
          // 添加滾動事件監聽器
          chatMessages.addEventListener('scroll', function() {
            // 可以添加滾動相關的邏輯，比如顯示/隱藏滾動到底部按鈕
          });
          
          // 確保初始狀態滾動到底部
          forceScrollToBottom();
          
          // 延遲再次滾動確保到達底部
          setTimeout(() => {
            forceScrollToBottom();
          }, 500);
        }
      }

      function append(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        
        // 創建頭像元素
        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        
        if (role === 'user') {
          // 用戶頭像：使用 Gmail 頭像或默認頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            avatar.innerHTML = `<img src="${userAvatarImg.src}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="用戶頭像">`;
          } else {
            avatar.textContent = '你';
          }
        } else {
          avatar.textContent = '🤖';
        }
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // 如果是 AI 回覆，清理 Markdown 格式
        if (role === 'assistant') {
          const cleanText = cleanMarkdownFormat(text);
          bubble.innerHTML = `<p>${cleanText}</p>`;
        } else {
          bubble.innerHTML = `<p>${text}</p>`;
        }
        
        div.appendChild(avatar);
        div.appendChild(bubble);
        chatEl.appendChild(div);
        
        // 確保滾動到底部
        scrollToBottom();
        return { container: div, bubble: bubble };
      }

      // 清理 Markdown 格式並轉換為 HTML
      function cleanMarkdownFormat(text) {
        // 處理 Markdown 標題格式
        text = text.replace(/^###\s*(.+)$/gm, '<strong>$1</strong>'); // ### 標題 → **標題**
        text = text.replace(/^##\s*(.+)$/gm, '<strong>$1</strong>');  // ## 標題 → **標題**
        text = text.replace(/^#\s*(.+)$/gm, '<strong>$1</strong>');   // # 標題 → **標題**
        
        // 將 **文字** 轉換為 <strong>文字</strong>
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // 處理其他常見的 Markdown 格式
        text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');           // *斜體* → 斜體
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');         // `代碼` → 代碼
        
        // 移除單獨的 Markdown 符號
        text = text.replace(/\*\*/g, '');                             // 移除單獨的 **
        text = text.replace(/^#{1,6}\s*/gm, '');                      // 移除行首的 # 符號
        
        // 處理換行符號，確保段落分明
        text = text.replace(/\n\n/g, '</p><p>');                      // 雙換行 → 段落分隔
        text = text.replace(/\n/g, '<br>');                           // 單換行 → 換行標籤
        
        // 包裝在段落標籤中
        if (text && !text.startsWith('<p>')) {
          text = '<p>' + text + '</p>';
        }
        
        return text;
      }

      function updateAssistantNode(nodeObj, text) {
        // 清理 Markdown 格式
        const cleanText = cleanMarkdownFormat(text);
        
        if (nodeObj.bubble) {
          // 使用 innerHTML 來支援 HTML 標籤（如 <strong>）
          nodeObj.bubble.innerHTML = cleanText;
        } else {
          nodeObj.innerHTML = cleanText;
        }
        
        // 確保滾動到底部
        scrollToBottom();
      }

      function canSubmit() {
        if (isSending) return false;
        const now = Date.now();
        if (now - lastSubmitAt < 600) return false; // 600ms 節流
        lastSubmitAt = now;
        return true;
      }

      async function send(message) {
        if (!message) return;
        if (!canSubmit()) return;
        lastMessage = message;
        const userNode = append('user', message);
        const assistantNode = append('assistant', '');

        // 顯示 AI 回覆中的載入狀態
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'ai-loading';
        loadingDiv.innerHTML = `
          <span>AI正在思考中</span>
          <div class="ai-loading-dots">
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
          </div>
        `;
        assistantNode.bubble.appendChild(loadingDiv);

        sendBtn.disabled = true;
        isSending = true;
        statusEl.textContent = '正在送出…';

        try {
          // 自動偵測環境，開發時使用 localhost，部署時使用環境變數或預設後端網域
          const isDevelopment = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname === '0.0.0.0';
          
          // 如果是開發環境，使用 localhost:8000；部署環境使用正確的後端網域
          let endpoint;
          if (isDevelopment) {
            endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          } else {
            // 部署環境：使用您提供的正確後端網域
            endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          }
          // 添加調試信息
          console.log('API 端點:', endpoint);
          console.log('當前位置:', window.location.href);
          console.log('Hostname:', window.location.hostname);
          console.log('Port:', window.location.port);
          
          // 準備請求頭
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          const res = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message,
              platform: settingsApplied ? appliedSettings.platform : null,
              topic: settingsApplied ? appliedSettings.topic : null,
              duration: settingsApplied ? appliedSettings.duration : null,
              style: styleInstruction,
              profile: settingsApplied ? appliedSettings.positioning : null,
              history,
              user_id: currentUser?.user_id || null
            })
          });

          if (!res.ok) {
            const text = await res.text().catch(() => '');
            console.error('API 請求失敗:', res.status, text);
            
            let errorMessage = `[請求失敗 ${res.status}] `;
            try {
              const errorData = JSON.parse(text);
              if (errorData.error) {
                errorMessage += errorData.error;
                if (errorData.error.includes('GEMINI_API_KEY')) {
                  errorMessage += '\n\n💡 解決方案：請在 Zeabur 後端服務的環境變數中設定 GEMINI_API_KEY';
                }
              } else {
                errorMessage += text || '無回應內容';
              }
            } catch {
              errorMessage += text || '無回應內容';
            }
            
            updateAssistantNode(assistantNode, errorMessage);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let aiText = '';
          let buffer = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              if (!frame.startsWith('data:')) continue;
              try {
                const jsonStr = frame.slice(5).trim();
                const evt = JSON.parse(jsonStr);
                if (evt.type === 'token') {
                  // 移除載入動畫，開始顯示 AI 回覆
                  const loadingDiv = assistantNode.bubble.querySelector('.loading');
                  if (loadingDiv) {
                    loadingDiv.remove();
                  }
                  aiText += evt.content;
                  updateAssistantNode(assistantNode, aiText);
                } else if (evt.type === 'end') {
                  history.push({ role: 'user', content: message });
                  history.push({ role: 'assistant', content: aiText });
                  
                  // 檢查是否包含腳本結果，自動顯示結果區塊
                  checkAndUpdateResults(aiText);
                }
              } catch (e) { /* ignore parse errors */ }
            }
          }
        } catch (e) {
          // 移除載入動畫，顯示錯誤訊息
          const loadingDiv = assistantNode.bubble.querySelector('.loading');
          if (loadingDiv) {
            loadingDiv.remove();
          }
          console.error('請求錯誤:', e);
          console.error('錯誤詳情:', {
            message: e?.message,
            name: e?.name,
            stack: e?.stack,
            endpoint: endpoint,
            location: window.location.href
          });
          
          // 提供更詳細的錯誤訊息
          let errorMsg = `[錯誤] ${e?.message || e}`;
          if (e?.name === 'TypeError' && e?.message.includes('fetch')) {
            errorMsg = '[連線錯誤] 無法連接到伺服器，請檢查網路連線或稍後再試';
          } else if (e?.name === 'TypeError' && e?.message.includes('Failed to fetch')) {
            errorMsg = '[網路錯誤] 請檢查網路連線或重新整理頁面';
          } else if (e?.message?.includes('CORS')) {
            errorMsg = '[跨域錯誤] 請嘗試重新整理頁面';
          }
          
          // 添加更多調試信息
          errorMsg += `\n\n調試信息：\n端點: ${endpoint}\n位置: ${window.location.href}`;
          updateAssistantNode(assistantNode, errorMsg);
        } finally {
          sendBtn.disabled = false;
          isSending = false;
          statusEl.textContent = '';
        }
      }

      // 這些事件監聽器已經在新的 DOMContentLoaded 中處理

      // 設定區塊摺疊/展開功能
      // 設定區塊摺疊/展開功能已移除

      // 這個事件監聽器已經在新的 DOMContentLoaded 中處理

      function updateBadge(badgeEl, label, value) {
        if (value) {
          badgeEl.style.display = 'inline-block';
          badgeEl.textContent = label + '：' + value;
        } else {
          badgeEl.style.display = 'none';
          badgeEl.textContent = '';
        }
      }

      // 測試連線功能
      async function testConnection() {
        const testNode = append('assistant', '🔧 正在測試連線...');
        
        try {
          // 測試後端根路徑
          const rootResponse = await fetch('https://aivideobackend.zeabur.app/');
          const rootText = await rootResponse.text();
          
          let testResult = `🔍 連線測試結果：\n\n`;
          testResult += `1️⃣ 後端根路徑：${rootResponse.ok ? '✅ 正常' : '❌ 異常'} (狀態碼: ${rootResponse.status})\n`;
          
          // 測試健康檢查
          try {
            const healthResponse = await fetch('https://aivideobackend.zeabur.app/api/health');
            const healthData = await healthResponse.json();
            
            testResult += `2️⃣ 健康檢查：${healthResponse.ok ? '✅ 正常' : '❌ 異常'}\n`;
            testResult += `   - 知識庫：${healthData.kb_status}\n`;
            testResult += `   - Gemini配置：${healthData.gemini_configured ? '✅ 已配置' : '❌ 未配置'}\n`;
            testResult += `   - Gemini測試：${healthData.gemini_test}\n`;
            testResult += `   - 模型：${healthData.model_name}\n`;
            
            if (!healthData.gemini_configured) {
              testResult += `\n⚠️ 問題：Gemini API Key 未配置\n`;
              testResult += `💡 解決方案：請在 Zeabur 後端環境變數中設定 GEMINI_API_KEY\n`;
            } else if (healthData.gemini_test !== 'working') {
              testResult += `\n⚠️ 問題：Gemini API 連線異常\n`;
              testResult += `💡 錯誤：${healthData.gemini_test}\n`;
            }
            
          } catch (healthError) {
            testResult += `2️⃣ 健康檢查：❌ 無法連線 (${healthError.message})\n`;
          }
          
          // 測試聊天API
          try {
            const chatResponse = await fetch('https://aivideobackend.zeabur.app/api/chat/stream', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'test', platform: null, topic: null, duration: '30' })
            });
            
            testResult += `3️⃣ 聊天API：${chatResponse.ok ? '✅ 正常' : '❌ 異常'} (狀態碼: ${chatResponse.status})\n`;
            
            if (!chatResponse.ok) {
              const errorText = await chatResponse.text();
              testResult += `   錯誤：${errorText}\n`;
            }
            
          } catch (chatError) {
            testResult += `3️⃣ 聊天API：❌ 無法連線 (${chatError.message})\n`;
          }
          
          updateAssistantNode(testNode, testResult);
          
        } catch (error) {
          updateAssistantNode(testNode, `❌ 連線測試失敗：${error.message}`);
        }
      }

      // 測試連線按鈕已移除

      // 添加全局測試函數（用於調試）
      window.testDOM = function() {
        console.log('=== DOM元素測試 ===');
        console.log('resultTitleEl:', resultTitleEl);
        console.log('resultScriptEl:', resultScriptEl);
        console.log('resultVisualEl:', resultVisualEl);
        console.log('resultCopyEl:', resultCopyEl);
        
        if (resultTitleEl) {
          resultTitleEl.innerHTML = '測試標題';
          console.log('測試標題設置成功');
        }
        if (resultScriptEl) {
          resultScriptEl.innerHTML = '測試腳本內容';
          console.log('測試腳本內容設置成功');
        }
        if (resultVisualEl) {
          resultVisualEl.innerHTML = '測試畫面感';
          console.log('測試畫面感設置成功');
        }
        if (resultCopyEl) {
          resultCopyEl.innerHTML = '測試發佈文案';
          console.log('測試發佈文案設置成功');
        }
      };
      
      // 添加AI內容測試函數
      window.testAIContent = function(aiText) {
        console.log('=== AI內容測試 ===');
        console.log('測試文本:', aiText);
        
        const isScript = detectScriptContent(aiText);
        console.log('是否為腳本內容:', isScript);
        
        if (isScript) {
          const sections = parseAIContent(aiText);
          console.log('解析結果:', sections);
          
          // 更新DOM元素
          if (sections.title && resultTitleEl) {
            resultTitleEl.innerHTML = sections.title;
            console.log('✅ 主題標題已設置');
          }
          if (sections.script && resultScriptEl) {
            resultScriptEl.innerHTML = sections.script;
            console.log('✅ 腳本內容已設置');
          }
          if (sections.visual && resultVisualEl) {
            resultVisualEl.innerHTML = sections.visual;
            console.log('✅ 畫面感已設置');
          }
          if (sections.copy && resultCopyEl) {
            resultCopyEl.innerHTML = sections.copy;
            console.log('✅ 發佈文案已設置');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已顯示');
        }
      };
      
      // 添加強制更新函數
      window.forceUpdateResults = function() {
        console.log('=== 強制更新結果區塊 ===');
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('獲取AI文本:', aiText.substring(0, 200) + '...');
          
          const isScript = detectScriptContent(aiText);
          console.log('是否為腳本內容:', isScript);
          
          if (isScript) {
            const sections = parseAIContent(aiText);
            console.log('解析結果:', sections);
            
            // 強制更新DOM元素
            if (resultTitleEl) {
              resultTitleEl.innerHTML = sections.title || '未找到主題標題';
              console.log('✅ 主題標題已強制設置');
            }
            if (resultScriptEl) {
              resultScriptEl.innerHTML = sections.script || '未找到腳本內容';
              console.log('✅ 腳本內容已強制設置');
            }
            if (resultVisualEl) {
              resultVisualEl.innerHTML = sections.visual || '未找到畫面感';
              console.log('✅ 畫面感已強制設置');
            }
            if (resultCopyEl) {
              resultCopyEl.innerHTML = sections.copy || '未找到發佈文案';
              console.log('✅ 發佈文案已強制設置');
            }
            
            // 顯示結果區塊
            resultsEl.style.display = 'block';
            console.log('✅ 結果區塊已強制顯示');
          } else {
            console.log('❌ 檢測失敗，不是腳本內容');
          }
        } else {
          console.log('❌ 未找到AI回應');
        }
      };
      
      // 添加簡單測試函數
      window.testCurrentContent = function() {
        console.log('=== 測試當前內容 ===');
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('AI文本長度:', aiText.length);
          console.log('AI文本前500字符:', aiText.substring(0, 500));
          
          // 測試主題標題提取
          const titleMatch = aiText.match(/主題標題[：:]\s*([^\n]+)/i);
          console.log('主題標題匹配結果:', titleMatch);
          
          // 測試腳本內容提取
          const scriptMatch = aiText.match(/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i);
          console.log('腳本內容匹配結果:', scriptMatch ? '匹配' : '無匹配');
          
          // 測試畫面感提取
          const visualMatch = aiText.match(/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i);
          console.log('畫面感匹配結果:', visualMatch ? '匹配' : '無匹配');
          
          // 測試發佈文案提取
          const copyMatch = aiText.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
          console.log('發佈文案匹配結果:', copyMatch ? '匹配' : '無匹配');
          
          // 直接更新結果區塊
          if (titleMatch && titleMatch[1]) {
            resultTitleEl.innerHTML = cleanMarkdownFormat(titleMatch[1].trim());
            console.log('✅ 直接設置主題標題');
          }
          if (scriptMatch && scriptMatch[1]) {
            resultScriptEl.innerHTML = cleanMarkdownFormat(scriptMatch[1].trim());
            console.log('✅ 直接設置腳本內容');
          }
          if (visualMatch && visualMatch[1]) {
            resultVisualEl.innerHTML = cleanMarkdownFormat(visualMatch[1].trim());
            console.log('✅ 直接設置畫面感');
          }
          if (copyMatch && copyMatch[1]) {
            resultCopyEl.innerHTML = cleanMarkdownFormat(copyMatch[1].trim());
            console.log('✅ 直接設置發佈文案');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已顯示');
        } else {
          console.log('❌ 未找到AI回應');
        }
      };
      
      // 添加超強力測試函數
      window.forceExtractContent = function() {
        console.log('=== 超強力內容提取 ===');
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('AI文本長度:', aiText.length);
          console.log('AI文本前1000字符:', aiText.substring(0, 1000));
          
          // 強制提取主題標題
          let title = '';
          const titlePatterns = [
            /\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /主題標題[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*主題標題[：:]\s*([^\n]+)/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              title = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到主題標題:', title);
              break;
            }
          }
          
          // 強制提取腳本內容
          let script = '';
          const scriptPatterns = [
            /\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /\d+\.\s*\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              script = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到腳本內容:', script.substring(0, 100) + '...');
              break;
            }
          }
          
          // 強制提取畫面感
          let visual = '';
          const visualPatterns = [
            /\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /\d+\.\s*\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              visual = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到畫面感:', visual.substring(0, 100) + '...');
              break;
            }
          }
          
          // 強制提取發佈文案
          let copy = '';
          const copyPatterns = [
            /\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /發佈文案[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*發佈文案[：:]\s*([\s\S]*?)$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              copy = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到發佈文案:', copy.substring(0, 100) + '...');
              break;
            }
          }
          
          // 強制更新結果區塊
          if (title) {
            resultTitleEl.innerHTML = title;
            console.log('✅ 強制設置主題標題');
          }
          if (script) {
            resultScriptEl.innerHTML = script;
            console.log('✅ 強制設置腳本內容');
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
            console.log('✅ 強制設置畫面感');
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
            console.log('✅ 強制設置發佈文案');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已強制顯示');
          
          // 如果還是沒有內容，顯示原始文本
          if (!title && !script && !visual && !copy) {
            console.log('⚠️ 所有提取都失敗，顯示原始文本');
            resultTitleEl.innerHTML = '原始AI回應';
            resultScriptEl.innerHTML = aiText.substring(0, 500) + '...';
            resultVisualEl.innerHTML = '請檢查控制台日誌';
            resultCopyEl.innerHTML = '解析失敗';
          }
        } else {
          console.log('❌ 未找到AI回應');
        }
      };
      // 添加終極解決方案：直接從頁面提取
      window.extractFromPage = function() {
        console.log('=== 終極解決方案：從頁面直接提取 ===');
        
        // 方法1：從聊天記錄中提取
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('從聊天記錄提取，文本長度:', aiText.length);
          
          // 簡單粗暴的提取方法
          const lines = aiText.split('\n').filter(line => line.trim().length > 0);
          console.log('總行數:', lines.length);
          
          let title = '';
          let script = '';
          let visual = '';
          let copy = '';
          
          // 逐行掃描，找到關鍵詞就提取
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // 提取主題標題
            if (line.includes('主題標題') && line.includes('：')) {
              const match = line.match(/主題標題[：:]\s*(.+)/i);
              if (match && match[1]) {
                title = cleanMarkdownFormat(match[1].trim());
                console.log('✅ 找到主題標題:', title);
              }
            }
            
            // 提取腳本內容
            if (line.includes('腳本內容') && line.includes('：')) {
              let scriptLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('畫面感') || nextLine.includes('發佈文案') || nextLine.includes('3.') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  scriptLines.push(nextLine);
                }
              }
              if (scriptLines.length > 0) {
                script = cleanMarkdownFormat(scriptLines.join('\n'));
                console.log('✅ 找到腳本內容:', script.substring(0, 100) + '...');
              }
            }
            
            // 提取畫面感
            if (line.includes('畫面感') && line.includes('：')) {
              let visualLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('發佈文案') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  visualLines.push(nextLine);
                }
              }
              if (visualLines.length > 0) {
                visual = cleanMarkdownFormat(visualLines.join('\n'));
                console.log('✅ 找到畫面感:', visual.substring(0, 100) + '...');
              }
            }
            
            // 提取發佈文案
            if (line.includes('發佈文案') && line.includes('：')) {
              let copyLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.length > 0) {
                  copyLines.push(nextLine);
                }
              }
              if (copyLines.length > 0) {
                copy = cleanMarkdownFormat(copyLines.join('\n'));
                console.log('✅ 找到發佈文案:', copy.substring(0, 100) + '...');
              }
            }
          }
          
          // 更新結果區塊
          if (title) {
            resultTitleEl.innerHTML = title;
            console.log('✅ 設置主題標題');
          }
          if (script) {
            resultScriptEl.innerHTML = script;
            console.log('✅ 設置腳本內容');
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
            console.log('✅ 設置畫面感');
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
            console.log('✅ 設置發佈文案');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已顯示');
          
          // 如果還是沒有內容，顯示原始文本
          if (!title && !script && !visual && !copy) {
            console.log('⚠️ 所有提取都失敗，顯示原始文本');
            resultTitleEl.innerHTML = '原始AI回應';
            resultScriptEl.innerHTML = aiText.substring(0, 500) + '...';
            resultVisualEl.innerHTML = '請檢查控制台日誌';
            resultCopyEl.innerHTML = '解析失敗';
          }
        } else {
          console.log('❌ 未找到AI回應');
        }
      };

      // 快速按鈕功能已移到 DOMContentLoaded 事件中

      // 檢查用戶是否要求生成腳本
      function checkIfScriptRequest(aiText) {
        console.log('=== 檢查是否為腳本生成請求 ===');
        
        // 檢查AI回應中是否包含腳本生成相關的關鍵詞
        const scriptRequestKeywords = [
          '短影音腳本',
          '生成腳本',
          '腳本生成',
          '腳本內容',
          '主題標題',
          '畫面感',
          '發佈文案',
          'Hook',
          'Value',
          'CTA',
          '短影音',
          '腳本',
          'Reels',
          'TikTok',
          '小紅書'
        ];
        
        const hasScriptKeywords = scriptRequestKeywords.some(keyword => 
          aiText.toLowerCase().includes(keyword.toLowerCase())
        );
        
        // 檢查是否包含腳本結構標記
        const hasScriptStructure = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ].some(pattern => pattern.test(aiText));
        
        const isScriptRequest = hasScriptKeywords || hasScriptStructure;
        
        console.log('包含腳本關鍵詞:', hasScriptKeywords);
        console.log('包含腳本結構:', hasScriptStructure);
        console.log('判斷為腳本請求:', isScriptRequest);
        
        return isScriptRequest;
      }

      function checkAndUpdateResults(aiText) {
        console.log('=== 開始解析AI回應 ===');
        console.log('AI回應長度:', aiText.length);
        console.log('AI回應前300字符:', aiText.substring(0, 300));
        
        // 檢查用戶是否要求生成腳本（只有這種情況才顯示腳本結果區塊）
        const isScriptRequest = checkIfScriptRequest(aiText);
        console.log('是否為腳本生成請求:', isScriptRequest);
        
        if (!isScriptRequest) {
          console.log('❌ 不是腳本生成請求，不顯示腳本結果區塊');
          return;
        }
        
        // 更精確的腳本內容檢測
        const isScriptContent = detectScriptContent(aiText);
        
        console.log('是否為腳本內容:', isScriptContent);
        
        if (isScriptContent) {
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('結果區塊已顯示，開始解析內容...');
          
          // 確保DOM元素存在
          if (!resultTitleEl || !resultScriptEl || !resultVisualEl || !resultCopyEl) {
            console.error('DOM元素不存在:', {
              resultTitleEl: !!resultTitleEl,
              resultScriptEl: !!resultScriptEl,
              resultVisualEl: !!resultVisualEl,
              resultCopyEl: !!resultCopyEl
            });
            return;
          }
          
          try {
            // 使用更靈活的解析方法
            const sections = parseAIContent(aiText);
            
            // 更新DOM元素
            if (sections.title) {
              resultTitleEl.innerHTML = sections.title;
              console.log('✅ 主題標題已設置:', sections.title);
            }
            
            if (sections.script) {
              resultScriptEl.innerHTML = sections.script;
              console.log('✅ 腳本內容已設置:', sections.script.substring(0, 100) + '...');
            }
            
            if (sections.visual) {
              resultVisualEl.innerHTML = sections.visual;
              console.log('✅ 畫面感已設置:', sections.visual.substring(0, 100) + '...');
            }
            
            if (sections.copy) {
              resultCopyEl.innerHTML = sections.copy;
              console.log('✅ 發佈文案已設置:', sections.copy.substring(0, 100) + '...');
            }
            
            // 延遲檢查內容是否正確設置
            setTimeout(() => {
              console.log('=== 延遲檢查DOM內容 ===');
              console.log('主題標題:', resultTitleEl.innerHTML);
              console.log('腳本內容:', resultScriptEl.innerHTML.substring(0, 100) + '...');
              console.log('畫面感:', resultVisualEl.innerHTML.substring(0, 100) + '...');
              console.log('發佈文案:', resultCopyEl.innerHTML.substring(0, 100) + '...');
            }, 500);
            
          } catch (e) {
            console.error('解析結果時出錯:', e);
          }
        } else {
          console.log('未檢測到腳本內容，不顯示結果區塊');
        }
      }
      
      // 新增：精確的腳本內容檢測函數
      function detectScriptContent(aiText) {
        console.log('=== 開始腳本內容檢測 ===');
        console.log('檢測文本長度:', aiText.length);
        console.log('檢測文本前200字符:', aiText.substring(0, 200));
        
        // 1. 檢查是否包含腳本相關的結構標記（更靈活的檢測）
        const structureMarkers = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ];
        
        const hasStructureMarkers = structureMarkers.some(pattern => pattern.test(aiText));
        console.log('是否包含腳本結構標記:', hasStructureMarkers);
        
        // 2. 檢查是否包含短影音腳本的關鍵元素
        const scriptElements = [
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /鏡頭[：:]/i,
          /音效[：:]/i,
          /字幕[：:]/i,
          /台詞[：:]/i
        ];
        
        const scriptElementCount = scriptElements.filter(pattern => pattern.test(aiText)).length;
        console.log('腳本元素數量:', scriptElementCount);
        
        // 檢查是否包含時間標記（Hook、Value、CTA格式）
        const timeMarkersPatterns = [
          /\(\d+-\d+秒\)\s*Hook/i,
          /\(\d+-\d+秒\)\s*Value/i,
          /\(\d+-\d+秒\)\s*CTA/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ];
        const hasTimeMarkers = timeMarkersPatterns.some(pattern => pattern.test(aiText));
        console.log('是否包含時間標記:', hasTimeMarkers);
        
        // 檢查是否包含短影音相關內容
        const videoContent = [
          /畫面感/i,
          /發佈文案/i,
          /台詞[：:]/i,
          /鏡頭[：:]/i,
          /音效[：:]/i,
          /字幕[：:]/i
        ];
        const hasVideoContent = videoContent.some(pattern => pattern.test(aiText));
        console.log('是否包含短影音內容:', hasVideoContent);
        
        // 更靈活的判斷條件
        const hasAnyScriptContent = hasStructureMarkers || scriptElementCount >= 3 || hasTimeMarkers || hasVideoContent;
        console.log('是否有任何腳本內容:', hasAnyScriptContent);
        
        if (!hasAnyScriptContent) {
          console.log('❌ 未包含足夠的腳本內容標記，不顯示結果區塊');
          console.log('檢測結果詳情:', {
            hasStructureMarkers,
            scriptElementCount,
            hasTimeMarkers,
            hasVideoContent
          });
          return false;
        }
        
        // 2. 檢查是否包含腳本相關的關鍵詞組合
        const scriptKeywords = ['主題標題', '腳本內容', '畫面感', '發佈文案', 'Hook', 'Value', 'CTA'];
        const keywordCount = scriptKeywords.filter(keyword => aiText.includes(keyword)).length;
        console.log('腳本關鍵詞數量:', keywordCount);
        
        // 3. 檢查是否包含短影音相關的內容指示詞
        const videoIndicators = [
          '短影音腳本',
          '短影音腳本結果',
          '生成腳本',
          '腳本生成',
          'Reels',
          'TikTok',
          '小紅書',
          '秒腳本',
          '影音內容',
          '短影音',
          '腳本'
        ];
        const hasVideoIndicators = videoIndicators.some(indicator => aiText.includes(indicator));
        console.log('是否包含短影音指示詞:', hasVideoIndicators);
        
        // 4. 檢查文本長度（腳本內容通常較長）
        const isLongEnough = aiText.length > 300; // 提高長度要求
        console.log('文本是否足夠長:', isLongEnough);
        
        // 5. 檢查是否包含多個段落（腳本通常有多個部分）
        const paragraphCount = aiText.split('\n\n').filter(p => p.trim().length > 0).length;
        const hasMultipleParagraphs = paragraphCount >= 4; // 提高段落要求
        console.log('段落數量:', paragraphCount, '是否多段落:', hasMultipleParagraphs);
        
        // 6. 排除明顯的非腳本內容
        const nonScriptIndicators = [
          '你好',
          '謝謝',
          '不客氣',
          '請問',
          '不好意思',
          '抱歉',
          '我來幫你',
          '讓我為你',
          '很高興為您',
          '歡迎',
          '再見',
          '拜拜',
          '有什麼可以幫你',
          '需要什麼幫助',
          '請告訴我',
          '請輸入',
          '請選擇',
          '請點擊',
          '請查看',
          '請注意',
          '提醒',
          '建議',
          '推薦',
          '介紹',
          '說明',
          '解釋',
          '回答',
          '回覆',
          '回應'
        ];
        const hasNonScriptIndicators = nonScriptIndicators.some(indicator => 
          aiText.toLowerCase().includes(indicator.toLowerCase())
        );
        console.log('是否包含非腳本指示詞:', hasNonScriptIndicators);
        
        // 7. 檢查是否包含完整的腳本結構（至少包含3個區塊）
        const requiredStructureMarkers = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i
        ];
        const structureCount = requiredStructureMarkers.filter(pattern => pattern.test(aiText)).length;
        const hasCompleteStructure = structureCount >= 3;
        console.log('結構區塊數量:', structureCount, '是否完整結構:', hasCompleteStructure);
        
        // 8. 檢查是否包含時間標記（腳本通常有時間標記）
        const timeMarkersGeneral = [
          /\d+[-\s]*\d*\s*秒/i,
          /\d+[-\s]*\d*\s*分鐘/i,
          /0-\d+\s*秒/i,
          /\d+-\d+\s*秒/i
        ];
        const hasTimeMarkersGeneral = timeMarkersGeneral.some(pattern => pattern.test(aiText));
        console.log('是否包含一般時間標記:', hasTimeMarkersGeneral);
        
        // 綜合判斷
        const score = {
          structureMarkers: hasStructureMarkers ? 3 : 0,
          scriptElements: Math.min(scriptElementCount, 4), // 腳本元素數量
          keywordCount: Math.min(keywordCount, 3),
          videoIndicators: hasVideoIndicators ? 2 : 0,
          length: isLongEnough ? 1 : 0,
          paragraphs: hasMultipleParagraphs ? 1 : 0,
          completeStructure: hasCompleteStructure ? 2 : 0,
          timeMarkers: hasTimeMarkers ? 1 : 0,
          timeMarkersGeneral: hasTimeMarkersGeneral ? 1 : 0,
          videoContent: hasVideoContent ? 1 : 0,
          nonScript: hasNonScriptIndicators ? -5 : 0 // 高懲罰
        };
        
        const totalScore = Object.values(score).reduce((sum, val) => sum + val, 0);
        
        console.log('腳本檢測評分:', score);
        console.log('總分:', totalScore);
        
        // 更靈活的判斷條件
        const isScriptContent = totalScore >= 4 && (hasStructureMarkers || scriptElementCount >= 3);
        
        // 如果包含非腳本指示詞，降低評分但不完全拒絕
        if (hasNonScriptIndicators) {
          console.log('⚠️ 包含非腳本指示詞，但內容結構完整，仍視為腳本內容');
        }
        
        console.log('是否為腳本內容:', isScriptContent);
        console.log('=== 腳本內容檢測結束 ===');
        
        return isScriptContent;
      }
      // 新增：更精確的AI內容解析函數
      function parseAIContent(aiText) {
        const sections = {
          title: '',
          script: '',
          visual: '',
          copy: ''
        };
        
        console.log('開始解析AI內容...');
        console.log('原始AI文本長度:', aiText.length);
        console.log('原始AI文本前500字符:', aiText.substring(0, 500));
        
        // 使用正則表達式精確提取每個區塊的內容
        try {
          // 通用內容提取策略 - 應對所有可能的AI格式變化
          let scriptContent = aiText;
          let extractionMethod = 'full';
          
          // 策略1: 檢查是否有 --- 分隔符
          const dashSections = aiText.split(/---/);
          if (dashSections.length > 1) {
            const contentSections = dashSections.slice(1);
            scriptContent = contentSections.join('---').trim();
            extractionMethod = 'dash-separated';
            console.log('✅ 使用 --- 分隔策略');
          }
          // 策略2: 檢查是否有明確的結構標記
          else if (aiText.includes('主題標題') || aiText.includes('腳本內容') || aiText.includes('畫面感') || aiText.includes('發佈文案')) {
            scriptContent = aiText;
            extractionMethod = 'structured';
            console.log('✅ 使用結構化標記策略');
          }
          // 策略3: 檢查是否有 Hook/Value/CTA 結構
          else if (aiText.includes('Hook') || aiText.includes('Value') || aiText.includes('CTA')) {
            scriptContent = aiText;
            extractionMethod = 'hook-value-cta';
            console.log('✅ 使用 Hook/Value/CTA 策略');
          }
          // 策略4: 檢查是否有時間標記
          else if (aiText.match(/\d+-\d+秒/) || aiText.match(/\d+秒/)) {
            scriptContent = aiText;
            extractionMethod = 'time-marked';
            console.log('✅ 使用時間標記策略');
          }
          // 策略5: 默認使用完整內容
          else {
            scriptContent = aiText;
            extractionMethod = 'full';
            console.log('✅ 使用完整內容策略');
          }
          
          console.log('提取方法:', extractionMethod);
            console.log('腳本內容長度:', scriptContent.length);
            console.log('腳本內容前200字符:', scriptContent.substring(0, 200));
          
          // 超級智能主題標題提取器 - 應對所有可能的AI格式
          function extractTitle(scriptContent) {
          const titlePatterns = [
              // 1. 表情符號 + 標題格式
              /[🎬📝🎯✨🔥📌]\s*主題標題[：:]\s*([^\n]+)/i,
              /[🎬📝🎯✨🔥📌]\s*主題[：:]\s*([^\n]+)/i,
              /[🎬📝🎯✨🔥📌]\s*標題[：:]\s*([^\n]+)/i,
              
              // 2. 標準標題格式
            /主題標題[：:]\s*([^\n]+)/i,
            /主題[：:]\s*([^\n]+)/i,
            /標題[：:]\s*([^\n]+)/i,
              
              // 3. 編號 + 標題格式
            /\d+\.\s*主題標題[：:]\s*([^\n]+)/i,
            /\d+\.\s*主題[：:]\s*([^\n]+)/i,
            /\d+\.\s*標題[：:]\s*([^\n]+)/i,
              
              // 4. 粗體標題格式
            /\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\*\*主題\*\*[：:]\s*([^\n]+)/i,
            /\*\*標題\*\*[：:]\s*([^\n]+)/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*主題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*標題\*\*[：:]\s*([^\n]+)/i,
              
              // 6. Markdown 標題格式
            /###\s*主題標題[：:]\s*([^\n]+)/i,
            /###\s*主題[：:]\s*([^\n]+)/i,
            /###\s*標題[：:]\s*([^\n]+)/i,
              /##\s*主題標題[：:]\s*([^\n]+)/i,
              /##\s*主題[：:]\s*([^\n]+)/i,
              /##\s*標題[：:]\s*([^\n]+)/i,
              
              // 7. 行首標題格式（--- 分隔後）
              /^主題標題[：:]\s*([^\n]+)/i,
              /^標題[：:]\s*([^\n]+)/i,
              /^主題[：:]\s*([^\n]+)/i,
              
              // 8. AI 狡猾格式：直接給標題，沒有前綴
            /^你的.*來了.*小紅書.*都在.*用的.*AI智能體.*$/i,
            /^.*AI智能體.*來了.*$/i,
            /^.*小紅書.*博主.*都在.*用的.*$/i,
              /^.*效率.*爆棚.*$/i,
              /^.*AI.*智能體.*這樣玩.*$/i,
              
              // 9. 引號標題格式
              /「([^」]+)」/,
              /"([^"]+)"/,
              /'([^']+)'/,
              
              // 10. 特殊標題模式
              /^.*你還在.*方法.*AI智能體.*效率.*爆棚.*$/i,
              /^.*AI智能體.*效率.*翻倍.*$/i,
              /^.*超級.*學伴.*$/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = scriptContent.match(pattern);
            if (match) {
              // 處理有捕獲組的情況
              if (match[1] && match[1].trim()) {
                  const title = cleanMarkdownFormat(match[1].trim());
                  if (title.length > 5 && title.length < 100) { // 合理的標題長度
                    console.log('✅ 找到主題標題(有前綴):', title);
                    return title;
                  }
              }
              // 處理沒有前綴，直接匹配整行的情況
              else if (match[0] && match[0].trim()) {
                  const title = cleanMarkdownFormat(match[0].trim());
                  if (title.length > 5 && title.length < 100) {
                    console.log('✅ 找到主題標題(無前綴):', title);
                    return title;
                  }
                }
              }
            }
            
            // 如果沒有找到明確的標題，嘗試提取第一行作為標題
            const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
            for (const line of lines) {
              const trimmedLine = line.trim();
              // 跳過明顯不是標題的行
              if (trimmedLine.match(/^(Hook|Value|CTA|畫面感|發佈文案|\d+\.|\(|台詞|鏡頭|音效|字幕|主題建議|目標|切入點|內容方向|好的|沒問題|讓我)/i)) {
                continue;
              }
              // 檢查是否為合理的標題
              if (trimmedLine.length > 5 && trimmedLine.length < 100 && !trimmedLine.includes('：') && !trimmedLine.includes(':')) {
                console.log('使用第一行作為主題標題:', trimmedLine);
                return cleanMarkdownFormat(trimmedLine);
              }
            }
            
            return '';
          }
          
          // 提取主題標題
          sections.title = extractTitle(scriptContent);
          
          // 超級智能腳本內容提取器 - 應對所有可能的AI格式
          function extractScript(scriptContent) {
          const scriptPatterns = [
              // 1. 標準腳本內容格式
            /腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 2. 表情符號 + 腳本內容格式
              /[📝🎬📜✨🔥]\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /[📝🎬📜✨🔥]\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 3. 編號 + 腳本內容格式
            /\d+\.\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
              
              // 4. 粗體腳本內容格式
            /\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /\*\*腳本\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*\*\*腳本\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
              
              // 6. Markdown 標題格式
              /###\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*畫面感|###\s*發佈文案|畫面感|發佈文案|$))/i,
              /###\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*畫面感|###\s*發佈文案|畫面感|發佈文案|$))/i,
              /##\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*畫面感|##\s*發佈文案|畫面感|發佈文案|$))/i,
              /##\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*畫面感|##\s*發佈文案|畫面感|發佈文案|$))/i,
              
              // 7. 行首腳本內容格式（--- 分隔後）
            /^腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /^腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 8. Hook/Value/CTA 結構格式
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Hook[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value\s*\d+|CTA|畫面感|發佈文案|$)/i,
              
              // 9. 台詞格式
              /台詞[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /台詞\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              
              // 10. 特殊腳本模式
              /^.*你還在.*手動.*報告.*寫文案.*落伍.*超級助理.*AI智能體.*$/i,
              /^.*它不只是.*程式.*真人.*思考.*學習.*$/i,
              /^.*想像一下.*專屬團隊.*24小時.*待命.*$/i,
              /^.*重點是.*越來越聰明.*不斷進化.*$/i,
              /^.*想知道.*怎麼開始.*AI智能體.*$/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = scriptContent.match(pattern);
              if (match) {
                let scriptText = '';
                if (match[1] && match[1].trim()) {
                  scriptText = match[1].trim();
                } else if (match[0] && match[0].trim()) {
                  scriptText = match[0].trim();
                }
                
                if (scriptText && scriptText.length > 10) {
                  console.log('✅ 找到腳本內容:', scriptText.substring(0, 100) + '...');
                  return cleanMarkdownFormat(scriptText);
                }
            }
          }
          
          // 如果沒有找到明確的腳本內容標記，嘗試提取 Hook、Value、CTA 部分
            console.log('嘗試提取 Hook/Value/CTA 內容...');
            
            // 支援多種時間標記格式
            const hookPatterns = [
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Hook[\s\S]*?(?=Value|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value\s*\d+|CTA|畫面感|發佈文案|$)/i
            ];
            const valuePatterns = [
              /Value\s*\d+\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Value\s*\d+[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Value\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i
            ];
            const ctaPatterns = [
              /CTA\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*CTA[\s\S]*?(?=畫面感|發佈文案|$)/i
            ];
            
            let extractedScriptContent = '';
            
            // 提取 Hook
            for (const pattern of hookPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                console.log('找到 Hook:', match[0].substring(0, 100) + '...');
                extractedScriptContent += match[0] + '\n\n';
                break;
              }
            }
            
            // 提取 Value
            for (const pattern of valuePatterns) {
              const matches = scriptContent.match(new RegExp(pattern.source, 'gi'));
              if (matches) {
                console.log('找到 Value 數量:', matches.length);
                extractedScriptContent += matches.join('\n\n');
                break;
              }
            }
            
            // 提取 CTA
            for (const pattern of ctaPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                console.log('找到 CTA:', match[0].substring(0, 100) + '...');
                extractedScriptContent += '\n\n' + match[0];
                break;
              }
            }
            
            if (extractedScriptContent.trim()) {
              console.log('使用 Hook/Value/CTA 作為腳本內容:', extractedScriptContent.substring(0, 100) + '...');
              return cleanMarkdownFormat(extractedScriptContent.trim());
            }
            
            return '';
          }
          
          // 提取腳本內容
          sections.script = extractScript(scriptContent);
          
          // 超級智能畫面感提取器 - 應對所有可能的AI格式
          function extractVisual(scriptContent) {
          const visualPatterns = [
              // 1. 標準畫面感格式
            /畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 2. 表情符號 + 畫面感格式
              /[🎬🎞️📹✨🔥]\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              /[🎬🎞️📹✨🔥]\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 3. 編號 + 畫面感格式
            /\d+\.\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              // 新增：編號 + 括號格式
              /\d+\.\s*畫面感\s*\([^)]*\)[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              /\d+\.\s*畫面\s*\([^)]*\)[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              
              // 4. 粗體畫面感格式
            /\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /\*\*畫面\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*\*\*畫面\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              
              // 6. Markdown 標題格式
            /###\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*發佈文案|發佈文案|$))/i,
            /###\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*發佈文案|發佈文案|$))/i,
              /##\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*發佈文案|發佈文案|$))/i,
              /##\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*發佈文案|發佈文案|$))/i,
              
              // 7. 行首畫面感格式（--- 分隔後）
            /^畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              /^畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 8. 特殊畫面感模式
              /^.*開場.*Hook.*鏡頭.*特寫.*$/i,
              /^.*核心價值.*鏡頭.*中景.*$/i,
              /^.*行動呼籲.*鏡頭.*指向.*$/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // 檢查是否為「尚未生成」
              if (match[1].trim() === '尚未生成' || match[1].trim().includes('尚未生成')) {
                console.log('⚠️ 畫面感標記為「尚未生成」');
                  return 'AI 未生成畫面感內容';
              } else {
                  const visual = cleanMarkdownFormat(match[1].trim());
                  console.log('✅ 找到畫面感:', visual.substring(0, 100) + '...');
                  return visual;
                }
              }
            }
            
            return '';
          }
          
          // 提取畫面感
          sections.visual = extractVisual(scriptContent);
          
          // 超級智能發佈文案提取器 - 應對所有可能的AI格式
          function extractCopy(scriptContent) {
          const copyPatterns = [
              // 1. 標準發佈文案格式
            /發佈文案[：:]\s*([\s\S]*?)$/i,
            /文案[：:]\s*([\s\S]*?)$/i,
              
              // 2. 表情符號 + 發佈文案格式
              /[📱📄📝✨🔥]\s*發佈文案[：:]\s*([\s\S]*?)$/i,
              /[📱📄📝✨🔥]\s*文案[：:]\s*([\s\S]*?)$/i,
              
              // 3. 編號 + 發佈文案格式
            /\d+\.\s*發佈文案[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*文案[：:]\s*([\s\S]*?)$/i,
              // 新增：編號 + 括號格式
              /\d+\.\s*發佈文案\s*\([^)]*\)[：:]\s*([\s\S]*?)$/i,
              /\d+\.\s*文案\s*\([^)]*\)[：:]\s*([\s\S]*?)$/i,
              
              // 4. 粗體發佈文案格式
            /\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\*\*文案\*\*[：:]\s*([\s\S]*?)$/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*文案\*\*[：:]\s*([\s\S]*?)$/i,
              
              // 6. Markdown 標題格式
            /###\s*發佈文案[：:]\s*([\s\S]*?)$/i,
            /###\s*文案[：:]\s*([\s\S]*?)$/i,
              /##\s*發佈文案[：:]\s*([\s\S]*?)$/i,
              /##\s*文案[：:]\s*([\s\S]*?)$/i,
              
              // 7. 行首發佈文案格式（--- 分隔後）
            /^發佈文案[：:]\s*([\s\S]*?)$/i,
              /^文案[：:]\s*([\s\S]*?)$/i,
              
              // 8. 特殊發佈文案模式
              /^.*還在.*繁瑣.*工作.*AI智能體.*救星.*$/i,
              /^.*自動化.*提升效率.*客製化.*$/i,
              /^.*未來趨勢.*點擊.*主頁.*連結.*$/i,
              /^.*免費.*領取.*AI.*入門.*指南.*$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // 檢查是否為「尚未生成」
              if (match[1].trim() === '尚未生成' || match[1].trim().includes('尚未生成')) {
                console.log('⚠️ 發佈文案標記為「尚未生成」');
                  return 'AI 未生成發佈文案內容';
              } else {
                  const copy = cleanMarkdownFormat(match[1].trim());
                  console.log('✅ 找到發佈文案:', copy.substring(0, 100) + '...');
                  return copy;
                }
              }
            }
            
            return '';
          }
          
          // 提取發佈文案
          sections.copy = extractCopy(scriptContent);
          
          // 最終調試輸出
          console.log('=== 超級智能解析結果 ===');
          console.log('提取方法:', extractionMethod);
          console.log('主題標題:', sections.title ? '✅ 有內容' : '❌ 無內容');
          console.log('腳本內容:', sections.script ? '✅ 有內容' : '❌ 無內容');
          console.log('畫面感:', sections.visual ? '✅ 有內容' : '❌ 無內容');
          console.log('發佈文案:', sections.copy ? '✅ 有內容' : '❌ 無內容');
          
          // 如果任何欄位為空，嘗試最後的強制提取
          if (!sections.title || !sections.script || !sections.visual || !sections.copy) {
            console.log('🔄 啟動最後的強制提取機制...');
            
            // 強制提取主題標題
            if (!sections.title) {
              const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
              for (const line of lines) {
                if (line.length > 10 && line.length < 100 && !line.includes('：') && !line.includes(':')) {
                  sections.title = cleanMarkdownFormat(line.trim());
                    console.log('強制提取主題標題:', sections.title);
                  break;
                }
              }
            }
            
            // 強制提取腳本內容
            if (!sections.script) {
              const scriptMatch = scriptContent.match(/(?:Hook|Value|CTA)[\s\S]*?(?=畫面感|發佈文案|$)/i);
              if (scriptMatch) {
                sections.script = cleanMarkdownFormat(scriptMatch[0].trim());
                console.log('強制提取腳本內容:', sections.script.substring(0, 100) + '...');
              }
            }
            
            // 強制提取畫面感
            if (!sections.visual) {
              const visualMatch = scriptContent.match(/畫面感[：:]\s*([\s\S]*?)(?=發佈文案|$)/i);
              if (visualMatch && visualMatch[1]) {
                if (visualMatch[1].trim() === '尚未生成' || visualMatch[1].trim().includes('尚未生成')) {
                  sections.visual = 'AI 未生成畫面感內容';
                } else {
                  sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
                }
                  console.log('強制提取畫面感:', sections.visual.substring(0, 100) + '...');
              }
            }
            
            // 強制提取發佈文案
            if (!sections.copy) {
              const copyMatch = scriptContent.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
              if (copyMatch && copyMatch[1]) {
                if (copyMatch[1].trim() === '尚未生成' || copyMatch[1].trim().includes('尚未生成')) {
                  sections.copy = 'AI 未生成發佈文案內容';
                } else {
                  sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
                }
                  console.log('強制提取發佈文案:', sections.copy.substring(0, 100) + '...');
              }
            }
          }
          
        } catch (error) {
          console.error('解析AI內容時出錯:', error);
        }
        
        console.log('=== 最終解析結果 ===');
        console.log('主題標題:', sections.title ? '✅ 有內容' : '❌ 無內容');
        console.log('腳本內容:', sections.script ? '✅ 有內容' : '❌ 無內容');
        console.log('畫面感:', sections.visual ? '✅ 有內容' : '❌ 無內容');
        console.log('發佈文案:', sections.copy ? '✅ 有內容' : '❌ 無內容');
        
        // 如果所有內容都為空，嘗試強制提取
        if (!sections.title && !sections.script && !sections.visual && !sections.copy) {
          console.log('⚠️ 所有內容都為空，嘗試強制提取...');
          
          // 強制提取主題標題
          const titleMatch = aiText.match(/主題標題[：:]\s*([^\n]+)/i);
          if (titleMatch && titleMatch[1]) {
            sections.title = cleanMarkdownFormat(titleMatch[1].trim());
            console.log('強制提取主題標題:', sections.title);
          }
          
          // 強制提取腳本內容
          const scriptMatch = aiText.match(/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i);
          if (scriptMatch && scriptMatch[1]) {
            sections.script = cleanMarkdownFormat(scriptMatch[1].trim());
            console.log('強制提取腳本內容:', sections.script.substring(0, 100) + '...');
          }
          
          // 強制提取畫面感
          const visualMatch = aiText.match(/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i);
          if (visualMatch && visualMatch[1]) {
            sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
            console.log('強制提取畫面感:', sections.visual.substring(0, 100) + '...');
          }
          
          // 強制提取發佈文案
          const copyMatch = aiText.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
          if (copyMatch && copyMatch[1]) {
            sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
            console.log('強制提取發佈文案:', sections.copy.substring(0, 100) + '...');
          }
        }
        
        console.log('完整解析結果:', sections);
        return sections;
      }

      // ===== 模式3：IP人設規劃模式函數 =====
      
      // 切換說明欄位顯示/隱藏
      function toggleMode3Instructions() {
        const instructions = document.querySelector('.mode3-instructions');
        const chatMessages = document.querySelector('.mode3-chat-messages');
        
        if (instructions.classList.contains('collapsed')) {
          instructions.classList.remove('collapsed');
          chatMessages.classList.remove('expanded');
        } else {
          instructions.classList.add('collapsed');
          chatMessages.classList.add('expanded');
        }
      }

      // 發送訊息
      async function sendMode3Message(message = null) {
        const input = document.getElementById('mode3-message-input');
        const messageText = message || input.value.trim();
        
        if (!messageText) return;
        
        // 清空輸入框
        if (!message) {
          input.value = '';
        }
        
        // 添加用戶訊息
        addMode3Message('user', messageText);
        
        // 添加載入訊息
        const loadingId = addMode3LoadingMessage();
        
        try {
          // 這裡應該調用後端API
          // 暫時使用模擬回應
          setTimeout(() => {
            updateMode3LastMessage(loadingId, 'assistant', '感謝您的分享！我已經記錄了您的資訊。請繼續告訴我更多關於您的背景、專長或目標，這樣我就能為您建立更完整的IP Profile。');
          }, 2000);
        } catch (error) {
          console.error('發送訊息失敗:', error);
          updateMode3LastMessage(loadingId, 'assistant', '抱歉，發生了錯誤。請稍後再試。');
        }
      }

      // 添加訊息到聊天區域
      function addMode3Message(sender, content) {
        const messagesContainer = document.getElementById('mode3-chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `mode3-message mode3-${sender}-message`;
        
        // 創建頭像元素
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'mode3-message-avatar';
        
        if (sender === 'user') {
          // 用戶頭像：使用 Gmail 頭像或默認頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = '👤';
          }
        } else {
          // AI 頭像：使用表情符號
          avatarDiv.textContent = '🤖';
        }
        
        // 創建訊息內容元素
        const contentDiv = document.createElement('div');
        contentDiv.className = 'mode3-message-content';
        contentDiv.innerHTML = `<p>${content}</p>`;
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // 添加載入訊息
      function addMode3LoadingMessage() {
        const messagesContainer = document.getElementById('mode3-chat-messages');
        const messageDiv = document.createElement('div');
        const messageId = 'loading-' + Date.now();
        messageDiv.id = messageId;
        messageDiv.className = 'mode3-message mode3-assistant-message';
        
        messageDiv.innerHTML = `
          <div class="mode3-message-avatar">🤖</div>
          <div class="mode3-message-content">
            <div class="mode3-loading">
              <span>AI正在思考中</span>
              <div class="mode3-loading-dots">
                <div class="mode3-loading-dot"></div>
                <div class="mode3-loading-dot"></div>
                <div class="mode3-loading-dot"></div>
              </div>
            </div>
          </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return messageId;
      }

      // 更新最後一條訊息
      function updateMode3LastMessage(messageId, sender, content) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
          messageDiv.className = `mode3-message mode3-${sender}-message`;
          
          // 創建頭像元素
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'mode3-message-avatar';
          
          if (sender === 'user') {
            // 用戶頭像：使用 Gmail 頭像或默認頭像
            const userAvatarImg = document.getElementById('userAvatar');
            if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
              const img = document.createElement('img');
              img.src = userAvatarImg.src;
              img.alt = '用戶頭像';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.borderRadius = '50%';
              img.style.objectFit = 'cover';
              avatarDiv.appendChild(img);
            } else {
              avatarDiv.textContent = '👤';
            }
          } else {
            // AI 頭像：使用表情符號
            avatarDiv.textContent = '🤖';
          }
          
          // 創建訊息內容元素
          const contentDiv = document.createElement('div');
          contentDiv.className = 'mode3-message-content';
          contentDiv.innerHTML = `<p>${content}</p>`;
          
          messageDiv.innerHTML = '';
          messageDiv.appendChild(avatarDiv);
          messageDiv.appendChild(contentDiv);
        }
      }

      // 切換結果標籤
      function switchMode3Tab(tabName) {
        // 移除所有標籤的active類別
        document.querySelectorAll('.mode3-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 隱藏所有結果區塊
        document.querySelectorAll('.mode3-result-block').forEach(block => {
          block.classList.remove('active');
        });
        
        // 激活選中的標籤
        event.target.classList.add('active');
        
        // 顯示對應的結果區塊
        const resultBlock = document.getElementById(`mode3-${tabName}-result`);
        if (resultBlock) {
          resultBlock.classList.add('active');
        }
      }

      // 生成IP Profile
      async function generateMode3IPProfile() {
        const resultBlock = document.getElementById('mode3-profile-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        // 禁用按鈕並顯示載入狀態
        button.disabled = true;
        button.innerHTML = '<span>⏳</span> 生成中...';
        
        try {
          // 這裡應該調用後端API
          // 暫時使用模擬數據
          setTimeout(() => {
            const mockProfile = `
              <div class="mode3-result-content">
                <h2>🎭 IP Profile</h2>
                <h3>基本資訊</h3>
                <p><strong>姓名：</strong>張小明</p>
                <p><strong>職業：</strong>軟體工程師</p>
                <p><strong>專長：</strong>前端開發、UI/UX設計</p>
                
                <h3>個人特色</h3>
                <ul>
                  <li>技術分享達人，善於將複雜概念簡化</li>
                  <li>熱愛學習新技術，樂於分享經驗</li>
                  <li>親和力強，善於與觀眾互動</li>
                </ul>
                
                <h3>內容定位</h3>
                <p>以「技術小白也能懂」的角度，分享前端開發技巧、職場經驗和學習心得。</p>
                
                <h3>目標受眾</h3>
                <p>對程式設計有興趣的初學者、轉職者、以及希望提升技能的在職工程師。</p>
              </div>
            `;
            
            resultBlock.innerHTML = mockProfile;
          }, 2000);
        } catch (error) {
          console.error('生成IP Profile失敗:', error);
          button.innerHTML = '<span>❌</span> 生成失敗，請重試';
          button.disabled = false;
        }
      }

      // 生成14天規劃
      async function generateMode314DayPlan() {
        const resultBlock = document.getElementById('mode3-plan-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>⏳</span> 生成中...';
        
        try {
          setTimeout(() => {
            const mockPlan = `
              <div class="mode3-result-content">
                <h2>📅 14天短影音規劃表</h2>
                <h3>第1-3天：技術基礎分享</h3>
                <ul>
                  <li>Day 1: HTML基礎概念</li>
                  <li>Day 2: CSS佈局技巧</li>
                  <li>Day 3: JavaScript入門</li>
                </ul>
                
                <h3>第4-7天：實作教學</h3>
                <ul>
                  <li>Day 4: 建立第一個網頁</li>
                  <li>Day 5: 響應式設計</li>
                  <li>Day 6: 互動功能實作</li>
                  <li>Day 7: 專案整合</li>
                </ul>
                
                <h3>第8-10天：職場經驗</h3>
                <ul>
                  <li>Day 8: 面試技巧分享</li>
                  <li>Day 9: 職場溝通</li>
                  <li>Day 10: 技能提升建議</li>
                </ul>
                
                <h3>第11-14天：進階主題</h3>
                <ul>
                  <li>Day 11: 框架選擇</li>
                  <li>Day 12: 效能優化</li>
                  <li>Day 13: 專案管理</li>
                  <li>Day 14: 未來規劃</li>
                </ul>
              </div>
            `;
            
            resultBlock.innerHTML = mockPlan;
          }, 2000);
        } catch (error) {
          console.error('生成14天規劃失敗:', error);
          button.innerHTML = '<span>❌</span> 生成失敗，請重試';
          button.disabled = false;
        }
      }
      // 生成今日腳本
      async function generateMode3TodayScripts() {
        const resultBlock = document.getElementById('mode3-scripts-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>⏳</span> 生成中...';
        
        try {
          setTimeout(() => {
            const mockScripts = `
              <div class="mode3-result-content">
                <h2>📝 今日3支腳本</h2>
                
                <h3>腳本1：技術分享</h3>
                <p><strong>標題：</strong>「5分鐘學會CSS Flexbox」</p>
                <p><strong>內容：</strong>大家好！今天要教大家CSS Flexbox的基本概念，讓你的網頁佈局更靈活...</p>
                <p><strong>時長：</strong>60秒</p>
                
                <h3>腳本2：職場經驗</h3>
                <p><strong>標題：</strong>「程式設計師面試必問的3個問題」</p>
                <p><strong>內容：</strong>面試時最常被問到的問題，我來分享我的回答技巧...</p>
                <p><strong>時長：</strong>45秒</p>
                
                <h3>腳本3：學習心得</h3>
                <p><strong>標題：</strong>「如何保持學習程式設計的動力」</p>
                <p><strong>內容：</strong>學習程式設計遇到挫折怎麼辦？分享我的經驗...</p>
                <p><strong>時長：</strong>50秒</p>
              </div>
            `;
            
            resultBlock.innerHTML = mockScripts;
          }, 2000);
        } catch (error) {
          console.error('生成今日腳本失敗:', error);
          button.innerHTML = '<span>❌</span> 生成失敗，請重試';
          button.disabled = false;
        }
      }

      // 儲存結果
      function saveMode3Result() {
        showToast('結果已儲存到個人資料庫', 3000);
        // 這裡應該調用後端API儲存結果
      }

      // 重新生成結果
      function regenerateMode3Result() {
        const activeTab = document.querySelector('.mode3-tab.active');
        if (activeTab) {
          const tabName = activeTab.textContent.includes('Profile') ? 'profile' : 
                         activeTab.textContent.includes('規劃') ? 'plan' : 'scripts';
          
          if (tabName === 'profile') {
            generateMode3IPProfile();
          } else if (tabName === 'plan') {
            generateMode314DayPlan();
          } else if (tabName === 'scripts') {
            generateMode3TodayScripts();
          }
        }
      }

      // 匯出結果
      function exportMode3Result() {
        const activeTab = document.querySelector('.mode3-tab.active');
        const tabName = activeTab.textContent.includes('Profile') ? 'profile' : 
                       activeTab.textContent.includes('規劃') ? 'plan' : 'scripts';
        
        const resultBlock = document.getElementById(`mode3-${tabName}-result`);
        const content = resultBlock.querySelector('.mode3-result-content');
        
        if (content) {
          const data = {
            type: tabName,
            content: content.innerHTML,
            timestamp: new Date().toISOString()
          };
          
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ip-${tabName}-${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          showToast('結果已匯出為JSON檔案', 3000);
        } else {
          showToast('沒有可匯出的內容', 3000);
        }
      }

      // 初始化模式3
      function initializeMode3() {
        // 設置說明欄位預設為收起狀態
        setTimeout(() => {
          const instructions = document.querySelector('.mode3-instructions');
          const chatMessages = document.querySelector('.mode3-chat-messages');
          if (instructions && chatMessages) {
            instructions.classList.add('collapsed');
            chatMessages.classList.add('expanded');
          }
        }, 100);
        
        // 設置輸入框Enter鍵發送
        const input = document.getElementById('mode3-message-input');
        if (input) {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMode3Message();
            }
          });
        }
      }

      // 關閉聊天容器
      function closeChatContainer() {
      }

      // 手機版抽屜控制函數
      function toggleMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileDrawerOverlay');
        
        if (drawer && overlay) {
          const isOpen = drawer.classList.contains('open');
          
          if (isOpen) {
            closeMobileDrawer();
          } else {
            openMobileDrawer();
          }
        }
      }

      function openMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileDrawerOverlay');
        
        if (drawer && overlay) {
          drawer.classList.add('open');
          overlay.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滾動
        }
      }

      function closeMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileDrawerOverlay');
        
        if (drawer && overlay) {
          drawer.classList.remove('open');
          overlay.style.display = 'none';
          document.body.style.overflow = ''; // 恢復背景滾動
        }
      }


      // 在頁面載入時初始化模式3
      window.addEventListener('load', function() {
        setTimeout(() => {
          try {
            initializeMode3();
          } catch (error) {
            console.error('初始化錯誤:', error);
          }
        }, 1000);
      });
    </script>
    
    <!-- 手機版抽屜導航 -->
    <div class="mobile-drawer-overlay" id="mobileDrawerOverlay" onclick="closeMobileDrawer()"></div>
    <div class="mobile-drawer" id="mobileDrawer">
      <div class="mobile-drawer-header">
        <h3>選單</h3>
        <button class="mobile-drawer-close" onclick="closeMobileDrawer()">✕</button>
      </div>
      <div class="mobile-drawer-content">
        <a href="#homepage" class="mobile-drawer-item" onclick="switchPage('homepage'); closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon">🏠</span>
          <span class="mobile-drawer-text">首頁</span>
        </a>
        <a href="#mode1" class="mobile-drawer-item" onclick="switchPage('mode1'); closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon">⚡</span>
          <span class="mobile-drawer-text">一鍵生成</span>
        </a>
        <a href="#mode2" class="mobile-drawer-item" onclick="switchPage('mode2'); closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon">💬</span>
          <span class="mobile-drawer-text">AI顧問</span>
        </a>
        <a href="#mode3" class="mobile-drawer-item" onclick="switchPage('mode3'); closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon">🎭</span>
          <span class="mobile-drawer-text">IP人設</span>
        </a>
        <a href="#userDB" id="mobileUserDBTab" class="mobile-drawer-item" onclick="switchPage('userDB'); closeMobileDrawer(); return false;" style="display:none;">
          <span class="mobile-drawer-icon">👤</span>
          <span class="mobile-drawer-text">資料庫</span>
      </a>
    </div>
    </div>

  </body>
</html>