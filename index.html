<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>AIJob短影音智能體</title>
    <style>
      :root { 
        color-scheme: light; 
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --safe-area-inset-left: env(safe-area-inset-left);
        --safe-area-inset-right: env(safe-area-inset-right);
      }
      body { 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
        background:#f7f7f8; /* 模擬 ChatGPT 的淺灰色背景 */
        color:#1a1a1a; 
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        overflow-x: hidden;
      }
      
      /* 頁面容器 */
      .app-container {
        display: flex;
        min-height: 100vh;
      }
      
      /* 主內容區域 */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: margin-right 0.3s ease;
      }
      
      .main-content.sidebar-open {
        margin-right: 300px;
      }
      
      /* 頂部導航欄 */
      .top-navbar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding-top: calc(16px + var(--safe-area-inset-top));
        min-height: 60px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .navbar-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }
      
      .navbar-title {
        font-size: 30px;
        font-weight: 600;
        color: #1f2937;
        margin-right: auto;
      }
      
      .clickable-title {
        cursor: pointer;
        transition: color 0.2s ease;
      }
      
      .clickable-title:hover {
        color: #3b82f6;
      }
      
      .navbar-tabs {
        display: flex;
        gap: 8px;
      }
      
      .navbar-tab {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: #6b7280;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
      }
      
      .navbar-tab.active {
        background: #3b82f6;
        color: white;
      }
      
      .navbar-tab:hover:not(.active) {
        background: #f3f4f6;
      }
      
      .navbar-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }
      
      .logout-btn {
        padding: 6px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
      }
      
      .logout-btn:hover {
        background: #dc2626;
      }
      
      /* 頁面內容區域 */
      .page-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* 首頁樣式 */
      .homepage {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        text-align: center;
      }
      
      .homepage-title {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
      }
      
      .homepage-subtitle {
        font-size: 18px;
        color: #6b7280;
        margin-bottom: 48px;
        max-width: 600px;
        line-height: 1.6;
      }
      
      .mode-cards {
        display: flex;
        gap: 24px;
        max-width: 800px;
      }
      
      .mode-card {
        flex: 1;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 32px 24px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        user-select: none;
      }
      
      .mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
      }
      
      .mode-card-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      
      .mode-card-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
      }
      
      .mode-card-desc {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 模式1：一鍵生成頁面 */
      .mode1-page {
        display: flex;
        gap: 24px;
        height: calc(100vh - 120px);
      }
      
      .mode1-left {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .mode1-right {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* 模式2：AI顧問對話頁面 */
      .mode2-page {
        /* 舊樣式，將被新樣式覆蓋 */
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        min-height: 600px;
        position: relative;
      }
      
      /* 說明按鈕 */
      .instructions-toggle-btn {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.2s ease;
        z-index: 1000;
      }
      
      .instructions-toggle-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      
      .btn-icon {
        font-size: 16px;
      }
      
      .btn-text {
        font-size: 13px;
      }
      
      /* 抽屜背景遮罩 */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .drawer-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      /* 說明抽屜 */
      .instructions-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1001;
        display: flex;
        flex-direction: column;
      }
      
      .instructions-drawer.open {
        right: 0;
      }
      
      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      
      .drawer-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }
      
      .drawer-close-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .drawer-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .drawer-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      
      .drawer-content p {
        margin: 0 0 16px 0;
        font-size: 14px;
        line-height: 1.6;
        color: #374151;
      }
      
      .drawer-content p:last-child {
        margin-bottom: 0;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        font-size: 13px;
        color: #6b7280;
      }
      
      .chat-container {
        /* 舊樣式，將被新樣式覆蓋 */
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      /* 側邊欄樣式 */
      .sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e5e7eb;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
      }
      
      .sidebar.open {
        right: 0;
      }
      
      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .sidebar-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
      
      .sidebar-menu {
        padding: 20px 0;
      }
      
      .sidebar-item {
        display: block;
        width: 100%;
        padding: 12px 20px;
        border: none;
        background: none;
        text-align: left;
        color: #6b7280;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .sidebar-item:hover {
        background: #f3f4f6;
        color: #1f2937;
      }
      
      .sidebar-item.active {
        background: #3b82f6;
        color: white;
      }
      
      
      /* 側邊欄頁面樣式 */
      .sidebar-page-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .sidebar-page-container {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90%;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      
      .sidebar-page-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
      }
      
      .sidebar-page-header h2 {
        margin: 0;
        font-size: 20px;
      }
      
      /* --- AI 顧問模式 (Mode 2) UI/UX 優化樣式 --- */
      
      /* 頁面內容區域 - 調整 padding 和居中 */
      .page-content {
        flex: 1;
        padding: 0; /* 移除 padding，讓 chat-container 處理 */
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center; /* 讓內容居中 */
        padding-bottom: 120px; /* 為輸入框留出空間 */
      }
      
      /* 模式2：AI顧問對話頁面 - 限制最大寬度 */
      .mode2-page {
        width: 100%;
        max-width: 800px; /* 限制最大寬度，模擬 ChatGPT 體驗 */
        padding: 0 20px;
        margin: 0 auto;
      }
      
      /* 聊天訊息容器 */
      .chat-container {
        width: 100%;
        padding-top: 20px;
        padding-bottom: 20px;
      }
      
      /* 訊息行 - 移除原有的氣泡樣式，改為塊狀 */
      .msg {
        display: flex;
        padding: 20px 0;
        border-bottom: 1px solid #e5e7eb; /* 訊息間隔線 */
      }
      
      /* 用戶訊息 */
      .msg.user {
        background: white; /* 用戶訊息背景 */
      }
      
      /* AI 訊息 */
      .msg.assistant {
        background: #f7f7f8; /* AI 訊息背景 */
        border-top: 1px solid #e5e7eb;
      }
      
      /* 頭像 */
      .msg-avatar {
        width: 30px;
        height: 30px;
        min-width: 30px;
        border-radius: 4px;
        background: #10a37f;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        font-weight: bold;
        margin-right: 15px;
      }
      
      .msg.user .msg-avatar {
        background: #3b82f6; /* 用戶頭像顏色 */
      }
      
      /* 訊息氣泡 (更像內容區塊) */
      .msg-bubble {
        flex: 1;
        padding: 0; /* 移除氣泡內邊距 */
        margin: 0;
        line-height: 1.6;
        color: #374151;
      }
      
      /* 訊息內容的樣式重置 */
      .msg-bubble p:first-child {
        margin-top: 0;
      }
      .msg-bubble p:last-child {
        margin-bottom: 0;
      }
      
      /* Markdown 渲染樣式 */
      .msg-bubble pre {
        background: #202123; /* 代碼塊背景 */
        color: #f8f8f2;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
        position: relative;
        margin: 15px 0;
      }
      
      .msg-bubble pre code {
        display: block;
        padding: 0;
        background: none;
      }
      
      .msg-bubble table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px 0;
      }
      
      .msg-bubble th, .msg-bubble td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      
      .msg-bubble th {
        background-color: #f2f2f2;
      }
      
      .msg-bubble blockquote {
        border-left: 4px solid #ccc;
        padding-left: 15px;
        margin: 15px 0;
        color: #666;
      }
      
      .msg-bubble ul, .msg-bubble ol {
        margin: 15px 0;
        padding-left: 20px;
      }

      /* 輸入區域 */
      .chat-input-area {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        flex-direction: column; /* 允許快速按鈕在上方 */
        align-items: center;
        padding: 10px 0; /* 調整 padding */
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }

      /* 快速按鈕容器 */
      .quick-replies-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        padding: 15px 20px;
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
      }

      /* 快速按鈕樣式 (膠囊/標籤風格) */
      .quick-reply-btn {
        padding: 8px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 20px; /* 膠囊形狀 */
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        user-select: none;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .quick-reply-btn:hover {
        background: #f3f4f6;
        border-color: #ccc;
      }
      
      .input-wrapper {
        width: 100%;
        max-width: 800px;
        display: flex;
        align-items: flex-end;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 8px 12px;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin: 0 20px; /* 確保在小螢幕上有邊距 */
      }
      
      .chat-input {
        flex-grow: 1;
        border: none;
        resize: none; /* 禁用瀏覽器自帶的拖拽調整大小 */
        outline: none;
        padding: 5px 0;
        font-size: 16px;
        line-height: 1.5;
        max-height: 200px; /* 限制最大高度 */
        overflow-y: auto;
      }
      
      .send-btn {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        padding: 8px;
        margin-left: 10px;
        font-size: 24px;
        transition: color 0.2s;
      }
      
      .send-btn:disabled {
        color: #ccc;
        cursor: not-allowed;
      }
      
      /* AI 思考中動畫 */
      .ai-loading {
        display: flex;
        align-items: center;
        font-style: italic;
        color: #6b7280;
      }
      
      .ai-loading-dots {
        display: flex;
        margin-left: 10px;
      }
      
      .ai-loading-dot {
        width: 6px;
        height: 6px;
        margin: 0 2px;
        background-color: #3b82f6;
        border-radius: 50%;
        animation: dot-flashing 1s infinite alternate;
      }
      
      .ai-loading-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .ai-loading-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes dot-flashing {
        0% {
          opacity: 0.2;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
    
    <!-- 引入 marked.js 用於專業 Markdown 渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入 highlight.js 用於代碼語法高亮 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- 引入 highlight.js 支援的語言 (可根據需求增減) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <!-- 引入 Font Awesome 圖標庫 (用於發送按鈕等) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  </head>
  <body>
    <!-- 登入頁面 -->
    <div id="loginPage" class="login-page">
      <div class="login-container">
        <div class="app-logo">AIJob短影音智能體</div>
        <div class="app-subtitle">您的個人化短影音創作專家</div>
        <div class="login-prompt">請登入以繼續</div>
        <button id="loginBtn" class="login-btn">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png" alt="Google Logo" class="google-logo">
          使用 Google 登入
        </button>
      </div>
    </div>
    
    <!-- 主應用程式頁面 -->
    <div id="mainApp" class="main-app" style="display: none;">
      <div class="app-container">
        <!-- 側邊欄 -->
        <div id="sidebar" class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-title">歷史紀錄</div>
            <button class="sidebar-close" onclick="toggleSidebar()">×</button>
          </div>
          <div id="sidebarMenu" class="sidebar-menu">
            <!-- 歷史紀錄項目將在這裡動態插入 -->
          </div>
        </div>
        
        <div class="main-content">
          <!-- 頂部導航欄 -->
          <div class="top-navbar">
            <div class="navbar-left">
              <div id="navbarTitle" class="navbar-title clickable-title" onclick="showPage('homepage')">AIJob短影音智能體</div>
              <div class="navbar-tabs">
                <button class="navbar-tab" data-page="homepage" onclick="showPage('homepage')">首頁</button>
                <button class="navbar-tab" data-page="mode1" onclick="showPage('mode1')">一鍵生成</button>
                <button class="navbar-tab active" data-page="mode2" onclick="showPage('mode2')">AI顧問</button>
                <button class="navbar-tab" data-page="mode3" onclick="showPage('mode3')">我的腳本</button>
                <button class="navbar-tab" data-page="userDB" onclick="showPage('userDB')">用戶資料庫</button>
              </div>
            </div>
            <div class="navbar-right">
              <div id="userInfo" class="user-info">
                <img id="userAvatar" src="" alt="Avatar" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
                <span id="userName"></span>
              </div>
              <button id="logoutBtn" class="logout-btn">登出</button>
              <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
              </button>
            </div>
          </div>
          
          <!-- 頁面內容 -->
          <div class="page-content">
            <!-- 首頁 -->
            <div id="homepage" class="homepage" style="display: none;">
              <div class="homepage-title">歡迎使用 AIJob短影音智能體</div>
              <div class="homepage-subtitle">您的個人化短影音創作專家，選擇一個模式開始創作吧！</div>
              <div class="mode-cards">
                <div class="mode-card" onclick="showPage('mode1')">
                  <div class="mode-card-icon">⚡️</div>
                  <div class="mode-card-title">一鍵生成</div>
                  <div class="mode-card-desc">快速輸入主題，AI立即生成完整的短影音腳本、文案和關鍵字。</div>
                </div>
                <div class="mode-card" onclick="showPage('mode2')">
                  <div class="mode-card-icon">💬</div>
                  <div class="mode-card-title">AI顧問</div>
                  <div class="mode-card-desc">與AI進行對話式互動，從帳號定位、選題到腳本創作，提供全程指導。</div>
                </div>
                <div class="mode-card" onclick="showPage('mode3')">
                  <div class="mode-card-icon">🗂️</div>
                  <div class="mode-card-title">我的腳本</div>
                  <div class="mode-card-desc">查看、編輯和管理所有已生成的短影音腳本。</div>
                </div>
              </div>
            </div>
            
            <!-- 模式1：一鍵生成頁面 -->
            <div id="mode1Page" class="mode1-page" style="display: none;">
              <div class="mode1-left">
                <div class="section-title">
                  <i class="fas fa-cog"></i>
                  生成設定
                </div>
                <!-- 設定表單 -->
                <div class="form-group">
                  <label for="platformSelect">目標平台</label>
                  <select id="platformSelect" class="input-field">
                    <option value="tiktok">TikTok 抖音</option>
                    <option value="youtube">YouTube Shorts</option>
                    <option value="instagram">Instagram Reels</option>
                    <option value="facebook">Facebook Reels</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="topicInput">主題/關鍵字</label>
                  <input type="text" id="topicInput" class="input-field" placeholder="例如：夏季美白保養、最新AI技術" />
                </div>
                <div class="form-group">
                  <label for="styleSelect">風格</label>
                  <select id="styleSelect" class="input-field">
                    <option value="funny">幽默風趣</option>
                    <option value="professional">專業知識</option>
                    <option value="lifestyle">生活分享</option>
                    <option value="review">產品評測</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="durationSelect">影片長度</label>
                  <select id="durationSelect" class="input-field">
                    <option value="15">15 秒內</option>
                    <option value="30">30 秒內</option>
                    <option value="60">60 秒內</option>
                  </select>
                </div>
                <button id="generateScriptBtn" class="primary-btn" onclick="generateScript()">
                  <i class="fas fa-magic"></i>
                  一鍵生成腳本
                </button>
              </div>
              
              <div class="mode1-right">
                <div class="section-title">
                  <i class="fas fa-file-alt"></i>
                  生成結果
                </div>
                <div id="scriptResult" class="result-block">
                  <!-- 腳本結果將在這裡顯示 -->
                  <p class="placeholder-text">點擊「一鍵生成腳本」後，結果將會顯示在這裡。</p>
                </div>
                <div class="result-actions">
                  <button id="saveScriptBtn" class="secondary-btn" onclick="saveScript()" style="display: none;">
                    <i class="fas fa-save"></i>
                    儲存腳本
                  </button>
                  <button id="copyScriptBtn" class="secondary-btn" onclick="copyResult('scriptResult')" style="display: none;">
                    <i class="fas fa-copy"></i>
                    複製結果
                  </button>
                </div>
              </div>
            </div>
            
            <!-- 模式2：AI顧問對話頁面 (重構後) -->
            <div id="mode2Page" class="mode2-page">
              <div id="chat-container" class="chat-container">
                <!-- 聊天訊息將在這裡動態插入 -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 輸入區域 -->
      <div class="chat-input-area">
        <!-- 快速按鈕容器 -->
        <div id="quick-replies" class="quick-replies-container">
          <!-- 快速按鈕將在這裡動態插入 -->
        </div>

        <div class="input-wrapper">
          <textarea id="chat-input" class="chat-input" placeholder="向AI顧問提問..." rows="1"></textarea>
          <button id="send-btn" class="send-btn" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 提示框 -->
    <div id="toast" class="toast"></div>
    
    <!-- 授權彈窗覆蓋層 -->
    <div id="popupOverlay" class="popup-overlay" style="display: none;">
      <div class="popup-content">
        <p>正在進行 Google 登入...</p>
      </div>
    </div>
    
    <!-- 用戶資料庫側邊頁面 -->
    <div id="userDBPage" class="sidebar-page-overlay" style="display: none;">
      <div class="sidebar-page-container">
        <div class="sidebar-page-header">
          <h2>用戶資料庫</h2>
          <button class="drawer-close-btn" onclick="closeUserDBPage()">×</button>
        </div>
        <div class="sidebar-page-content">
          <div class="tabs-container">
            <button class="result-tab active" data-tab="positioning" onclick="switchTab('positioning')">帳號定位</button>
            <button class="result-tab" data-tab="topics" onclick="switchTab('topics')">腳本選題</button>
            <button class="result-tab" data-tab="scripts" onclick="switchTab('scripts')">我的腳本</button>
            <button class="result-tab" data-tab="memory" onclick="switchTab('memory')">AI記憶</button>
          </div>
          
          <div id="tabContent">
            <!-- 帳號定位 Tab -->
            <div id="positioningTab" class="tab-content active">
              <div class="section-title">
                <i class="fas fa-bullseye"></i>
                帳號定位分析
              </div>
              <div class="form-group">
                <label for="positioningInput">請輸入您的帳號定位描述</label>
                <textarea id="positioningInput" class="input-field" rows="3" placeholder="例如：專注於分享 3C 科技產品的開箱與評測，風格偏向幽默風趣。"></textarea>
              </div>
              <button class="primary-btn" onclick="analyzePositioning()">
                <i class="fas fa-search"></i>
                開始分析
              </button>
              
              <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-chart-line"></i>
                分析結果
              </div>
              <div id="positioningResult" class="result-block">
                <p class="placeholder-text">分析結果將會顯示在這裡。</p>
              </div>
              
              <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-history"></i>
                歷史定位記錄
              </div>
              <div id="positioningHistory" class="history-list">
                <!-- 歷史記錄將在這裡動態插入 -->
              </div>
            </div>
            
            <!-- 腳本選題 Tab -->
            <div id="topicsTab" class="tab-content" style="display: none;">
              <div class="section-title">
                <i class="fas fa-lightbulb"></i>
                腳本選題建議
              </div>
              <div class="form-group">
                <label for="topicPlatformSelect">目標平台</label>
                <select id="topicPlatformSelect" class="input-field">
                  <option value="tiktok">TikTok 抖音</option>
                  <option value="youtube">YouTube Shorts</option>
                  <option value="instagram">Instagram Reels</option>
                  <option value="facebook">Facebook Reels</option>
                </select>
              </div>
              <div class="form-group">
                <label for="topicTopicInput">主題/關鍵字</label>
                <input type="text" id="topicTopicInput" class="input-field" placeholder="例如：夏季美白保養、最新AI技術" />
              </div>
              <button class="primary-btn" onclick="selectTopics()">
                <i class="fas fa-search"></i>
                獲取選題建議
              </button>
              
              <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-list"></i>
                建議列表
              </div>
              <div id="topicSelectionResult" class="result-block">
                <p class="placeholder-text">選題建議將會顯示在這裡。</p>
              </div>
            </div>
            
            <!-- 我的腳本 Tab -->
            <div id="scriptsTab" class="tab-content" style="display: none;">
              <div class="section-title">
                <i class="fas fa-scroll"></i>
                已儲存腳本
              </div>
              <div id="myScriptsList" class="history-list">
                <!-- 已儲存腳本列表將在這裡動態插入 -->
              </div>
            </div>
            
            <!-- AI記憶 Tab -->
            <div id="memoryTab" class="tab-content" style="display: none;">
              <div class="section-title">
                <i class="fas fa-brain"></i>
                AI 長短期記憶
              </div>
              <div id="memoryContent" class="result-block">
                <p class="placeholder-text">點擊下方按鈕載入 AI 記憶狀態。</p>
              </div>
              <button class="primary-btn" onclick="loadMemoryStatus()">
                <i class="fas fa-sync-alt"></i>
                載入記憶狀態
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      // 全局變量
      let accessToken = localStorage.getItem('accessToken') || null;
      let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      let isSending = false;
      let lastSubmitAt = 0;
      let chatHistory = []; // 用於存儲 AI 顧問模式的對話歷史
      
      // DOM 元素
      const loginPage = document.getElementById('loginPage');
      const mainApp = document.getElementById('mainApp');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const userNameEl = document.getElementById('userName');
      const userAvatarEl = document.getElementById('userAvatar');
      const toastEl = document.getElementById('toast');
      const popupOverlay = document.getElementById('popupOverlay');
      const sidebar = document.getElementById('sidebar');
      const sidebarMenu = document.getElementById('sidebarMenu');
      const userDBPage = document.getElementById('userDBPage');
      
      // 模式2 (AI顧問) 相關 DOM 元素
      const chatEl = document.getElementById('chat-container');
      const inputEl = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const quickRepliesEl = document.getElementById('quick-replies');
      
      // 模式1 (一鍵生成) 相關 DOM 元素
      const platformSelect = document.getElementById('platformSelect');
      const topicInput = document.getElementById('topicInput');
      const styleSelect = document.getElementById('styleSelect');
      const durationSelect = document.getElementById('durationSelect');
      const scriptResultEl = document.getElementById('scriptResult');
      const saveScriptBtn = document.getElementById('saveScriptBtn');
      const copyScriptBtn = document.getElementById('copyScriptBtn');
      
      // 用戶資料庫相關 DOM 元素
      const positioningInput = document.getElementById('positioningInput');
      const topicTopicInput = document.getElementById('topicTopicInput');
      
      // 預設的快速按鈕
      const initialQuickReplies = [
        "請幫我規劃一個美食短影音腳本",
        "目前有哪些熱門的短影音平台？",
        "如何提升我的短影音曝光率？",
        "我需要一個關於科技產品的腳本"
      ];
      
      // --- 核心功能函數 ---
      
      // 顯示頁面
      function showPage(pageId) {
        document.querySelectorAll('.homepage, .mode1-page, .mode2-page, .mode3-page, .userDB-page').forEach(el => {
          el.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'flex';
        
        // 更新導航標籤狀態
        document.querySelectorAll('.navbar-tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.getAttribute('data-page') === pageId) {
            tab.classList.add('active');
          }
        });
        
        // 特殊處理 AI 顧問模式的初始化
        if (pageId === 'mode2') {
          initializeChat();
        }
      }
      
      // 登入/登出 UI 更新
      function updateAuthUI(loggedIn) {
        if (loggedIn) {
          loginPage.style.display = 'none';
          mainApp.style.display = 'block';
          updatePersonalInfo();
          showPage('homepage');
        } else {
          loginPage.style.display = 'flex';
          mainApp.style.display = 'none';
        }
      }
      
      // 更新個人資訊
      function updatePersonalInfo() {
        if (currentUser) {
          userNameEl.textContent = currentUser.name || currentUser.email;
          if (currentUser.picture) {
            userAvatarEl.src = currentUser.picture;
          } else {
            userAvatarEl.src = 'default-avatar.png'; // 預設頭像
          }
        }
      }
      
      // 模擬登入
      function login() {
        const authUrl = `https://aivideobackend.zeabur.app/api/auth/google/login`;
        const authWindow = window.open(authUrl, '_blank', 'width=500,height=600');
        
        if (authWindow) {
          popupOverlay.style.display = 'flex';
          window.addEventListener('message', handleAuthMessage);
        } else {
          showToast('請允許彈出視窗以完成登入', 5000);
        }
      }
      
      // 登出
      function logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('currentUser');
        accessToken = null;
        currentUser = null;
        updateAuthUI(false);
        showToast('登出成功', 3000);
      }
      
      // 處理授權訊息
      function handleAuthMessage(event) {
        // ... (保留原有的 handleAuthMessage 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 處理授權回調
      async function handleAuthCallback() {
        // ... (保留原有的 handleAuthCallback 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 彈出提示框函數
      function showToast(message, duration = 3000) {
        // ... (保留原有的 showToast 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 側邊欄控制
      function toggleSidebar() {
        sidebar.classList.toggle('open');
        document.querySelector('.main-content').classList.toggle('sidebar-open');
      }
      
      // 關閉用戶資料庫頁面
      function closeUserDBPage() {
        userDBPage.style.display = 'none';
        showPage('homepage'); // 返回首頁
      }
      
      // 切換用戶資料庫 Tab
      function switchTab(tabName) {
        // ... (保留原有的 switchTab 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 複製結果
      function copyResult(elementId) {
        // ... (保留原有的 copyResult 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 生成腳本 (Mode 1)
      async function generateScript() {
        // ... (保留原有的 generateScript 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 儲存腳本
      async function saveScript() {
        // ... (保留原有的 saveScript 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 載入我的腳本
      async function loadMyScripts() {
        // ... (保留原有的 loadMyScripts 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 刪除腳本
      async function deleteScript(scriptId) {
        // ... (保留原有的 deleteScript 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 格式化台灣時間
      function formatTaiwanTime(dateString) {
        // ... (保留原有的 formatTaiwanTime 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 重新生成結果
      async function regenerateResult(type) {
        // ... (保留原有的 regenerateResult 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 更新結果區塊內容
      function updateResultBlock(elementId, content, hasContent) {
        // ... (保留原有的 updateResultBlock 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 帳號定位功能
      async function analyzePositioning() {
        // ... (保留原有的 analyzePositioning 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 腳本選題功能
      async function selectTopics() {
        // ... (保留原有的 selectTopics 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // 載入記憶狀態
      async function loadMemoryStatus() {
        // ... (保留原有的 loadMemoryStatus 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
      }
      
      // --- AI 顧問模式 (Mode 2) 重構部分 ---
      
      // 1. 初始化 Markdown 渲染器
      marked.setOptions({
        renderer: new marked.Renderer(),
        gfm: true,
        breaks: true,
        sanitize: true, // 啟用安全模式
        langPrefix: 'hljs language-', // highlight.js 前綴
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        }
      });
      
      // 2. 快速按鈕邏輯
      function showQuickReplies(replies) {
        quickRepliesEl.innerHTML = ''; // 清空現有按鈕
        quickRepliesEl.style.display = 'flex';
        
        replies.forEach(text => {
          const button = document.createElement('button');
          button.className = 'quick-reply-btn';
          button.textContent = text;
          button.addEventListener('click', () => {
            send(text); // 點擊後直接發送
            hideQuickReplies();
          });
          quickRepliesEl.appendChild(button);
        });
        
        // 確保滾動到最底部
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function hideQuickReplies() {
        quickRepliesEl.innerHTML = '';
        quickRepliesEl.style.display = 'none';
      }
      
      // 3. 訊息追加邏輯 (使用 marked.js)
      function append(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        
        // 創建頭像元素
        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.textContent = role === 'user' ? '你' : '🤖';
        if (role === 'user' && currentUser && currentUser.picture) {
            avatar.innerHTML = `<img src="${currentUser.picture}" style="width: 100%; height: 100%; border-radius: 4px; object-fit: cover;" alt="用戶頭像">`;
        }
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // 渲染內容
        if (text) {
          bubble.innerHTML = marked.parse(text);
          // 渲染後，對代碼塊進行高亮
          bubble.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        }
        
        div.appendChild(avatar);
        div.appendChild(bubble);
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
        
        return { container: div, bubble: bubble };
      }
      
      // 4. 助理訊息更新邏輯 (串流)
      function updateAssistantNode(nodeObj, text) {
        if (nodeObj.bubble) {
          // 移除載入動畫
          const loadingDiv = nodeObj.bubble.querySelector('.ai-loading');
          if (loadingDiv) {
            loadingDiv.remove();
          }
          
          // 使用 marked.js 渲染 Markdown
          nodeObj.bubble.innerHTML = marked.parse(text);
          
          // 渲染後，對代碼塊進行高亮
          nodeObj.bubble.querySelectorAll('pre code').forEach((block) => {
            if (!block.classList.contains('hljs')) {
                hljs.highlightElement(block);
            }
          });
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }
      
      // 5. 輸入框自動調整高度和按鈕啟用/禁用邏輯
      function autoResizeTextarea() {
        // 重置高度，然後設置為滾動高度
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
        
        // 檢查內容以啟用/禁用按鈕
        sendBtn.disabled = inputEl.value.trim() === '';
      }
      
      // 6. 發送訊息 (Mode 2) - 核心邏輯保留
      async function send(message) {
        if (!message || isSending) return;
        
        // 隱藏快速按鈕
        hideQuickReplies();
        
        // 1. 顯示用戶訊息
        append('user', message);
        
        // 2. 顯示 AI 載入狀態
        const assistantNode = append('assistant', '');
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'ai-loading';
        loadingDiv.innerHTML = `
          <span>AI正在思考中</span>
          <div class="ai-loading-dots">
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
          </div>
        `;
        assistantNode.bubble.appendChild(loadingDiv);
        
        // 3. 鎖定介面
        isSending = true;
        sendBtn.disabled = true;
        inputEl.value = '';
        autoResizeTextarea();
        
        // 準備歷史紀錄 (這裡使用 chatHistory，確保與後端 API 格式一致)
        chatHistory.push({ role: 'user', content: message });
        
        // --- 核心 API 呼叫邏輯 (保留並適應新的 UI 更新) ---
        let fullResponse = '';
        
        try {
          // 這裡的 API 呼叫邏輯應該與您原始的 sendMessage 類似，但使用新的 chatHistory
          const endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          // 構建請求體
          const body = JSON.stringify({
              message: message,
              history: chatHistory.slice(0, -1), // 傳遞除了最新訊息之外的歷史紀錄
              user_id: currentUser ? currentUser.id : null,
              // 其他參數 (platform, topic, style, duration) 暫時不從 chat 介面傳遞，除非有專門的設定區
          });

          const response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder('utf-8');
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value, { stream: true });
            
            // 處理 SSE 格式的數據
            chunk.split('\n').forEach(line => {
                if (line.startsWith('data:')) {
                    const data = line.substring(5).trim();
                    if (data === '[DONE]') {
                        return;
                    }
                    try {
                        const json = JSON.parse(data);
                        if (json.text) {
                            fullResponse += json.text;
                            updateAssistantNode(assistantNode, fullResponse);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e, data);
                    }
                }
            });
          }
          
        } catch (error) {
          console.error('Chat API Error:', error);
          fullResponse = `抱歉，AI顧問目前無法連接或發生錯誤：${error.message}`;
          updateAssistantNode(assistantNode, fullResponse);
        }
        
        // 4. 解鎖介面
        isSending = false;
        sendBtn.disabled = false;
        
        // 5. 將最終訊息加入歷史紀錄
        chatHistory.push({ role: 'assistant', content: fullResponse });

        // 6. 顯示下一組快速按鈕 (例如，與本次回覆相關的後續問題)
        const nextQuickReplies = [
          "如何將腳本轉為影片？",
          "請提供一個腳本範例",
          "還有其他風格建議嗎？"
        ];
        showQuickReplies(nextQuickReplies);
      }
      
      // 7. AI 顧問模式初始化
      function initializeChat() {
        if (chatEl.children.length === 0) {
            // 顯示初始歡迎訊息
            const welcomeMessage = "您好！我是您的AI短影音創作顧問。請問您想製作哪種主題、平台或風格的短影音呢？";
            append('assistant', welcomeMessage);
            
            // 顯示初始快速按鈕
            showQuickReplies(initialQuickReplies);
        }
      }
      
      // --- 事件監聽器 ---
      
      document.addEventListener('DOMContentLoaded', async () => {
        // ... (保留原有的 DOMContentLoaded 邏輯)
        // 這裡的邏輯很長，為了簡潔，假設它已經被保留在原始文件中
        
        // 替換舊的聊天輸入事件
        // 假設原始文件中有類似 sendBtn.addEventListener('click', sendMessage); 的程式碼，現在將其替換為新的邏輯
        
        // 替換或新增 AI 顧問模式的事件監聽
        inputEl.addEventListener('input', autoResizeTextarea);
        
        inputEl.addEventListener('keypress', (e) => {
          // 檢查是否為 Enter 鍵，並且沒有按 Shift 鍵 (模擬 ChatGPT 行為)
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // 阻止換行
            const message = inputEl.value.trim();
            if (message) {
              send(message);
            }
          }
        });
        
        sendBtn.addEventListener('click', () => {
          const message = inputEl.value.trim();
          if (message) {
            send(message);
          }
        });
        
        // 初始檢查
        updateAuthUI(accessToken && currentUser);
        
        // 檢查是否有認證回調
        await handleAuthCallback();
        
        // 初始顯示首頁
        showPage('homepage');
      });
      
    </script>
  </body>
</html>
