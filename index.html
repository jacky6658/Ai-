<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AIJob短影音智能體</title>
    <style>
      :root { color-scheme: light; }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#ffffff; color:#1a1a1a; }
      .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
      
      /* 主要布局：左右分欄 5:5 */
      .main-layout { 
        display: flex; 
        gap: 20px; 
        min-height: calc(100vh - 100px);
      }
      
      /* 左側面板 - 5份 */
      .left-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* 右側面板 - 5份 */
      .right-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* 左側內容區域 */
      .left-content {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      /* 結果區塊標籤切換 */
      .result-tabs {
        display: flex;
        background: white;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-bottom: none;
        overflow: hidden;
      }
      
      .result-tab {
        flex: 1;
        padding: 16px 20px;
        background: #f8fafc;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-right: 1px solid #e5e7eb;
      }
      
      .result-tab:last-child {
        border-right: none;
      }
      
      .result-tab.active {
        background: white;
        color: #1f2937;
        border-bottom: 2px solid #3b82f6;
      }
      
      .result-tab:hover {
        background: #f1f5f9;
      }
      
      /* 結果區塊容器 */
      .results-container {
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-top: none;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .result-content {
        flex: 1;
        padding: 20px;
        min-height: 400px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-content.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      /* 結果區塊新樣式 */
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .result-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
      }
      
      .generate-btn {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .generate-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }
      
      .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      
      .result-body {
        min-height: 200px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-body.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      .result-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }
      
      .save-btn, .regenerate-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .save-btn {
        background: #10b981;
        color: white;
        border-color: #10b981;
      }
      
      .save-btn:hover {
        background: #059669;
        border-color: #059669;
      }
      
      .regenerate-btn {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
      }
      
      .regenerate-btn:hover {
        background: #d97706;
        border-color: #d97706;
      }
      
      /* 聊天區域樣式 */
      .chat-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 20px;
        min-height: 600px;
        flex: 1;
      }
      
      .chat-messages {
        background: white;
        border-radius: 12px;
        padding: 16px;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex: 1;
      }
      
      .message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      
      .message.user {
        background: #dbeafe;
        color: #1e40af;
        margin-left: 20px;
      }
      
      .message.ai {
        background: #f0f9ff;
        color: #0c4a6e;
        margin-right: 20px;
      }
      
      .input-row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }
      
      .input-row textarea {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 60px;
        max-height: 200px;
        line-height: 1.4;
        font-family: inherit;
      }
      
      .input-row textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .input-row button {
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      
      .input-row button:hover {
        background: #2563eb;
      }
      
      /* 用戶抽屜樣式 - 左右兩欄彈出式視窗 */
      .user-drawer {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        width: 800px;
        max-width: 95vw;
        height: 600px;
        max-height: 90vh;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
      }
      
      .user-drawer.open {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        visibility: visible;
      }
      
      .user-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      
      .user-drawer-overlay.open {
        display: block;
      }
      
      .user-drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        flex-shrink: 0;
      }
      
      .user-drawer-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .app-logo {
        font-size: 20px;
        font-weight: bold;
        color: #3b82f6;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .app-name {
        font-size: 16px;
        color: #374151;
        font-weight: 500;
      }
      
      .user-drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .user-drawer-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      /* 左右兩欄布局 */
      .user-drawer-body {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      /* 左側選單欄 */
      .user-drawer-sidebar {
        width: 250px;
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      
      .user-profile {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .user-drawer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
      }
      
      .user-drawer-info h3 {
        margin: 0;
        font-size: 16px;
        color: #1f2937;
        font-weight: 600;
      }
      
      .user-drawer-info p {
        margin: 4px 0 0 0;
        font-size: 14px;
        color: #6b7280;
      }
      
      /* 右側內容區域 */
      .user-drawer-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: white;
      }
      
      
      .user-drawer-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
      }
      
      .user-drawer-menu li {
        margin: 0;
      }
      
      .user-drawer-menu a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #374151;
        text-decoration: none;
        border-radius: 0;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        font-weight: 500;
      }
      
      .user-drawer-menu a:hover {
        background: #f3f4f6;
        color: #1f2937;
      }
      
      .user-drawer-menu a.active {
        background: #dbeafe;
        color: #1d4ed8;
        border-left-color: #3b82f6;
        font-weight: 600;
      }
      
      .user-drawer-menu .icon {
        width: 20px;
        height: 20px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h2 {
        margin: 0 0 24px 0;
        font-size: 24px;
        color: #1f2937;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 12px;
      }
      
      .user-info-detail {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      
      .info-item label {
        font-weight: 600;
        color: #374151;
        min-width: 80px;
      }
      
      .info-item span {
        color: #6b7280;
        word-break: break-all;
      }
      
      .generations-list, .conversations-list, .memory-content {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .generation-item, .conversation-item {
        background: #f9fafb;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid #3b82f6;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform, .generation-topic {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      
      .generation-content, .conversation-summary {
        color: #374151;
        line-height: 1.5;
        margin-bottom: 8px;
      }
      
      .generation-date, .conversation-date {
        font-size: 12px;
        color: #9ca3af;
      }
      
      .loading-text {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 20px;
      }
      
      /* 抽屜內容區域樣式 */
      .drawer-content {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      
      .user-info-detail {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }
      
      .info-item {
        display: flex;
        margin-bottom: 10px;
      }
      
      .info-item label {
        font-weight: bold;
        min-width: 80px;
        color: #666;
      }
      
      .info-item span {
        color: #333;
      }
      
      .generations-list,
      .conversations-list,
      .memory-content {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .generation-item,
      .conversation-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 3px solid #007bff;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-topic {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-content,
      .conversation-summary {
        color: #333;
        margin-bottom: 5px;
        line-height: 1.4;
      }
      
      .generation-date,
      .conversation-date {
        color: #666;
        font-size: 12px;
      }
      
      .loading-text {
        text-align: center;
        color: #666;
        font-style: italic;
      }
      
      /* 設定區塊樣式 */
      .settings-block {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      
      .settings-block h3 {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .setting-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .setting-item label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }
      
      .setting-item input,
      .setting-item select {
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      
      .setting-item input:focus,
      .setting-item select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .apply-btn {
        width: 100%;
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .apply-btn:hover {
        background: #2563eb;
      }
      
      /* AI 說明區塊樣式 */
      .ai-instructions {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      
      .ai-instructions h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .instruction-list p {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 控制區域樣式 */
      .controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .controls .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .control-btn, .secondary-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
      }
      
      .control-btn {
        background: #10b981;
        color: white;
      }
      
      .control-btn:hover {
        background: #059669;
      }
      
      .secondary-btn {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }
      
      .secondary-btn:hover {
        background: #e5e7eb;
      }
      
      .controls textarea {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 50px;
        font-family: inherit;
      }
      
      .controls textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .send-btn {
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      
      .send-btn:hover {
        background: #2563eb;
      }
      
      /* 手機版優化 */
      @media (max-width: 768px) {
        .container { padding: 12px; }
        .main-layout { 
          flex-direction: column; 
          gap: 16px;
        }
        .left-panel { 
          order: 1;
        }
        .right-panel { 
          order: 2;
        }
        .left-content {
          padding: 16px;
        }
        .settings-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .chat-messages {
          min-height: 300px;
          max-height: 400px;
        }
        .result-tabs {
          flex-direction: column;
        }
        .result-tab {
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
        }
        .result-tab:last-child {
          border-bottom: none;
        }
        .result-content {
          min-height: 200px;
        }
        .user-drawer {
          width: 280px;
          right: -280px;
        }
        .input-row {
          flex-direction: column;
          gap: 8px;
        }
        .input-row button {
          width: 100%;
        }
        h1 { font-size: 16px; margin-bottom: 12px; }
        .chat { height: 50vh; padding: 12px; }
        .msg-bubble { max-width: 85%; padding: 10px 14px; font-size: 14px; }
        .settings-block { padding: 16px; margin-bottom: 12px; }
        .settings-block h3 { font-size: 14px; margin-bottom: 12px; }
        .settings-grid { grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
        .setting-item input, .setting-item select { padding: 10px 12px; font-size: 16px; }
        .apply-btn { padding: 12px 16px; font-size: 14px; }
        .controls { flex-direction: column; gap: 10px; }
        .controls .row { flex-direction: row !important; justify-content: space-between; }
        .controls .row button { flex: 1; margin: 0 4px; }
        textarea { min-height: 50px; font-size: 16px; }
        button { padding: 12px 16px; font-size: 14px; }
        .results-block { padding: 16px; }
        .results-block h3 { font-size: 14px; }
        .result-item h4 { font-size: 13px; }
        .result-item .content { padding: 10px; font-size: 14px; }
        .toast { top: 10px; right: 10px; left: 10px; max-width: none; font-size: 13px; }
      }
      h1 { font-size: 18px; font-weight: 600; color:#2563eb; margin: 0 0 16px; }
      
      /* 用戶認證樣式 */
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 16px; 
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-info { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .user-info:hover {
        background: #f3f4f6;
      }
      .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #e5e7eb; }
      .user-name { font-size: 14px; font-weight: 500; color: #374151; }
      .auth-buttons { display: flex; gap: 8px; }
      .login-btn, .logout-btn { 
        padding: 8px 16px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.2s;
      }
      .login-btn { 
        background: #4285f4; 
        color: white; 
      }
      .login-btn:hover { background: #3367d6; }
      .logout-btn { 
        background: #f3f4f6; 
        color: #374151; 
        border: 1px solid #d1d5db;
      }
      .logout-btn:hover { background: #e5e7eb; }
      
      /* 彈跳視窗登入樣式 */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      
      .popup-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }
      
      .popup-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      
      .popup-message {
        font-size: 16px;
        color: #2c3e50;
        margin-bottom: 20px;
      }
      
      .popup-btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 10px;
      }
      
      .popup-btn:hover {
        background: #2980b9;
      }
      
      .popup-btn.secondary {
        background: #95a5a6;
      }
      
      .popup-btn.secondary:hover {
        background: #7f8c8d;
      }
      
      /* 手機版用戶認證優化 */
      @media (max-width: 768px) {
        .header { flex-direction: column; align-items: flex-start; gap: 12px; }
        .user-info { width: 100%; justify-content: space-between; }
        .auth-buttons { width: 100%; justify-content: flex-end; }
        .login-btn, .logout-btn { padding: 10px 16px; font-size: 16px; }
      }
      .chat { border: 1px solid #e5e7eb; background: #f9fafb; border-radius: 12px; height: 60vh; overflow: auto; padding: 16px; }
      .msg { margin: 12px 0; line-height: 1.6; display: flex; }
      .msg.user { justify-content: flex-end; }
      .msg.assistant { justify-content: flex-start; }
      .msg-bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; white-space: pre-wrap; word-wrap: break-word; }
      .msg.user .msg-bubble { background: #3b82f6; color: #ffffff; border-bottom-right-radius: 4px; }
      .msg.assistant .msg-bubble { background: #f3f4f6; color: #374151; border-bottom-left-radius: 4px; }
      .msg-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
      .msg.user .msg-label { text-align: right; }
      .msg.assistant .msg-label { text-align: left; }
      
      /* 載入動畫 */
      .loading { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        padding: 8px 12px;
        background: #f0f9ff;
        color: #0c4a6e;
        border-radius: 8px;
        margin-right: 20px;
        max-width: 70%;
        position: relative;
      }
      
      .loading::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid #f0f9ff;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
      }
      .spinner { 
        width: 16px; 
        height: 16px; 
        border: 2px solid #e5e7eb; 
        border-top: 2px solid #3b82f6; 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .controls { display: flex; gap: 8px; margin-top: 12px; align-items:center; }
      textarea { flex: 1; min-height: 44px; max-height: 140px; resize: vertical; border-radius: 10px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding: 10px 12px; line-height: 1.4; -webkit-appearance: none; }
      button { padding: 10px 14px; border-radius: 10px; border:1px solid #d1d5db; background:#f9fafb; color:#374151; cursor:pointer; -webkit-appearance: none; }
      button:disabled { opacity: .6; cursor:not-allowed; }
      .row { display:flex; gap:8px; flex-direction:column; }
      .meta { display:flex; gap:8px; margin-bottom:8px; align-items:center; flex-wrap:wrap; }
      .meta input, .meta select { flex:1; min-width: 200px; border-radius: 8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding:8px 10px; }
      .small { font-size:12px; color:#6b7280; }
      .tag { display:inline-block; padding:4px 8px; border:1px solid #d1d5db; border-radius:999px; font-size:12px; color:#6b7280; background:#f3f4f6; }
      
      /* 設定區塊樣式 */
      .settings-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; }
      .settings-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; cursor:pointer; user-select:none; display:flex; align-items:center; gap:8px; }
      .settings-block h3:hover { color:#1d4ed8; }
      .settings-toggle { font-size:12px; transition:transform 0.2s ease; }
      .settings-content { transition:all 0.3s ease; overflow:hidden; }
      .settings-content.collapsed { max-height:0; margin:0; padding:0; }
      .settings-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px; }
      .setting-item { display:flex; flex-direction:column; gap:6px; }
      .setting-item label { font-size:12px; color:#6b7280; font-weight:500; }
      .setting-item input, .setting-item select { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; -webkit-appearance: none; }
      .apply-btn { background:#3b82f6; border:1px solid #2563eb; color:#ffffff; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; }
      .apply-btn:hover { background:#2563eb; }
      .applied-tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
      
      /* 結果區塊樣式 */
      .results-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-top:16px; display:none; }
      .results-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; }
      .result-item { margin-bottom:16px; }
      .result-item h4 { margin:0 0 8px; color:#374151; font-size:14px; font-weight:500; }
      .result-item .content { background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:12px; color:#374151; white-space:pre-wrap; line-height:1.6; }
      
      /* 彈出框樣式 */
      .toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px; max-width: 300px; word-wrap: break-word; }
      .toast.show { animation: slideIn 0.3s ease-out; }
      .toast.hide { animation: slideOut 0.3s ease-in; }
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
      
      /* iOS Safari 特定優化 */
      @supports (-webkit-touch-callout: none) {
        .chat { -webkit-overflow-scrolling: touch; }
        textarea { -webkit-user-select: text; }
        input, select { -webkit-user-select: text; }
        .msg-bubble { -webkit-user-select: text; }
        .result-item .content { -webkit-user-select: text; }
      }
      
      /* 防止 iOS Safari 縮放 */
      input[type="text"], input[type="email"], input[type="password"], textarea, select { font-size: 16px; }
      
      /* 快速按鈕樣式 */
      .quick-buttons { 
        display: flex; 
        gap: 8px; 
        margin-bottom: 12px; 
        flex-wrap: wrap;
        justify-content: center;
      }
      .quick-btn { 
        padding: 10px 18px; 
        border-radius: 20px; 
        border: 1px solid #3b82f6; 
        background: #ffffff; 
        color: #3b82f6; 
        cursor: pointer; 
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .quick-btn:hover { 
        background: #3b82f6; 
        color: #ffffff; 
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }
      .quick-btn:active { 
        transform: translateY(0); 
        box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
      }
      
      /* 手機版快速按鈕優化 */
      @media (max-width: 768px) {
        .quick-buttons { 
          gap: 6px; 
          margin-bottom: 10px;
        }
        .quick-btn { 
          padding: 6px 12px; 
          font-size: 13px;
        }
      }
      
      /* 帳號定位記錄列表樣式 */
      .positioning-history-content {
        padding: 10px;
        max-height: 500px;
        overflow-y: auto;
      }
      
      .positioning-records {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .positioning-record-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
      }
      
      .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .record-number {
        font-weight: 600;
        color: #3b82f6;
        font-size: 14px;
      }
      
      .record-date {
        font-size: 12px;
        color: #6b7280;
      }
      
      .record-preview {
        color: #374151;
        font-size: 14px;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      
      .record-actions {
        display: flex;
        gap: 8px;
      }
      
      .view-btn, .delete-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* 詳細內容彈出視窗樣式 */
      .detail-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      
      .detail-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      
      .detail-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #111827;
      }
      
      .close-detail-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }
      
      .close-detail-btn:hover {
        background: #f3f4f6;
        color: #111827;
      }
      
      .detail-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }
      
      .detail-info {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-info span {
        font-size: 14px;
        color: #6b7280;
      }
      
      .detail-info strong {
        color: #111827;
        font-weight: 600;
      }
      
      .detail-content {
        color: #374151;
        line-height: 1.8;
        font-size: 15px;
      }
      
      /* 擴大用戶抽屜視窗 */
      .user-drawer {
        width: 85%;
        max-width: 1000px;
        height: 85vh;
        max-height: 700px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 頂部標題欄 -->
      <div class="header">
      <h1>AIJob短影音智能體</h1>
        <div class="header-right">
          <div class="user-info" id="userInfo" style="display: none;" onclick="toggleUserDrawer()">
            <img id="userAvatar" class="user-avatar" src="" alt="用戶頭像">
            <span id="userName" class="user-name"></span>
          </div>
          <div class="auth-buttons">
            <button id="loginBtn" class="login-btn">🔐 Google 登入</button>
            <button id="logoutBtn" class="logout-btn" style="display: none;">登出</button>
          </div>
        </div>
      </div>

      <!-- 主要布局：左右分欄 5:5 -->
      <div class="main-layout">
        <!-- 左側面板：設定+聊天+輸入 -->
        <div class="left-panel">
          <div class="left-content">
            <!-- 用戶需求設定區塊 -->
      <div class="settings-block">
              <h3 id="settingsToggle">📋 用戶需求設定 <span class="settings-toggle">▼</span></h3>
        <div class="settings-content" id="settingsContent">
          <div class="settings-grid">
          <div class="setting-item">
            <label>平台</label>
                    <select id="platformSelect">
              <option value="">選擇平台</option>
              <option value="TikTok">TikTok</option>
                      <option value="Instagram">Instagram Reels</option>
                      <option value="YouTube">YouTube Shorts</option>
                      <option value="Facebook">Facebook Reels</option>
            </select>
          </div>
          <div class="setting-item">
            <label>主題</label>
                    <input type="text" id="topicInput" placeholder="例如:夏季變白挑戰/美白保養">
          </div>
          <div class="setting-item">
            <label>腳本秒數</label>
                    <select id="durationInput">
                      <option value="15秒">15秒</option>
                      <option value="30秒" selected>30秒</option>
                      <option value="45秒">45秒</option>
                      <option value="60秒">60秒</option>
            </select>
          </div>
          <div class="setting-item">
            <label>帳號定位</label>
                    <input type="text" id="positioningInput" placeholder="如:健康×加密,輕鬆幽默">
          </div>
        </div>
                <button id="applyBtn" class="apply-btn">套用設定</button>
          </div>
            </div>

            <!-- AI 說明區塊 -->
            <div class="ai-instructions">
              <h3>如何與AI短影音顧問對話？</h3>
              <div class="instruction-list">
                <p><strong>方法1</strong> "用戶需求設定"選擇平台、輸入主題與帳號定位,按「套用」✅ 點選下方任一快速按紐"生成腳本"＆"腳本選題""帳號定位"按下後 AI顧問將為快速為您量身定制做屬於你的短影音內容 🎯</p>
                <p><strong>方法2</strong> "用戶需求設定"選擇平台、輸入主題與帳號定位,按「套用」✅ 不按快速鈕 直接與AI短影音顧問討論 💬</p>
                <p><strong>方法3</strong> 不設定 "用戶需求設定"直接與AI短影音顧問對話您的短影音規劃與需求 🚀</p>
                <p><strong>為您打造爆款短影音帳號的顧問！</strong> ⭐</p>
        </div>
      </div>

            <!-- 聊天區域 -->
            <div class="chat-section">
              <div class="chat-messages" id="chatMessages">
                <div class="message ai">您好！我是 AIJob短影音顧問，請告訴我您想要什麼樣的短影音內容？</div>
              </div>

      <!-- 快速按鈕區域 -->
      <div class="quick-buttons">
        <button class="quick-btn" data-text="我要如何開始？">我要如何開始？</button>
        <button class="quick-btn" data-text="我要怎麼帳號定位">我要怎麼帳號定位</button>
        <button class="quick-btn" data-text="什麼是腳本選題">什麼是腳本選題</button>
      </div>

              <div class="input-row">
                <textarea id="messageInput" placeholder="輸入訊息...(Ctrl+Enter 送出、Enter換行)"></textarea>
                <button id="sendBtn" class="send-btn">送出</button>
        </div>
      </div>
          </div>
        </div>

        <!-- 右側面板：結果區塊（可切換） -->
        <div class="right-panel">
          <!-- 結果標籤切換 -->
          <div class="result-tabs">
            <button class="result-tab active" data-tab="positioning">🎯 帳號定位</button>
            <button class="result-tab" data-tab="topics">💡 腳本選題</button>
            <button class="result-tab" data-tab="script">📝 短影音腳本</button>
          </div>
          
          <!-- 結果區塊容器 -->
          <div class="results-container">
            <!-- 帳號定位結果 -->
            <div id="positioningResult" class="result-content" style="display: block;">
              <div class="result-header">
                <h3>帳號定位分析</h3>
                <button class="generate-btn" onclick="generatePositioning()">一鍵生成帳號定位</button>
              </div>
              <div id="positioningContent" class="result-body">
                點擊「一鍵生成帳號定位」按鈕開始分析...
              </div>
              <div class="result-actions" id="positioningActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('positioning')">儲存</button>
                <button class="regenerate-btn" onclick="regenerateResult('positioning')">再換一個</button>
              </div>
            </div>
            
            <!-- 腳本選題結果 -->
            <div id="topicSelectionResult" class="result-content" style="display: none;">
              <div class="result-header">
                <h3>腳本選題推薦</h3>
                <button class="generate-btn" onclick="generateTopics()">一鍵生成選題</button>
              </div>
              <div id="topicContent" class="result-body">
                請先完成帳號定位，再進行選題推薦...
              </div>
              <div class="result-actions" id="topicActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('topics')">儲存</button>
                <button class="regenerate-btn" onclick="regenerateResult('topics')">再換一個</button>
              </div>
            </div>
            
            <!-- 短影音腳本結果 -->
            <div id="scriptResult" class="result-content" style="display: none;">
              <div class="result-header">
                <h3>短影音腳本生成</h3>
                <button class="generate-btn" onclick="generateScript()">一鍵生成腳本</button>
              </div>
              <div id="scriptContent" class="result-body">
                請先完成帳號定位和選題，再生成腳本...
              </div>
              <div class="result-actions" id="scriptActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('script')">儲存</button>
                <button class="regenerate-btn" onclick="regenerateResult('script')">再換一個</button>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- 用戶抽屜 -->
      <div id="userDrawerOverlay" class="user-drawer-overlay" onclick="closeUserDrawer()"></div>
      <div id="userDrawer" class="user-drawer">
        <!-- 標題欄 -->
        <div class="user-drawer-header">
          <div class="user-drawer-title">
            <div class="app-logo">AIJob</div>
            <span class="app-name">短影音顧問</span>
          </div>
          <button class="user-drawer-close" onclick="closeUserDrawer()">×</button>
        </div>
        
        <!-- 左右兩欄布局 -->
        <div class="user-drawer-body">
          <!-- 左側選單 -->
          <div class="user-drawer-sidebar">
            <div class="user-profile">
              <img id="drawerAvatar" class="user-drawer-avatar" src="" alt="用戶頭像">
              <div class="user-drawer-info">
                <h3 id="drawerName">用戶名稱</h3>
                <p id="drawerEmail">user@example.com</p>
              </div>
            </div>
            
            <ul class="user-drawer-menu">
              <li><a href="#" class="active" data-section="personalInfo" onclick="switchDrawerContent('personalInfo')"><span class="icon">👤</span>個人資料</a></li>
              <li><a href="#" data-section="myScripts" onclick="switchDrawerContent('myScripts')"><span class="icon">💾</span>我的腳本</a></li>
              <li><a href="#" data-section="accountPositioning" onclick="switchDrawerContent('accountPositioning')"><span class="icon">🎯</span>帳號定位</a></li>
              <li><a href="#" data-section="topicHistory" onclick="switchDrawerContent('topicHistory')"><span class="icon">💡</span>選題記錄</a></li>
              <li><a href="#" data-section="settings" onclick="switchDrawerContent('settings')"><span class="icon">⚙️</span>設定</a></li>
              <li><a href="#" data-section="usageStats" onclick="switchDrawerContent('usageStats')"><span class="icon">📊</span>使用統計</a></li>
              <li><a href="#" data-section="helpCenter" onclick="switchDrawerContent('helpCenter')"><span class="icon">❓</span>幫助中心</a></li>
              <li><a href="#" onclick="logout()"><span class="icon">🚪</span>登出</a></li>
            </ul>
          </div>
          
          <!-- 右側內容區域 -->
          <div class="user-drawer-content">
            <!-- 個人資料 -->
            <div id="personalInfo" class="content-section active">
              <h2>個人資料</h2>
              <div class="user-info-detail">
                <div class="info-item">
                  <label>姓名：</label>
                  <span id="userNameDetail">-</span>
                </div>
                <div class="info-item">
                  <label>信箱：</label>
                  <span id="userEmailDetail">-</span>
                </div>
                <div class="info-item">
                  <label>用戶ID：</label>
                  <span id="userIdDetail">-</span>
                </div>
              </div>
            </div>
            
            <!-- 我的腳本 -->
            <div id="myScripts" class="content-section">
              <h2>我的腳本</h2>
              <div id="generationsList" class="generations-list">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 帳號定位 -->
            <div id="accountPositioning" class="content-section">
              <h2>帳號定位記錄</h2>
              <div id="positioningHistoryContent" class="positioning-history-content">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 選題記錄 -->
            <div id="topicHistory" class="content-section">
              <h2>選題記錄</h2>
              <div id="conversationsList" class="conversations-list">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 設定 -->
            <div id="settings" class="content-section">
              <h2>設定</h2>
              <div class="settings-content">
                <p>設定功能開發中...</p>
              </div>
            </div>
            
            <!-- 使用統計 -->
            <div id="usageStats" class="content-section">
              <h2>使用統計</h2>
              <div class="stats-content">
                <p>統計功能開發中...</p>
              </div>
            </div>
            
            <!-- 幫助中心 -->
            <div id="helpCenter" class="content-section">
              <h2>幫助中心</h2>
              <div class="help-content">
                <p>幫助功能開發中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 彈跳視窗登入覆蓋層 -->
      <div id="popupOverlay" class="popup-overlay">
        <div class="popup-content">
          <div id="popupSpinner" class="popup-spinner"></div>
          <div id="popupMessage" class="popup-message">正在開啟 Google 登入視窗...</div>
          <div id="popupButtons" style="display: none;">
            <button id="popupRetry" class="popup-btn">重試</button>
            <button id="popupCancel" class="popup-btn secondary">取消</button>
          </div>
        </div>
      </div>


      <div id="status" class="small"></div>
      
      <!-- 結果區塊 -->
      <div id="results" class="results-block">
        <h3>📝 短影音腳本結果</h3>
        <div class="result-item">
          <h4>🎯 主題</h4>
          <div id="result-title" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>📜 腳本內容</h4>
          <div id="result-script" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>🎬 畫面感</h4>
          <div id="result-visual" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>📱 文案</h4>
          <div id="result-copy" class="content">尚未生成</div>
        </div>
      </div>
      
      <div class="small">2025 AIJob學院版權所有</div>
    </div>

    <!-- 彈出提示框 -->
    <div id="toast" class="toast" style="display: none;"></div>


    <script>
      // 新的元素引用
      const chatEl = document.getElementById('chatMessages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const applyBtn = document.getElementById('applyBtn');
      const platformSelect = document.getElementById('platformSelect');
      const topicInput = document.getElementById('topicInput');
      const durationInput = document.getElementById('durationInput');
      const positioningInput = document.getElementById('positioningInput');
      
      // 結果區塊元素
      const resultsEl = document.getElementById('results');
      const resultTitleEl = document.getElementById('result-title');
      const resultScriptEl = document.getElementById('result-script');
      const resultVisualEl = document.getElementById('result-visual');
      const resultCopyEl = document.getElementById('result-copy');
      const scriptResult = document.getElementById('scriptResult');
      const positioningResult = document.getElementById('positioningResult');
      const topicSelectionResult = document.getElementById('topicSelectionResult');
      
      // 控制按鈕（已移除，功能整合到快速按鈕中）
      
      // 用戶抽屜元素
      const userDrawer = document.getElementById('userDrawer');
      const userDrawerOverlay = document.getElementById('userDrawerOverlay');
      const drawerAvatar = document.getElementById('drawerAvatar');
      const drawerName = document.getElementById('drawerName');
      const drawerEmail = document.getElementById('drawerEmail');
      
      // 認證相關元素
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // 彈跳視窗元素
      const popupOverlay = document.getElementById('popupOverlay');
      const popupSpinner = document.getElementById('popupSpinner');
      const popupMessage = document.getElementById('popupMessage');
      const popupButtons = document.getElementById('popupButtons');
      const popupRetry = document.getElementById('popupRetry');
      const popupCancel = document.getElementById('popupCancel');
      
      // 提示框
      const toastEl = document.getElementById('toast');
      
      // 設定區塊元素
      const settingsToggleEl = document.getElementById('settingsToggle');
      const settingsContentEl = document.getElementById('settingsContent');
      
      // 全局變數
      let accessToken = null;
      let currentUser = null;
      const styleInstruction = '格式要求：分段清楚，短句，每段換行，適度加入表情符號（如：✅✨🔥📌），避免口頭禪。絕對不要使用 ** 或任何 Markdown 格式符號，所有內容必須是純文字格式。';
      
      // 生成隨機用戶ID
      function generateUserId() {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substring(2, 8);
        return `user_${timestamp}_${randomStr}`;
      }
      
      // 用戶抽屜功能
      function toggleUserDrawer() {
        userDrawer.classList.toggle('open');
        userDrawerOverlay.classList.toggle('open');
        
        // 如果抽屜打開，載入用戶歷史資訊
        if (userDrawer.classList.contains('open') && currentUser) {
          loadUserHistory();
        }
      }
      
      function closeUserDrawer() {
        userDrawer.classList.remove('open');
        userDrawerOverlay.classList.remove('open');
      }
      
      // 更新用戶抽屜資訊
      function updateUserDrawer(user) {
        if (user) {
          // 確保用戶有ID
          if (!user.user_id) {
            user.user_id = generateUserId();
            currentUser = user; // 更新當前用戶
            localStorage.setItem('currentUser', JSON.stringify(user));
            console.log('在updateUserDrawer中為用戶生成新ID:', user.user_id);
          }
          
          // 更新抽屜內的資訊
          drawerAvatar.src = user.picture || 'https://via.placeholder.com/50';
          drawerName.textContent = user.name || '用戶';
          drawerEmail.textContent = user.email || '';
          
          // 更新頂部 header 中的用戶資訊
          userAvatar.src = user.picture || 'https://via.placeholder.com/32';
          userName.textContent = user.name || '用戶';
          
          // 更新個人資料顯示
          updatePersonalInfo();
          
          // 載入用戶的過往資訊
          loadUserHistory();
        }
      }

      // 載入用戶歷史資訊
      async function loadUserHistory() {
        // 確保用戶有ID
        if (!currentUser?.user_id) {
          console.log('沒有用戶ID，嘗試生成...');
          if (currentUser) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('為用戶生成新ID:', currentUser.user_id);
          } else {
            console.log('沒有當前用戶，跳過載入歷史');
            return;
          }
        }
        
        console.log('開始載入用戶歷史，用戶ID:', currentUser.user_id);
        
        try {
          // 載入對話記錄
          console.log('正在載入對話記錄...');
          const conversationsResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/conversations/${currentUser.user_id}`);
          console.log('對話記錄響應狀態:', conversationsResponse.status);
          if (conversationsResponse.ok) {
            const conversationsData = await conversationsResponse.json();
            console.log('對話記錄數據:', conversationsData);
            updateConversationsDisplay(conversationsData.conversations);
          } else {
            console.error('載入對話記錄失敗:', conversationsResponse.status, conversationsResponse.statusText);
          }
          
          // 載入生成記錄
          console.log('正在載入生成記錄...');
          const generationsResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/generations/${currentUser.user_id}`);
          console.log('生成記錄響應狀態:', generationsResponse.status);
          if (generationsResponse.ok) {
            const generationsData = await generationsResponse.json();
            console.log('生成記錄數據:', generationsData);
            updateGenerationsDisplay(generationsData.generations);
          } else {
            console.error('載入生成記錄失敗:', generationsResponse.status, generationsResponse.statusText);
          }
          
          // 載入帳號定位記錄
          console.log('正在載入帳號定位記錄...');
          await loadPositioningRecords();
          
          // 載入用戶記憶
          console.log('正在載入用戶記憶...');
          const memoryResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/memory/${currentUser.user_id}`);
          console.log('用戶記憶響應狀態:', memoryResponse.status);
          if (memoryResponse.ok) {
            const memoryData = await memoryResponse.json();
            console.log('用戶記憶數據:', memoryData);
            updateMemoryDisplay(memoryData.memory);
          } else {
            console.error('載入用戶記憶失敗:', memoryResponse.status, memoryResponse.statusText);
          }
          
        } catch (error) {
          console.error('載入用戶歷史資訊時出錯:', error);
        }
      }

      // 更新對話記錄顯示
      function updateConversationsDisplay(conversations) {
        const conversationsList = document.getElementById('conversationsList');
        if (!conversationsList) return;
        
        conversationsList.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div');
          item.className = 'conversation-item';
          item.innerHTML = `
            <div class="conversation-summary">${conv.summary}</div>
            <div class="conversation-date">${new Date(conv.created_at).toLocaleDateString()}</div>
          `;
          conversationsList.appendChild(item);
        });
      }

      // 更新生成記錄顯示
      function updateGenerationsDisplay(generations) {
        const generationsList = document.getElementById('generationsList');
        if (!generationsList) return;
        
        generationsList.innerHTML = '';
        generations.forEach(gen => {
          const item = document.createElement('div');
          item.className = 'generation-item';
          item.innerHTML = `
            <div class="generation-header">
              <span class="generation-platform">${gen.platform}</span>
              <span class="generation-topic">${gen.topic}</span>
            </div>
            <div class="generation-content">${gen.content}</div>
            <div class="generation-date">${new Date(gen.created_at).toLocaleDateString()}</div>
          `;
          generationsList.appendChild(item);
        });
      }

      // 更新記憶顯示
      function updateMemoryDisplay(memory) {
        const memoryContent = document.getElementById('memoryContent');
        if (!memoryContent) return;
        
        memoryContent.innerHTML = memory || '暫無記憶資訊';
      }
      
      // 載入帳號定位記錄
      async function loadPositioningRecords() {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            updatePositioningDisplay(data.records || []);
          }
        } catch (error) {
          console.error('載入帳號定位記錄失敗:', error);
        }
      }
      
      // 更新帳號定位顯示
      function updatePositioningDisplay(records) {
        const positioningContent = document.getElementById('positioningHistoryContent');
        if (!positioningContent) return;
        
        if (records.length === 0) {
          positioningContent.innerHTML = '<p style="color: #666;">尚無帳號定位記錄</p>';
          return;
        }
        
        let html = '<div class="positioning-records">';
        records.forEach(record => {
          const date = new Date(record.created_at).toLocaleDateString('zh-TW');
          const preview = record.content.substring(0, 50) + (record.content.length > 50 ? '...' : '');
          
          html += `
            <div class="positioning-record-item">
              <div class="record-header">
                <span class="record-number">編號 ${record.record_number}</span>
                <span class="record-date">${date}</span>
              </div>
              <div class="record-preview">${preview}</div>
              <div class="record-actions">
                <button class="view-btn" onclick="viewPositioningDetail(${record.id}, '${record.record_number}')">查看完整結果</button>
                <button class="delete-btn" onclick="deletePositioningRecord(${record.id})">刪除</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        positioningContent.innerHTML = html;
      }
      
      // 查看帳號定位詳細內容
      async function viewPositioningDetail(recordId, recordNumber) {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const record = data.records.find(r => r.id === recordId);
            
            if (record) {
              // 顯示詳細內容在彈出視窗
              showDetailModal(recordNumber, record.created_at, record.content);
            }
          }
        } catch (error) {
          console.error('載入詳細內容失敗:', error);
          showToast('載入失敗', 3000);
        }
      }
      
      // 顯示詳細內容彈出視窗
      function showDetailModal(recordNumber, createdAt, content) {
        const date = new Date(createdAt).toLocaleString('zh-TW');
        const modal = document.createElement('div');
        modal.className = 'detail-modal-overlay';
        modal.innerHTML = `
          <div class="detail-modal">
            <div class="detail-modal-header">
              <h3>帳號定位詳細內容</h3>
              <button class="close-detail-btn" onclick="this.closest('.detail-modal-overlay').remove()">✕</button>
            </div>
            <div class="detail-modal-body">
              <div class="detail-info">
                <span><strong>編號：</strong>${recordNumber}</span>
                <span><strong>生成日期：</strong>${date}</span>
              </div>
              <div class="detail-content">
                ${content.replace(/\n/g, '<br>')}
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // 點擊背景關閉
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }
      
      // 刪除帳號定位記錄
      async function deletePositioningRecord(recordId) {
        if (!confirm('確定要刪除這筆記錄嗎？')) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${recordId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            showToast('記錄已刪除', 2000);
            await loadPositioningRecords();
          } else {
            throw new Error('刪除失敗');
          }
        } catch (error) {
          console.error('刪除錯誤:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }

      // 切換抽屜內容區域
      function switchDrawerContent(sectionId) {
        // 隱藏所有內容區域
        const allSections = document.querySelectorAll('.content-section');
        allSections.forEach(section => {
          section.classList.remove('active');
        });
        
        // 移除所有按鈕的 active 狀態
        const allMenuItems = document.querySelectorAll('.user-drawer-menu a');
        allMenuItems.forEach(item => {
          item.classList.remove('active');
        });
        
        // 顯示選中的內容區域
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // 添加對應按鈕的 active 狀態
        const targetMenuItem = document.querySelector(`[data-section="${sectionId}"]`);
        if (targetMenuItem) {
          targetMenuItem.classList.add('active');
        }
      }

      // 更新個人資料顯示
      function updatePersonalInfo() {
        if (currentUser) {
          // 確保用戶有ID，如果沒有則生成一個
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('在updatePersonalInfo中為用戶生成新ID:', currentUser.user_id);
          }
          
          const userNameDetail = document.getElementById('userNameDetail');
          const userEmailDetail = document.getElementById('userEmailDetail');
          const userIdDetail = document.getElementById('userIdDetail');
          
          if (userNameDetail) userNameDetail.textContent = currentUser.name || currentUser.displayName || '未設定';
          if (userEmailDetail) userEmailDetail.textContent = currentUser.email || '未設定';
          if (userIdDetail) userIdDetail.textContent = currentUser.user_id || '未生成';
          
          console.log('更新個人資料:', {
            name: currentUser.name,
            email: currentUser.email,
            user_id: currentUser.user_id
          });
        }
      }
      
      // 更新認證 UI
      function updateAuthUI(isLoggedIn) {
        if (isLoggedIn) {
          userInfo.style.display = 'flex';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'block';
          updateUserDrawer(currentUser);
        } else {
          userInfo.style.display = 'none';
          loginBtn.style.display = 'block';
          logoutBtn.style.display = 'none';
          closeUserDrawer();
        }
      }
      
      // 登出功能
      function logout() {
        accessToken = null;
        currentUser = null;
        localStorage.removeItem('accessToken');
        localStorage.removeItem('currentUser');
        updateAuthUI(false);
        showToast('已登出', 3000);
        closeUserDrawer();
      }
      
      // 結果區塊功能
      function updateResultBlock(blockId, content, hasContent = true) {
        const block = document.getElementById(blockId);
        if (block) {
          block.textContent = content;
          if (hasContent) {
            block.classList.add('has-content');
          } else {
            block.classList.remove('has-content');
          }
        }
      }
      
      // 標籤切換功能
      function switchTab(tabName) {
        // 移除所有標籤的 active 類別
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 隱藏所有結果內容
        document.querySelectorAll('.result-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // 激活選中的標籤
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
        }
        
        // 顯示對應的結果內容
        let contentId = '';
        if (tabName === 'positioning') {
          contentId = 'positioningResult';
        } else if (tabName === 'topics') {
          contentId = 'topicSelectionResult';
        } else if (tabName === 'script') {
          contentId = 'scriptResult';
        }
        
        const activeContent = document.getElementById(contentId);
        if (activeContent) {
          activeContent.style.display = 'block';
        }
      }
      
      // 添加聊天訊息
      function addMessage(content, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `msg ${isUser ? 'user' : 'assistant'}`;
        
        // 添加標籤
        const label = document.createElement('div');
        label.className = 'msg-label';
        label.textContent = isUser ? '你' : 'AIJob短影音顧問';
        messageDiv.appendChild(label);
        
        // 添加氣泡
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // 如果是 AI 回覆，清理 Markdown 格式
        if (!isUser) {
          const cleanText = cleanMarkdownFormat(content);
          bubble.innerHTML = cleanText;
        } else {
          bubble.textContent = content;
        }
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // 發送聊天訊息
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // 添加用戶訊息
        addMessage(message, true);
        messageInput.value = '';
        
        // 顯示 AI 回覆中的載入狀態
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'msg assistant';
        thinkingDiv.id = 'thinking-message';
        
        // 添加 AI 標籤
        const aiLabel = document.createElement('div');
        aiLabel.className = 'msg-label';
        aiLabel.textContent = 'AIJob短影音顧問';
        thinkingDiv.appendChild(aiLabel);
        
        // 添加載入動畫氣泡
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.innerHTML = '<div class="spinner"></div><span>AI回覆中...</span>';
        thinkingDiv.appendChild(loadingDiv);
        
        document.getElementById('chatMessages').appendChild(thinkingDiv);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: message,
              platform: platformSelect.value || null,
              topic: topicInput.value || null,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioningInput.value || null,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('發送失敗');
          }
          
          // 準備接收 AI 回應
          const reader = response.body.getReader();
          let aiResponse = '';
          let aiDiv = null;
          let bubble = null;
          
          let buffer = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += new TextDecoder().decode(value, { stream: true });
            
            // 處理完整的 JSON 行
            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              
              if (!frame.startsWith('data:')) continue;
              
              try {
                const jsonStr = frame.slice(5).trim();
                const data = JSON.parse(jsonStr);
                
                if (data.type === 'token' && data.content) {
                  // 如果是第一次收到 token，創建 AI 回應 div 並移除載入動畫
                  if (!aiDiv) {
                    const thinkingMsg = document.getElementById('thinking-message');
                    if (thinkingMsg) {
                      thinkingMsg.remove();
                    }
                    
                    // 創建 AI 回應 div
                    aiDiv = document.createElement('div');
                    aiDiv.className = 'msg assistant';
                    aiDiv.id = 'ai-response';
                    
                    // 添加 AI 標籤
                    const aiLabel = document.createElement('div');
                    aiLabel.className = 'msg-label';
                    aiLabel.textContent = 'AIJob短影音顧問';
                    aiDiv.appendChild(aiLabel);
                    
                    // 添加氣泡
                    bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    aiDiv.appendChild(bubble);
                    
                    document.getElementById('chatMessages').appendChild(aiDiv);
                  }
                  
                  aiResponse += data.content;
                  bubble.innerHTML = cleanMarkdownFormat(aiResponse);
                } else if (data.type === 'end') {
                  // 回應結束
                  // 新增：智能判斷 AI 回應類型並顯示到結果區塊
                  if (aiResponse && currentUser?.user_id) {
                    detectAndDisplayResult(message, aiResponse);
                  }
                  break;
                }
              } catch (e) {
                // 忽略解析錯誤
                continue;
              }
            }
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }
        } catch (error) {
          // 移除載入動畫，顯示錯誤訊息
          const thinkingMsg = document.getElementById('thinking-message');
          if (thinkingMsg) {
            thinkingMsg.remove();
          }
          
          addMessage('抱歉，發送失敗，請稍後再試', false);
        }
      }
      
      // 生成腳本功能
      async function generateScript() {
        // 檢查是否已完成帳號定位和選題（只檢查是否為預設提示文字）
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const topicContent = document.getElementById('topicContent').textContent.trim();
        
        const isPositioningDefault = positioningContent.includes('點擊「一鍵生成帳號定位」') || 
                                     positioningContent.includes('開始分析');
        const isTopicDefault = topicContent.includes('完成帳號定位') || 
                              topicContent.includes('進行選題') ||
                              topicContent.includes('點擊「一鍵生成選題」');
        
        if (!positioningContent || isPositioningDefault) {
          showToast('請先完成帳號定位', 3000);
          return;
        }
        
        if (!topicContent || isTopicDefault) {
          showToast('請先完成選題推薦', 3000);
          return;
        }
        
        const platform = platformSelect.value;
        const topic = topicInput.value;
        const positioning = positioningInput.value;
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('scriptContent', '正在生成腳本...', false);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/script', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: '請幫我生成完整腳本',
              platform: platform,
              topic: topic,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('scriptContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 顯示操作按鈕
          document.getElementById('scriptActions').style.display = 'flex';
          
          // 自動切換到腳本標籤
          switchTab('script');
          
        } catch (error) {
          updateResultBlock('scriptContent', '生成失敗，請稍後再試', false);
          showToast('生成腳本失敗', 3000);
        }
      }
      
      // 一鍵生成帳號定位
      async function generatePositioning() {
        const platform = platformSelect.value;
        const topic = topicInput.value;
        const positioning = positioningInput.value;
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('positioningContent', '正在分析帳號定位...', false);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/positioning', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: '請幫我進行帳號定位分析',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('positioningContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 顯示操作按鈕
          document.getElementById('positioningActions').style.display = 'flex';
          
          // 自動切換到帳號定位標籤
          switchTab('positioning');
          
        } catch (error) {
          updateResultBlock('positioningContent', '生成失敗，請稍後再試', false);
          showToast('生成帳號定位失敗', 3000);
        }
      }
      
      // 智能判斷 AI 回應類型並顯示到結果區塊
      function detectAndDisplayResult(userMessage, aiResponse) {
        // 判斷是否為明確的帳號定位總結
        const isPositioningSummary = aiResponse.includes('📌 你的帳號定位建議') ||
                                     aiResponse.includes('帳號定位建議：') ||
                                     aiResponse.includes('定位總結：') ||
                                     (aiResponse.includes('定位建議') && aiResponse.length > 200);
        
        // 判斷是否為明確的選題推薦結果
        const isTopicsSummary = aiResponse.includes('📌 選題推薦') ||
                               aiResponse.includes('選題建議：') ||
                               aiResponse.includes('推薦選題：') ||
                               (aiResponse.includes('選題') && 
                                (aiResponse.includes('1.') || aiResponse.includes('一、')) &&
                                aiResponse.length > 200);
        
        // 判斷是否為完整腳本（必須包含結構化內容）
        const isCompletScript = (aiResponse.includes('Hook') || aiResponse.includes('開場')) && 
                               (aiResponse.includes('Value') || aiResponse.includes('核心')) && 
                               (aiResponse.includes('CTA') || aiResponse.includes('行動呼籲')) &&
                               aiResponse.length > 300;
        
        // 根據判斷結果顯示到對應區塊（只顯示明確的總結/結果）
        if (isCompletScript) {
          // 完整腳本：顯示到腳本區塊
          updateResultBlock('scriptContent', aiResponse, true);
          document.getElementById('scriptActions').style.display = 'flex';
          switchTab('script');
        } else if (isTopicsSummary) {
          // 選題推薦：顯示到選題區塊
          updateResultBlock('topicContent', aiResponse, true);
          document.getElementById('topicActions').style.display = 'flex';
          switchTab('topics');
        } else if (isPositioningSummary) {
          // 帳號定位總結：顯示到定位區塊
          updateResultBlock('positioningContent', aiResponse, true);
          document.getElementById('positioningActions').style.display = 'flex';
          switchTab('positioning');
        }
        // 如果都不符合（一般討論、問答），就不顯示到結果區（保留在對話框中）
      }
      
      // 一鍵生成選題
      async function generateTopics() {
        // 檢查是否已完成帳號定位（只檢查是否為預設提示文字）
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const isDefaultText = positioningContent.includes('點擊「一鍵生成帳號定位」') || 
                             positioningContent.includes('開始分析');
        
        if (!positioningContent || isDefaultText) {
          showToast('請先完成帳號定位', 3000);
          return;
        }
        
        const platform = platformSelect.value;
        const topic = topicInput.value;
        const positioning = positioningInput.value;
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('topicContent', '正在推薦選題...', false);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/topics', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: '請幫我推薦選題',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('topicContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 顯示操作按鈕
          document.getElementById('topicActions').style.display = 'flex';
          
          // 自動切換到選題標籤
          switchTab('topics');
          
        } catch (error) {
          updateResultBlock('topicContent', '生成失敗，請稍後再試', false);
          showToast('生成選題失敗', 3000);
        }
      }
      
      // 儲存結果
      async function saveResult(type) {
        if (!currentUser || !currentUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        let content = '';
        let contentElement = null;
        
        switch(type) {
          case 'positioning':
            contentElement = document.getElementById('positioningContent');
            break;
          case 'topics':
            contentElement = document.getElementById('topicContent');
            break;
          case 'script':
            contentElement = document.getElementById('scriptContent');
            break;
        }
        
        if (contentElement) {
          content = contentElement.textContent;
          
          // 只有帳號定位需要保存到資料庫
          if (type === 'positioning') {
            try {
              const response = await fetch('https://aivideobackend.zeabur.app/api/user/positioning/save', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                  user_id: currentUser.user_id,
                  content: content
                })
              });
              
              if (response.ok) {
                const data = await response.json();
                showToast(`帳號定位已儲存（編號：${data.record_number}）`, 3000);
                // 重新載入帳號定位列表
                await loadPositioningRecords();
              } else {
                throw new Error('儲存失敗');
              }
            } catch (error) {
              console.error('儲存錯誤:', error);
              showToast('儲存失敗，請稍後再試', 3000);
            }
          } else {
            // 其他類型暫時儲存到 localStorage
            localStorage.setItem(`saved_${type}`, content);
            showToast(`${type === 'topics' ? '選題' : '腳本'}已儲存`, 2000);
          }
        }
      }
      
      // 重新生成結果
      async function regenerateResult(type) {
        switch(type) {
          case 'positioning':
            await generatePositioning();
            break;
          case 'topics':
            await generateTopics();
            break;
          case 'script':
            await generateScript();
            break;
        }
      }
      
      // 更新結果區塊內容
      function updateResultBlock(elementId, content, hasContent) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          if (hasContent) {
            element.classList.add('has-content');
          } else {
            element.classList.remove('has-content');
          }
        }
      }
      
      // 帳號定位功能
      async function analyzePositioning() {
        const positioning = positioningInput.value;
        
        if (!positioning) {
          showToast('請先輸入帳號定位', 3000);
          return;
        }
        
        updateResultBlock('positioningResult', '正在分析帳號定位...', false);
        
        try {
          // 這裡可以調用後端 API 進行帳號定位分析
          // 暫時使用模擬數據
          setTimeout(() => {
            const analysis = `根據您的帳號定位"${positioning}"，建議：\n\n1. 內容風格：輕鬆幽默\n2. 目標受眾：健康愛好者\n3. 內容主題：加密貨幣與健康結合\n4. 發布時間：晚上8-10點\n5. 互動策略：多使用問答形式`;
            updateResultBlock('positioningResult', analysis, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('positioningResult', '分析失敗，請稍後再試', false);
          showToast('分析失敗', 3000);
        }
      }
      
      // 腳本選題功能
      async function selectTopics() {
        const platform = platformSelect.value;
        const topic = topicInput.value;
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('topicSelectionResult', '正在為您選題...', false);
        
        try {
          // 這裡可以調用後端 API 進行選題
          // 暫時使用模擬數據
          setTimeout(() => {
            const topics = `為${platform}平台推薦以下選題${topic ? `（基於"${topic}"主題）` : ''}：\n\n1. 夏季美白保養的5個小技巧\n2. 30天美白挑戰實測\n3. 美白產品成分大解析\n4. 天然美白方法分享\n5. 美白誤區你中了幾個？`;
            updateResultBlock('topicSelectionResult', topics, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('topicSelectionResult', '選題失敗，請稍後再試', false);
          showToast('選題失敗', 3000);
        }
      }
      
      // 事件監聽器
      document.addEventListener('DOMContentLoaded', async () => {
        // 確保抽屜初始狀態為關閉
        closeUserDrawer();
        
        // 檢查本地存儲的認證資訊
        accessToken = localStorage.getItem('accessToken');
        currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        
        if (accessToken && currentUser) {
          updateAuthUI(true);
        } else {
          updateAuthUI(false);
        }
        
        // 按鈕功能已整合到快速按鈕中
        
        // 標籤切換事件
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
        
        // 設定區塊摺疊/展開功能
        settingsToggleEl.addEventListener('click', () => {
          const isCollapsed = settingsContentEl.classList.contains('collapsed');
          const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
          
          if (isCollapsed) {
            settingsContentEl.classList.remove('collapsed');
            toggleIcon.textContent = '▼';
          } else {
            settingsContentEl.classList.add('collapsed');
            toggleIcon.textContent = '▶';
          }
        });
        
        // 登入按鈕功能
        loginBtn.addEventListener('click', login);
        
        // 登出按鈕功能
        logoutBtn.addEventListener('click', logout);
        
        // 聊天功能
        sendBtn.addEventListener('click', sendMessage);
        
        // 快速按鈕功能
        document.querySelectorAll('.quick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            if (text) {
              messageInput.value = text;
              messageInput.focus();
              
              // 添加視覺反饋
              btn.style.transform = 'scale(0.95)';
              setTimeout(() => {
                btn.style.transform = '';
              }, 150);
              
              // 根據按鈕類型切換到對應的結果標籤
              if (text.includes('生成腳本')) {
                switchTab('script');
              } else if (text.includes('腳本選題')) {
                switchTab('topics');
              } else if (text.includes('帳號定位')) {
                switchTab('positioning');
              }
              
              // 自動發送訊息
              setTimeout(() => {
                sendMessage();
              }, 500);
            }
          });
        });
        
        // 設定已套用的標記
        let settingsApplied = false;
        let appliedSettings = {
          platform: null,
          topic: null,
          duration: null,
          positioning: null
        };

        applyBtn.addEventListener('click', () => {
          const platform = platformSelect.value;
          const topic = topicInput.value;
          const positioning = positioningInput.value;
          const duration = durationInput.value;
          
          if (platform) {
            // 記錄已套用的設定
            settingsApplied = true;
            appliedSettings = {
              platform: platform,
              topic: topic,
              duration: duration,
              positioning: positioning
            };
            
            showToast('設定已套用', 2000);
            
            // 自動收合設定區塊
            settingsContentEl.classList.add('collapsed');
            const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
            toggleIcon.textContent = '▶';
          } else {
            showToast('請選擇平台', 3000);
          }
        });
        
        // 測試連線和顯示結果功能已整合到其他按鈕中
        
        // 綁定彈跳視窗按鈕事件
        popupRetry.addEventListener('click', () => {
          hidePopupOverlay();
          login();
        });
        
        popupCancel.addEventListener('click', () => {
          hidePopupOverlay();
        });
        
        // 鍵盤快捷鍵
        messageInput.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
          }
        });
      });
      
      // 登入功能
      async function login() {
        try {
          // 顯示彈跳視窗覆蓋層
          showPopupOverlay('正在開啟 Google 登入視窗...');
          
          // 獲取 Google 認證 URL
          const response = await fetch('https://aivideobackend.zeabur.app/api/auth/google');
          const data = await response.json();
          
          // 使用彈跳視窗進行 Google 認證
          const popup = window.open(
            data.auth_url,
            'googleAuth',
            'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
          );
          
          if (!popup) {
            hidePopupOverlay();
            showPopupError('請允許彈跳視窗以完成登入', true);
            return;
          }
          
          // 更新覆蓋層訊息
          updatePopupMessage('請在彈跳視窗中完成 Google 登入...');
          
          // 監聽彈跳視窗關閉
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              clearInterval(checkClosed);
              hidePopupOverlay();
              // 檢查是否有認證結果
              checkAuthResult();
            }
          }, 1000);
          
          // 監聽來自彈跳視窗的訊息
          window.addEventListener('message', handleAuthMessage);
          
        } catch (error) {
          console.error('Login error:', error);
          hidePopupOverlay();
          showToast('登入失敗，請稍後再試', 5000);
        }
      }
      
      function showPopupOverlay(message) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'block';
        popupButtons.style.display = 'none';
        popupOverlay.style.display = 'flex';
      }
      
      function updatePopupMessage(message) {
        popupMessage.textContent = message;
      }
      
      function showPopupError(message, showRetry = false) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'none';
        if (showRetry) {
          popupButtons.style.display = 'block';
        } else {
          popupButtons.style.display = 'none';
        }
        popupOverlay.style.display = 'flex';
      }
      
      function hidePopupOverlay() {
        popupOverlay.style.display = 'none';
      }
      
      function handleAuthMessage(event) {
        // 確保訊息來自我們的回調頁面
        if (event.origin !== window.location.origin) return;
        
        if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
          // 認證成功，更新 UI
          accessToken = event.data.accessToken;
          currentUser = event.data.user;
          
          // 保存到本地存儲
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          hidePopupOverlay();
          updateAuthUI(true);
          showToast('登入成功！', 3000);
          
          // 移除事件監聽器
          window.removeEventListener('message', handleAuthMessage);
        } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
          hidePopupOverlay();
          showToast('認證失敗：' + event.data.error, 5000);
          window.removeEventListener('message', handleAuthMessage);
        }
      }
      
      async function checkAuthResult() {
        // 檢查本地存儲中是否有新的認證資訊
        const storedToken = localStorage.getItem('accessToken');
        const storedUser = localStorage.getItem('currentUser');
        
        if (storedToken && storedUser && storedToken !== accessToken) {
          accessToken = storedToken;
          currentUser = JSON.parse(storedUser);
          
          // 為用戶生成隨機ID（如果沒有）
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('頁面載入時為用戶生成新ID:', currentUser.user_id);
          }
          
          updateAuthUI(true);
          updatePersonalInfo();
          showToast('登入成功！', 3000);
        }
      }

      async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
          try {
            const response = await fetch('https://aivideobackend.zeabur.app/api/auth/google/callback', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code })
            });
            
            if (response.ok) {
              const authData = await response.json();
              accessToken = authData.access_token;
              currentUser = authData.user;
              
              // 保存到本地存儲
              localStorage.setItem('accessToken', accessToken);
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              
              updateAuthUI(true);
              showToast('登入成功！', 3000);
              
              // 清除 URL 中的認證碼
              window.history.replaceState({}, document.title, window.location.pathname);
            } else {
              throw new Error('Authentication failed');
            }
          } catch (error) {
            console.error('Auth callback error:', error);
            showToast('認證失敗，請重新登入', 5000);
            updateAuthUI(false);
          }
        }
      }

      async function fetchUserInfo() {
        if (!accessToken) return;
        
        const response = await fetch('https://aivideobackend.zeabur.app/api/auth/me', {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (response.ok) {
          const userData = await response.json();
          currentUser = userData;
          
          // 為用戶生成隨機ID（如果沒有）
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            console.log('為用戶生成新ID:', currentUser.user_id);
          }
          
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          updateAuthUI(true);
          
          // 立即更新個人資料顯示
          updatePersonalInfo();
        } else {
          throw new Error('Failed to fetch user info');
        }
      }

      // 彈出提示框函數
      function showToast(message, duration = 3000) {
        toastEl.textContent = message;
        toastEl.style.display = 'block';
        toastEl.className = 'toast show';
        
        setTimeout(() => {
          toastEl.className = 'toast hide';
          setTimeout(() => {
            toastEl.style.display = 'none';
          }, 300);
        }, duration);
      }

      // 這個事件監聽器已經合併到上面的 DOMContentLoaded 中

      function append(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        
        const label = document.createElement('div');
        label.className = 'msg-label';
        label.textContent = role === 'user' ? '你' : 'AIJob短影音顧問';
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // 如果是 AI 回覆，清理 Markdown 格式
        if (role === 'assistant') {
          const cleanText = cleanMarkdownFormat(text);
          bubble.innerHTML = cleanText;
        } else {
          bubble.textContent = text;
        }
        
        div.appendChild(label);
        div.appendChild(bubble);
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
        return { container: div, bubble: bubble };
      }

      // 清理 Markdown 格式並轉換為 HTML
      function cleanMarkdownFormat(text) {
        // 處理 Markdown 標題格式
        text = text.replace(/^###\s*(.+)$/gm, '<strong>$1</strong>'); // ### 標題 → **標題**
        text = text.replace(/^##\s*(.+)$/gm, '<strong>$1</strong>');  // ## 標題 → **標題**
        text = text.replace(/^#\s*(.+)$/gm, '<strong>$1</strong>');   // # 標題 → **標題**
        
        // 將 **文字** 轉換為 <strong>文字</strong>
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // 處理其他常見的 Markdown 格式
        text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');           // *斜體* → 斜體
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');         // `代碼` → 代碼
        
        // 移除單獨的 Markdown 符號
        text = text.replace(/\*\*/g, '');                             // 移除單獨的 **
        text = text.replace(/^#{1,6}\s*/gm, '');                      // 移除行首的 # 符號
        
        // 處理換行符號，確保段落分明
        text = text.replace(/\n\n/g, '</p><p>');                      // 雙換行 → 段落分隔
        text = text.replace(/\n/g, '<br>');                           // 單換行 → 換行標籤
        
        // 包裝在段落標籤中
        if (text && !text.startsWith('<p>')) {
          text = '<p>' + text + '</p>';
        }
        
        return text;
      }

      function updateAssistantNode(nodeObj, text) {
        // 清理 Markdown 格式
        const cleanText = cleanMarkdownFormat(text);
        
        if (nodeObj.bubble) {
          // 使用 innerHTML 來支援 HTML 標籤（如 <strong>）
          nodeObj.bubble.innerHTML = cleanText;
        } else {
          nodeObj.innerHTML = cleanText;
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function canSubmit() {
        if (isSending) return false;
        const now = Date.now();
        if (now - lastSubmitAt < 600) return false; // 600ms 節流
        lastSubmitAt = now;
        return true;
      }

      async function send(message) {
        if (!message) return;
        if (!canSubmit()) return;
        lastMessage = message;
        const userNode = append('user', message);
        const assistantNode = append('assistant', '');

        // 顯示 AI 回覆中的載入狀態
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.innerHTML = '<div class="spinner"></div><span>AI回覆中...</span>';
        assistantNode.bubble.appendChild(loadingDiv);

        sendBtn.disabled = true;
        isSending = true;
        statusEl.textContent = '正在送出…';

        try {
          // 自動偵測環境，開發時使用 localhost，部署時使用環境變數或預設後端網域
          const isDevelopment = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname === '0.0.0.0';
          
          // 如果是開發環境，使用 localhost:8000；部署環境使用正確的後端網域
          let endpoint;
          if (isDevelopment) {
            endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          } else {
            // 部署環境：使用您提供的正確後端網域
            endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          }
          // 添加調試信息
          console.log('API 端點:', endpoint);
          console.log('當前位置:', window.location.href);
          console.log('Hostname:', window.location.hostname);
          console.log('Port:', window.location.port);
          
          // 準備請求頭
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          const res = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message,
              platform: settingsApplied ? appliedSettings.platform : null,
              topic: settingsApplied ? appliedSettings.topic : null,
              duration: settingsApplied ? appliedSettings.duration : null,
              style: styleInstruction,
              profile: settingsApplied ? appliedSettings.positioning : null,
              history,
              user_id: currentUser?.user_id || null
            })
          });

          if (!res.ok) {
            const text = await res.text().catch(() => '');
            console.error('API 請求失敗:', res.status, text);
            
            let errorMessage = `[請求失敗 ${res.status}] `;
            try {
              const errorData = JSON.parse(text);
              if (errorData.error) {
                errorMessage += errorData.error;
                if (errorData.error.includes('GEMINI_API_KEY')) {
                  errorMessage += '\n\n💡 解決方案：請在 Zeabur 後端服務的環境變數中設定 GEMINI_API_KEY';
                }
              } else {
                errorMessage += text || '無回應內容';
              }
            } catch {
              errorMessage += text || '無回應內容';
            }
            
            updateAssistantNode(assistantNode, errorMessage);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let aiText = '';
          let buffer = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              if (!frame.startsWith('data:')) continue;
              try {
                const jsonStr = frame.slice(5).trim();
                const evt = JSON.parse(jsonStr);
                if (evt.type === 'token') {
                  // 移除載入動畫，開始顯示 AI 回覆
                  const loadingDiv = assistantNode.bubble.querySelector('.loading');
                  if (loadingDiv) {
                    loadingDiv.remove();
                  }
                  aiText += evt.content;
                  updateAssistantNode(assistantNode, aiText);
                } else if (evt.type === 'end') {
                  history.push({ role: 'user', content: message });
                  history.push({ role: 'assistant', content: aiText });
                  
                  // 檢查是否包含腳本結果，自動顯示結果區塊
                  checkAndUpdateResults(aiText);
                }
              } catch (e) { /* ignore parse errors */ }
            }
          }
        } catch (e) {
          // 移除載入動畫，顯示錯誤訊息
          const loadingDiv = assistantNode.bubble.querySelector('.loading');
          if (loadingDiv) {
            loadingDiv.remove();
          }
          console.error('請求錯誤:', e);
          console.error('錯誤詳情:', {
            message: e?.message,
            name: e?.name,
            stack: e?.stack,
            endpoint: endpoint,
            location: window.location.href
          });
          
          // 提供更詳細的錯誤訊息
          let errorMsg = `[錯誤] ${e?.message || e}`;
          if (e?.name === 'TypeError' && e?.message.includes('fetch')) {
            errorMsg = '[連線錯誤] 無法連接到伺服器，請檢查網路連線或稍後再試';
          } else if (e?.name === 'TypeError' && e?.message.includes('Failed to fetch')) {
            errorMsg = '[網路錯誤] 請檢查網路連線或重新整理頁面';
          } else if (e?.message?.includes('CORS')) {
            errorMsg = '[跨域錯誤] 請嘗試重新整理頁面';
          }
          
          // 添加更多調試信息
          errorMsg += `\n\n調試信息：\n端點: ${endpoint}\n位置: ${window.location.href}`;
          updateAssistantNode(assistantNode, errorMsg);
        } finally {
          sendBtn.disabled = false;
          isSending = false;
          statusEl.textContent = '';
        }
      }

      // 這些事件監聽器已經在新的 DOMContentLoaded 中處理

      // 設定區塊摺疊/展開功能
      // 設定區塊摺疊/展開功能已移除

      // 這個事件監聽器已經在新的 DOMContentLoaded 中處理

      function updateBadge(badgeEl, label, value) {
        if (value) {
          badgeEl.style.display = 'inline-block';
          badgeEl.textContent = label + '：' + value;
        } else {
          badgeEl.style.display = 'none';
          badgeEl.textContent = '';
        }
      }

      // 測試連線功能
      async function testConnection() {
        const testNode = append('assistant', '🔧 正在測試連線...');
        
        try {
          // 測試後端根路徑
          const rootResponse = await fetch('https://aivideobackend.zeabur.app/');
          const rootText = await rootResponse.text();
          
          let testResult = `🔍 連線測試結果：\n\n`;
          testResult += `1️⃣ 後端根路徑：${rootResponse.ok ? '✅ 正常' : '❌ 異常'} (狀態碼: ${rootResponse.status})\n`;
          
          // 測試健康檢查
          try {
            const healthResponse = await fetch('https://aivideobackend.zeabur.app/api/health');
            const healthData = await healthResponse.json();
            
            testResult += `2️⃣ 健康檢查：${healthResponse.ok ? '✅ 正常' : '❌ 異常'}\n`;
            testResult += `   - 知識庫：${healthData.kb_status}\n`;
            testResult += `   - Gemini配置：${healthData.gemini_configured ? '✅ 已配置' : '❌ 未配置'}\n`;
            testResult += `   - Gemini測試：${healthData.gemini_test}\n`;
            testResult += `   - 模型：${healthData.model_name}\n`;
            
            if (!healthData.gemini_configured) {
              testResult += `\n⚠️ 問題：Gemini API Key 未配置\n`;
              testResult += `💡 解決方案：請在 Zeabur 後端環境變數中設定 GEMINI_API_KEY\n`;
            } else if (healthData.gemini_test !== 'working') {
              testResult += `\n⚠️ 問題：Gemini API 連線異常\n`;
              testResult += `💡 錯誤：${healthData.gemini_test}\n`;
            }
            
          } catch (healthError) {
            testResult += `2️⃣ 健康檢查：❌ 無法連線 (${healthError.message})\n`;
          }
          
          // 測試聊天API
          try {
            const chatResponse = await fetch('https://aivideobackend.zeabur.app/api/chat/stream', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'test', platform: null, topic: null, duration: '30' })
            });
            
            testResult += `3️⃣ 聊天API：${chatResponse.ok ? '✅ 正常' : '❌ 異常'} (狀態碼: ${chatResponse.status})\n`;
            
            if (!chatResponse.ok) {
              const errorText = await chatResponse.text();
              testResult += `   錯誤：${errorText}\n`;
            }
            
          } catch (chatError) {
            testResult += `3️⃣ 聊天API：❌ 無法連線 (${chatError.message})\n`;
          }
          
          updateAssistantNode(testNode, testResult);
          
        } catch (error) {
          updateAssistantNode(testNode, `❌ 連線測試失敗：${error.message}`);
        }
      }

      // 測試連線按鈕已移除

      // 添加全局測試函數（用於調試）
      window.testDOM = function() {
        console.log('=== DOM元素測試 ===');
        console.log('resultTitleEl:', resultTitleEl);
        console.log('resultScriptEl:', resultScriptEl);
        console.log('resultVisualEl:', resultVisualEl);
        console.log('resultCopyEl:', resultCopyEl);
        
        if (resultTitleEl) {
          resultTitleEl.innerHTML = '測試標題';
          console.log('測試標題設置成功');
        }
        if (resultScriptEl) {
          resultScriptEl.innerHTML = '測試腳本內容';
          console.log('測試腳本內容設置成功');
        }
        if (resultVisualEl) {
          resultVisualEl.innerHTML = '測試畫面感';
          console.log('測試畫面感設置成功');
        }
        if (resultCopyEl) {
          resultCopyEl.innerHTML = '測試發佈文案';
          console.log('測試發佈文案設置成功');
        }
      };
      
      // 添加AI內容測試函數
      window.testAIContent = function(aiText) {
        console.log('=== AI內容測試 ===');
        console.log('測試文本:', aiText);
        
        const isScript = detectScriptContent(aiText);
        console.log('是否為腳本內容:', isScript);
        
        if (isScript) {
          const sections = parseAIContent(aiText);
          console.log('解析結果:', sections);
          
          // 更新DOM元素
          if (sections.title && resultTitleEl) {
            resultTitleEl.innerHTML = sections.title;
            console.log('✅ 主題標題已設置');
          }
          if (sections.script && resultScriptEl) {
            resultScriptEl.innerHTML = sections.script;
            console.log('✅ 腳本內容已設置');
          }
          if (sections.visual && resultVisualEl) {
            resultVisualEl.innerHTML = sections.visual;
            console.log('✅ 畫面感已設置');
          }
          if (sections.copy && resultCopyEl) {
            resultCopyEl.innerHTML = sections.copy;
            console.log('✅ 發佈文案已設置');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已顯示');
        }
      };
      
      // 添加強制更新函數
      window.forceUpdateResults = function() {
        console.log('=== 強制更新結果區塊 ===');
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('獲取AI文本:', aiText.substring(0, 200) + '...');
          
          const isScript = detectScriptContent(aiText);
          console.log('是否為腳本內容:', isScript);
          
          if (isScript) {
            const sections = parseAIContent(aiText);
            console.log('解析結果:', sections);
            
            // 強制更新DOM元素
            if (resultTitleEl) {
              resultTitleEl.innerHTML = sections.title || '未找到主題標題';
              console.log('✅ 主題標題已強制設置');
            }
            if (resultScriptEl) {
              resultScriptEl.innerHTML = sections.script || '未找到腳本內容';
              console.log('✅ 腳本內容已強制設置');
            }
            if (resultVisualEl) {
              resultVisualEl.innerHTML = sections.visual || '未找到畫面感';
              console.log('✅ 畫面感已強制設置');
            }
            if (resultCopyEl) {
              resultCopyEl.innerHTML = sections.copy || '未找到發佈文案';
              console.log('✅ 發佈文案已強制設置');
            }
            
            // 顯示結果區塊
            resultsEl.style.display = 'block';
            console.log('✅ 結果區塊已強制顯示');
          } else {
            console.log('❌ 檢測失敗，不是腳本內容');
          }
        } else {
          console.log('❌ 未找到AI回應');
        }
      };
      
      // 添加簡單測試函數
      window.testCurrentContent = function() {
        console.log('=== 測試當前內容 ===');
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('AI文本長度:', aiText.length);
          console.log('AI文本前500字符:', aiText.substring(0, 500));
          
          // 測試主題標題提取
          const titleMatch = aiText.match(/主題標題[：:]\s*([^\n]+)/i);
          console.log('主題標題匹配結果:', titleMatch);
          
          // 測試腳本內容提取
          const scriptMatch = aiText.match(/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i);
          console.log('腳本內容匹配結果:', scriptMatch ? '匹配' : '無匹配');
          
          // 測試畫面感提取
          const visualMatch = aiText.match(/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i);
          console.log('畫面感匹配結果:', visualMatch ? '匹配' : '無匹配');
          
          // 測試發佈文案提取
          const copyMatch = aiText.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
          console.log('發佈文案匹配結果:', copyMatch ? '匹配' : '無匹配');
          
          // 直接更新結果區塊
          if (titleMatch && titleMatch[1]) {
            resultTitleEl.innerHTML = cleanMarkdownFormat(titleMatch[1].trim());
            console.log('✅ 直接設置主題標題');
          }
          if (scriptMatch && scriptMatch[1]) {
            resultScriptEl.innerHTML = cleanMarkdownFormat(scriptMatch[1].trim());
            console.log('✅ 直接設置腳本內容');
          }
          if (visualMatch && visualMatch[1]) {
            resultVisualEl.innerHTML = cleanMarkdownFormat(visualMatch[1].trim());
            console.log('✅ 直接設置畫面感');
          }
          if (copyMatch && copyMatch[1]) {
            resultCopyEl.innerHTML = cleanMarkdownFormat(copyMatch[1].trim());
            console.log('✅ 直接設置發佈文案');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已顯示');
        } else {
          console.log('❌ 未找到AI回應');
        }
      };
      
      // 添加超強力測試函數
      window.forceExtractContent = function() {
        console.log('=== 超強力內容提取 ===');
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('AI文本長度:', aiText.length);
          console.log('AI文本前1000字符:', aiText.substring(0, 1000));
          
          // 強制提取主題標題
          let title = '';
          const titlePatterns = [
            /\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /主題標題[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*主題標題[：:]\s*([^\n]+)/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              title = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到主題標題:', title);
              break;
            }
          }
          
          // 強制提取腳本內容
          let script = '';
          const scriptPatterns = [
            /\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /\d+\.\s*\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              script = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到腳本內容:', script.substring(0, 100) + '...');
              break;
            }
          }
          
          // 強制提取畫面感
          let visual = '';
          const visualPatterns = [
            /\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /\d+\.\s*\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              visual = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到畫面感:', visual.substring(0, 100) + '...');
              break;
            }
          }
          
          // 強制提取發佈文案
          let copy = '';
          const copyPatterns = [
            /\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /發佈文案[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*發佈文案[：:]\s*([\s\S]*?)$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              copy = cleanMarkdownFormat(match[1].trim());
              console.log('✅ 找到發佈文案:', copy.substring(0, 100) + '...');
              break;
            }
          }
          
          // 強制更新結果區塊
          if (title) {
            resultTitleEl.innerHTML = title;
            console.log('✅ 強制設置主題標題');
          }
          if (script) {
            resultScriptEl.innerHTML = script;
            console.log('✅ 強制設置腳本內容');
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
            console.log('✅ 強制設置畫面感');
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
            console.log('✅ 強制設置發佈文案');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已強制顯示');
          
          // 如果還是沒有內容，顯示原始文本
          if (!title && !script && !visual && !copy) {
            console.log('⚠️ 所有提取都失敗，顯示原始文本');
            resultTitleEl.innerHTML = '原始AI回應';
            resultScriptEl.innerHTML = aiText.substring(0, 500) + '...';
            resultVisualEl.innerHTML = '請檢查控制台日誌';
            resultCopyEl.innerHTML = '解析失敗';
          }
        } else {
          console.log('❌ 未找到AI回應');
        }
      };
      
      // 添加終極解決方案：直接從頁面提取
      window.extractFromPage = function() {
        console.log('=== 終極解決方案：從頁面直接提取 ===');
        
        // 方法1：從聊天記錄中提取
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('從聊天記錄提取，文本長度:', aiText.length);
          
          // 簡單粗暴的提取方法
          const lines = aiText.split('\n').filter(line => line.trim().length > 0);
          console.log('總行數:', lines.length);
          
          let title = '';
          let script = '';
          let visual = '';
          let copy = '';
          
          // 逐行掃描，找到關鍵詞就提取
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // 提取主題標題
            if (line.includes('主題標題') && line.includes('：')) {
              const match = line.match(/主題標題[：:]\s*(.+)/i);
              if (match && match[1]) {
                title = cleanMarkdownFormat(match[1].trim());
                console.log('✅ 找到主題標題:', title);
              }
            }
            
            // 提取腳本內容
            if (line.includes('腳本內容') && line.includes('：')) {
              let scriptLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('畫面感') || nextLine.includes('發佈文案') || nextLine.includes('3.') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  scriptLines.push(nextLine);
                }
              }
              if (scriptLines.length > 0) {
                script = cleanMarkdownFormat(scriptLines.join('\n'));
                console.log('✅ 找到腳本內容:', script.substring(0, 100) + '...');
              }
            }
            
            // 提取畫面感
            if (line.includes('畫面感') && line.includes('：')) {
              let visualLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('發佈文案') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  visualLines.push(nextLine);
                }
              }
              if (visualLines.length > 0) {
                visual = cleanMarkdownFormat(visualLines.join('\n'));
                console.log('✅ 找到畫面感:', visual.substring(0, 100) + '...');
              }
            }
            
            // 提取發佈文案
            if (line.includes('發佈文案') && line.includes('：')) {
              let copyLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.length > 0) {
                  copyLines.push(nextLine);
                }
              }
              if (copyLines.length > 0) {
                copy = cleanMarkdownFormat(copyLines.join('\n'));
                console.log('✅ 找到發佈文案:', copy.substring(0, 100) + '...');
              }
            }
          }
          
          // 更新結果區塊
          if (title) {
            resultTitleEl.innerHTML = title;
            console.log('✅ 設置主題標題');
          }
          if (script) {
            resultScriptEl.innerHTML = script;
            console.log('✅ 設置腳本內容');
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
            console.log('✅ 設置畫面感');
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
            console.log('✅ 設置發佈文案');
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('✅ 結果區塊已顯示');
          
          // 如果還是沒有內容，顯示原始文本
          if (!title && !script && !visual && !copy) {
            console.log('⚠️ 所有提取都失敗，顯示原始文本');
            resultTitleEl.innerHTML = '原始AI回應';
            resultScriptEl.innerHTML = aiText.substring(0, 500) + '...';
            resultVisualEl.innerHTML = '請檢查控制台日誌';
            resultCopyEl.innerHTML = '解析失敗';
          }
        } else {
          console.log('❌ 未找到AI回應');
        }
      };

      // 快速按鈕功能已移到 DOMContentLoaded 事件中

      // 檢查用戶是否要求生成腳本
      function checkIfScriptRequest(aiText) {
        console.log('=== 檢查是否為腳本生成請求 ===');
        
        // 檢查AI回應中是否包含腳本生成相關的關鍵詞
        const scriptRequestKeywords = [
          '短影音腳本',
          '生成腳本',
          '腳本生成',
          '腳本內容',
          '主題標題',
          '畫面感',
          '發佈文案',
          'Hook',
          'Value',
          'CTA',
          '短影音',
          '腳本',
          'Reels',
          'TikTok',
          '小紅書'
        ];
        
        const hasScriptKeywords = scriptRequestKeywords.some(keyword => 
          aiText.toLowerCase().includes(keyword.toLowerCase())
        );
        
        // 檢查是否包含腳本結構標記
        const hasScriptStructure = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ].some(pattern => pattern.test(aiText));
        
        const isScriptRequest = hasScriptKeywords || hasScriptStructure;
        
        console.log('包含腳本關鍵詞:', hasScriptKeywords);
        console.log('包含腳本結構:', hasScriptStructure);
        console.log('判斷為腳本請求:', isScriptRequest);
        
        return isScriptRequest;
      }

      function checkAndUpdateResults(aiText) {
        console.log('=== 開始解析AI回應 ===');
        console.log('AI回應長度:', aiText.length);
        console.log('AI回應前300字符:', aiText.substring(0, 300));
        
        // 檢查用戶是否要求生成腳本（只有這種情況才顯示腳本結果區塊）
        const isScriptRequest = checkIfScriptRequest(aiText);
        console.log('是否為腳本生成請求:', isScriptRequest);
        
        if (!isScriptRequest) {
          console.log('❌ 不是腳本生成請求，不顯示腳本結果區塊');
          return;
        }
        
        // 更精確的腳本內容檢測
        const isScriptContent = detectScriptContent(aiText);
        
        console.log('是否為腳本內容:', isScriptContent);
        
        if (isScriptContent) {
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          console.log('結果區塊已顯示，開始解析內容...');
          
          // 確保DOM元素存在
          if (!resultTitleEl || !resultScriptEl || !resultVisualEl || !resultCopyEl) {
            console.error('DOM元素不存在:', {
              resultTitleEl: !!resultTitleEl,
              resultScriptEl: !!resultScriptEl,
              resultVisualEl: !!resultVisualEl,
              resultCopyEl: !!resultCopyEl
            });
            return;
          }
          
          try {
            // 使用更靈活的解析方法
            const sections = parseAIContent(aiText);
            
            // 更新DOM元素
            if (sections.title) {
              resultTitleEl.innerHTML = sections.title;
              console.log('✅ 主題標題已設置:', sections.title);
            }
            
            if (sections.script) {
              resultScriptEl.innerHTML = sections.script;
              console.log('✅ 腳本內容已設置:', sections.script.substring(0, 100) + '...');
            }
            
            if (sections.visual) {
              resultVisualEl.innerHTML = sections.visual;
              console.log('✅ 畫面感已設置:', sections.visual.substring(0, 100) + '...');
            }
            
            if (sections.copy) {
              resultCopyEl.innerHTML = sections.copy;
              console.log('✅ 發佈文案已設置:', sections.copy.substring(0, 100) + '...');
            }
            
            // 延遲檢查內容是否正確設置
            setTimeout(() => {
              console.log('=== 延遲檢查DOM內容 ===');
              console.log('主題標題:', resultTitleEl.innerHTML);
              console.log('腳本內容:', resultScriptEl.innerHTML.substring(0, 100) + '...');
              console.log('畫面感:', resultVisualEl.innerHTML.substring(0, 100) + '...');
              console.log('發佈文案:', resultCopyEl.innerHTML.substring(0, 100) + '...');
            }, 500);
            
          } catch (e) {
            console.error('解析結果時出錯:', e);
          }
        } else {
          console.log('未檢測到腳本內容，不顯示結果區塊');
        }
      }
      
      // 新增：精確的腳本內容檢測函數
      function detectScriptContent(aiText) {
        console.log('=== 開始腳本內容檢測 ===');
        console.log('檢測文本長度:', aiText.length);
        console.log('檢測文本前200字符:', aiText.substring(0, 200));
        
        // 1. 檢查是否包含腳本相關的結構標記（更靈活的檢測）
        const structureMarkers = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ];
        
        const hasStructureMarkers = structureMarkers.some(pattern => pattern.test(aiText));
        console.log('是否包含腳本結構標記:', hasStructureMarkers);
        
        // 2. 檢查是否包含短影音腳本的關鍵元素
        const scriptElements = [
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /鏡頭[：:]/i,
          /音效[：:]/i,
          /字幕[：:]/i,
          /台詞[：:]/i
        ];
        
        const scriptElementCount = scriptElements.filter(pattern => pattern.test(aiText)).length;
        console.log('腳本元素數量:', scriptElementCount);
        
        // 檢查是否包含時間標記（Hook、Value、CTA格式）
        const timeMarkersPatterns = [
          /\(\d+-\d+秒\)\s*Hook/i,
          /\(\d+-\d+秒\)\s*Value/i,
          /\(\d+-\d+秒\)\s*CTA/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ];
        const hasTimeMarkers = timeMarkersPatterns.some(pattern => pattern.test(aiText));
        console.log('是否包含時間標記:', hasTimeMarkers);
        
        // 檢查是否包含短影音相關內容
        const videoContent = [
          /畫面感/i,
          /發佈文案/i,
          /台詞[：:]/i,
          /鏡頭[：:]/i,
          /音效[：:]/i,
          /字幕[：:]/i
        ];
        const hasVideoContent = videoContent.some(pattern => pattern.test(aiText));
        console.log('是否包含短影音內容:', hasVideoContent);
        
        // 更靈活的判斷條件
        const hasAnyScriptContent = hasStructureMarkers || scriptElementCount >= 3 || hasTimeMarkers || hasVideoContent;
        console.log('是否有任何腳本內容:', hasAnyScriptContent);
        
        if (!hasAnyScriptContent) {
          console.log('❌ 未包含足夠的腳本內容標記，不顯示結果區塊');
          console.log('檢測結果詳情:', {
            hasStructureMarkers,
            scriptElementCount,
            hasTimeMarkers,
            hasVideoContent
          });
          return false;
        }
        
        // 2. 檢查是否包含腳本相關的關鍵詞組合
        const scriptKeywords = ['主題標題', '腳本內容', '畫面感', '發佈文案', 'Hook', 'Value', 'CTA'];
        const keywordCount = scriptKeywords.filter(keyword => aiText.includes(keyword)).length;
        console.log('腳本關鍵詞數量:', keywordCount);
        
        // 3. 檢查是否包含短影音相關的內容指示詞
        const videoIndicators = [
          '短影音腳本',
          '短影音腳本結果',
          '生成腳本',
          '腳本生成',
          'Reels',
          'TikTok',
          '小紅書',
          '秒腳本',
          '影音內容',
          '短影音',
          '腳本'
        ];
        const hasVideoIndicators = videoIndicators.some(indicator => aiText.includes(indicator));
        console.log('是否包含短影音指示詞:', hasVideoIndicators);
        
        // 4. 檢查文本長度（腳本內容通常較長）
        const isLongEnough = aiText.length > 300; // 提高長度要求
        console.log('文本是否足夠長:', isLongEnough);
        
        // 5. 檢查是否包含多個段落（腳本通常有多個部分）
        const paragraphCount = aiText.split('\n\n').filter(p => p.trim().length > 0).length;
        const hasMultipleParagraphs = paragraphCount >= 4; // 提高段落要求
        console.log('段落數量:', paragraphCount, '是否多段落:', hasMultipleParagraphs);
        
        // 6. 排除明顯的非腳本內容
        const nonScriptIndicators = [
          '你好',
          '謝謝',
          '不客氣',
          '請問',
          '不好意思',
          '抱歉',
          '我來幫你',
          '讓我為你',
          '很高興為您',
          '歡迎',
          '再見',
          '拜拜',
          '有什麼可以幫你',
          '需要什麼幫助',
          '請告訴我',
          '請輸入',
          '請選擇',
          '請點擊',
          '請查看',
          '請注意',
          '提醒',
          '建議',
          '推薦',
          '介紹',
          '說明',
          '解釋',
          '回答',
          '回覆',
          '回應'
        ];
        const hasNonScriptIndicators = nonScriptIndicators.some(indicator => 
          aiText.toLowerCase().includes(indicator.toLowerCase())
        );
        console.log('是否包含非腳本指示詞:', hasNonScriptIndicators);
        
        // 7. 檢查是否包含完整的腳本結構（至少包含3個區塊）
        const requiredStructureMarkers = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i
        ];
        const structureCount = requiredStructureMarkers.filter(pattern => pattern.test(aiText)).length;
        const hasCompleteStructure = structureCount >= 3;
        console.log('結構區塊數量:', structureCount, '是否完整結構:', hasCompleteStructure);
        
        // 8. 檢查是否包含時間標記（腳本通常有時間標記）
        const timeMarkersGeneral = [
          /\d+[-\s]*\d*\s*秒/i,
          /\d+[-\s]*\d*\s*分鐘/i,
          /0-\d+\s*秒/i,
          /\d+-\d+\s*秒/i
        ];
        const hasTimeMarkersGeneral = timeMarkersGeneral.some(pattern => pattern.test(aiText));
        console.log('是否包含一般時間標記:', hasTimeMarkersGeneral);
        
        // 綜合判斷
        const score = {
          structureMarkers: hasStructureMarkers ? 3 : 0,
          scriptElements: Math.min(scriptElementCount, 4), // 腳本元素數量
          keywordCount: Math.min(keywordCount, 3),
          videoIndicators: hasVideoIndicators ? 2 : 0,
          length: isLongEnough ? 1 : 0,
          paragraphs: hasMultipleParagraphs ? 1 : 0,
          completeStructure: hasCompleteStructure ? 2 : 0,
          timeMarkers: hasTimeMarkers ? 1 : 0,
          timeMarkersGeneral: hasTimeMarkersGeneral ? 1 : 0,
          videoContent: hasVideoContent ? 1 : 0,
          nonScript: hasNonScriptIndicators ? -5 : 0 // 高懲罰
        };
        
        const totalScore = Object.values(score).reduce((sum, val) => sum + val, 0);
        
        console.log('腳本檢測評分:', score);
        console.log('總分:', totalScore);
        
        // 更靈活的判斷條件
        const isScriptContent = totalScore >= 4 && (hasStructureMarkers || scriptElementCount >= 3);
        
        // 如果包含非腳本指示詞，降低評分但不完全拒絕
        if (hasNonScriptIndicators) {
          console.log('⚠️ 包含非腳本指示詞，但內容結構完整，仍視為腳本內容');
        }
        
        console.log('是否為腳本內容:', isScriptContent);
        console.log('=== 腳本內容檢測結束 ===');
        
        return isScriptContent;
      }
      
      // 新增：更精確的AI內容解析函數
      function parseAIContent(aiText) {
        const sections = {
          title: '',
          script: '',
          visual: '',
          copy: ''
        };
        
        console.log('開始解析AI內容...');
        console.log('原始AI文本長度:', aiText.length);
        console.log('原始AI文本前500字符:', aiText.substring(0, 500));
        
        // 使用正則表達式精確提取每個區塊的內容
        try {
          // 通用內容提取策略 - 應對所有可能的AI格式變化
          let scriptContent = aiText;
          let extractionMethod = 'full';
          
          // 策略1: 檢查是否有 --- 分隔符
          const dashSections = aiText.split(/---/);
          if (dashSections.length > 1) {
            const contentSections = dashSections.slice(1);
            scriptContent = contentSections.join('---').trim();
            extractionMethod = 'dash-separated';
            console.log('✅ 使用 --- 分隔策略');
          }
          // 策略2: 檢查是否有明確的結構標記
          else if (aiText.includes('主題標題') || aiText.includes('腳本內容') || aiText.includes('畫面感') || aiText.includes('發佈文案')) {
            scriptContent = aiText;
            extractionMethod = 'structured';
            console.log('✅ 使用結構化標記策略');
          }
          // 策略3: 檢查是否有 Hook/Value/CTA 結構
          else if (aiText.includes('Hook') || aiText.includes('Value') || aiText.includes('CTA')) {
            scriptContent = aiText;
            extractionMethod = 'hook-value-cta';
            console.log('✅ 使用 Hook/Value/CTA 策略');
          }
          // 策略4: 檢查是否有時間標記
          else if (aiText.match(/\d+-\d+秒/) || aiText.match(/\d+秒/)) {
            scriptContent = aiText;
            extractionMethod = 'time-marked';
            console.log('✅ 使用時間標記策略');
          }
          // 策略5: 默認使用完整內容
          else {
            scriptContent = aiText;
            extractionMethod = 'full';
            console.log('✅ 使用完整內容策略');
          }
          
          console.log('提取方法:', extractionMethod);
            console.log('腳本內容長度:', scriptContent.length);
            console.log('腳本內容前200字符:', scriptContent.substring(0, 200));
          
          // 超級智能主題標題提取器 - 應對所有可能的AI格式
          function extractTitle(scriptContent) {
          const titlePatterns = [
              // 1. 表情符號 + 標題格式
              /[🎬📝🎯✨🔥📌]\s*主題標題[：:]\s*([^\n]+)/i,
              /[🎬📝🎯✨🔥📌]\s*主題[：:]\s*([^\n]+)/i,
              /[🎬📝🎯✨🔥📌]\s*標題[：:]\s*([^\n]+)/i,
              
              // 2. 標準標題格式
            /主題標題[：:]\s*([^\n]+)/i,
            /主題[：:]\s*([^\n]+)/i,
            /標題[：:]\s*([^\n]+)/i,
              
              // 3. 編號 + 標題格式
            /\d+\.\s*主題標題[：:]\s*([^\n]+)/i,
            /\d+\.\s*主題[：:]\s*([^\n]+)/i,
            /\d+\.\s*標題[：:]\s*([^\n]+)/i,
              
              // 4. 粗體標題格式
            /\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\*\*主題\*\*[：:]\s*([^\n]+)/i,
            /\*\*標題\*\*[：:]\s*([^\n]+)/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*主題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*標題\*\*[：:]\s*([^\n]+)/i,
              
              // 6. Markdown 標題格式
            /###\s*主題標題[：:]\s*([^\n]+)/i,
            /###\s*主題[：:]\s*([^\n]+)/i,
            /###\s*標題[：:]\s*([^\n]+)/i,
              /##\s*主題標題[：:]\s*([^\n]+)/i,
              /##\s*主題[：:]\s*([^\n]+)/i,
              /##\s*標題[：:]\s*([^\n]+)/i,
              
              // 7. 行首標題格式（--- 分隔後）
              /^主題標題[：:]\s*([^\n]+)/i,
              /^標題[：:]\s*([^\n]+)/i,
              /^主題[：:]\s*([^\n]+)/i,
              
              // 8. AI 狡猾格式：直接給標題，沒有前綴
            /^你的.*來了.*小紅書.*都在.*用的.*AI智能體.*$/i,
            /^.*AI智能體.*來了.*$/i,
            /^.*小紅書.*博主.*都在.*用的.*$/i,
              /^.*效率.*爆棚.*$/i,
              /^.*AI.*智能體.*這樣玩.*$/i,
              
              // 9. 引號標題格式
              /「([^」]+)」/,
              /"([^"]+)"/,
              /'([^']+)'/,
              
              // 10. 特殊標題模式
              /^.*你還在.*方法.*AI智能體.*效率.*爆棚.*$/i,
              /^.*AI智能體.*效率.*翻倍.*$/i,
              /^.*超級.*學伴.*$/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = scriptContent.match(pattern);
            if (match) {
              // 處理有捕獲組的情況
              if (match[1] && match[1].trim()) {
                  const title = cleanMarkdownFormat(match[1].trim());
                  if (title.length > 5 && title.length < 100) { // 合理的標題長度
                    console.log('✅ 找到主題標題(有前綴):', title);
                    return title;
                  }
              }
              // 處理沒有前綴，直接匹配整行的情況
              else if (match[0] && match[0].trim()) {
                  const title = cleanMarkdownFormat(match[0].trim());
                  if (title.length > 5 && title.length < 100) {
                    console.log('✅ 找到主題標題(無前綴):', title);
                    return title;
                  }
                }
              }
            }
            
            // 如果沒有找到明確的標題，嘗試提取第一行作為標題
            const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
            for (const line of lines) {
              const trimmedLine = line.trim();
              // 跳過明顯不是標題的行
              if (trimmedLine.match(/^(Hook|Value|CTA|畫面感|發佈文案|\d+\.|\(|台詞|鏡頭|音效|字幕|主題建議|目標|切入點|內容方向|好的|沒問題|讓我)/i)) {
                continue;
              }
              // 檢查是否為合理的標題
              if (trimmedLine.length > 5 && trimmedLine.length < 100 && !trimmedLine.includes('：') && !trimmedLine.includes(':')) {
                console.log('使用第一行作為主題標題:', trimmedLine);
                return cleanMarkdownFormat(trimmedLine);
              }
            }
            
            return '';
          }
          
          // 提取主題標題
          sections.title = extractTitle(scriptContent);
          
          // 超級智能腳本內容提取器 - 應對所有可能的AI格式
          function extractScript(scriptContent) {
          const scriptPatterns = [
              // 1. 標準腳本內容格式
            /腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 2. 表情符號 + 腳本內容格式
              /[📝🎬📜✨🔥]\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /[📝🎬📜✨🔥]\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 3. 編號 + 腳本內容格式
            /\d+\.\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
              
              // 4. 粗體腳本內容格式
            /\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /\*\*腳本\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*\*\*腳本\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
              
              // 6. Markdown 標題格式
              /###\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*畫面感|###\s*發佈文案|畫面感|發佈文案|$))/i,
              /###\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*畫面感|###\s*發佈文案|畫面感|發佈文案|$))/i,
              /##\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*畫面感|##\s*發佈文案|畫面感|發佈文案|$))/i,
              /##\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*畫面感|##\s*發佈文案|畫面感|發佈文案|$))/i,
              
              // 7. 行首腳本內容格式（--- 分隔後）
            /^腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /^腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 8. Hook/Value/CTA 結構格式
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Hook[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value\s*\d+|CTA|畫面感|發佈文案|$)/i,
              
              // 9. 台詞格式
              /台詞[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /台詞\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              
              // 10. 特殊腳本模式
              /^.*你還在.*手動.*報告.*寫文案.*落伍.*超級助理.*AI智能體.*$/i,
              /^.*它不只是.*程式.*真人.*思考.*學習.*$/i,
              /^.*想像一下.*專屬團隊.*24小時.*待命.*$/i,
              /^.*重點是.*越來越聰明.*不斷進化.*$/i,
              /^.*想知道.*怎麼開始.*AI智能體.*$/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = scriptContent.match(pattern);
              if (match) {
                let scriptText = '';
                if (match[1] && match[1].trim()) {
                  scriptText = match[1].trim();
                } else if (match[0] && match[0].trim()) {
                  scriptText = match[0].trim();
                }
                
                if (scriptText && scriptText.length > 10) {
                  console.log('✅ 找到腳本內容:', scriptText.substring(0, 100) + '...');
                  return cleanMarkdownFormat(scriptText);
                }
            }
          }
          
          // 如果沒有找到明確的腳本內容標記，嘗試提取 Hook、Value、CTA 部分
            console.log('嘗試提取 Hook/Value/CTA 內容...');
            
            // 支援多種時間標記格式
            const hookPatterns = [
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Hook[\s\S]*?(?=Value|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value\s*\d+|CTA|畫面感|發佈文案|$)/i
            ];
            const valuePatterns = [
              /Value\s*\d+\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Value\s*\d+[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Value\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i
            ];
            const ctaPatterns = [
              /CTA\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*CTA[\s\S]*?(?=畫面感|發佈文案|$)/i
            ];
            
            let extractedScriptContent = '';
            
            // 提取 Hook
            for (const pattern of hookPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                console.log('找到 Hook:', match[0].substring(0, 100) + '...');
                extractedScriptContent += match[0] + '\n\n';
                break;
              }
            }
            
            // 提取 Value
            for (const pattern of valuePatterns) {
              const matches = scriptContent.match(new RegExp(pattern.source, 'gi'));
              if (matches) {
                console.log('找到 Value 數量:', matches.length);
                extractedScriptContent += matches.join('\n\n');
                break;
              }
            }
            
            // 提取 CTA
            for (const pattern of ctaPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                console.log('找到 CTA:', match[0].substring(0, 100) + '...');
                extractedScriptContent += '\n\n' + match[0];
                break;
              }
            }
            
            if (extractedScriptContent.trim()) {
              console.log('使用 Hook/Value/CTA 作為腳本內容:', extractedScriptContent.substring(0, 100) + '...');
              return cleanMarkdownFormat(extractedScriptContent.trim());
            }
            
            return '';
          }
          
          // 提取腳本內容
          sections.script = extractScript(scriptContent);
          
          // 超級智能畫面感提取器 - 應對所有可能的AI格式
          function extractVisual(scriptContent) {
          const visualPatterns = [
              // 1. 標準畫面感格式
            /畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 2. 表情符號 + 畫面感格式
              /[🎬🎞️📹✨🔥]\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              /[🎬🎞️📹✨🔥]\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 3. 編號 + 畫面感格式
            /\d+\.\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              // 新增：編號 + 括號格式
              /\d+\.\s*畫面感\s*\([^)]*\)[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              /\d+\.\s*畫面\s*\([^)]*\)[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              
              // 4. 粗體畫面感格式
            /\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /\*\*畫面\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*\*\*畫面\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              
              // 6. Markdown 標題格式
            /###\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*發佈文案|發佈文案|$))/i,
            /###\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*發佈文案|發佈文案|$))/i,
              /##\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*發佈文案|發佈文案|$))/i,
              /##\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*發佈文案|發佈文案|$))/i,
              
              // 7. 行首畫面感格式（--- 分隔後）
            /^畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              /^畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 8. 特殊畫面感模式
              /^.*開場.*Hook.*鏡頭.*特寫.*$/i,
              /^.*核心價值.*鏡頭.*中景.*$/i,
              /^.*行動呼籲.*鏡頭.*指向.*$/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // 檢查是否為「尚未生成」
              if (match[1].trim() === '尚未生成' || match[1].trim().includes('尚未生成')) {
                console.log('⚠️ 畫面感標記為「尚未生成」');
                  return 'AI 未生成畫面感內容';
              } else {
                  const visual = cleanMarkdownFormat(match[1].trim());
                  console.log('✅ 找到畫面感:', visual.substring(0, 100) + '...');
                  return visual;
                }
              }
            }
            
            return '';
          }
          
          // 提取畫面感
          sections.visual = extractVisual(scriptContent);
          
          // 超級智能發佈文案提取器 - 應對所有可能的AI格式
          function extractCopy(scriptContent) {
          const copyPatterns = [
              // 1. 標準發佈文案格式
            /發佈文案[：:]\s*([\s\S]*?)$/i,
            /文案[：:]\s*([\s\S]*?)$/i,
              
              // 2. 表情符號 + 發佈文案格式
              /[📱📄📝✨🔥]\s*發佈文案[：:]\s*([\s\S]*?)$/i,
              /[📱📄📝✨🔥]\s*文案[：:]\s*([\s\S]*?)$/i,
              
              // 3. 編號 + 發佈文案格式
            /\d+\.\s*發佈文案[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*文案[：:]\s*([\s\S]*?)$/i,
              // 新增：編號 + 括號格式
              /\d+\.\s*發佈文案\s*\([^)]*\)[：:]\s*([\s\S]*?)$/i,
              /\d+\.\s*文案\s*\([^)]*\)[：:]\s*([\s\S]*?)$/i,
              
              // 4. 粗體發佈文案格式
            /\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\*\*文案\*\*[：:]\s*([\s\S]*?)$/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*文案\*\*[：:]\s*([\s\S]*?)$/i,
              
              // 6. Markdown 標題格式
            /###\s*發佈文案[：:]\s*([\s\S]*?)$/i,
            /###\s*文案[：:]\s*([\s\S]*?)$/i,
              /##\s*發佈文案[：:]\s*([\s\S]*?)$/i,
              /##\s*文案[：:]\s*([\s\S]*?)$/i,
              
              // 7. 行首發佈文案格式（--- 分隔後）
            /^發佈文案[：:]\s*([\s\S]*?)$/i,
              /^文案[：:]\s*([\s\S]*?)$/i,
              
              // 8. 特殊發佈文案模式
              /^.*還在.*繁瑣.*工作.*AI智能體.*救星.*$/i,
              /^.*自動化.*提升效率.*客製化.*$/i,
              /^.*未來趨勢.*點擊.*主頁.*連結.*$/i,
              /^.*免費.*領取.*AI.*入門.*指南.*$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // 檢查是否為「尚未生成」
              if (match[1].trim() === '尚未生成' || match[1].trim().includes('尚未生成')) {
                console.log('⚠️ 發佈文案標記為「尚未生成」');
                  return 'AI 未生成發佈文案內容';
              } else {
                  const copy = cleanMarkdownFormat(match[1].trim());
                  console.log('✅ 找到發佈文案:', copy.substring(0, 100) + '...');
                  return copy;
                }
              }
            }
            
            return '';
          }
          
          // 提取發佈文案
          sections.copy = extractCopy(scriptContent);
          
          // 最終調試輸出
          console.log('=== 超級智能解析結果 ===');
          console.log('提取方法:', extractionMethod);
          console.log('主題標題:', sections.title ? '✅ 有內容' : '❌ 無內容');
          console.log('腳本內容:', sections.script ? '✅ 有內容' : '❌ 無內容');
          console.log('畫面感:', sections.visual ? '✅ 有內容' : '❌ 無內容');
          console.log('發佈文案:', sections.copy ? '✅ 有內容' : '❌ 無內容');
          
          // 如果任何欄位為空，嘗試最後的強制提取
          if (!sections.title || !sections.script || !sections.visual || !sections.copy) {
            console.log('🔄 啟動最後的強制提取機制...');
            
            // 強制提取主題標題
            if (!sections.title) {
              const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
              for (const line of lines) {
                if (line.length > 10 && line.length < 100 && !line.includes('：') && !line.includes(':')) {
                  sections.title = cleanMarkdownFormat(line.trim());
                    console.log('強制提取主題標題:', sections.title);
                  break;
                }
              }
            }
            
            // 強制提取腳本內容
            if (!sections.script) {
              const scriptMatch = scriptContent.match(/(?:Hook|Value|CTA)[\s\S]*?(?=畫面感|發佈文案|$)/i);
              if (scriptMatch) {
                sections.script = cleanMarkdownFormat(scriptMatch[0].trim());
                console.log('強制提取腳本內容:', sections.script.substring(0, 100) + '...');
              }
            }
            
            // 強制提取畫面感
            if (!sections.visual) {
              const visualMatch = scriptContent.match(/畫面感[：:]\s*([\s\S]*?)(?=發佈文案|$)/i);
              if (visualMatch && visualMatch[1]) {
                if (visualMatch[1].trim() === '尚未生成' || visualMatch[1].trim().includes('尚未生成')) {
                  sections.visual = 'AI 未生成畫面感內容';
                } else {
                  sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
                }
                  console.log('強制提取畫面感:', sections.visual.substring(0, 100) + '...');
              }
            }
            
            // 強制提取發佈文案
            if (!sections.copy) {
              const copyMatch = scriptContent.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
              if (copyMatch && copyMatch[1]) {
                if (copyMatch[1].trim() === '尚未生成' || copyMatch[1].trim().includes('尚未生成')) {
                  sections.copy = 'AI 未生成發佈文案內容';
                } else {
                  sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
                }
                  console.log('強制提取發佈文案:', sections.copy.substring(0, 100) + '...');
              }
            }
          }
          
        } catch (error) {
          console.error('解析AI內容時出錯:', error);
        }
        
        console.log('=== 最終解析結果 ===');
        console.log('主題標題:', sections.title ? '✅ 有內容' : '❌ 無內容');
        console.log('腳本內容:', sections.script ? '✅ 有內容' : '❌ 無內容');
        console.log('畫面感:', sections.visual ? '✅ 有內容' : '❌ 無內容');
        console.log('發佈文案:', sections.copy ? '✅ 有內容' : '❌ 無內容');
        
        // 如果所有內容都為空，嘗試強制提取
        if (!sections.title && !sections.script && !sections.visual && !sections.copy) {
          console.log('⚠️ 所有內容都為空，嘗試強制提取...');
          
          // 強制提取主題標題
          const titleMatch = aiText.match(/主題標題[：:]\s*([^\n]+)/i);
          if (titleMatch && titleMatch[1]) {
            sections.title = cleanMarkdownFormat(titleMatch[1].trim());
            console.log('強制提取主題標題:', sections.title);
          }
          
          // 強制提取腳本內容
          const scriptMatch = aiText.match(/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i);
          if (scriptMatch && scriptMatch[1]) {
            sections.script = cleanMarkdownFormat(scriptMatch[1].trim());
            console.log('強制提取腳本內容:', sections.script.substring(0, 100) + '...');
          }
          
          // 強制提取畫面感
          const visualMatch = aiText.match(/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i);
          if (visualMatch && visualMatch[1]) {
            sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
            console.log('強制提取畫面感:', sections.visual.substring(0, 100) + '...');
          }
          
          // 強制提取發佈文案
          const copyMatch = aiText.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
          if (copyMatch && copyMatch[1]) {
            sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
            console.log('強制提取發佈文案:', sections.copy.substring(0, 100) + '...');
          }
        }
        
        console.log('完整解析結果:', sections);
        return sections;
      }
    </script>
  </body>
  </html>




