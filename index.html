<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AIJobçŸ­å½±éŸ³æ™ºèƒ½é«”</title>
    <style>
      :root { color-scheme: light; }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#ffffff; color:#1a1a1a; }
      .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
      
      /* ä¸»è¦å¸ƒå±€ï¼šå·¦å³åˆ†æ¬„ 5:5 */
      .main-layout { 
        display: flex; 
        gap: 20px; 
        min-height: calc(100vh - 100px);
      }
      
      /* å·¦å´é¢æ¿ - 5ä»½ */
      .left-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* å³å´é¢æ¿ - 5ä»½ */
      .right-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* å·¦å´å…§å®¹å€åŸŸ */
      .left-content {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      /* çµæœå€å¡Šæ¨™ç±¤åˆ‡æ› */
      .result-tabs {
        display: flex;
        background: white;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-bottom: none;
        overflow: hidden;
      }
      
      .result-tab {
        flex: 1;
        padding: 16px 20px;
        background: #f8fafc;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-right: 1px solid #e5e7eb;
      }
      
      .result-tab:last-child {
        border-right: none;
      }
      
      .result-tab.active {
        background: white;
        color: #1f2937;
        border-bottom: 2px solid #3b82f6;
      }
      
      .result-tab:hover {
        background: #f1f5f9;
      }
      
      /* çµæœå€å¡Šå®¹å™¨ */
      .results-container {
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-top: none;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .result-content {
        flex: 1;
        padding: 20px;
        min-height: 400px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-content.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      /* çµæœå€å¡Šæ–°æ¨£å¼ */
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .result-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
      }
      
      .generate-btn {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .generate-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }
      
      .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      
      .result-body {
        min-height: 200px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-body.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      .result-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }
      
      .save-btn, .regenerate-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .save-btn {
        background: #10b981;
        color: white;
        border-color: #10b981;
      }
      
      .save-btn:hover {
        background: #059669;
        border-color: #059669;
      }
      
      .regenerate-btn {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
      }
      
      .regenerate-btn:hover {
        background: #d97706;
        border-color: #d97706;
      }
      
      /* èŠå¤©å€åŸŸæ¨£å¼ */
      .chat-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 20px;
        min-height: 600px;
        flex: 1;
      }
      
      .chat-messages {
        background: white;
        border-radius: 12px;
        padding: 16px;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex: 1;
      }
      
      .message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      
      .message.user {
        background: #dbeafe;
        color: #1e40af;
        margin-left: 20px;
      }
      
      .message.ai {
        background: #f0f9ff;
        color: #0c4a6e;
        margin-right: 20px;
      }
      
      .input-row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }
      
      .input-row textarea {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 60px;
        max-height: 200px;
        line-height: 1.4;
        font-family: inherit;
      }
      
      .input-row textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .input-row button {
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      
      .input-row button:hover {
        background: #2563eb;
      }
      
      /* ç”¨æˆ¶æŠ½å±œæ¨£å¼ - å·¦å³å…©æ¬„å½ˆå‡ºå¼è¦–çª— */
      .user-drawer {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        width: 800px;
        max-width: 95vw;
        height: 600px;
        max-height: 90vh;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
      }
      
      .user-drawer.open {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        visibility: visible;
      }
      
      .user-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      
      .user-drawer-overlay.open {
        display: block;
      }
      
      .user-drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        flex-shrink: 0;
      }
      
      .user-drawer-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .app-logo {
        font-size: 20px;
        font-weight: bold;
        color: #3b82f6;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .app-name {
        font-size: 16px;
        color: #374151;
        font-weight: 500;
      }
      
      .user-drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .user-drawer-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      /* å·¦å³å…©æ¬„å¸ƒå±€ */
      .user-drawer-body {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      /* å·¦å´é¸å–®æ¬„ */
      .user-drawer-sidebar {
        width: 250px;
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      
      .user-profile {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .user-drawer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
      }
      
      .user-drawer-info h3 {
        margin: 0;
        font-size: 16px;
        color: #1f2937;
        font-weight: 600;
      }
      
      .user-drawer-info p {
        margin: 4px 0 0 0;
        font-size: 14px;
        color: #6b7280;
      }
      
      /* å³å´å…§å®¹å€åŸŸ */
      .user-drawer-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: white;
      }
      
      
      .user-drawer-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
      }
      
      .user-drawer-menu li {
        margin: 0;
      }
      
      .user-drawer-menu a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: #374151;
        text-decoration: none;
        border-radius: 0;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        font-weight: 500;
      }
      
      .user-drawer-menu a:hover {
        background: #f3f4f6;
        color: #1f2937;
      }
      
      .user-drawer-menu a.active {
        background: #dbeafe;
        color: #1d4ed8;
        border-left-color: #3b82f6;
        font-weight: 600;
      }
      
      .user-drawer-menu .icon {
        width: 20px;
        height: 20px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h2 {
        margin: 0 0 24px 0;
        font-size: 24px;
        color: #1f2937;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 12px;
      }
      
      .user-info-detail {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      
      .info-item label {
        font-weight: 600;
        color: #374151;
        min-width: 80px;
      }
      
      .info-item span {
        color: #6b7280;
        word-break: break-all;
      }
      
      .generations-list, .conversations-list, .memory-content {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .generation-item, .conversation-item {
        background: #f9fafb;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid #3b82f6;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform, .generation-topic {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      
      .generation-content, .conversation-summary {
        color: #374151;
        line-height: 1.5;
        margin-bottom: 8px;
      }
      
      .generation-date, .conversation-date {
        font-size: 12px;
        color: #9ca3af;
      }
      
      .loading-text {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 20px;
      }
      
      /* æŠ½å±œå…§å®¹å€åŸŸæ¨£å¼ */
      .drawer-content {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      
      .user-info-detail {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }
      
      .info-item {
        display: flex;
        margin-bottom: 10px;
      }
      
      .info-item label {
        font-weight: bold;
        min-width: 80px;
        color: #666;
      }
      
      .info-item span {
        color: #333;
      }
      
      .generations-list,
      .conversations-list,
      .memory-content {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .generation-item,
      .conversation-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 3px solid #007bff;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-topic {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-content,
      .conversation-summary {
        color: #333;
        margin-bottom: 5px;
        line-height: 1.4;
      }
      
      .generation-date,
      .conversation-date {
        color: #666;
        font-size: 12px;
      }
      
      .loading-text {
        text-align: center;
        color: #666;
        font-style: italic;
      }
      
      /* è¨­å®šå€å¡Šæ¨£å¼ */
      .settings-block {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      
      .settings-block h3 {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .setting-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .setting-item label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }
      
      .setting-item input,
      .setting-item select {
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      
      .setting-item input:focus,
      .setting-item select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .apply-btn {
        width: 100%;
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .apply-btn:hover {
        background: #2563eb;
      }
      
      /* AI èªªæ˜å€å¡Šæ¨£å¼ */
      .ai-instructions {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      
      .ai-instructions h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .instruction-list p {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* æ§åˆ¶å€åŸŸæ¨£å¼ */
      .controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .controls .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .control-btn, .secondary-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
      }
      
      .control-btn {
        background: #10b981;
        color: white;
      }
      
      .control-btn:hover {
        background: #059669;
      }
      
      .secondary-btn {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }
      
      .secondary-btn:hover {
        background: #e5e7eb;
      }
      
      .controls textarea {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 50px;
        font-family: inherit;
      }
      
      .controls textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .send-btn {
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      
      .send-btn:hover {
        background: #2563eb;
      }
      
      /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
      @media (max-width: 768px) {
        .container { padding: 12px; }
        .main-layout { 
          flex-direction: column; 
          gap: 16px;
        }
        .left-panel { 
          order: 1;
        }
        .right-panel { 
          order: 2;
        }
        .left-content {
          padding: 16px;
        }
        .settings-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .chat-messages {
          min-height: 300px;
          max-height: 400px;
        }
        .result-tabs {
          flex-direction: column;
        }
        .result-tab {
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
        }
        .result-tab:last-child {
          border-bottom: none;
        }
        .result-content {
          min-height: 200px;
        }
        .user-drawer {
          width: 280px;
          right: -280px;
        }
        .input-row {
          flex-direction: column;
          gap: 8px;
        }
        .input-row button {
          width: 100%;
        }
        h1 { font-size: 16px; margin-bottom: 12px; }
        .chat { height: 50vh; padding: 12px; }
        .msg-bubble { max-width: 85%; padding: 10px 14px; font-size: 14px; }
        .settings-block { padding: 16px; margin-bottom: 12px; }
        .settings-block h3 { font-size: 14px; margin-bottom: 12px; }
        .settings-grid { grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
        .setting-item input, .setting-item select { padding: 10px 12px; font-size: 16px; }
        .apply-btn { padding: 12px 16px; font-size: 14px; }
        .controls { flex-direction: column; gap: 10px; }
        .controls .row { flex-direction: row !important; justify-content: space-between; }
        .controls .row button { flex: 1; margin: 0 4px; }
        textarea { min-height: 50px; font-size: 16px; }
        button { padding: 12px 16px; font-size: 14px; }
        .results-block { padding: 16px; }
        .results-block h3 { font-size: 14px; }
        .result-item h4 { font-size: 13px; }
        .result-item .content { padding: 10px; font-size: 14px; }
        .toast { top: 10px; right: 10px; left: 10px; max-width: none; font-size: 13px; }
      }
      h1 { font-size: 18px; font-weight: 600; color:#2563eb; margin: 0 0 16px; }
      
      /* ç”¨æˆ¶èªè­‰æ¨£å¼ */
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 16px; 
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-info { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .user-info:hover {
        background: #f3f4f6;
      }
      .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #e5e7eb; }
      .user-name { font-size: 14px; font-weight: 500; color: #374151; }
      .auth-buttons { display: flex; gap: 8px; }
      .login-btn, .logout-btn { 
        padding: 8px 16px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.2s;
      }
      .login-btn { 
        background: #4285f4; 
        color: white; 
      }
      .login-btn:hover { background: #3367d6; }
      .logout-btn { 
        background: #f3f4f6; 
        color: #374151; 
        border: 1px solid #d1d5db;
      }
      .logout-btn:hover { background: #e5e7eb; }
      
      /* å½ˆè·³è¦–çª—ç™»å…¥æ¨£å¼ */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      
      .popup-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }
      
      .popup-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      
      .popup-message {
        font-size: 16px;
        color: #2c3e50;
        margin-bottom: 20px;
      }
      
      .popup-btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 10px;
      }
      
      .popup-btn:hover {
        background: #2980b9;
      }
      
      .popup-btn.secondary {
        background: #95a5a6;
      }
      
      .popup-btn.secondary:hover {
        background: #7f8c8d;
      }
      
      /* æ‰‹æ©Ÿç‰ˆç”¨æˆ¶èªè­‰å„ªåŒ– */
      @media (max-width: 768px) {
        .header { flex-direction: column; align-items: flex-start; gap: 12px; }
        .user-info { width: 100%; justify-content: space-between; }
        .auth-buttons { width: 100%; justify-content: flex-end; }
        .login-btn, .logout-btn { padding: 10px 16px; font-size: 16px; }
      }
      .chat { border: 1px solid #e5e7eb; background: #f9fafb; border-radius: 12px; height: 60vh; overflow: auto; padding: 16px; }
      .msg { margin: 12px 0; line-height: 1.6; display: flex; }
      .msg.user { justify-content: flex-end; }
      .msg.assistant { justify-content: flex-start; }
      .msg-bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; white-space: pre-wrap; word-wrap: break-word; }
      .msg.user .msg-bubble { background: #3b82f6; color: #ffffff; border-bottom-right-radius: 4px; }
      .msg.assistant .msg-bubble { background: #f3f4f6; color: #374151; border-bottom-left-radius: 4px; }
      .msg-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
      .msg.user .msg-label { text-align: right; }
      .msg.assistant .msg-label { text-align: left; }
      
      /* è¼‰å…¥å‹•ç•« */
      .loading { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        padding: 8px 12px;
        background: #f0f9ff;
        color: #0c4a6e;
        border-radius: 8px;
        margin-right: 20px;
        max-width: 70%;
        position: relative;
      }
      
      .loading::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid #f0f9ff;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
      }
      .spinner { 
        width: 16px; 
        height: 16px; 
        border: 2px solid #e5e7eb; 
        border-top: 2px solid #3b82f6; 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .controls { display: flex; gap: 8px; margin-top: 12px; align-items:center; }
      textarea { flex: 1; min-height: 44px; max-height: 140px; resize: vertical; border-radius: 10px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding: 10px 12px; line-height: 1.4; -webkit-appearance: none; }
      button { padding: 10px 14px; border-radius: 10px; border:1px solid #d1d5db; background:#f9fafb; color:#374151; cursor:pointer; -webkit-appearance: none; }
      button:disabled { opacity: .6; cursor:not-allowed; }
      .row { display:flex; gap:8px; flex-direction:column; }
      .meta { display:flex; gap:8px; margin-bottom:8px; align-items:center; flex-wrap:wrap; }
      .meta input, .meta select { flex:1; min-width: 200px; border-radius: 8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding:8px 10px; }
      .small { font-size:12px; color:#6b7280; }
      .tag { display:inline-block; padding:4px 8px; border:1px solid #d1d5db; border-radius:999px; font-size:12px; color:#6b7280; background:#f3f4f6; }
      
      /* è¨­å®šå€å¡Šæ¨£å¼ */
      .settings-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; }
      .settings-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; cursor:pointer; user-select:none; display:flex; align-items:center; gap:8px; }
      .settings-block h3:hover { color:#1d4ed8; }
      .settings-toggle { font-size:12px; transition:transform 0.2s ease; }
      .settings-content { transition:all 0.3s ease; overflow:hidden; }
      .settings-content.collapsed { max-height:0; margin:0; padding:0; }
      .settings-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px; }
      .setting-item { display:flex; flex-direction:column; gap:6px; }
      .setting-item label { font-size:12px; color:#6b7280; font-weight:500; }
      .setting-item input, .setting-item select { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; -webkit-appearance: none; }
      .apply-btn { background:#3b82f6; border:1px solid #2563eb; color:#ffffff; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; }
      .apply-btn:hover { background:#2563eb; }
      .applied-tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
      
      /* çµæœå€å¡Šæ¨£å¼ */
      .results-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-top:16px; display:none; }
      .results-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; }
      .result-item { margin-bottom:16px; }
      .result-item h4 { margin:0 0 8px; color:#374151; font-size:14px; font-weight:500; }
      .result-item .content { background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:12px; color:#374151; white-space:pre-wrap; line-height:1.6; }
      
      /* å½ˆå‡ºæ¡†æ¨£å¼ */
      .toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px; max-width: 300px; word-wrap: break-word; }
      .toast.show { animation: slideIn 0.3s ease-out; }
      .toast.hide { animation: slideOut 0.3s ease-in; }
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
      
      /* iOS Safari ç‰¹å®šå„ªåŒ– */
      @supports (-webkit-touch-callout: none) {
        .chat { -webkit-overflow-scrolling: touch; }
        textarea { -webkit-user-select: text; }
        input, select { -webkit-user-select: text; }
        .msg-bubble { -webkit-user-select: text; }
        .result-item .content { -webkit-user-select: text; }
      }
      
      /* é˜²æ­¢ iOS Safari ç¸®æ”¾ */
      input[type="text"], input[type="email"], input[type="password"], textarea, select { font-size: 16px; }
      
      /* å¿«é€ŸæŒ‰éˆ•æ¨£å¼ */
      .quick-buttons { 
        display: flex; 
        gap: 8px; 
        margin-bottom: 12px; 
        flex-wrap: wrap;
        justify-content: center;
      }
      .quick-btn { 
        padding: 10px 18px; 
        border-radius: 20px; 
        border: 1px solid #3b82f6; 
        background: #ffffff; 
        color: #3b82f6; 
        cursor: pointer; 
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .quick-btn:hover { 
        background: #3b82f6; 
        color: #ffffff; 
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }
      .quick-btn:active { 
        transform: translateY(0); 
        box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
      }
      
      /* æ‰‹æ©Ÿç‰ˆå¿«é€ŸæŒ‰éˆ•å„ªåŒ– */
      @media (max-width: 768px) {
        .quick-buttons { 
          gap: 6px; 
          margin-bottom: 10px;
        }
        .quick-btn { 
          padding: 6px 12px; 
          font-size: 13px;
        }
      }
      
      /* å¸³è™Ÿå®šä½è¨˜éŒ„åˆ—è¡¨æ¨£å¼ */
      .positioning-history-content {
        padding: 10px;
        max-height: 500px;
        overflow-y: auto;
      }
      
      .positioning-records {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .positioning-record-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
      }
      
      .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .record-number {
        font-weight: 600;
        color: #3b82f6;
        font-size: 14px;
      }
      
      .record-date {
        font-size: 12px;
        color: #6b7280;
      }
      
      .record-preview {
        color: #374151;
        font-size: 14px;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      
      .record-actions {
        display: flex;
        gap: 8px;
      }
      
      .view-btn, .delete-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* è©³ç´°å…§å®¹å½ˆå‡ºè¦–çª—æ¨£å¼ */
      .detail-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      
      .detail-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      
      .detail-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #111827;
      }
      
      .close-detail-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }
      
      .close-detail-btn:hover {
        background: #f3f4f6;
        color: #111827;
      }
      
      .detail-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }
      
      .detail-info {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-info span {
        font-size: 14px;
        color: #6b7280;
      }
      
      .detail-info strong {
        color: #111827;
        font-weight: 600;
      }
      
      .detail-content {
        color: #374151;
        line-height: 1.8;
        font-size: 15px;
      }
      
      /* æ“´å¤§ç”¨æˆ¶æŠ½å±œè¦–çª— */
      .user-drawer {
        width: 85%;
        max-width: 1000px;
        height: 85vh;
        max-height: 700px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
      <div class="header">
      <h1>AIJobçŸ­å½±éŸ³æ™ºèƒ½é«”</h1>
        <div class="header-right">
          <div class="user-info" id="userInfo" style="display: none;" onclick="toggleUserDrawer()">
            <img id="userAvatar" class="user-avatar" src="" alt="ç”¨æˆ¶é ­åƒ">
            <span id="userName" class="user-name"></span>
          </div>
          <div class="auth-buttons">
            <button id="loginBtn" class="login-btn">ğŸ” Google ç™»å…¥</button>
            <button id="logoutBtn" class="logout-btn" style="display: none;">ç™»å‡º</button>
          </div>
        </div>
      </div>

      <!-- ä¸»è¦å¸ƒå±€ï¼šå·¦å³åˆ†æ¬„ 5:5 -->
      <div class="main-layout">
        <!-- å·¦å´é¢æ¿ï¼šè¨­å®š+èŠå¤©+è¼¸å…¥ -->
        <div class="left-panel">
          <div class="left-content">
            <!-- ç”¨æˆ¶éœ€æ±‚è¨­å®šå€å¡Š -->
      <div class="settings-block">
              <h3 id="settingsToggle">ğŸ“‹ ç”¨æˆ¶éœ€æ±‚è¨­å®š <span class="settings-toggle">â–¼</span></h3>
        <div class="settings-content" id="settingsContent">
          <div class="settings-grid">
          <div class="setting-item">
            <label>å¹³å°</label>
                    <select id="platformSelect">
              <option value="">é¸æ“‡å¹³å°</option>
              <option value="TikTok">TikTok</option>
                      <option value="Instagram">Instagram Reels</option>
                      <option value="YouTube">YouTube Shorts</option>
                      <option value="Facebook">Facebook Reels</option>
            </select>
          </div>
          <div class="setting-item">
            <label>ä¸»é¡Œ</label>
                    <input type="text" id="topicInput" placeholder="ä¾‹å¦‚:å¤å­£è®Šç™½æŒ‘æˆ°/ç¾ç™½ä¿é¤Š">
          </div>
          <div class="setting-item">
            <label>è…³æœ¬ç§’æ•¸</label>
                    <select id="durationInput">
                      <option value="15ç§’">15ç§’</option>
                      <option value="30ç§’" selected>30ç§’</option>
                      <option value="45ç§’">45ç§’</option>
                      <option value="60ç§’">60ç§’</option>
            </select>
          </div>
          <div class="setting-item">
            <label>å¸³è™Ÿå®šä½</label>
                    <input type="text" id="positioningInput" placeholder="å¦‚:å¥åº·Ã—åŠ å¯†,è¼•é¬†å¹½é»˜">
          </div>
        </div>
                <button id="applyBtn" class="apply-btn">å¥—ç”¨è¨­å®š</button>
          </div>
            </div>

            <!-- AI èªªæ˜å€å¡Š -->
            <div class="ai-instructions">
              <h3>å¦‚ä½•èˆ‡AIçŸ­å½±éŸ³é¡§å•å°è©±ï¼Ÿ</h3>
              <div class="instruction-list">
                <p><strong>æ–¹æ³•1</strong> "ç”¨æˆ¶éœ€æ±‚è¨­å®š"é¸æ“‡å¹³å°ã€è¼¸å…¥ä¸»é¡Œèˆ‡å¸³è™Ÿå®šä½,æŒ‰ã€Œå¥—ç”¨ã€âœ… é»é¸ä¸‹æ–¹ä»»ä¸€å¿«é€ŸæŒ‰ç´"ç”Ÿæˆè…³æœ¬"ï¼†"è…³æœ¬é¸é¡Œ""å¸³è™Ÿå®šä½"æŒ‰ä¸‹å¾Œ AIé¡§å•å°‡ç‚ºå¿«é€Ÿç‚ºæ‚¨é‡èº«å®šåˆ¶åšå±¬æ–¼ä½ çš„çŸ­å½±éŸ³å…§å®¹ ğŸ¯</p>
                <p><strong>æ–¹æ³•2</strong> "ç”¨æˆ¶éœ€æ±‚è¨­å®š"é¸æ“‡å¹³å°ã€è¼¸å…¥ä¸»é¡Œèˆ‡å¸³è™Ÿå®šä½,æŒ‰ã€Œå¥—ç”¨ã€âœ… ä¸æŒ‰å¿«é€Ÿéˆ• ç›´æ¥èˆ‡AIçŸ­å½±éŸ³é¡§å•è¨è«– ğŸ’¬</p>
                <p><strong>æ–¹æ³•3</strong> ä¸è¨­å®š "ç”¨æˆ¶éœ€æ±‚è¨­å®š"ç›´æ¥èˆ‡AIçŸ­å½±éŸ³é¡§å•å°è©±æ‚¨çš„çŸ­å½±éŸ³è¦åŠƒèˆ‡éœ€æ±‚ ğŸš€</p>
                <p><strong>ç‚ºæ‚¨æ‰“é€ çˆ†æ¬¾çŸ­å½±éŸ³å¸³è™Ÿçš„é¡§å•ï¼</strong> â­</p>
        </div>
      </div>

            <!-- èŠå¤©å€åŸŸ -->
            <div class="chat-section">
              <div class="chat-messages" id="chatMessages">
                <div class="message ai">æ‚¨å¥½ï¼æˆ‘æ˜¯ AIJobçŸ­å½±éŸ³é¡§å•ï¼Œè«‹å‘Šè¨´æˆ‘æ‚¨æƒ³è¦ä»€éº¼æ¨£çš„çŸ­å½±éŸ³å…§å®¹ï¼Ÿ</div>
              </div>

      <!-- å¿«é€ŸæŒ‰éˆ•å€åŸŸ -->
      <div class="quick-buttons">
        <button class="quick-btn" data-text="æˆ‘è¦å¦‚ä½•é–‹å§‹ï¼Ÿ">æˆ‘è¦å¦‚ä½•é–‹å§‹ï¼Ÿ</button>
        <button class="quick-btn" data-text="æˆ‘è¦æ€éº¼å¸³è™Ÿå®šä½">æˆ‘è¦æ€éº¼å¸³è™Ÿå®šä½</button>
        <button class="quick-btn" data-text="ä»€éº¼æ˜¯è…³æœ¬é¸é¡Œ">ä»€éº¼æ˜¯è…³æœ¬é¸é¡Œ</button>
      </div>

              <div class="input-row">
                <textarea id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...(Ctrl+Enter é€å‡ºã€Enteræ›è¡Œ)"></textarea>
                <button id="sendBtn" class="send-btn">é€å‡º</button>
        </div>
      </div>
          </div>
        </div>

        <!-- å³å´é¢æ¿ï¼šçµæœå€å¡Šï¼ˆå¯åˆ‡æ›ï¼‰ -->
        <div class="right-panel">
          <!-- çµæœæ¨™ç±¤åˆ‡æ› -->
          <div class="result-tabs">
            <button class="result-tab active" data-tab="positioning">ğŸ¯ å¸³è™Ÿå®šä½</button>
            <button class="result-tab" data-tab="topics">ğŸ’¡ è…³æœ¬é¸é¡Œ</button>
            <button class="result-tab" data-tab="script">ğŸ“ çŸ­å½±éŸ³è…³æœ¬</button>
          </div>
          
          <!-- çµæœå€å¡Šå®¹å™¨ -->
          <div class="results-container">
            <!-- å¸³è™Ÿå®šä½çµæœ -->
            <div id="positioningResult" class="result-content" style="display: block;">
              <div class="result-header">
                <h3>å¸³è™Ÿå®šä½åˆ†æ</h3>
                <button class="generate-btn" onclick="generatePositioning()">ä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½</button>
              </div>
              <div id="positioningContent" class="result-body">
                é»æ“Šã€Œä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½ã€æŒ‰éˆ•é–‹å§‹åˆ†æ...
              </div>
              <div class="result-actions" id="positioningActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('positioning')">å„²å­˜</button>
                <button class="regenerate-btn" onclick="regenerateResult('positioning')">å†æ›ä¸€å€‹</button>
              </div>
            </div>
            
            <!-- è…³æœ¬é¸é¡Œçµæœ -->
            <div id="topicSelectionResult" class="result-content" style="display: none;">
              <div class="result-header">
                <h3>è…³æœ¬é¸é¡Œæ¨è–¦</h3>
                <button class="generate-btn" onclick="generateTopics()">ä¸€éµç”Ÿæˆé¸é¡Œ</button>
              </div>
              <div id="topicContent" class="result-body">
                è«‹å…ˆå®Œæˆå¸³è™Ÿå®šä½ï¼Œå†é€²è¡Œé¸é¡Œæ¨è–¦...
              </div>
              <div class="result-actions" id="topicActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('topics')">å„²å­˜</button>
                <button class="regenerate-btn" onclick="regenerateResult('topics')">å†æ›ä¸€å€‹</button>
              </div>
            </div>
            
            <!-- çŸ­å½±éŸ³è…³æœ¬çµæœ -->
            <div id="scriptResult" class="result-content" style="display: none;">
              <div class="result-header">
                <h3>çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆ</h3>
                <button class="generate-btn" onclick="generateScript()">ä¸€éµç”Ÿæˆè…³æœ¬</button>
              </div>
              <div id="scriptContent" class="result-body">
                è«‹å…ˆå®Œæˆå¸³è™Ÿå®šä½å’Œé¸é¡Œï¼Œå†ç”Ÿæˆè…³æœ¬...
              </div>
              <div class="result-actions" id="scriptActions" style="display: none;">
                <button class="save-btn" onclick="saveResult('script')">å„²å­˜</button>
                <button class="regenerate-btn" onclick="regenerateResult('script')">å†æ›ä¸€å€‹</button>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- ç”¨æˆ¶æŠ½å±œ -->
      <div id="userDrawerOverlay" class="user-drawer-overlay" onclick="closeUserDrawer()"></div>
      <div id="userDrawer" class="user-drawer">
        <!-- æ¨™é¡Œæ¬„ -->
        <div class="user-drawer-header">
          <div class="user-drawer-title">
            <div class="app-logo">AIJob</div>
            <span class="app-name">çŸ­å½±éŸ³é¡§å•</span>
          </div>
          <button class="user-drawer-close" onclick="closeUserDrawer()">Ã—</button>
        </div>
        
        <!-- å·¦å³å…©æ¬„å¸ƒå±€ -->
        <div class="user-drawer-body">
          <!-- å·¦å´é¸å–® -->
          <div class="user-drawer-sidebar">
            <div class="user-profile">
              <img id="drawerAvatar" class="user-drawer-avatar" src="" alt="ç”¨æˆ¶é ­åƒ">
              <div class="user-drawer-info">
                <h3 id="drawerName">ç”¨æˆ¶åç¨±</h3>
                <p id="drawerEmail">user@example.com</p>
              </div>
            </div>
            
            <ul class="user-drawer-menu">
              <li><a href="#" class="active" data-section="personalInfo" onclick="switchDrawerContent('personalInfo')"><span class="icon">ğŸ‘¤</span>å€‹äººè³‡æ–™</a></li>
              <li><a href="#" data-section="myScripts" onclick="switchDrawerContent('myScripts')"><span class="icon">ğŸ’¾</span>æˆ‘çš„è…³æœ¬</a></li>
              <li><a href="#" data-section="accountPositioning" onclick="switchDrawerContent('accountPositioning')"><span class="icon">ğŸ¯</span>å¸³è™Ÿå®šä½</a></li>
              <li><a href="#" data-section="topicHistory" onclick="switchDrawerContent('topicHistory')"><span class="icon">ğŸ’¡</span>é¸é¡Œè¨˜éŒ„</a></li>
              <li><a href="#" data-section="settings" onclick="switchDrawerContent('settings')"><span class="icon">âš™ï¸</span>è¨­å®š</a></li>
              <li><a href="#" data-section="usageStats" onclick="switchDrawerContent('usageStats')"><span class="icon">ğŸ“Š</span>ä½¿ç”¨çµ±è¨ˆ</a></li>
              <li><a href="#" data-section="helpCenter" onclick="switchDrawerContent('helpCenter')"><span class="icon">â“</span>å¹«åŠ©ä¸­å¿ƒ</a></li>
              <li><a href="#" onclick="logout()"><span class="icon">ğŸšª</span>ç™»å‡º</a></li>
            </ul>
          </div>
          
          <!-- å³å´å…§å®¹å€åŸŸ -->
          <div class="user-drawer-content">
            <!-- å€‹äººè³‡æ–™ -->
            <div id="personalInfo" class="content-section active">
              <h2>å€‹äººè³‡æ–™</h2>
              <div class="user-info-detail">
                <div class="info-item">
                  <label>å§“åï¼š</label>
                  <span id="userNameDetail">-</span>
                </div>
                <div class="info-item">
                  <label>ä¿¡ç®±ï¼š</label>
                  <span id="userEmailDetail">-</span>
                </div>
                <div class="info-item">
                  <label>ç”¨æˆ¶IDï¼š</label>
                  <span id="userIdDetail">-</span>
                </div>
              </div>
            </div>
            
            <!-- æˆ‘çš„è…³æœ¬ -->
            <div id="myScripts" class="content-section">
              <h2>æˆ‘çš„è…³æœ¬</h2>
              <div id="generationsList" class="generations-list">
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
            
            <!-- å¸³è™Ÿå®šä½ -->
            <div id="accountPositioning" class="content-section">
              <h2>å¸³è™Ÿå®šä½è¨˜éŒ„</h2>
              <div id="positioningHistoryContent" class="positioning-history-content">
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
            
            <!-- é¸é¡Œè¨˜éŒ„ -->
            <div id="topicHistory" class="content-section">
              <h2>é¸é¡Œè¨˜éŒ„</h2>
              <div id="conversationsList" class="conversations-list">
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
            
            <!-- è¨­å®š -->
            <div id="settings" class="content-section">
              <h2>è¨­å®š</h2>
              <div class="settings-content">
                <p>è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...</p>
              </div>
            </div>
            
            <!-- ä½¿ç”¨çµ±è¨ˆ -->
            <div id="usageStats" class="content-section">
              <h2>ä½¿ç”¨çµ±è¨ˆ</h2>
              <div class="stats-content">
                <p>çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</p>
              </div>
            </div>
            
            <!-- å¹«åŠ©ä¸­å¿ƒ -->
            <div id="helpCenter" class="content-section">
              <h2>å¹«åŠ©ä¸­å¿ƒ</h2>
              <div class="help-content">
                <p>å¹«åŠ©åŠŸèƒ½é–‹ç™¼ä¸­...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å½ˆè·³è¦–çª—ç™»å…¥è¦†è“‹å±¤ -->
      <div id="popupOverlay" class="popup-overlay">
        <div class="popup-content">
          <div id="popupSpinner" class="popup-spinner"></div>
          <div id="popupMessage" class="popup-message">æ­£åœ¨é–‹å•Ÿ Google ç™»å…¥è¦–çª—...</div>
          <div id="popupButtons" style="display: none;">
            <button id="popupRetry" class="popup-btn">é‡è©¦</button>
            <button id="popupCancel" class="popup-btn secondary">å–æ¶ˆ</button>
          </div>
        </div>
      </div>


      <div id="status" class="small"></div>
      
      <!-- çµæœå€å¡Š -->
      <div id="results" class="results-block">
        <h3>ğŸ“ çŸ­å½±éŸ³è…³æœ¬çµæœ</h3>
        <div class="result-item">
          <h4>ğŸ¯ ä¸»é¡Œ</h4>
          <div id="result-title" class="content">å°šæœªç”Ÿæˆ</div>
        </div>
        <div class="result-item">
          <h4>ğŸ“œ è…³æœ¬å…§å®¹</h4>
          <div id="result-script" class="content">å°šæœªç”Ÿæˆ</div>
        </div>
        <div class="result-item">
          <h4>ğŸ¬ ç•«é¢æ„Ÿ</h4>
          <div id="result-visual" class="content">å°šæœªç”Ÿæˆ</div>
        </div>
        <div class="result-item">
          <h4>ğŸ“± æ–‡æ¡ˆ</h4>
          <div id="result-copy" class="content">å°šæœªç”Ÿæˆ</div>
        </div>
      </div>
      
      <div class="small">2025 AIJobå­¸é™¢ç‰ˆæ¬Šæ‰€æœ‰</div>
    </div>

    <!-- å½ˆå‡ºæç¤ºæ¡† -->
    <div id="toast" class="toast" style="display: none;"></div>


    <script>
      // æ–°çš„å…ƒç´ å¼•ç”¨
      const chatEl = document.getElementById('chatMessages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const applyBtn = document.getElementById('applyBtn');
      const platformSelect = document.getElementById('platformSelect');
      const topicInput = document.getElementById('topicInput');
      const durationInput = document.getElementById('durationInput');
      const positioningInput = document.getElementById('positioningInput');
      
      // çµæœå€å¡Šå…ƒç´ 
      const resultsEl = document.getElementById('results');
      const resultTitleEl = document.getElementById('result-title');
      const resultScriptEl = document.getElementById('result-script');
      const resultVisualEl = document.getElementById('result-visual');
      const resultCopyEl = document.getElementById('result-copy');
      const scriptResult = document.getElementById('scriptResult');
      const positioningResult = document.getElementById('positioningResult');
      const topicSelectionResult = document.getElementById('topicSelectionResult');
      
      // æ§åˆ¶æŒ‰éˆ•ï¼ˆå·²ç§»é™¤ï¼ŒåŠŸèƒ½æ•´åˆåˆ°å¿«é€ŸæŒ‰éˆ•ä¸­ï¼‰
      
      // ç”¨æˆ¶æŠ½å±œå…ƒç´ 
      const userDrawer = document.getElementById('userDrawer');
      const userDrawerOverlay = document.getElementById('userDrawerOverlay');
      const drawerAvatar = document.getElementById('drawerAvatar');
      const drawerName = document.getElementById('drawerName');
      const drawerEmail = document.getElementById('drawerEmail');
      
      // èªè­‰ç›¸é—œå…ƒç´ 
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // å½ˆè·³è¦–çª—å…ƒç´ 
      const popupOverlay = document.getElementById('popupOverlay');
      const popupSpinner = document.getElementById('popupSpinner');
      const popupMessage = document.getElementById('popupMessage');
      const popupButtons = document.getElementById('popupButtons');
      const popupRetry = document.getElementById('popupRetry');
      const popupCancel = document.getElementById('popupCancel');
      
      // æç¤ºæ¡†
      const toastEl = document.getElementById('toast');
      
      // è¨­å®šå€å¡Šå…ƒç´ 
      const settingsToggleEl = document.getElementById('settingsToggle');
      const settingsContentEl = document.getElementById('settingsContent');
      
      // å…¨å±€è®Šæ•¸
      let accessToken = null;
      let currentUser = null;
      const styleInstruction = 'æ ¼å¼è¦æ±‚ï¼šåˆ†æ®µæ¸…æ¥šï¼ŒçŸ­å¥ï¼Œæ¯æ®µæ›è¡Œï¼Œé©åº¦åŠ å…¥è¡¨æƒ…ç¬¦è™Ÿï¼ˆå¦‚ï¼šâœ…âœ¨ğŸ”¥ğŸ“Œï¼‰ï¼Œé¿å…å£é ­ç¦ªã€‚çµ•å°ä¸è¦ä½¿ç”¨ ** æˆ–ä»»ä½• Markdown æ ¼å¼ç¬¦è™Ÿï¼Œæ‰€æœ‰å…§å®¹å¿…é ˆæ˜¯ç´”æ–‡å­—æ ¼å¼ã€‚';
      
      // ç”Ÿæˆéš¨æ©Ÿç”¨æˆ¶ID
      function generateUserId() {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substring(2, 8);
        return `user_${timestamp}_${randomStr}`;
      }
      
      // ç”¨æˆ¶æŠ½å±œåŠŸèƒ½
      function toggleUserDrawer() {
        userDrawer.classList.toggle('open');
        userDrawerOverlay.classList.toggle('open');
        
        // å¦‚æœæŠ½å±œæ‰“é–‹ï¼Œè¼‰å…¥ç”¨æˆ¶æ­·å²è³‡è¨Š
        if (userDrawer.classList.contains('open') && currentUser) {
          loadUserHistory();
        }
      }
      
      function closeUserDrawer() {
        userDrawer.classList.remove('open');
        userDrawerOverlay.classList.remove('open');
      }
      
      // æ›´æ–°ç”¨æˆ¶æŠ½å±œè³‡è¨Š
      function updateUserDrawer(user) {
        if (user) {
          // ç¢ºä¿ç”¨æˆ¶æœ‰ID
          if (!user.user_id) {
            user.user_id = generateUserId();
            currentUser = user; // æ›´æ–°ç•¶å‰ç”¨æˆ¶
            localStorage.setItem('currentUser', JSON.stringify(user));
            console.log('åœ¨updateUserDrawerä¸­ç‚ºç”¨æˆ¶ç”Ÿæˆæ–°ID:', user.user_id);
          }
          
          // æ›´æ–°æŠ½å±œå…§çš„è³‡è¨Š
          drawerAvatar.src = user.picture || 'https://via.placeholder.com/50';
          drawerName.textContent = user.name || 'ç”¨æˆ¶';
          drawerEmail.textContent = user.email || '';
          
          // æ›´æ–°é ‚éƒ¨ header ä¸­çš„ç”¨æˆ¶è³‡è¨Š
          userAvatar.src = user.picture || 'https://via.placeholder.com/32';
          userName.textContent = user.name || 'ç”¨æˆ¶';
          
          // æ›´æ–°å€‹äººè³‡æ–™é¡¯ç¤º
          updatePersonalInfo();
          
          // è¼‰å…¥ç”¨æˆ¶çš„éå¾€è³‡è¨Š
          loadUserHistory();
        }
      }

      // è¼‰å…¥ç”¨æˆ¶æ­·å²è³‡è¨Š
      async function loadUserHistory() {
        // ç¢ºä¿ç”¨æˆ¶æœ‰ID
        if (!currentUser?.user_id) {
          console.log('æ²’æœ‰ç”¨æˆ¶IDï¼Œå˜—è©¦ç”Ÿæˆ...');
          if (currentUser) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('ç‚ºç”¨æˆ¶ç”Ÿæˆæ–°ID:', currentUser.user_id);
          } else {
            console.log('æ²’æœ‰ç•¶å‰ç”¨æˆ¶ï¼Œè·³éè¼‰å…¥æ­·å²');
            return;
          }
        }
        
        console.log('é–‹å§‹è¼‰å…¥ç”¨æˆ¶æ­·å²ï¼Œç”¨æˆ¶ID:', currentUser.user_id);
        
        try {
          // è¼‰å…¥å°è©±è¨˜éŒ„
          console.log('æ­£åœ¨è¼‰å…¥å°è©±è¨˜éŒ„...');
          const conversationsResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/conversations/${currentUser.user_id}`);
          console.log('å°è©±è¨˜éŒ„éŸ¿æ‡‰ç‹€æ…‹:', conversationsResponse.status);
          if (conversationsResponse.ok) {
            const conversationsData = await conversationsResponse.json();
            console.log('å°è©±è¨˜éŒ„æ•¸æ“š:', conversationsData);
            updateConversationsDisplay(conversationsData.conversations);
          } else {
            console.error('è¼‰å…¥å°è©±è¨˜éŒ„å¤±æ•—:', conversationsResponse.status, conversationsResponse.statusText);
          }
          
          // è¼‰å…¥ç”Ÿæˆè¨˜éŒ„
          console.log('æ­£åœ¨è¼‰å…¥ç”Ÿæˆè¨˜éŒ„...');
          const generationsResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/generations/${currentUser.user_id}`);
          console.log('ç”Ÿæˆè¨˜éŒ„éŸ¿æ‡‰ç‹€æ…‹:', generationsResponse.status);
          if (generationsResponse.ok) {
            const generationsData = await generationsResponse.json();
            console.log('ç”Ÿæˆè¨˜éŒ„æ•¸æ“š:', generationsData);
            updateGenerationsDisplay(generationsData.generations);
          } else {
            console.error('è¼‰å…¥ç”Ÿæˆè¨˜éŒ„å¤±æ•—:', generationsResponse.status, generationsResponse.statusText);
          }
          
          // è¼‰å…¥å¸³è™Ÿå®šä½è¨˜éŒ„
          console.log('æ­£åœ¨è¼‰å…¥å¸³è™Ÿå®šä½è¨˜éŒ„...');
          await loadPositioningRecords();
          
          // è¼‰å…¥ç”¨æˆ¶è¨˜æ†¶
          console.log('æ­£åœ¨è¼‰å…¥ç”¨æˆ¶è¨˜æ†¶...');
          const memoryResponse = await fetch(`https://aivideobackend.zeabur.app/api/user/memory/${currentUser.user_id}`);
          console.log('ç”¨æˆ¶è¨˜æ†¶éŸ¿æ‡‰ç‹€æ…‹:', memoryResponse.status);
          if (memoryResponse.ok) {
            const memoryData = await memoryResponse.json();
            console.log('ç”¨æˆ¶è¨˜æ†¶æ•¸æ“š:', memoryData);
            updateMemoryDisplay(memoryData.memory);
          } else {
            console.error('è¼‰å…¥ç”¨æˆ¶è¨˜æ†¶å¤±æ•—:', memoryResponse.status, memoryResponse.statusText);
          }
          
        } catch (error) {
          console.error('è¼‰å…¥ç”¨æˆ¶æ­·å²è³‡è¨Šæ™‚å‡ºéŒ¯:', error);
        }
      }

      // æ›´æ–°å°è©±è¨˜éŒ„é¡¯ç¤º
      function updateConversationsDisplay(conversations) {
        const conversationsList = document.getElementById('conversationsList');
        if (!conversationsList) return;
        
        conversationsList.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div');
          item.className = 'conversation-item';
          item.innerHTML = `
            <div class="conversation-summary">${conv.summary}</div>
            <div class="conversation-date">${new Date(conv.created_at).toLocaleDateString()}</div>
          `;
          conversationsList.appendChild(item);
        });
      }

      // æ›´æ–°ç”Ÿæˆè¨˜éŒ„é¡¯ç¤º
      function updateGenerationsDisplay(generations) {
        const generationsList = document.getElementById('generationsList');
        if (!generationsList) return;
        
        generationsList.innerHTML = '';
        generations.forEach(gen => {
          const item = document.createElement('div');
          item.className = 'generation-item';
          item.innerHTML = `
            <div class="generation-header">
              <span class="generation-platform">${gen.platform}</span>
              <span class="generation-topic">${gen.topic}</span>
            </div>
            <div class="generation-content">${gen.content}</div>
            <div class="generation-date">${new Date(gen.created_at).toLocaleDateString()}</div>
          `;
          generationsList.appendChild(item);
        });
      }

      // æ›´æ–°è¨˜æ†¶é¡¯ç¤º
      function updateMemoryDisplay(memory) {
        const memoryContent = document.getElementById('memoryContent');
        if (!memoryContent) return;
        
        memoryContent.innerHTML = memory || 'æš«ç„¡è¨˜æ†¶è³‡è¨Š';
      }
      
      // è¼‰å…¥å¸³è™Ÿå®šä½è¨˜éŒ„
      async function loadPositioningRecords() {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            updatePositioningDisplay(data.records || []);
          }
        } catch (error) {
          console.error('è¼‰å…¥å¸³è™Ÿå®šä½è¨˜éŒ„å¤±æ•—:', error);
        }
      }
      
      // æ›´æ–°å¸³è™Ÿå®šä½é¡¯ç¤º
      function updatePositioningDisplay(records) {
        const positioningContent = document.getElementById('positioningHistoryContent');
        if (!positioningContent) return;
        
        if (records.length === 0) {
          positioningContent.innerHTML = '<p style="color: #666;">å°šç„¡å¸³è™Ÿå®šä½è¨˜éŒ„</p>';
          return;
        }
        
        let html = '<div class="positioning-records">';
        records.forEach(record => {
          const date = new Date(record.created_at).toLocaleDateString('zh-TW');
          const preview = record.content.substring(0, 50) + (record.content.length > 50 ? '...' : '');
          
          html += `
            <div class="positioning-record-item">
              <div class="record-header">
                <span class="record-number">ç·¨è™Ÿ ${record.record_number}</span>
                <span class="record-date">${date}</span>
              </div>
              <div class="record-preview">${preview}</div>
              <div class="record-actions">
                <button class="view-btn" onclick="viewPositioningDetail(${record.id}, '${record.record_number}')">æŸ¥çœ‹å®Œæ•´çµæœ</button>
                <button class="delete-btn" onclick="deletePositioningRecord(${record.id})">åˆªé™¤</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        positioningContent.innerHTML = html;
      }
      
      // æŸ¥çœ‹å¸³è™Ÿå®šä½è©³ç´°å…§å®¹
      async function viewPositioningDetail(recordId, recordNumber) {
        if (!currentUser?.user_id) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${currentUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const record = data.records.find(r => r.id === recordId);
            
            if (record) {
              // é¡¯ç¤ºè©³ç´°å…§å®¹åœ¨å½ˆå‡ºè¦–çª—
              showDetailModal(recordNumber, record.created_at, record.content);
            }
          }
        } catch (error) {
          console.error('è¼‰å…¥è©³ç´°å…§å®¹å¤±æ•—:', error);
          showToast('è¼‰å…¥å¤±æ•—', 3000);
        }
      }
      
      // é¡¯ç¤ºè©³ç´°å…§å®¹å½ˆå‡ºè¦–çª—
      function showDetailModal(recordNumber, createdAt, content) {
        const date = new Date(createdAt).toLocaleString('zh-TW');
        const modal = document.createElement('div');
        modal.className = 'detail-modal-overlay';
        modal.innerHTML = `
          <div class="detail-modal">
            <div class="detail-modal-header">
              <h3>å¸³è™Ÿå®šä½è©³ç´°å…§å®¹</h3>
              <button class="close-detail-btn" onclick="this.closest('.detail-modal-overlay').remove()">âœ•</button>
            </div>
            <div class="detail-modal-body">
              <div class="detail-info">
                <span><strong>ç·¨è™Ÿï¼š</strong>${recordNumber}</span>
                <span><strong>ç”Ÿæˆæ—¥æœŸï¼š</strong>${date}</span>
              </div>
              <div class="detail-content">
                ${content.replace(/\n/g, '<br>')}
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }
      
      // åˆªé™¤å¸³è™Ÿå®šä½è¨˜éŒ„
      async function deletePositioningRecord(recordId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
        
        try {
          const response = await fetch(`https://aivideobackend.zeabur.app/api/user/positioning/${recordId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            showToast('è¨˜éŒ„å·²åˆªé™¤', 2000);
            await loadPositioningRecords();
          } else {
            throw new Error('åˆªé™¤å¤±æ•—');
          }
        } catch (error) {
          console.error('åˆªé™¤éŒ¯èª¤:', error);
          showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 3000);
        }
      }

      // åˆ‡æ›æŠ½å±œå…§å®¹å€åŸŸ
      function switchDrawerContent(sectionId) {
        // éš±è—æ‰€æœ‰å…§å®¹å€åŸŸ
        const allSections = document.querySelectorAll('.content-section');
        allSections.forEach(section => {
          section.classList.remove('active');
        });
        
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
        const allMenuItems = document.querySelectorAll('.user-drawer-menu a');
        allMenuItems.forEach(item => {
          item.classList.remove('active');
        });
        
        // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹å€åŸŸ
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // æ·»åŠ å°æ‡‰æŒ‰éˆ•çš„ active ç‹€æ…‹
        const targetMenuItem = document.querySelector(`[data-section="${sectionId}"]`);
        if (targetMenuItem) {
          targetMenuItem.classList.add('active');
        }
      }

      // æ›´æ–°å€‹äººè³‡æ–™é¡¯ç¤º
      function updatePersonalInfo() {
        if (currentUser) {
          // ç¢ºä¿ç”¨æˆ¶æœ‰IDï¼Œå¦‚æœæ²’æœ‰å‰‡ç”Ÿæˆä¸€å€‹
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('åœ¨updatePersonalInfoä¸­ç‚ºç”¨æˆ¶ç”Ÿæˆæ–°ID:', currentUser.user_id);
          }
          
          const userNameDetail = document.getElementById('userNameDetail');
          const userEmailDetail = document.getElementById('userEmailDetail');
          const userIdDetail = document.getElementById('userIdDetail');
          
          if (userNameDetail) userNameDetail.textContent = currentUser.name || currentUser.displayName || 'æœªè¨­å®š';
          if (userEmailDetail) userEmailDetail.textContent = currentUser.email || 'æœªè¨­å®š';
          if (userIdDetail) userIdDetail.textContent = currentUser.user_id || 'æœªç”Ÿæˆ';
          
          console.log('æ›´æ–°å€‹äººè³‡æ–™:', {
            name: currentUser.name,
            email: currentUser.email,
            user_id: currentUser.user_id
          });
        }
      }
      
      // æ›´æ–°èªè­‰ UI
      function updateAuthUI(isLoggedIn) {
        if (isLoggedIn) {
          userInfo.style.display = 'flex';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'block';
          updateUserDrawer(currentUser);
        } else {
          userInfo.style.display = 'none';
          loginBtn.style.display = 'block';
          logoutBtn.style.display = 'none';
          closeUserDrawer();
        }
      }
      
      // ç™»å‡ºåŠŸèƒ½
      function logout() {
        accessToken = null;
        currentUser = null;
        localStorage.removeItem('accessToken');
        localStorage.removeItem('currentUser');
        updateAuthUI(false);
        showToast('å·²ç™»å‡º', 3000);
        closeUserDrawer();
      }
      
      // çµæœå€å¡ŠåŠŸèƒ½
      function updateResultBlock(blockId, content, hasContent = true) {
        const block = document.getElementById(blockId);
        if (block) {
          block.textContent = content;
          if (hasContent) {
            block.classList.add('has-content');
          } else {
            block.classList.remove('has-content');
          }
        }
      }
      
      // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
      function switchTab(tabName) {
        // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active é¡åˆ¥
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // éš±è—æ‰€æœ‰çµæœå…§å®¹
        document.querySelectorAll('.result-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // æ¿€æ´»é¸ä¸­çš„æ¨™ç±¤
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
        }
        
        // é¡¯ç¤ºå°æ‡‰çš„çµæœå…§å®¹
        let contentId = '';
        if (tabName === 'positioning') {
          contentId = 'positioningResult';
        } else if (tabName === 'topics') {
          contentId = 'topicSelectionResult';
        } else if (tabName === 'script') {
          contentId = 'scriptResult';
        }
        
        const activeContent = document.getElementById(contentId);
        if (activeContent) {
          activeContent.style.display = 'block';
        }
      }
      
      // æ·»åŠ èŠå¤©è¨Šæ¯
      function addMessage(content, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `msg ${isUser ? 'user' : 'assistant'}`;
        
        // æ·»åŠ æ¨™ç±¤
        const label = document.createElement('div');
        label.className = 'msg-label';
        label.textContent = isUser ? 'ä½ ' : 'AIJobçŸ­å½±éŸ³é¡§å•';
        messageDiv.appendChild(label);
        
        // æ·»åŠ æ°£æ³¡
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // å¦‚æœæ˜¯ AI å›è¦†ï¼Œæ¸…ç† Markdown æ ¼å¼
        if (!isUser) {
          const cleanText = cleanMarkdownFormat(content);
          bubble.innerHTML = cleanText;
        } else {
          bubble.textContent = content;
        }
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // ç™¼é€èŠå¤©è¨Šæ¯
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
        addMessage(message, true);
        messageInput.value = '';
        
        // é¡¯ç¤º AI å›è¦†ä¸­çš„è¼‰å…¥ç‹€æ…‹
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'msg assistant';
        thinkingDiv.id = 'thinking-message';
        
        // æ·»åŠ  AI æ¨™ç±¤
        const aiLabel = document.createElement('div');
        aiLabel.className = 'msg-label';
        aiLabel.textContent = 'AIJobçŸ­å½±éŸ³é¡§å•';
        thinkingDiv.appendChild(aiLabel);
        
        // æ·»åŠ è¼‰å…¥å‹•ç•«æ°£æ³¡
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.innerHTML = '<div class="spinner"></div><span>AIå›è¦†ä¸­...</span>';
        thinkingDiv.appendChild(loadingDiv);
        
        document.getElementById('chatMessages').appendChild(thinkingDiv);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: message,
              platform: platformSelect.value || null,
              topic: topicInput.value || null,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioningInput.value || null,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('ç™¼é€å¤±æ•—');
          }
          
          // æº–å‚™æ¥æ”¶ AI å›æ‡‰
          const reader = response.body.getReader();
          let aiResponse = '';
          let aiDiv = null;
          let bubble = null;
          
          let buffer = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += new TextDecoder().decode(value, { stream: true });
            
            // è™•ç†å®Œæ•´çš„ JSON è¡Œ
            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              
              if (!frame.startsWith('data:')) continue;
              
              try {
                const jsonStr = frame.slice(5).trim();
                const data = JSON.parse(jsonStr);
                
                if (data.type === 'token' && data.content) {
                  // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ”¶åˆ° tokenï¼Œå‰µå»º AI å›æ‡‰ div ä¸¦ç§»é™¤è¼‰å…¥å‹•ç•«
                  if (!aiDiv) {
                    const thinkingMsg = document.getElementById('thinking-message');
                    if (thinkingMsg) {
                      thinkingMsg.remove();
                    }
                    
                    // å‰µå»º AI å›æ‡‰ div
                    aiDiv = document.createElement('div');
                    aiDiv.className = 'msg assistant';
                    aiDiv.id = 'ai-response';
                    
                    // æ·»åŠ  AI æ¨™ç±¤
                    const aiLabel = document.createElement('div');
                    aiLabel.className = 'msg-label';
                    aiLabel.textContent = 'AIJobçŸ­å½±éŸ³é¡§å•';
                    aiDiv.appendChild(aiLabel);
                    
                    // æ·»åŠ æ°£æ³¡
                    bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    aiDiv.appendChild(bubble);
                    
                    document.getElementById('chatMessages').appendChild(aiDiv);
                  }
                  
                  aiResponse += data.content;
                  bubble.innerHTML = cleanMarkdownFormat(aiResponse);
                } else if (data.type === 'end') {
                  // å›æ‡‰çµæŸ
                  // æ–°å¢ï¼šæ™ºèƒ½åˆ¤æ–· AI å›æ‡‰é¡å‹ä¸¦é¡¯ç¤ºåˆ°çµæœå€å¡Š
                  if (aiResponse && currentUser?.user_id) {
                    detectAndDisplayResult(message, aiResponse);
                  }
                  break;
                }
              } catch (e) {
                // å¿½ç•¥è§£æéŒ¯èª¤
                continue;
              }
            }
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }
        } catch (error) {
          // ç§»é™¤è¼‰å…¥å‹•ç•«ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          const thinkingMsg = document.getElementById('thinking-message');
          if (thinkingMsg) {
            thinkingMsg.remove();
          }
          
          addMessage('æŠ±æ­‰ï¼Œç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
        }
      }
      
      // ç”Ÿæˆè…³æœ¬åŠŸèƒ½
      async function generateScript() {
        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆå¸³è™Ÿå®šä½å’Œé¸é¡Œï¼ˆåªæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­æç¤ºæ–‡å­—ï¼‰
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const topicContent = document.getElementById('topicContent').textContent.trim();
        
        const isPositioningDefault = positioningContent.includes('é»æ“Šã€Œä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½ã€') || 
                                     positioningContent.includes('é–‹å§‹åˆ†æ');
        const isTopicDefault = topicContent.includes('å®Œæˆå¸³è™Ÿå®šä½') || 
                              topicContent.includes('é€²è¡Œé¸é¡Œ') ||
                              topicContent.includes('é»æ“Šã€Œä¸€éµç”Ÿæˆé¸é¡Œã€');
        
        if (!positioningContent || isPositioningDefault) {
          showToast('è«‹å…ˆå®Œæˆå¸³è™Ÿå®šä½', 3000);
          return;
        }
        
        if (!topicContent || isTopicDefault) {
          showToast('è«‹å…ˆå®Œæˆé¸é¡Œæ¨è–¦', 3000);
          return;
        }
        
        const platform = platformSelect.value;
        const topic = topicInput.value;
        const positioning = positioningInput.value;
        
        if (!platform) {
          showToast('è«‹å…ˆé¸æ“‡å¹³å°', 3000);
          return;
        }
        
        updateResultBlock('scriptContent', 'æ­£åœ¨ç”Ÿæˆè…³æœ¬...', false);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/script', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: 'è«‹å¹«æˆ‘ç”Ÿæˆå®Œæ•´è…³æœ¬',
              platform: platform,
              topic: topic,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('ç”Ÿæˆå¤±æ•—');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('scriptContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±æ•—');
                  }
                } catch (e) {
                  console.error('è§£æéŒ¯èª¤:', e);
                }
              }
            }
          }
          
          // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
          document.getElementById('scriptActions').style.display = 'flex';
          
          // è‡ªå‹•åˆ‡æ›åˆ°è…³æœ¬æ¨™ç±¤
          switchTab('script');
          
        } catch (error) {
          updateResultBlock('scriptContent', 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
          showToast('ç”Ÿæˆè…³æœ¬å¤±æ•—', 3000);
        }
      }
      
      // ä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½
      async function generatePositioning() {
        const platform = platformSelect.value;
        const topic = topicInput.value;
        const positioning = positioningInput.value;
        
        if (!platform) {
          showToast('è«‹å…ˆé¸æ“‡å¹³å°', 3000);
          return;
        }
        
        updateResultBlock('positioningContent', 'æ­£åœ¨åˆ†æå¸³è™Ÿå®šä½...', false);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/positioning', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: 'è«‹å¹«æˆ‘é€²è¡Œå¸³è™Ÿå®šä½åˆ†æ',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('ç”Ÿæˆå¤±æ•—');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('positioningContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±æ•—');
                  }
                } catch (e) {
                  console.error('è§£æéŒ¯èª¤:', e);
                }
              }
            }
          }
          
          // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
          document.getElementById('positioningActions').style.display = 'flex';
          
          // è‡ªå‹•åˆ‡æ›åˆ°å¸³è™Ÿå®šä½æ¨™ç±¤
          switchTab('positioning');
          
        } catch (error) {
          updateResultBlock('positioningContent', 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
          showToast('ç”Ÿæˆå¸³è™Ÿå®šä½å¤±æ•—', 3000);
        }
      }
      
      // æ™ºèƒ½åˆ¤æ–· AI å›æ‡‰é¡å‹ä¸¦é¡¯ç¤ºåˆ°çµæœå€å¡Š
      function detectAndDisplayResult(userMessage, aiResponse) {
        // åˆ¤æ–·æ˜¯å¦ç‚ºæ˜ç¢ºçš„å¸³è™Ÿå®šä½ç¸½çµ
        const isPositioningSummary = aiResponse.includes('ğŸ“Œ ä½ çš„å¸³è™Ÿå®šä½å»ºè­°') ||
                                     aiResponse.includes('å¸³è™Ÿå®šä½å»ºè­°ï¼š') ||
                                     aiResponse.includes('å®šä½ç¸½çµï¼š') ||
                                     (aiResponse.includes('å®šä½å»ºè­°') && aiResponse.length > 200);
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºæ˜ç¢ºçš„é¸é¡Œæ¨è–¦çµæœ
        const isTopicsSummary = aiResponse.includes('ğŸ“Œ é¸é¡Œæ¨è–¦') ||
                               aiResponse.includes('é¸é¡Œå»ºè­°ï¼š') ||
                               aiResponse.includes('æ¨è–¦é¸é¡Œï¼š') ||
                               (aiResponse.includes('é¸é¡Œ') && 
                                (aiResponse.includes('1.') || aiResponse.includes('ä¸€ã€')) &&
                                aiResponse.length > 200);
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå®Œæ•´è…³æœ¬ï¼ˆå¿…é ˆåŒ…å«çµæ§‹åŒ–å…§å®¹ï¼‰
        const isCompletScript = (aiResponse.includes('Hook') || aiResponse.includes('é–‹å ´')) && 
                               (aiResponse.includes('Value') || aiResponse.includes('æ ¸å¿ƒ')) && 
                               (aiResponse.includes('CTA') || aiResponse.includes('è¡Œå‹•å‘¼ç±²')) &&
                               aiResponse.length > 300;
        
        // æ ¹æ“šåˆ¤æ–·çµæœé¡¯ç¤ºåˆ°å°æ‡‰å€å¡Šï¼ˆåªé¡¯ç¤ºæ˜ç¢ºçš„ç¸½çµ/çµæœï¼‰
        if (isCompletScript) {
          // å®Œæ•´è…³æœ¬ï¼šé¡¯ç¤ºåˆ°è…³æœ¬å€å¡Š
          updateResultBlock('scriptContent', aiResponse, true);
          document.getElementById('scriptActions').style.display = 'flex';
          switchTab('script');
        } else if (isTopicsSummary) {
          // é¸é¡Œæ¨è–¦ï¼šé¡¯ç¤ºåˆ°é¸é¡Œå€å¡Š
          updateResultBlock('topicContent', aiResponse, true);
          document.getElementById('topicActions').style.display = 'flex';
          switchTab('topics');
        } else if (isPositioningSummary) {
          // å¸³è™Ÿå®šä½ç¸½çµï¼šé¡¯ç¤ºåˆ°å®šä½å€å¡Š
          updateResultBlock('positioningContent', aiResponse, true);
          document.getElementById('positioningActions').style.display = 'flex';
          switchTab('positioning');
        }
        // å¦‚æœéƒ½ä¸ç¬¦åˆï¼ˆä¸€èˆ¬è¨è«–ã€å•ç­”ï¼‰ï¼Œå°±ä¸é¡¯ç¤ºåˆ°çµæœå€ï¼ˆä¿ç•™åœ¨å°è©±æ¡†ä¸­ï¼‰
      }
      
      // ä¸€éµç”Ÿæˆé¸é¡Œ
      async function generateTopics() {
        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆå¸³è™Ÿå®šä½ï¼ˆåªæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­æç¤ºæ–‡å­—ï¼‰
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const isDefaultText = positioningContent.includes('é»æ“Šã€Œä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½ã€') || 
                             positioningContent.includes('é–‹å§‹åˆ†æ');
        
        if (!positioningContent || isDefaultText) {
          showToast('è«‹å…ˆå®Œæˆå¸³è™Ÿå®šä½', 3000);
          return;
        }
        
        const platform = platformSelect.value;
        const topic = topicInput.value;
        const positioning = positioningInput.value;
        
        if (!platform) {
          showToast('è«‹å…ˆé¸æ“‡å¹³å°', 3000);
          return;
        }
        
        updateResultBlock('topicContent', 'æ­£åœ¨æ¨è–¦é¸é¡Œ...', false);
        
        try {
          const response = await fetch('https://aivideobackend.zeabur.app/api/generate/topics', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              message: 'è«‹å¹«æˆ‘æ¨è–¦é¸é¡Œ',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: currentUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('ç”Ÿæˆå¤±æ•—');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('topicContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±æ•—');
                  }
                } catch (e) {
                  console.error('è§£æéŒ¯èª¤:', e);
                }
              }
            }
          }
          
          // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
          document.getElementById('topicActions').style.display = 'flex';
          
          // è‡ªå‹•åˆ‡æ›åˆ°é¸é¡Œæ¨™ç±¤
          switchTab('topics');
          
        } catch (error) {
          updateResultBlock('topicContent', 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
          showToast('ç”Ÿæˆé¸é¡Œå¤±æ•—', 3000);
        }
      }
      
      // å„²å­˜çµæœ
      async function saveResult(type) {
        if (!currentUser || !currentUser.user_id) {
          showToast('è«‹å…ˆç™»å…¥', 3000);
          return;
        }
        
        let content = '';
        let contentElement = null;
        
        switch(type) {
          case 'positioning':
            contentElement = document.getElementById('positioningContent');
            break;
          case 'topics':
            contentElement = document.getElementById('topicContent');
            break;
          case 'script':
            contentElement = document.getElementById('scriptContent');
            break;
        }
        
        if (contentElement) {
          content = contentElement.textContent;
          
          // åªæœ‰å¸³è™Ÿå®šä½éœ€è¦ä¿å­˜åˆ°è³‡æ–™åº«
          if (type === 'positioning') {
            try {
              const response = await fetch('https://aivideobackend.zeabur.app/api/user/positioning/save', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                  user_id: currentUser.user_id,
                  content: content
                })
              });
              
              if (response.ok) {
                const data = await response.json();
                showToast(`å¸³è™Ÿå®šä½å·²å„²å­˜ï¼ˆç·¨è™Ÿï¼š${data.record_number}ï¼‰`, 3000);
                // é‡æ–°è¼‰å…¥å¸³è™Ÿå®šä½åˆ—è¡¨
                await loadPositioningRecords();
              } else {
                throw new Error('å„²å­˜å¤±æ•—');
              }
            } catch (error) {
              console.error('å„²å­˜éŒ¯èª¤:', error);
              showToast('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 3000);
            }
          } else {
            // å…¶ä»–é¡å‹æš«æ™‚å„²å­˜åˆ° localStorage
            localStorage.setItem(`saved_${type}`, content);
            showToast(`${type === 'topics' ? 'é¸é¡Œ' : 'è…³æœ¬'}å·²å„²å­˜`, 2000);
          }
        }
      }
      
      // é‡æ–°ç”Ÿæˆçµæœ
      async function regenerateResult(type) {
        switch(type) {
          case 'positioning':
            await generatePositioning();
            break;
          case 'topics':
            await generateTopics();
            break;
          case 'script':
            await generateScript();
            break;
        }
      }
      
      // æ›´æ–°çµæœå€å¡Šå…§å®¹
      function updateResultBlock(elementId, content, hasContent) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          if (hasContent) {
            element.classList.add('has-content');
          } else {
            element.classList.remove('has-content');
          }
        }
      }
      
      // å¸³è™Ÿå®šä½åŠŸèƒ½
      async function analyzePositioning() {
        const positioning = positioningInput.value;
        
        if (!positioning) {
          showToast('è«‹å…ˆè¼¸å…¥å¸³è™Ÿå®šä½', 3000);
          return;
        }
        
        updateResultBlock('positioningResult', 'æ­£åœ¨åˆ†æå¸³è™Ÿå®šä½...', false);
        
        try {
          // é€™è£¡å¯ä»¥èª¿ç”¨å¾Œç«¯ API é€²è¡Œå¸³è™Ÿå®šä½åˆ†æ
          // æš«æ™‚ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
          setTimeout(() => {
            const analysis = `æ ¹æ“šæ‚¨çš„å¸³è™Ÿå®šä½"${positioning}"ï¼Œå»ºè­°ï¼š\n\n1. å…§å®¹é¢¨æ ¼ï¼šè¼•é¬†å¹½é»˜\n2. ç›®æ¨™å—çœ¾ï¼šå¥åº·æ„›å¥½è€…\n3. å…§å®¹ä¸»é¡Œï¼šåŠ å¯†è²¨å¹£èˆ‡å¥åº·çµåˆ\n4. ç™¼å¸ƒæ™‚é–“ï¼šæ™šä¸Š8-10é»\n5. äº’å‹•ç­–ç•¥ï¼šå¤šä½¿ç”¨å•ç­”å½¢å¼`;
            updateResultBlock('positioningResult', analysis, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('positioningResult', 'åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
          showToast('åˆ†æå¤±æ•—', 3000);
        }
      }
      
      // è…³æœ¬é¸é¡ŒåŠŸèƒ½
      async function selectTopics() {
        const platform = platformSelect.value;
        const topic = topicInput.value;
        
        if (!platform) {
          showToast('è«‹å…ˆé¸æ“‡å¹³å°', 3000);
          return;
        }
        
        updateResultBlock('topicSelectionResult', 'æ­£åœ¨ç‚ºæ‚¨é¸é¡Œ...', false);
        
        try {
          // é€™è£¡å¯ä»¥èª¿ç”¨å¾Œç«¯ API é€²è¡Œé¸é¡Œ
          // æš«æ™‚ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
          setTimeout(() => {
            const topics = `ç‚º${platform}å¹³å°æ¨è–¦ä»¥ä¸‹é¸é¡Œ${topic ? `ï¼ˆåŸºæ–¼"${topic}"ä¸»é¡Œï¼‰` : ''}ï¼š\n\n1. å¤å­£ç¾ç™½ä¿é¤Šçš„5å€‹å°æŠ€å·§\n2. 30å¤©ç¾ç™½æŒ‘æˆ°å¯¦æ¸¬\n3. ç¾ç™½ç”¢å“æˆåˆ†å¤§è§£æ\n4. å¤©ç„¶ç¾ç™½æ–¹æ³•åˆ†äº«\n5. ç¾ç™½èª¤å€ä½ ä¸­äº†å¹¾å€‹ï¼Ÿ`;
            updateResultBlock('topicSelectionResult', topics, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('topicSelectionResult', 'é¸é¡Œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
          showToast('é¸é¡Œå¤±æ•—', 3000);
        }
      }
      
      // äº‹ä»¶ç›£è½å™¨
      document.addEventListener('DOMContentLoaded', async () => {
        // ç¢ºä¿æŠ½å±œåˆå§‹ç‹€æ…‹ç‚ºé—œé–‰
        closeUserDrawer();
        
        // æª¢æŸ¥æœ¬åœ°å­˜å„²çš„èªè­‰è³‡è¨Š
        accessToken = localStorage.getItem('accessToken');
        currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        
        if (accessToken && currentUser) {
          updateAuthUI(true);
        } else {
          updateAuthUI(false);
        }
        
        // æŒ‰éˆ•åŠŸèƒ½å·²æ•´åˆåˆ°å¿«é€ŸæŒ‰éˆ•ä¸­
        
        // æ¨™ç±¤åˆ‡æ›äº‹ä»¶
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
        
        // è¨­å®šå€å¡Šæ‘ºç–Š/å±•é–‹åŠŸèƒ½
        settingsToggleEl.addEventListener('click', () => {
          const isCollapsed = settingsContentEl.classList.contains('collapsed');
          const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
          
          if (isCollapsed) {
            settingsContentEl.classList.remove('collapsed');
            toggleIcon.textContent = 'â–¼';
          } else {
            settingsContentEl.classList.add('collapsed');
            toggleIcon.textContent = 'â–¶';
          }
        });
        
        // ç™»å…¥æŒ‰éˆ•åŠŸèƒ½
        loginBtn.addEventListener('click', login);
        
        // ç™»å‡ºæŒ‰éˆ•åŠŸèƒ½
        logoutBtn.addEventListener('click', logout);
        
        // èŠå¤©åŠŸèƒ½
        sendBtn.addEventListener('click', sendMessage);
        
        // å¿«é€ŸæŒ‰éˆ•åŠŸèƒ½
        document.querySelectorAll('.quick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            if (text) {
              messageInput.value = text;
              messageInput.focus();
              
              // æ·»åŠ è¦–è¦ºåé¥‹
              btn.style.transform = 'scale(0.95)';
              setTimeout(() => {
                btn.style.transform = '';
              }, 150);
              
              // æ ¹æ“šæŒ‰éˆ•é¡å‹åˆ‡æ›åˆ°å°æ‡‰çš„çµæœæ¨™ç±¤
              if (text.includes('ç”Ÿæˆè…³æœ¬')) {
                switchTab('script');
              } else if (text.includes('è…³æœ¬é¸é¡Œ')) {
                switchTab('topics');
              } else if (text.includes('å¸³è™Ÿå®šä½')) {
                switchTab('positioning');
              }
              
              // è‡ªå‹•ç™¼é€è¨Šæ¯
              setTimeout(() => {
                sendMessage();
              }, 500);
            }
          });
        });
        
        // è¨­å®šå·²å¥—ç”¨çš„æ¨™è¨˜
        let settingsApplied = false;
        let appliedSettings = {
          platform: null,
          topic: null,
          duration: null,
          positioning: null
        };

        applyBtn.addEventListener('click', () => {
          const platform = platformSelect.value;
          const topic = topicInput.value;
          const positioning = positioningInput.value;
          const duration = durationInput.value;
          
          if (platform) {
            // è¨˜éŒ„å·²å¥—ç”¨çš„è¨­å®š
            settingsApplied = true;
            appliedSettings = {
              platform: platform,
              topic: topic,
              duration: duration,
              positioning: positioning
            };
            
            showToast('è¨­å®šå·²å¥—ç”¨', 2000);
            
            // è‡ªå‹•æ”¶åˆè¨­å®šå€å¡Š
            settingsContentEl.classList.add('collapsed');
            const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
            toggleIcon.textContent = 'â–¶';
          } else {
            showToast('è«‹é¸æ“‡å¹³å°', 3000);
          }
        });
        
        // æ¸¬è©¦é€£ç·šå’Œé¡¯ç¤ºçµæœåŠŸèƒ½å·²æ•´åˆåˆ°å…¶ä»–æŒ‰éˆ•ä¸­
        
        // ç¶å®šå½ˆè·³è¦–çª—æŒ‰éˆ•äº‹ä»¶
        popupRetry.addEventListener('click', () => {
          hidePopupOverlay();
          login();
        });
        
        popupCancel.addEventListener('click', () => {
          hidePopupOverlay();
        });
        
        // éµç›¤å¿«æ·éµ
        messageInput.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
          }
        });
      });
      
      // ç™»å…¥åŠŸèƒ½
      async function login() {
        try {
          // é¡¯ç¤ºå½ˆè·³è¦–çª—è¦†è“‹å±¤
          showPopupOverlay('æ­£åœ¨é–‹å•Ÿ Google ç™»å…¥è¦–çª—...');
          
          // ç²å– Google èªè­‰ URL
          const response = await fetch('https://aivideobackend.zeabur.app/api/auth/google');
          const data = await response.json();
          
          // ä½¿ç”¨å½ˆè·³è¦–çª—é€²è¡Œ Google èªè­‰
          const popup = window.open(
            data.auth_url,
            'googleAuth',
            'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
          );
          
          if (!popup) {
            hidePopupOverlay();
            showPopupError('è«‹å…è¨±å½ˆè·³è¦–çª—ä»¥å®Œæˆç™»å…¥', true);
            return;
          }
          
          // æ›´æ–°è¦†è“‹å±¤è¨Šæ¯
          updatePopupMessage('è«‹åœ¨å½ˆè·³è¦–çª—ä¸­å®Œæˆ Google ç™»å…¥...');
          
          // ç›£è½å½ˆè·³è¦–çª—é—œé–‰
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              clearInterval(checkClosed);
              hidePopupOverlay();
              // æª¢æŸ¥æ˜¯å¦æœ‰èªè­‰çµæœ
              checkAuthResult();
            }
          }, 1000);
          
          // ç›£è½ä¾†è‡ªå½ˆè·³è¦–çª—çš„è¨Šæ¯
          window.addEventListener('message', handleAuthMessage);
          
        } catch (error) {
          console.error('Login error:', error);
          hidePopupOverlay();
          showToast('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 5000);
        }
      }
      
      function showPopupOverlay(message) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'block';
        popupButtons.style.display = 'none';
        popupOverlay.style.display = 'flex';
      }
      
      function updatePopupMessage(message) {
        popupMessage.textContent = message;
      }
      
      function showPopupError(message, showRetry = false) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'none';
        if (showRetry) {
          popupButtons.style.display = 'block';
        } else {
          popupButtons.style.display = 'none';
        }
        popupOverlay.style.display = 'flex';
      }
      
      function hidePopupOverlay() {
        popupOverlay.style.display = 'none';
      }
      
      function handleAuthMessage(event) {
        // ç¢ºä¿è¨Šæ¯ä¾†è‡ªæˆ‘å€‘çš„å›èª¿é é¢
        if (event.origin !== window.location.origin) return;
        
        if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
          // èªè­‰æˆåŠŸï¼Œæ›´æ–° UI
          accessToken = event.data.accessToken;
          currentUser = event.data.user;
          
          // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          hidePopupOverlay();
          updateAuthUI(true);
          showToast('ç™»å…¥æˆåŠŸï¼', 3000);
          
          // ç§»é™¤äº‹ä»¶ç›£è½å™¨
          window.removeEventListener('message', handleAuthMessage);
        } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
          hidePopupOverlay();
          showToast('èªè­‰å¤±æ•—ï¼š' + event.data.error, 5000);
          window.removeEventListener('message', handleAuthMessage);
        }
      }
      
      async function checkAuthResult() {
        // æª¢æŸ¥æœ¬åœ°å­˜å„²ä¸­æ˜¯å¦æœ‰æ–°çš„èªè­‰è³‡è¨Š
        const storedToken = localStorage.getItem('accessToken');
        const storedUser = localStorage.getItem('currentUser');
        
        if (storedToken && storedUser && storedToken !== accessToken) {
          accessToken = storedToken;
          currentUser = JSON.parse(storedUser);
          
          // ç‚ºç”¨æˆ¶ç”Ÿæˆéš¨æ©ŸIDï¼ˆå¦‚æœæ²’æœ‰ï¼‰
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('é é¢è¼‰å…¥æ™‚ç‚ºç”¨æˆ¶ç”Ÿæˆæ–°ID:', currentUser.user_id);
          }
          
          updateAuthUI(true);
          updatePersonalInfo();
          showToast('ç™»å…¥æˆåŠŸï¼', 3000);
        }
      }

      async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
          try {
            const response = await fetch('https://aivideobackend.zeabur.app/api/auth/google/callback', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code })
            });
            
            if (response.ok) {
              const authData = await response.json();
              accessToken = authData.access_token;
              currentUser = authData.user;
              
              // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
              localStorage.setItem('accessToken', accessToken);
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              
              updateAuthUI(true);
              showToast('ç™»å…¥æˆåŠŸï¼', 3000);
              
              // æ¸…é™¤ URL ä¸­çš„èªè­‰ç¢¼
              window.history.replaceState({}, document.title, window.location.pathname);
            } else {
              throw new Error('Authentication failed');
            }
          } catch (error) {
            console.error('Auth callback error:', error);
            showToast('èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥', 5000);
            updateAuthUI(false);
          }
        }
      }

      async function fetchUserInfo() {
        if (!accessToken) return;
        
        const response = await fetch('https://aivideobackend.zeabur.app/api/auth/me', {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (response.ok) {
          const userData = await response.json();
          currentUser = userData;
          
          // ç‚ºç”¨æˆ¶ç”Ÿæˆéš¨æ©ŸIDï¼ˆå¦‚æœæ²’æœ‰ï¼‰
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            console.log('ç‚ºç”¨æˆ¶ç”Ÿæˆæ–°ID:', currentUser.user_id);
          }
          
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          updateAuthUI(true);
          
          // ç«‹å³æ›´æ–°å€‹äººè³‡æ–™é¡¯ç¤º
          updatePersonalInfo();
        } else {
          throw new Error('Failed to fetch user info');
        }
      }

      // å½ˆå‡ºæç¤ºæ¡†å‡½æ•¸
      function showToast(message, duration = 3000) {
        toastEl.textContent = message;
        toastEl.style.display = 'block';
        toastEl.className = 'toast show';
        
        setTimeout(() => {
          toastEl.className = 'toast hide';
          setTimeout(() => {
            toastEl.style.display = 'none';
          }, 300);
        }, duration);
      }

      // é€™å€‹äº‹ä»¶ç›£è½å™¨å·²ç¶“åˆä½µåˆ°ä¸Šé¢çš„ DOMContentLoaded ä¸­

      function append(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        
        const label = document.createElement('div');
        label.className = 'msg-label';
        label.textContent = role === 'user' ? 'ä½ ' : 'AIJobçŸ­å½±éŸ³é¡§å•';
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // å¦‚æœæ˜¯ AI å›è¦†ï¼Œæ¸…ç† Markdown æ ¼å¼
        if (role === 'assistant') {
          const cleanText = cleanMarkdownFormat(text);
          bubble.innerHTML = cleanText;
        } else {
          bubble.textContent = text;
        }
        
        div.appendChild(label);
        div.appendChild(bubble);
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
        return { container: div, bubble: bubble };
      }

      // æ¸…ç† Markdown æ ¼å¼ä¸¦è½‰æ›ç‚º HTML
      function cleanMarkdownFormat(text) {
        // è™•ç† Markdown æ¨™é¡Œæ ¼å¼
        text = text.replace(/^###\s*(.+)$/gm, '<strong>$1</strong>'); // ### æ¨™é¡Œ â†’ **æ¨™é¡Œ**
        text = text.replace(/^##\s*(.+)$/gm, '<strong>$1</strong>');  // ## æ¨™é¡Œ â†’ **æ¨™é¡Œ**
        text = text.replace(/^#\s*(.+)$/gm, '<strong>$1</strong>');   // # æ¨™é¡Œ â†’ **æ¨™é¡Œ**
        
        // å°‡ **æ–‡å­—** è½‰æ›ç‚º <strong>æ–‡å­—</strong>
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // è™•ç†å…¶ä»–å¸¸è¦‹çš„ Markdown æ ¼å¼
        text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');           // *æ–œé«”* â†’ æ–œé«”
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');         // `ä»£ç¢¼` â†’ ä»£ç¢¼
        
        // ç§»é™¤å–®ç¨çš„ Markdown ç¬¦è™Ÿ
        text = text.replace(/\*\*/g, '');                             // ç§»é™¤å–®ç¨çš„ **
        text = text.replace(/^#{1,6}\s*/gm, '');                      // ç§»é™¤è¡Œé¦–çš„ # ç¬¦è™Ÿ
        
        // è™•ç†æ›è¡Œç¬¦è™Ÿï¼Œç¢ºä¿æ®µè½åˆ†æ˜
        text = text.replace(/\n\n/g, '</p><p>');                      // é›™æ›è¡Œ â†’ æ®µè½åˆ†éš”
        text = text.replace(/\n/g, '<br>');                           // å–®æ›è¡Œ â†’ æ›è¡Œæ¨™ç±¤
        
        // åŒ…è£åœ¨æ®µè½æ¨™ç±¤ä¸­
        if (text && !text.startsWith('<p>')) {
          text = '<p>' + text + '</p>';
        }
        
        return text;
      }

      function updateAssistantNode(nodeObj, text) {
        // æ¸…ç† Markdown æ ¼å¼
        const cleanText = cleanMarkdownFormat(text);
        
        if (nodeObj.bubble) {
          // ä½¿ç”¨ innerHTML ä¾†æ”¯æ´ HTML æ¨™ç±¤ï¼ˆå¦‚ <strong>ï¼‰
          nodeObj.bubble.innerHTML = cleanText;
        } else {
          nodeObj.innerHTML = cleanText;
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function canSubmit() {
        if (isSending) return false;
        const now = Date.now();
        if (now - lastSubmitAt < 600) return false; // 600ms ç¯€æµ
        lastSubmitAt = now;
        return true;
      }

      async function send(message) {
        if (!message) return;
        if (!canSubmit()) return;
        lastMessage = message;
        const userNode = append('user', message);
        const assistantNode = append('assistant', '');

        // é¡¯ç¤º AI å›è¦†ä¸­çš„è¼‰å…¥ç‹€æ…‹
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.innerHTML = '<div class="spinner"></div><span>AIå›è¦†ä¸­...</span>';
        assistantNode.bubble.appendChild(loadingDiv);

        sendBtn.disabled = true;
        isSending = true;
        statusEl.textContent = 'æ­£åœ¨é€å‡ºâ€¦';

        try {
          // è‡ªå‹•åµæ¸¬ç’°å¢ƒï¼Œé–‹ç™¼æ™‚ä½¿ç”¨ localhostï¼Œéƒ¨ç½²æ™‚ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ–é è¨­å¾Œç«¯ç¶²åŸŸ
          const isDevelopment = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname === '0.0.0.0';
          
          // å¦‚æœæ˜¯é–‹ç™¼ç’°å¢ƒï¼Œä½¿ç”¨ localhost:8000ï¼›éƒ¨ç½²ç’°å¢ƒä½¿ç”¨æ­£ç¢ºçš„å¾Œç«¯ç¶²åŸŸ
          let endpoint;
          if (isDevelopment) {
            endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          } else {
            // éƒ¨ç½²ç’°å¢ƒï¼šä½¿ç”¨æ‚¨æä¾›çš„æ­£ç¢ºå¾Œç«¯ç¶²åŸŸ
            endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          }
          // æ·»åŠ èª¿è©¦ä¿¡æ¯
          console.log('API ç«¯é»:', endpoint);
          console.log('ç•¶å‰ä½ç½®:', window.location.href);
          console.log('Hostname:', window.location.hostname);
          console.log('Port:', window.location.port);
          
          // æº–å‚™è«‹æ±‚é ­
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          const res = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message,
              platform: settingsApplied ? appliedSettings.platform : null,
              topic: settingsApplied ? appliedSettings.topic : null,
              duration: settingsApplied ? appliedSettings.duration : null,
              style: styleInstruction,
              profile: settingsApplied ? appliedSettings.positioning : null,
              history,
              user_id: currentUser?.user_id || null
            })
          });

          if (!res.ok) {
            const text = await res.text().catch(() => '');
            console.error('API è«‹æ±‚å¤±æ•—:', res.status, text);
            
            let errorMessage = `[è«‹æ±‚å¤±æ•— ${res.status}] `;
            try {
              const errorData = JSON.parse(text);
              if (errorData.error) {
                errorMessage += errorData.error;
                if (errorData.error.includes('GEMINI_API_KEY')) {
                  errorMessage += '\n\nğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼šè«‹åœ¨ Zeabur å¾Œç«¯æœå‹™çš„ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š GEMINI_API_KEY';
                }
              } else {
                errorMessage += text || 'ç„¡å›æ‡‰å…§å®¹';
              }
            } catch {
              errorMessage += text || 'ç„¡å›æ‡‰å…§å®¹';
            }
            
            updateAssistantNode(assistantNode, errorMessage);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let aiText = '';
          let buffer = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              if (!frame.startsWith('data:')) continue;
              try {
                const jsonStr = frame.slice(5).trim();
                const evt = JSON.parse(jsonStr);
                if (evt.type === 'token') {
                  // ç§»é™¤è¼‰å…¥å‹•ç•«ï¼Œé–‹å§‹é¡¯ç¤º AI å›è¦†
                  const loadingDiv = assistantNode.bubble.querySelector('.loading');
                  if (loadingDiv) {
                    loadingDiv.remove();
                  }
                  aiText += evt.content;
                  updateAssistantNode(assistantNode, aiText);
                } else if (evt.type === 'end') {
                  history.push({ role: 'user', content: message });
                  history.push({ role: 'assistant', content: aiText });
                  
                  // æª¢æŸ¥æ˜¯å¦åŒ…å«è…³æœ¬çµæœï¼Œè‡ªå‹•é¡¯ç¤ºçµæœå€å¡Š
                  checkAndUpdateResults(aiText);
                }
              } catch (e) { /* ignore parse errors */ }
            }
          }
        } catch (e) {
          // ç§»é™¤è¼‰å…¥å‹•ç•«ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          const loadingDiv = assistantNode.bubble.querySelector('.loading');
          if (loadingDiv) {
            loadingDiv.remove();
          }
          console.error('è«‹æ±‚éŒ¯èª¤:', e);
          console.error('éŒ¯èª¤è©³æƒ…:', {
            message: e?.message,
            name: e?.name,
            stack: e?.stack,
            endpoint: endpoint,
            location: window.location.href
          });
          
          // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
          let errorMsg = `[éŒ¯èª¤] ${e?.message || e}`;
          if (e?.name === 'TypeError' && e?.message.includes('fetch')) {
            errorMsg = '[é€£ç·šéŒ¯èª¤] ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦';
          } else if (e?.name === 'TypeError' && e?.message.includes('Failed to fetch')) {
            errorMsg = '[ç¶²è·¯éŒ¯èª¤] è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢';
          } else if (e?.message?.includes('CORS')) {
            errorMsg = '[è·¨åŸŸéŒ¯èª¤] è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢';
          }
          
          // æ·»åŠ æ›´å¤šèª¿è©¦ä¿¡æ¯
          errorMsg += `\n\nèª¿è©¦ä¿¡æ¯ï¼š\nç«¯é»: ${endpoint}\nä½ç½®: ${window.location.href}`;
          updateAssistantNode(assistantNode, errorMsg);
        } finally {
          sendBtn.disabled = false;
          isSending = false;
          statusEl.textContent = '';
        }
      }

      // é€™äº›äº‹ä»¶ç›£è½å™¨å·²ç¶“åœ¨æ–°çš„ DOMContentLoaded ä¸­è™•ç†

      // è¨­å®šå€å¡Šæ‘ºç–Š/å±•é–‹åŠŸèƒ½
      // è¨­å®šå€å¡Šæ‘ºç–Š/å±•é–‹åŠŸèƒ½å·²ç§»é™¤

      // é€™å€‹äº‹ä»¶ç›£è½å™¨å·²ç¶“åœ¨æ–°çš„ DOMContentLoaded ä¸­è™•ç†

      function updateBadge(badgeEl, label, value) {
        if (value) {
          badgeEl.style.display = 'inline-block';
          badgeEl.textContent = label + 'ï¼š' + value;
        } else {
          badgeEl.style.display = 'none';
          badgeEl.textContent = '';
        }
      }

      // æ¸¬è©¦é€£ç·šåŠŸèƒ½
      async function testConnection() {
        const testNode = append('assistant', 'ğŸ”§ æ­£åœ¨æ¸¬è©¦é€£ç·š...');
        
        try {
          // æ¸¬è©¦å¾Œç«¯æ ¹è·¯å¾‘
          const rootResponse = await fetch('https://aivideobackend.zeabur.app/');
          const rootText = await rootResponse.text();
          
          let testResult = `ğŸ” é€£ç·šæ¸¬è©¦çµæœï¼š\n\n`;
          testResult += `1ï¸âƒ£ å¾Œç«¯æ ¹è·¯å¾‘ï¼š${rootResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'} (ç‹€æ…‹ç¢¼: ${rootResponse.status})\n`;
          
          // æ¸¬è©¦å¥åº·æª¢æŸ¥
          try {
            const healthResponse = await fetch('https://aivideobackend.zeabur.app/api/health');
            const healthData = await healthResponse.json();
            
            testResult += `2ï¸âƒ£ å¥åº·æª¢æŸ¥ï¼š${healthResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'}\n`;
            testResult += `   - çŸ¥è­˜åº«ï¼š${healthData.kb_status}\n`;
            testResult += `   - Geminié…ç½®ï¼š${healthData.gemini_configured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;
            testResult += `   - Geminiæ¸¬è©¦ï¼š${healthData.gemini_test}\n`;
            testResult += `   - æ¨¡å‹ï¼š${healthData.model_name}\n`;
            
            if (!healthData.gemini_configured) {
              testResult += `\nâš ï¸ å•é¡Œï¼šGemini API Key æœªé…ç½®\n`;
              testResult += `ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼šè«‹åœ¨ Zeabur å¾Œç«¯ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š GEMINI_API_KEY\n`;
            } else if (healthData.gemini_test !== 'working') {
              testResult += `\nâš ï¸ å•é¡Œï¼šGemini API é€£ç·šç•°å¸¸\n`;
              testResult += `ğŸ’¡ éŒ¯èª¤ï¼š${healthData.gemini_test}\n`;
            }
            
          } catch (healthError) {
            testResult += `2ï¸âƒ£ å¥åº·æª¢æŸ¥ï¼šâŒ ç„¡æ³•é€£ç·š (${healthError.message})\n`;
          }
          
          // æ¸¬è©¦èŠå¤©API
          try {
            const chatResponse = await fetch('https://aivideobackend.zeabur.app/api/chat/stream', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'test', platform: null, topic: null, duration: '30' })
            });
            
            testResult += `3ï¸âƒ£ èŠå¤©APIï¼š${chatResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'} (ç‹€æ…‹ç¢¼: ${chatResponse.status})\n`;
            
            if (!chatResponse.ok) {
              const errorText = await chatResponse.text();
              testResult += `   éŒ¯èª¤ï¼š${errorText}\n`;
            }
            
          } catch (chatError) {
            testResult += `3ï¸âƒ£ èŠå¤©APIï¼šâŒ ç„¡æ³•é€£ç·š (${chatError.message})\n`;
          }
          
          updateAssistantNode(testNode, testResult);
          
        } catch (error) {
          updateAssistantNode(testNode, `âŒ é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š${error.message}`);
        }
      }

      // æ¸¬è©¦é€£ç·šæŒ‰éˆ•å·²ç§»é™¤

      // æ·»åŠ å…¨å±€æ¸¬è©¦å‡½æ•¸ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
      window.testDOM = function() {
        console.log('=== DOMå…ƒç´ æ¸¬è©¦ ===');
        console.log('resultTitleEl:', resultTitleEl);
        console.log('resultScriptEl:', resultScriptEl);
        console.log('resultVisualEl:', resultVisualEl);
        console.log('resultCopyEl:', resultCopyEl);
        
        if (resultTitleEl) {
          resultTitleEl.innerHTML = 'æ¸¬è©¦æ¨™é¡Œ';
          console.log('æ¸¬è©¦æ¨™é¡Œè¨­ç½®æˆåŠŸ');
        }
        if (resultScriptEl) {
          resultScriptEl.innerHTML = 'æ¸¬è©¦è…³æœ¬å…§å®¹';
          console.log('æ¸¬è©¦è…³æœ¬å…§å®¹è¨­ç½®æˆåŠŸ');
        }
        if (resultVisualEl) {
          resultVisualEl.innerHTML = 'æ¸¬è©¦ç•«é¢æ„Ÿ';
          console.log('æ¸¬è©¦ç•«é¢æ„Ÿè¨­ç½®æˆåŠŸ');
        }
        if (resultCopyEl) {
          resultCopyEl.innerHTML = 'æ¸¬è©¦ç™¼ä½ˆæ–‡æ¡ˆ';
          console.log('æ¸¬è©¦ç™¼ä½ˆæ–‡æ¡ˆè¨­ç½®æˆåŠŸ');
        }
      };
      
      // æ·»åŠ AIå…§å®¹æ¸¬è©¦å‡½æ•¸
      window.testAIContent = function(aiText) {
        console.log('=== AIå…§å®¹æ¸¬è©¦ ===');
        console.log('æ¸¬è©¦æ–‡æœ¬:', aiText);
        
        const isScript = detectScriptContent(aiText);
        console.log('æ˜¯å¦ç‚ºè…³æœ¬å…§å®¹:', isScript);
        
        if (isScript) {
          const sections = parseAIContent(aiText);
          console.log('è§£æçµæœ:', sections);
          
          // æ›´æ–°DOMå…ƒç´ 
          if (sections.title && resultTitleEl) {
            resultTitleEl.innerHTML = sections.title;
            console.log('âœ… ä¸»é¡Œæ¨™é¡Œå·²è¨­ç½®');
          }
          if (sections.script && resultScriptEl) {
            resultScriptEl.innerHTML = sections.script;
            console.log('âœ… è…³æœ¬å…§å®¹å·²è¨­ç½®');
          }
          if (sections.visual && resultVisualEl) {
            resultVisualEl.innerHTML = sections.visual;
            console.log('âœ… ç•«é¢æ„Ÿå·²è¨­ç½®');
          }
          if (sections.copy && resultCopyEl) {
            resultCopyEl.innerHTML = sections.copy;
            console.log('âœ… ç™¼ä½ˆæ–‡æ¡ˆå·²è¨­ç½®');
          }
          
          // é¡¯ç¤ºçµæœå€å¡Š
          resultsEl.style.display = 'block';
          console.log('âœ… çµæœå€å¡Šå·²é¡¯ç¤º');
        }
      };
      
      // æ·»åŠ å¼·åˆ¶æ›´æ–°å‡½æ•¸
      window.forceUpdateResults = function() {
        console.log('=== å¼·åˆ¶æ›´æ–°çµæœå€å¡Š ===');
        
        // å¾èŠå¤©è¨˜éŒ„ä¸­ç²å–æœ€å¾Œä¸€æ¢AIå›æ‡‰
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('ç²å–AIæ–‡æœ¬:', aiText.substring(0, 200) + '...');
          
          const isScript = detectScriptContent(aiText);
          console.log('æ˜¯å¦ç‚ºè…³æœ¬å…§å®¹:', isScript);
          
          if (isScript) {
            const sections = parseAIContent(aiText);
            console.log('è§£æçµæœ:', sections);
            
            // å¼·åˆ¶æ›´æ–°DOMå…ƒç´ 
            if (resultTitleEl) {
              resultTitleEl.innerHTML = sections.title || 'æœªæ‰¾åˆ°ä¸»é¡Œæ¨™é¡Œ';
              console.log('âœ… ä¸»é¡Œæ¨™é¡Œå·²å¼·åˆ¶è¨­ç½®');
            }
            if (resultScriptEl) {
              resultScriptEl.innerHTML = sections.script || 'æœªæ‰¾åˆ°è…³æœ¬å…§å®¹';
              console.log('âœ… è…³æœ¬å…§å®¹å·²å¼·åˆ¶è¨­ç½®');
            }
            if (resultVisualEl) {
              resultVisualEl.innerHTML = sections.visual || 'æœªæ‰¾åˆ°ç•«é¢æ„Ÿ';
              console.log('âœ… ç•«é¢æ„Ÿå·²å¼·åˆ¶è¨­ç½®');
            }
            if (resultCopyEl) {
              resultCopyEl.innerHTML = sections.copy || 'æœªæ‰¾åˆ°ç™¼ä½ˆæ–‡æ¡ˆ';
              console.log('âœ… ç™¼ä½ˆæ–‡æ¡ˆå·²å¼·åˆ¶è¨­ç½®');
            }
            
            // é¡¯ç¤ºçµæœå€å¡Š
            resultsEl.style.display = 'block';
            console.log('âœ… çµæœå€å¡Šå·²å¼·åˆ¶é¡¯ç¤º');
          } else {
            console.log('âŒ æª¢æ¸¬å¤±æ•—ï¼Œä¸æ˜¯è…³æœ¬å…§å®¹');
          }
        } else {
          console.log('âŒ æœªæ‰¾åˆ°AIå›æ‡‰');
        }
      };
      
      // æ·»åŠ ç°¡å–®æ¸¬è©¦å‡½æ•¸
      window.testCurrentContent = function() {
        console.log('=== æ¸¬è©¦ç•¶å‰å…§å®¹ ===');
        
        // å¾èŠå¤©è¨˜éŒ„ä¸­ç²å–æœ€å¾Œä¸€æ¢AIå›æ‡‰
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('AIæ–‡æœ¬é•·åº¦:', aiText.length);
          console.log('AIæ–‡æœ¬å‰500å­—ç¬¦:', aiText.substring(0, 500));
          
          // æ¸¬è©¦ä¸»é¡Œæ¨™é¡Œæå–
          const titleMatch = aiText.match(/ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i);
          console.log('ä¸»é¡Œæ¨™é¡ŒåŒ¹é…çµæœ:', titleMatch);
          
          // æ¸¬è©¦è…³æœ¬å…§å®¹æå–
          const scriptMatch = aiText.match(/è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i);
          console.log('è…³æœ¬å…§å®¹åŒ¹é…çµæœ:', scriptMatch ? 'åŒ¹é…' : 'ç„¡åŒ¹é…');
          
          // æ¸¬è©¦ç•«é¢æ„Ÿæå–
          const visualMatch = aiText.match(/ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i);
          console.log('ç•«é¢æ„ŸåŒ¹é…çµæœ:', visualMatch ? 'åŒ¹é…' : 'ç„¡åŒ¹é…');
          
          // æ¸¬è©¦ç™¼ä½ˆæ–‡æ¡ˆæå–
          const copyMatch = aiText.match(/ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i);
          console.log('ç™¼ä½ˆæ–‡æ¡ˆåŒ¹é…çµæœ:', copyMatch ? 'åŒ¹é…' : 'ç„¡åŒ¹é…');
          
          // ç›´æ¥æ›´æ–°çµæœå€å¡Š
          if (titleMatch && titleMatch[1]) {
            resultTitleEl.innerHTML = cleanMarkdownFormat(titleMatch[1].trim());
            console.log('âœ… ç›´æ¥è¨­ç½®ä¸»é¡Œæ¨™é¡Œ');
          }
          if (scriptMatch && scriptMatch[1]) {
            resultScriptEl.innerHTML = cleanMarkdownFormat(scriptMatch[1].trim());
            console.log('âœ… ç›´æ¥è¨­ç½®è…³æœ¬å…§å®¹');
          }
          if (visualMatch && visualMatch[1]) {
            resultVisualEl.innerHTML = cleanMarkdownFormat(visualMatch[1].trim());
            console.log('âœ… ç›´æ¥è¨­ç½®ç•«é¢æ„Ÿ');
          }
          if (copyMatch && copyMatch[1]) {
            resultCopyEl.innerHTML = cleanMarkdownFormat(copyMatch[1].trim());
            console.log('âœ… ç›´æ¥è¨­ç½®ç™¼ä½ˆæ–‡æ¡ˆ');
          }
          
          // é¡¯ç¤ºçµæœå€å¡Š
          resultsEl.style.display = 'block';
          console.log('âœ… çµæœå€å¡Šå·²é¡¯ç¤º');
        } else {
          console.log('âŒ æœªæ‰¾åˆ°AIå›æ‡‰');
        }
      };
      
      // æ·»åŠ è¶…å¼·åŠ›æ¸¬è©¦å‡½æ•¸
      window.forceExtractContent = function() {
        console.log('=== è¶…å¼·åŠ›å…§å®¹æå– ===');
        
        // å¾èŠå¤©è¨˜éŒ„ä¸­ç²å–æœ€å¾Œä¸€æ¢AIå›æ‡‰
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('AIæ–‡æœ¬é•·åº¦:', aiText.length);
          console.log('AIæ–‡æœ¬å‰1000å­—ç¬¦:', aiText.substring(0, 1000));
          
          // å¼·åˆ¶æå–ä¸»é¡Œæ¨™é¡Œ
          let title = '';
          const titlePatterns = [
            /\*\*ä¸»é¡Œæ¨™é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
            /ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*ä¸»é¡Œæ¨™é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
            /\d+\.\s*ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              title = cleanMarkdownFormat(match[1].trim());
              console.log('âœ… æ‰¾åˆ°ä¸»é¡Œæ¨™é¡Œ:', title);
              break;
            }
          }
          
          // å¼·åˆ¶æå–è…³æœ¬å…§å®¹
          let script = '';
          const scriptPatterns = [
            /\*\*è…³æœ¬å…§å®¹\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*\*\*è…³æœ¬å…§å®¹\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç•«é¢æ„Ÿ|\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç•«é¢æ„Ÿ|\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              script = cleanMarkdownFormat(match[1].trim());
              console.log('âœ… æ‰¾åˆ°è…³æœ¬å…§å®¹:', script.substring(0, 100) + '...');
              break;
            }
          }
          
          // å¼·åˆ¶æå–ç•«é¢æ„Ÿ
          let visual = '';
          const visualPatterns = [
            /\*\*ç•«é¢æ„Ÿ\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*\*\*ç•«é¢æ„Ÿ\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              visual = cleanMarkdownFormat(match[1].trim());
              console.log('âœ… æ‰¾åˆ°ç•«é¢æ„Ÿ:', visual.substring(0, 100) + '...');
              break;
            }
          }
          
          // å¼·åˆ¶æå–ç™¼ä½ˆæ–‡æ¡ˆ
          let copy = '';
          const copyPatterns = [
            /\*\*ç™¼ä½ˆæ–‡æ¡ˆ\*\*[ï¼š:]\s*([\s\S]*?)$/i,
            /ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*ç™¼ä½ˆæ–‡æ¡ˆ\*\*[ï¼š:]\s*([\s\S]*?)$/i,
            /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              copy = cleanMarkdownFormat(match[1].trim());
              console.log('âœ… æ‰¾åˆ°ç™¼ä½ˆæ–‡æ¡ˆ:', copy.substring(0, 100) + '...');
              break;
            }
          }
          
          // å¼·åˆ¶æ›´æ–°çµæœå€å¡Š
          if (title) {
            resultTitleEl.innerHTML = title;
            console.log('âœ… å¼·åˆ¶è¨­ç½®ä¸»é¡Œæ¨™é¡Œ');
          }
          if (script) {
            resultScriptEl.innerHTML = script;
            console.log('âœ… å¼·åˆ¶è¨­ç½®è…³æœ¬å…§å®¹');
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
            console.log('âœ… å¼·åˆ¶è¨­ç½®ç•«é¢æ„Ÿ');
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
            console.log('âœ… å¼·åˆ¶è¨­ç½®ç™¼ä½ˆæ–‡æ¡ˆ');
          }
          
          // é¡¯ç¤ºçµæœå€å¡Š
          resultsEl.style.display = 'block';
          console.log('âœ… çµæœå€å¡Šå·²å¼·åˆ¶é¡¯ç¤º');
          
          // å¦‚æœé‚„æ˜¯æ²’æœ‰å…§å®¹ï¼Œé¡¯ç¤ºåŸå§‹æ–‡æœ¬
          if (!title && !script && !visual && !copy) {
            console.log('âš ï¸ æ‰€æœ‰æå–éƒ½å¤±æ•—ï¼Œé¡¯ç¤ºåŸå§‹æ–‡æœ¬');
            resultTitleEl.innerHTML = 'åŸå§‹AIå›æ‡‰';
            resultScriptEl.innerHTML = aiText.substring(0, 500) + '...';
            resultVisualEl.innerHTML = 'è«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ';
            resultCopyEl.innerHTML = 'è§£æå¤±æ•—';
          }
        } else {
          console.log('âŒ æœªæ‰¾åˆ°AIå›æ‡‰');
        }
      };
      
      // æ·»åŠ çµ‚æ¥µè§£æ±ºæ–¹æ¡ˆï¼šç›´æ¥å¾é é¢æå–
      window.extractFromPage = function() {
        console.log('=== çµ‚æ¥µè§£æ±ºæ–¹æ¡ˆï¼šå¾é é¢ç›´æ¥æå– ===');
        
        // æ–¹æ³•1ï¼šå¾èŠå¤©è¨˜éŒ„ä¸­æå–
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          console.log('å¾èŠå¤©è¨˜éŒ„æå–ï¼Œæ–‡æœ¬é•·åº¦:', aiText.length);
          
          // ç°¡å–®ç²—æš´çš„æå–æ–¹æ³•
          const lines = aiText.split('\n').filter(line => line.trim().length > 0);
          console.log('ç¸½è¡Œæ•¸:', lines.length);
          
          let title = '';
          let script = '';
          let visual = '';
          let copy = '';
          
          // é€è¡Œæƒæï¼Œæ‰¾åˆ°é—œéµè©å°±æå–
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // æå–ä¸»é¡Œæ¨™é¡Œ
            if (line.includes('ä¸»é¡Œæ¨™é¡Œ') && line.includes('ï¼š')) {
              const match = line.match(/ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*(.+)/i);
              if (match && match[1]) {
                title = cleanMarkdownFormat(match[1].trim());
                console.log('âœ… æ‰¾åˆ°ä¸»é¡Œæ¨™é¡Œ:', title);
              }
            }
            
            // æå–è…³æœ¬å…§å®¹
            if (line.includes('è…³æœ¬å…§å®¹') && line.includes('ï¼š')) {
              let scriptLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('ç•«é¢æ„Ÿ') || nextLine.includes('ç™¼ä½ˆæ–‡æ¡ˆ') || nextLine.includes('3.') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  scriptLines.push(nextLine);
                }
              }
              if (scriptLines.length > 0) {
                script = cleanMarkdownFormat(scriptLines.join('\n'));
                console.log('âœ… æ‰¾åˆ°è…³æœ¬å…§å®¹:', script.substring(0, 100) + '...');
              }
            }
            
            // æå–ç•«é¢æ„Ÿ
            if (line.includes('ç•«é¢æ„Ÿ') && line.includes('ï¼š')) {
              let visualLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('ç™¼ä½ˆæ–‡æ¡ˆ') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  visualLines.push(nextLine);
                }
              }
              if (visualLines.length > 0) {
                visual = cleanMarkdownFormat(visualLines.join('\n'));
                console.log('âœ… æ‰¾åˆ°ç•«é¢æ„Ÿ:', visual.substring(0, 100) + '...');
              }
            }
            
            // æå–ç™¼ä½ˆæ–‡æ¡ˆ
            if (line.includes('ç™¼ä½ˆæ–‡æ¡ˆ') && line.includes('ï¼š')) {
              let copyLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.length > 0) {
                  copyLines.push(nextLine);
                }
              }
              if (copyLines.length > 0) {
                copy = cleanMarkdownFormat(copyLines.join('\n'));
                console.log('âœ… æ‰¾åˆ°ç™¼ä½ˆæ–‡æ¡ˆ:', copy.substring(0, 100) + '...');
              }
            }
          }
          
          // æ›´æ–°çµæœå€å¡Š
          if (title) {
            resultTitleEl.innerHTML = title;
            console.log('âœ… è¨­ç½®ä¸»é¡Œæ¨™é¡Œ');
          }
          if (script) {
            resultScriptEl.innerHTML = script;
            console.log('âœ… è¨­ç½®è…³æœ¬å…§å®¹');
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
            console.log('âœ… è¨­ç½®ç•«é¢æ„Ÿ');
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
            console.log('âœ… è¨­ç½®ç™¼ä½ˆæ–‡æ¡ˆ');
          }
          
          // é¡¯ç¤ºçµæœå€å¡Š
          resultsEl.style.display = 'block';
          console.log('âœ… çµæœå€å¡Šå·²é¡¯ç¤º');
          
          // å¦‚æœé‚„æ˜¯æ²’æœ‰å…§å®¹ï¼Œé¡¯ç¤ºåŸå§‹æ–‡æœ¬
          if (!title && !script && !visual && !copy) {
            console.log('âš ï¸ æ‰€æœ‰æå–éƒ½å¤±æ•—ï¼Œé¡¯ç¤ºåŸå§‹æ–‡æœ¬');
            resultTitleEl.innerHTML = 'åŸå§‹AIå›æ‡‰';
            resultScriptEl.innerHTML = aiText.substring(0, 500) + '...';
            resultVisualEl.innerHTML = 'è«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ';
            resultCopyEl.innerHTML = 'è§£æå¤±æ•—';
          }
        } else {
          console.log('âŒ æœªæ‰¾åˆ°AIå›æ‡‰');
        }
      };

      // å¿«é€ŸæŒ‰éˆ•åŠŸèƒ½å·²ç§»åˆ° DOMContentLoaded äº‹ä»¶ä¸­

      // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦è¦æ±‚ç”Ÿæˆè…³æœ¬
      function checkIfScriptRequest(aiText) {
        console.log('=== æª¢æŸ¥æ˜¯å¦ç‚ºè…³æœ¬ç”Ÿæˆè«‹æ±‚ ===');
        
        // æª¢æŸ¥AIå›æ‡‰ä¸­æ˜¯å¦åŒ…å«è…³æœ¬ç”Ÿæˆç›¸é—œçš„é—œéµè©
        const scriptRequestKeywords = [
          'çŸ­å½±éŸ³è…³æœ¬',
          'ç”Ÿæˆè…³æœ¬',
          'è…³æœ¬ç”Ÿæˆ',
          'è…³æœ¬å…§å®¹',
          'ä¸»é¡Œæ¨™é¡Œ',
          'ç•«é¢æ„Ÿ',
          'ç™¼ä½ˆæ–‡æ¡ˆ',
          'Hook',
          'Value',
          'CTA',
          'çŸ­å½±éŸ³',
          'è…³æœ¬',
          'Reels',
          'TikTok',
          'å°ç´…æ›¸'
        ];
        
        const hasScriptKeywords = scriptRequestKeywords.some(keyword => 
          aiText.toLowerCase().includes(keyword.toLowerCase())
        );
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å«è…³æœ¬çµæ§‹æ¨™è¨˜
        const hasScriptStructure = [
          /ä¸»é¡Œæ¨™é¡Œ[ï¼š:]/i,
          /è…³æœ¬å…§å®¹[ï¼š:]/i,
          /ç•«é¢æ„Ÿ[ï¼š:]/i,
          /ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]/i,
          /\d+\.\s*ä¸»é¡Œæ¨™é¡Œ/i,
          /\d+\.\s*è…³æœ¬å…§å®¹/i,
          /\d+\.\s*ç•«é¢æ„Ÿ/i,
          /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ/i,
          /Hook\s*\(\d+-\d+ç§’\)/i,
          /Value\s*\d+\s*\(\d+-\d+ç§’\)/i,
          /CTA\s*\(\d+-\d+ç§’\)/i
        ].some(pattern => pattern.test(aiText));
        
        const isScriptRequest = hasScriptKeywords || hasScriptStructure;
        
        console.log('åŒ…å«è…³æœ¬é—œéµè©:', hasScriptKeywords);
        console.log('åŒ…å«è…³æœ¬çµæ§‹:', hasScriptStructure);
        console.log('åˆ¤æ–·ç‚ºè…³æœ¬è«‹æ±‚:', isScriptRequest);
        
        return isScriptRequest;
      }

      function checkAndUpdateResults(aiText) {
        console.log('=== é–‹å§‹è§£æAIå›æ‡‰ ===');
        console.log('AIå›æ‡‰é•·åº¦:', aiText.length);
        console.log('AIå›æ‡‰å‰300å­—ç¬¦:', aiText.substring(0, 300));
        
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦è¦æ±‚ç”Ÿæˆè…³æœ¬ï¼ˆåªæœ‰é€™ç¨®æƒ…æ³æ‰é¡¯ç¤ºè…³æœ¬çµæœå€å¡Šï¼‰
        const isScriptRequest = checkIfScriptRequest(aiText);
        console.log('æ˜¯å¦ç‚ºè…³æœ¬ç”Ÿæˆè«‹æ±‚:', isScriptRequest);
        
        if (!isScriptRequest) {
          console.log('âŒ ä¸æ˜¯è…³æœ¬ç”Ÿæˆè«‹æ±‚ï¼Œä¸é¡¯ç¤ºè…³æœ¬çµæœå€å¡Š');
          return;
        }
        
        // æ›´ç²¾ç¢ºçš„è…³æœ¬å…§å®¹æª¢æ¸¬
        const isScriptContent = detectScriptContent(aiText);
        
        console.log('æ˜¯å¦ç‚ºè…³æœ¬å…§å®¹:', isScriptContent);
        
        if (isScriptContent) {
          // é¡¯ç¤ºçµæœå€å¡Š
          resultsEl.style.display = 'block';
          console.log('çµæœå€å¡Šå·²é¡¯ç¤ºï¼Œé–‹å§‹è§£æå…§å®¹...');
          
          // ç¢ºä¿DOMå…ƒç´ å­˜åœ¨
          if (!resultTitleEl || !resultScriptEl || !resultVisualEl || !resultCopyEl) {
            console.error('DOMå…ƒç´ ä¸å­˜åœ¨:', {
              resultTitleEl: !!resultTitleEl,
              resultScriptEl: !!resultScriptEl,
              resultVisualEl: !!resultVisualEl,
              resultCopyEl: !!resultCopyEl
            });
            return;
          }
          
          try {
            // ä½¿ç”¨æ›´éˆæ´»çš„è§£ææ–¹æ³•
            const sections = parseAIContent(aiText);
            
            // æ›´æ–°DOMå…ƒç´ 
            if (sections.title) {
              resultTitleEl.innerHTML = sections.title;
              console.log('âœ… ä¸»é¡Œæ¨™é¡Œå·²è¨­ç½®:', sections.title);
            }
            
            if (sections.script) {
              resultScriptEl.innerHTML = sections.script;
              console.log('âœ… è…³æœ¬å…§å®¹å·²è¨­ç½®:', sections.script.substring(0, 100) + '...');
            }
            
            if (sections.visual) {
              resultVisualEl.innerHTML = sections.visual;
              console.log('âœ… ç•«é¢æ„Ÿå·²è¨­ç½®:', sections.visual.substring(0, 100) + '...');
            }
            
            if (sections.copy) {
              resultCopyEl.innerHTML = sections.copy;
              console.log('âœ… ç™¼ä½ˆæ–‡æ¡ˆå·²è¨­ç½®:', sections.copy.substring(0, 100) + '...');
            }
            
            // å»¶é²æª¢æŸ¥å…§å®¹æ˜¯å¦æ­£ç¢ºè¨­ç½®
            setTimeout(() => {
              console.log('=== å»¶é²æª¢æŸ¥DOMå…§å®¹ ===');
              console.log('ä¸»é¡Œæ¨™é¡Œ:', resultTitleEl.innerHTML);
              console.log('è…³æœ¬å…§å®¹:', resultScriptEl.innerHTML.substring(0, 100) + '...');
              console.log('ç•«é¢æ„Ÿ:', resultVisualEl.innerHTML.substring(0, 100) + '...');
              console.log('ç™¼ä½ˆæ–‡æ¡ˆ:', resultCopyEl.innerHTML.substring(0, 100) + '...');
            }, 500);
            
          } catch (e) {
            console.error('è§£æçµæœæ™‚å‡ºéŒ¯:', e);
          }
        } else {
          console.log('æœªæª¢æ¸¬åˆ°è…³æœ¬å…§å®¹ï¼Œä¸é¡¯ç¤ºçµæœå€å¡Š');
        }
      }
      
      // æ–°å¢ï¼šç²¾ç¢ºçš„è…³æœ¬å…§å®¹æª¢æ¸¬å‡½æ•¸
      function detectScriptContent(aiText) {
        console.log('=== é–‹å§‹è…³æœ¬å…§å®¹æª¢æ¸¬ ===');
        console.log('æª¢æ¸¬æ–‡æœ¬é•·åº¦:', aiText.length);
        console.log('æª¢æ¸¬æ–‡æœ¬å‰200å­—ç¬¦:', aiText.substring(0, 200));
        
        // 1. æª¢æŸ¥æ˜¯å¦åŒ…å«è…³æœ¬ç›¸é—œçš„çµæ§‹æ¨™è¨˜ï¼ˆæ›´éˆæ´»çš„æª¢æ¸¬ï¼‰
        const structureMarkers = [
          /ä¸»é¡Œæ¨™é¡Œ[ï¼š:]/i,
          /è…³æœ¬å…§å®¹[ï¼š:]/i,
          /ç•«é¢æ„Ÿ[ï¼š:]/i,
          /ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]/i,
          /\d+\.\s*ä¸»é¡Œæ¨™é¡Œ/i,
          /\d+\.\s*è…³æœ¬å…§å®¹/i,
          /\d+\.\s*ç•«é¢æ„Ÿ/i,
          /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ/i,
          /Hook\s*\(\d+-\d+ç§’\)/i,
          /Value\s*\d+\s*\(\d+-\d+ç§’\)/i,
          /CTA\s*\(\d+-\d+ç§’\)/i
        ];
        
        const hasStructureMarkers = structureMarkers.some(pattern => pattern.test(aiText));
        console.log('æ˜¯å¦åŒ…å«è…³æœ¬çµæ§‹æ¨™è¨˜:', hasStructureMarkers);
        
        // 2. æª¢æŸ¥æ˜¯å¦åŒ…å«çŸ­å½±éŸ³è…³æœ¬çš„é—œéµå…ƒç´ 
        const scriptElements = [
          /Hook\s*\(\d+-\d+ç§’\)/i,
          /Value\s*\d+\s*\(\d+-\d+ç§’\)/i,
          /CTA\s*\(\d+-\d+ç§’\)/i,
          /ç•«é¢æ„Ÿ[ï¼š:]/i,
          /ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]/i,
          /\d+\.\s*ç•«é¢æ„Ÿ/i,
          /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ/i,
          /é¡é ­[ï¼š:]/i,
          /éŸ³æ•ˆ[ï¼š:]/i,
          /å­—å¹•[ï¼š:]/i,
          /å°è©[ï¼š:]/i
        ];
        
        const scriptElementCount = scriptElements.filter(pattern => pattern.test(aiText)).length;
        console.log('è…³æœ¬å…ƒç´ æ•¸é‡:', scriptElementCount);
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å«æ™‚é–“æ¨™è¨˜ï¼ˆHookã€Valueã€CTAæ ¼å¼ï¼‰
        const timeMarkersPatterns = [
          /\(\d+-\d+ç§’\)\s*Hook/i,
          /\(\d+-\d+ç§’\)\s*Value/i,
          /\(\d+-\d+ç§’\)\s*CTA/i,
          /Hook\s*\(\d+-\d+ç§’\)/i,
          /Value\s*\d+\s*\(\d+-\d+ç§’\)/i,
          /CTA\s*\(\d+-\d+ç§’\)/i
        ];
        const hasTimeMarkers = timeMarkersPatterns.some(pattern => pattern.test(aiText));
        console.log('æ˜¯å¦åŒ…å«æ™‚é–“æ¨™è¨˜:', hasTimeMarkers);
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å«çŸ­å½±éŸ³ç›¸é—œå…§å®¹
        const videoContent = [
          /ç•«é¢æ„Ÿ/i,
          /ç™¼ä½ˆæ–‡æ¡ˆ/i,
          /å°è©[ï¼š:]/i,
          /é¡é ­[ï¼š:]/i,
          /éŸ³æ•ˆ[ï¼š:]/i,
          /å­—å¹•[ï¼š:]/i
        ];
        const hasVideoContent = videoContent.some(pattern => pattern.test(aiText));
        console.log('æ˜¯å¦åŒ…å«çŸ­å½±éŸ³å…§å®¹:', hasVideoContent);
        
        // æ›´éˆæ´»çš„åˆ¤æ–·æ¢ä»¶
        const hasAnyScriptContent = hasStructureMarkers || scriptElementCount >= 3 || hasTimeMarkers || hasVideoContent;
        console.log('æ˜¯å¦æœ‰ä»»ä½•è…³æœ¬å…§å®¹:', hasAnyScriptContent);
        
        if (!hasAnyScriptContent) {
          console.log('âŒ æœªåŒ…å«è¶³å¤ çš„è…³æœ¬å…§å®¹æ¨™è¨˜ï¼Œä¸é¡¯ç¤ºçµæœå€å¡Š');
          console.log('æª¢æ¸¬çµæœè©³æƒ…:', {
            hasStructureMarkers,
            scriptElementCount,
            hasTimeMarkers,
            hasVideoContent
          });
          return false;
        }
        
        // 2. æª¢æŸ¥æ˜¯å¦åŒ…å«è…³æœ¬ç›¸é—œçš„é—œéµè©çµ„åˆ
        const scriptKeywords = ['ä¸»é¡Œæ¨™é¡Œ', 'è…³æœ¬å…§å®¹', 'ç•«é¢æ„Ÿ', 'ç™¼ä½ˆæ–‡æ¡ˆ', 'Hook', 'Value', 'CTA'];
        const keywordCount = scriptKeywords.filter(keyword => aiText.includes(keyword)).length;
        console.log('è…³æœ¬é—œéµè©æ•¸é‡:', keywordCount);
        
        // 3. æª¢æŸ¥æ˜¯å¦åŒ…å«çŸ­å½±éŸ³ç›¸é—œçš„å…§å®¹æŒ‡ç¤ºè©
        const videoIndicators = [
          'çŸ­å½±éŸ³è…³æœ¬',
          'çŸ­å½±éŸ³è…³æœ¬çµæœ',
          'ç”Ÿæˆè…³æœ¬',
          'è…³æœ¬ç”Ÿæˆ',
          'Reels',
          'TikTok',
          'å°ç´…æ›¸',
          'ç§’è…³æœ¬',
          'å½±éŸ³å…§å®¹',
          'çŸ­å½±éŸ³',
          'è…³æœ¬'
        ];
        const hasVideoIndicators = videoIndicators.some(indicator => aiText.includes(indicator));
        console.log('æ˜¯å¦åŒ…å«çŸ­å½±éŸ³æŒ‡ç¤ºè©:', hasVideoIndicators);
        
        // 4. æª¢æŸ¥æ–‡æœ¬é•·åº¦ï¼ˆè…³æœ¬å…§å®¹é€šå¸¸è¼ƒé•·ï¼‰
        const isLongEnough = aiText.length > 300; // æé«˜é•·åº¦è¦æ±‚
        console.log('æ–‡æœ¬æ˜¯å¦è¶³å¤ é•·:', isLongEnough);
        
        // 5. æª¢æŸ¥æ˜¯å¦åŒ…å«å¤šå€‹æ®µè½ï¼ˆè…³æœ¬é€šå¸¸æœ‰å¤šå€‹éƒ¨åˆ†ï¼‰
        const paragraphCount = aiText.split('\n\n').filter(p => p.trim().length > 0).length;
        const hasMultipleParagraphs = paragraphCount >= 4; // æé«˜æ®µè½è¦æ±‚
        console.log('æ®µè½æ•¸é‡:', paragraphCount, 'æ˜¯å¦å¤šæ®µè½:', hasMultipleParagraphs);
        
        // 6. æ’é™¤æ˜é¡¯çš„éè…³æœ¬å…§å®¹
        const nonScriptIndicators = [
          'ä½ å¥½',
          'è¬è¬',
          'ä¸å®¢æ°£',
          'è«‹å•',
          'ä¸å¥½æ„æ€',
          'æŠ±æ­‰',
          'æˆ‘ä¾†å¹«ä½ ',
          'è®“æˆ‘ç‚ºä½ ',
          'å¾ˆé«˜èˆˆç‚ºæ‚¨',
          'æ­¡è¿',
          'å†è¦‹',
          'æ‹œæ‹œ',
          'æœ‰ä»€éº¼å¯ä»¥å¹«ä½ ',
          'éœ€è¦ä»€éº¼å¹«åŠ©',
          'è«‹å‘Šè¨´æˆ‘',
          'è«‹è¼¸å…¥',
          'è«‹é¸æ“‡',
          'è«‹é»æ“Š',
          'è«‹æŸ¥çœ‹',
          'è«‹æ³¨æ„',
          'æé†’',
          'å»ºè­°',
          'æ¨è–¦',
          'ä»‹ç´¹',
          'èªªæ˜',
          'è§£é‡‹',
          'å›ç­”',
          'å›è¦†',
          'å›æ‡‰'
        ];
        const hasNonScriptIndicators = nonScriptIndicators.some(indicator => 
          aiText.toLowerCase().includes(indicator.toLowerCase())
        );
        console.log('æ˜¯å¦åŒ…å«éè…³æœ¬æŒ‡ç¤ºè©:', hasNonScriptIndicators);
        
        // 7. æª¢æŸ¥æ˜¯å¦åŒ…å«å®Œæ•´çš„è…³æœ¬çµæ§‹ï¼ˆè‡³å°‘åŒ…å«3å€‹å€å¡Šï¼‰
        const requiredStructureMarkers = [
          /ä¸»é¡Œæ¨™é¡Œ[ï¼š:]/i,
          /è…³æœ¬å…§å®¹[ï¼š:]/i,
          /ç•«é¢æ„Ÿ[ï¼š:]/i,
          /ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]/i,
          /\d+\.\s*ä¸»é¡Œæ¨™é¡Œ/i,
          /\d+\.\s*è…³æœ¬å…§å®¹/i,
          /\d+\.\s*ç•«é¢æ„Ÿ/i,
          /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ/i
        ];
        const structureCount = requiredStructureMarkers.filter(pattern => pattern.test(aiText)).length;
        const hasCompleteStructure = structureCount >= 3;
        console.log('çµæ§‹å€å¡Šæ•¸é‡:', structureCount, 'æ˜¯å¦å®Œæ•´çµæ§‹:', hasCompleteStructure);
        
        // 8. æª¢æŸ¥æ˜¯å¦åŒ…å«æ™‚é–“æ¨™è¨˜ï¼ˆè…³æœ¬é€šå¸¸æœ‰æ™‚é–“æ¨™è¨˜ï¼‰
        const timeMarkersGeneral = [
          /\d+[-\s]*\d*\s*ç§’/i,
          /\d+[-\s]*\d*\s*åˆ†é˜/i,
          /0-\d+\s*ç§’/i,
          /\d+-\d+\s*ç§’/i
        ];
        const hasTimeMarkersGeneral = timeMarkersGeneral.some(pattern => pattern.test(aiText));
        console.log('æ˜¯å¦åŒ…å«ä¸€èˆ¬æ™‚é–“æ¨™è¨˜:', hasTimeMarkersGeneral);
        
        // ç¶œåˆåˆ¤æ–·
        const score = {
          structureMarkers: hasStructureMarkers ? 3 : 0,
          scriptElements: Math.min(scriptElementCount, 4), // è…³æœ¬å…ƒç´ æ•¸é‡
          keywordCount: Math.min(keywordCount, 3),
          videoIndicators: hasVideoIndicators ? 2 : 0,
          length: isLongEnough ? 1 : 0,
          paragraphs: hasMultipleParagraphs ? 1 : 0,
          completeStructure: hasCompleteStructure ? 2 : 0,
          timeMarkers: hasTimeMarkers ? 1 : 0,
          timeMarkersGeneral: hasTimeMarkersGeneral ? 1 : 0,
          videoContent: hasVideoContent ? 1 : 0,
          nonScript: hasNonScriptIndicators ? -5 : 0 // é«˜æ‡²ç½°
        };
        
        const totalScore = Object.values(score).reduce((sum, val) => sum + val, 0);
        
        console.log('è…³æœ¬æª¢æ¸¬è©•åˆ†:', score);
        console.log('ç¸½åˆ†:', totalScore);
        
        // æ›´éˆæ´»çš„åˆ¤æ–·æ¢ä»¶
        const isScriptContent = totalScore >= 4 && (hasStructureMarkers || scriptElementCount >= 3);
        
        // å¦‚æœåŒ…å«éè…³æœ¬æŒ‡ç¤ºè©ï¼Œé™ä½è©•åˆ†ä½†ä¸å®Œå…¨æ‹’çµ•
        if (hasNonScriptIndicators) {
          console.log('âš ï¸ åŒ…å«éè…³æœ¬æŒ‡ç¤ºè©ï¼Œä½†å…§å®¹çµæ§‹å®Œæ•´ï¼Œä»è¦–ç‚ºè…³æœ¬å…§å®¹');
        }
        
        console.log('æ˜¯å¦ç‚ºè…³æœ¬å…§å®¹:', isScriptContent);
        console.log('=== è…³æœ¬å…§å®¹æª¢æ¸¬çµæŸ ===');
        
        return isScriptContent;
      }
      
      // æ–°å¢ï¼šæ›´ç²¾ç¢ºçš„AIå…§å®¹è§£æå‡½æ•¸
      function parseAIContent(aiText) {
        const sections = {
          title: '',
          script: '',
          visual: '',
          copy: ''
        };
        
        console.log('é–‹å§‹è§£æAIå…§å®¹...');
        console.log('åŸå§‹AIæ–‡æœ¬é•·åº¦:', aiText.length);
        console.log('åŸå§‹AIæ–‡æœ¬å‰500å­—ç¬¦:', aiText.substring(0, 500));
        
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ç²¾ç¢ºæå–æ¯å€‹å€å¡Šçš„å…§å®¹
        try {
          // é€šç”¨å…§å®¹æå–ç­–ç•¥ - æ‡‰å°æ‰€æœ‰å¯èƒ½çš„AIæ ¼å¼è®ŠåŒ–
          let scriptContent = aiText;
          let extractionMethod = 'full';
          
          // ç­–ç•¥1: æª¢æŸ¥æ˜¯å¦æœ‰ --- åˆ†éš”ç¬¦
          const dashSections = aiText.split(/---/);
          if (dashSections.length > 1) {
            const contentSections = dashSections.slice(1);
            scriptContent = contentSections.join('---').trim();
            extractionMethod = 'dash-separated';
            console.log('âœ… ä½¿ç”¨ --- åˆ†éš”ç­–ç•¥');
          }
          // ç­–ç•¥2: æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç¢ºçš„çµæ§‹æ¨™è¨˜
          else if (aiText.includes('ä¸»é¡Œæ¨™é¡Œ') || aiText.includes('è…³æœ¬å…§å®¹') || aiText.includes('ç•«é¢æ„Ÿ') || aiText.includes('ç™¼ä½ˆæ–‡æ¡ˆ')) {
            scriptContent = aiText;
            extractionMethod = 'structured';
            console.log('âœ… ä½¿ç”¨çµæ§‹åŒ–æ¨™è¨˜ç­–ç•¥');
          }
          // ç­–ç•¥3: æª¢æŸ¥æ˜¯å¦æœ‰ Hook/Value/CTA çµæ§‹
          else if (aiText.includes('Hook') || aiText.includes('Value') || aiText.includes('CTA')) {
            scriptContent = aiText;
            extractionMethod = 'hook-value-cta';
            console.log('âœ… ä½¿ç”¨ Hook/Value/CTA ç­–ç•¥');
          }
          // ç­–ç•¥4: æª¢æŸ¥æ˜¯å¦æœ‰æ™‚é–“æ¨™è¨˜
          else if (aiText.match(/\d+-\d+ç§’/) || aiText.match(/\d+ç§’/)) {
            scriptContent = aiText;
            extractionMethod = 'time-marked';
            console.log('âœ… ä½¿ç”¨æ™‚é–“æ¨™è¨˜ç­–ç•¥');
          }
          // ç­–ç•¥5: é»˜èªä½¿ç”¨å®Œæ•´å…§å®¹
          else {
            scriptContent = aiText;
            extractionMethod = 'full';
            console.log('âœ… ä½¿ç”¨å®Œæ•´å…§å®¹ç­–ç•¥');
          }
          
          console.log('æå–æ–¹æ³•:', extractionMethod);
            console.log('è…³æœ¬å…§å®¹é•·åº¦:', scriptContent.length);
            console.log('è…³æœ¬å…§å®¹å‰200å­—ç¬¦:', scriptContent.substring(0, 200));
          
          // è¶…ç´šæ™ºèƒ½ä¸»é¡Œæ¨™é¡Œæå–å™¨ - æ‡‰å°æ‰€æœ‰å¯èƒ½çš„AIæ ¼å¼
          function extractTitle(scriptContent) {
          const titlePatterns = [
              // 1. è¡¨æƒ…ç¬¦è™Ÿ + æ¨™é¡Œæ ¼å¼
              /[ğŸ¬ğŸ“ğŸ¯âœ¨ğŸ”¥ğŸ“Œ]\s*ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /[ğŸ¬ğŸ“ğŸ¯âœ¨ğŸ”¥ğŸ“Œ]\s*ä¸»é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /[ğŸ¬ğŸ“ğŸ¯âœ¨ğŸ”¥ğŸ“Œ]\s*æ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              
              // 2. æ¨™æº–æ¨™é¡Œæ ¼å¼
            /ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /ä¸»é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /æ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              
              // 3. ç·¨è™Ÿ + æ¨™é¡Œæ ¼å¼
            /\d+\.\s*ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /\d+\.\s*ä¸»é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /\d+\.\s*æ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              
              // 4. ç²—é«”æ¨™é¡Œæ ¼å¼
            /\*\*ä¸»é¡Œæ¨™é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
            /\*\*ä¸»é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
            /\*\*æ¨™é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
              
              // 5. æ··åˆæ ¼å¼
            /\d+\.\s*\*\*ä¸»é¡Œæ¨™é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*ä¸»é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*æ¨™é¡Œ\*\*[ï¼š:]\s*([^\n]+)/i,
              
              // 6. Markdown æ¨™é¡Œæ ¼å¼
            /###\s*ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /###\s*ä¸»é¡Œ[ï¼š:]\s*([^\n]+)/i,
            /###\s*æ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /##\s*ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /##\s*ä¸»é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /##\s*æ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              
              // 7. è¡Œé¦–æ¨™é¡Œæ ¼å¼ï¼ˆ--- åˆ†éš”å¾Œï¼‰
              /^ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /^æ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i,
              /^ä¸»é¡Œ[ï¼š:]\s*([^\n]+)/i,
              
              // 8. AI ç‹¡çŒ¾æ ¼å¼ï¼šç›´æ¥çµ¦æ¨™é¡Œï¼Œæ²’æœ‰å‰ç¶´
            /^ä½ çš„.*ä¾†äº†.*å°ç´…æ›¸.*éƒ½åœ¨.*ç”¨çš„.*AIæ™ºèƒ½é«”.*$/i,
            /^.*AIæ™ºèƒ½é«”.*ä¾†äº†.*$/i,
            /^.*å°ç´…æ›¸.*åšä¸».*éƒ½åœ¨.*ç”¨çš„.*$/i,
              /^.*æ•ˆç‡.*çˆ†æ£š.*$/i,
              /^.*AI.*æ™ºèƒ½é«”.*é€™æ¨£ç©.*$/i,
              
              // 9. å¼•è™Ÿæ¨™é¡Œæ ¼å¼
              /ã€Œ([^ã€]+)ã€/,
              /"([^"]+)"/,
              /'([^']+)'/,
              
              // 10. ç‰¹æ®Šæ¨™é¡Œæ¨¡å¼
              /^.*ä½ é‚„åœ¨.*æ–¹æ³•.*AIæ™ºèƒ½é«”.*æ•ˆç‡.*çˆ†æ£š.*$/i,
              /^.*AIæ™ºèƒ½é«”.*æ•ˆç‡.*ç¿»å€.*$/i,
              /^.*è¶…ç´š.*å­¸ä¼´.*$/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = scriptContent.match(pattern);
            if (match) {
              // è™•ç†æœ‰æ•ç²çµ„çš„æƒ…æ³
              if (match[1] && match[1].trim()) {
                  const title = cleanMarkdownFormat(match[1].trim());
                  if (title.length > 5 && title.length < 100) { // åˆç†çš„æ¨™é¡Œé•·åº¦
                    console.log('âœ… æ‰¾åˆ°ä¸»é¡Œæ¨™é¡Œ(æœ‰å‰ç¶´):', title);
                    return title;
                  }
              }
              // è™•ç†æ²’æœ‰å‰ç¶´ï¼Œç›´æ¥åŒ¹é…æ•´è¡Œçš„æƒ…æ³
              else if (match[0] && match[0].trim()) {
                  const title = cleanMarkdownFormat(match[0].trim());
                  if (title.length > 5 && title.length < 100) {
                    console.log('âœ… æ‰¾åˆ°ä¸»é¡Œæ¨™é¡Œ(ç„¡å‰ç¶´):', title);
                    return title;
                  }
                }
              }
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ˜ç¢ºçš„æ¨™é¡Œï¼Œå˜—è©¦æå–ç¬¬ä¸€è¡Œä½œç‚ºæ¨™é¡Œ
            const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
            for (const line of lines) {
              const trimmedLine = line.trim();
              // è·³éæ˜é¡¯ä¸æ˜¯æ¨™é¡Œçš„è¡Œ
              if (trimmedLine.match(/^(Hook|Value|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|\d+\.|\(|å°è©|é¡é ­|éŸ³æ•ˆ|å­—å¹•|ä¸»é¡Œå»ºè­°|ç›®æ¨™|åˆ‡å…¥é»|å…§å®¹æ–¹å‘|å¥½çš„|æ²’å•é¡Œ|è®“æˆ‘)/i)) {
                continue;
              }
              // æª¢æŸ¥æ˜¯å¦ç‚ºåˆç†çš„æ¨™é¡Œ
              if (trimmedLine.length > 5 && trimmedLine.length < 100 && !trimmedLine.includes('ï¼š') && !trimmedLine.includes(':')) {
                console.log('ä½¿ç”¨ç¬¬ä¸€è¡Œä½œç‚ºä¸»é¡Œæ¨™é¡Œ:', trimmedLine);
                return cleanMarkdownFormat(trimmedLine);
              }
            }
            
            return '';
          }
          
          // æå–ä¸»é¡Œæ¨™é¡Œ
          sections.title = extractTitle(scriptContent);
          
          // è¶…ç´šæ™ºèƒ½è…³æœ¬å…§å®¹æå–å™¨ - æ‡‰å°æ‰€æœ‰å¯èƒ½çš„AIæ ¼å¼
          function extractScript(scriptContent) {
          const scriptPatterns = [
              // 1. æ¨™æº–è…³æœ¬å…§å®¹æ ¼å¼
            /è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /è…³æœ¬[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 2. è¡¨æƒ…ç¬¦è™Ÿ + è…³æœ¬å…§å®¹æ ¼å¼
              /[ğŸ“ğŸ¬ğŸ“œâœ¨ğŸ”¥]\s*è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /[ğŸ“ğŸ¬ğŸ“œâœ¨ğŸ”¥]\s*è…³æœ¬[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 3. ç·¨è™Ÿ + è…³æœ¬å…§å®¹æ ¼å¼
            /\d+\.\s*è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç•«é¢æ„Ÿ|\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*è…³æœ¬[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç•«é¢æ„Ÿ|\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 4. ç²—é«”è…³æœ¬å…§å®¹æ ¼å¼
            /\*\*è…³æœ¬å…§å®¹\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\*\*è…³æœ¬\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 5. æ··åˆæ ¼å¼
            /\d+\.\s*\*\*è…³æœ¬å…§å®¹\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç•«é¢æ„Ÿ|\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*\*\*è…³æœ¬\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç•«é¢æ„Ÿ|\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 6. Markdown æ¨™é¡Œæ ¼å¼
              /###\s*è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:###\s*ç•«é¢æ„Ÿ|###\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /###\s*è…³æœ¬[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:###\s*ç•«é¢æ„Ÿ|###\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /##\s*è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:##\s*ç•«é¢æ„Ÿ|##\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /##\s*è…³æœ¬[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:##\s*ç•«é¢æ„Ÿ|##\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 7. è¡Œé¦–è…³æœ¬å…§å®¹æ ¼å¼ï¼ˆ--- åˆ†éš”å¾Œï¼‰
            /^è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /^è…³æœ¬[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 8. Hook/Value/CTA çµæ§‹æ ¼å¼
              /Hook\s*\(\d+-\d+ç§’\)[\s\S]*?(?=ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /\(\d+-\d+ç§’\)\s*Hook[\s\S]*?(?=ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /Hook\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /Hook\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value\s*\d+|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              
              // 9. å°è©æ ¼å¼
              /å°è©[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /å°è©\s*\(\d+-\d+ç§’\)[\s\S]*?(?=ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              
              // 10. ç‰¹æ®Šè…³æœ¬æ¨¡å¼
              /^.*ä½ é‚„åœ¨.*æ‰‹å‹•.*å ±å‘Š.*å¯«æ–‡æ¡ˆ.*è½ä¼.*è¶…ç´šåŠ©ç†.*AIæ™ºèƒ½é«”.*$/i,
              /^.*å®ƒä¸åªæ˜¯.*ç¨‹å¼.*çœŸäºº.*æ€è€ƒ.*å­¸ç¿’.*$/i,
              /^.*æƒ³åƒä¸€ä¸‹.*å°ˆå±¬åœ˜éšŠ.*24å°æ™‚.*å¾…å‘½.*$/i,
              /^.*é‡é»æ˜¯.*è¶Šä¾†è¶Šè°æ˜.*ä¸æ–·é€²åŒ–.*$/i,
              /^.*æƒ³çŸ¥é“.*æ€éº¼é–‹å§‹.*AIæ™ºèƒ½é«”.*$/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = scriptContent.match(pattern);
              if (match) {
                let scriptText = '';
                if (match[1] && match[1].trim()) {
                  scriptText = match[1].trim();
                } else if (match[0] && match[0].trim()) {
                  scriptText = match[0].trim();
                }
                
                if (scriptText && scriptText.length > 10) {
                  console.log('âœ… æ‰¾åˆ°è…³æœ¬å…§å®¹:', scriptText.substring(0, 100) + '...');
                  return cleanMarkdownFormat(scriptText);
                }
            }
          }
          
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ˜ç¢ºçš„è…³æœ¬å…§å®¹æ¨™è¨˜ï¼Œå˜—è©¦æå– Hookã€Valueã€CTA éƒ¨åˆ†
            console.log('å˜—è©¦æå– Hook/Value/CTA å…§å®¹...');
            
            // æ”¯æ´å¤šç¨®æ™‚é–“æ¨™è¨˜æ ¼å¼
            const hookPatterns = [
              /Hook\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /\(\d+-\d+ç§’\)\s*Hook[\s\S]*?(?=Value|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /Hook\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /Hook\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value\s*\d+|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i
            ];
            const valuePatterns = [
              /Value\s*\d+\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /\(\d+-\d+ç§’\)\s*Value\s*\d+[\s\S]*?(?=Value|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /Value\s*\(\d+-\d+ç§’\)[\s\S]*?(?=Value|CTA|ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i
            ];
            const ctaPatterns = [
              /CTA\s*\(\d+-\d+ç§’\)[\s\S]*?(?=ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i,
              /\(\d+-\d+ç§’\)\s*CTA[\s\S]*?(?=ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i
            ];
            
            let extractedScriptContent = '';
            
            // æå– Hook
            for (const pattern of hookPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                console.log('æ‰¾åˆ° Hook:', match[0].substring(0, 100) + '...');
                extractedScriptContent += match[0] + '\n\n';
                break;
              }
            }
            
            // æå– Value
            for (const pattern of valuePatterns) {
              const matches = scriptContent.match(new RegExp(pattern.source, 'gi'));
              if (matches) {
                console.log('æ‰¾åˆ° Value æ•¸é‡:', matches.length);
                extractedScriptContent += matches.join('\n\n');
                break;
              }
            }
            
            // æå– CTA
            for (const pattern of ctaPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                console.log('æ‰¾åˆ° CTA:', match[0].substring(0, 100) + '...');
                extractedScriptContent += '\n\n' + match[0];
                break;
              }
            }
            
            if (extractedScriptContent.trim()) {
              console.log('ä½¿ç”¨ Hook/Value/CTA ä½œç‚ºè…³æœ¬å…§å®¹:', extractedScriptContent.substring(0, 100) + '...');
              return cleanMarkdownFormat(extractedScriptContent.trim());
            }
            
            return '';
          }
          
          // æå–è…³æœ¬å…§å®¹
          sections.script = extractScript(scriptContent);
          
          // è¶…ç´šæ™ºèƒ½ç•«é¢æ„Ÿæå–å™¨ - æ‡‰å°æ‰€æœ‰å¯èƒ½çš„AIæ ¼å¼
          function extractVisual(scriptContent) {
          const visualPatterns = [
              // 1. æ¨™æº–ç•«é¢æ„Ÿæ ¼å¼
            /ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /ç•«é¢[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 2. è¡¨æƒ…ç¬¦è™Ÿ + ç•«é¢æ„Ÿæ ¼å¼
              /[ğŸ¬ğŸï¸ğŸ“¹âœ¨ğŸ”¥]\s*ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /[ğŸ¬ğŸï¸ğŸ“¹âœ¨ğŸ”¥]\s*ç•«é¢[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 3. ç·¨è™Ÿ + ç•«é¢æ„Ÿæ ¼å¼
            /\d+\.\s*ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*ç•«é¢[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              // æ–°å¢ï¼šç·¨è™Ÿ + æ‹¬è™Ÿæ ¼å¼
              /\d+\.\s*ç•«é¢æ„Ÿ\s*\([^)]*\)[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /\d+\.\s*ç•«é¢\s*\([^)]*\)[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 4. ç²—é«”ç•«é¢æ„Ÿæ ¼å¼
            /\*\*ç•«é¢æ„Ÿ\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\*\*ç•«é¢\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 5. æ··åˆæ ¼å¼
            /\d+\.\s*\*\*ç•«é¢æ„Ÿ\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /\d+\.\s*\*\*ç•«é¢\*\*[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 6. Markdown æ¨™é¡Œæ ¼å¼
            /###\s*ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:###\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
            /###\s*ç•«é¢[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:###\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /##\s*ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:##\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /##\s*ç•«é¢[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:##\s*ç™¼ä½ˆæ–‡æ¡ˆ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 7. è¡Œé¦–ç•«é¢æ„Ÿæ ¼å¼ï¼ˆ--- åˆ†éš”å¾Œï¼‰
            /^ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              /^ç•«é¢[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i,
              
              // 8. ç‰¹æ®Šç•«é¢æ„Ÿæ¨¡å¼
              /^.*é–‹å ´.*Hook.*é¡é ­.*ç‰¹å¯«.*$/i,
              /^.*æ ¸å¿ƒåƒ¹å€¼.*é¡é ­.*ä¸­æ™¯.*$/i,
              /^.*è¡Œå‹•å‘¼ç±².*é¡é ­.*æŒ‡å‘.*$/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // æª¢æŸ¥æ˜¯å¦ç‚ºã€Œå°šæœªç”Ÿæˆã€
              if (match[1].trim() === 'å°šæœªç”Ÿæˆ' || match[1].trim().includes('å°šæœªç”Ÿæˆ')) {
                console.log('âš ï¸ ç•«é¢æ„Ÿæ¨™è¨˜ç‚ºã€Œå°šæœªç”Ÿæˆã€');
                  return 'AI æœªç”Ÿæˆç•«é¢æ„Ÿå…§å®¹';
              } else {
                  const visual = cleanMarkdownFormat(match[1].trim());
                  console.log('âœ… æ‰¾åˆ°ç•«é¢æ„Ÿ:', visual.substring(0, 100) + '...');
                  return visual;
                }
              }
            }
            
            return '';
          }
          
          // æå–ç•«é¢æ„Ÿ
          sections.visual = extractVisual(scriptContent);
          
          // è¶…ç´šæ™ºèƒ½ç™¼ä½ˆæ–‡æ¡ˆæå–å™¨ - æ‡‰å°æ‰€æœ‰å¯èƒ½çš„AIæ ¼å¼
          function extractCopy(scriptContent) {
          const copyPatterns = [
              // 1. æ¨™æº–ç™¼ä½ˆæ–‡æ¡ˆæ ¼å¼
            /ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
            /æ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 2. è¡¨æƒ…ç¬¦è™Ÿ + ç™¼ä½ˆæ–‡æ¡ˆæ ¼å¼
              /[ğŸ“±ğŸ“„ğŸ“âœ¨ğŸ”¥]\s*ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              /[ğŸ“±ğŸ“„ğŸ“âœ¨ğŸ”¥]\s*æ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 3. ç·¨è™Ÿ + ç™¼ä½ˆæ–‡æ¡ˆæ ¼å¼
            /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
            /\d+\.\s*æ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              // æ–°å¢ï¼šç·¨è™Ÿ + æ‹¬è™Ÿæ ¼å¼
              /\d+\.\s*ç™¼ä½ˆæ–‡æ¡ˆ\s*\([^)]*\)[ï¼š:]\s*([\s\S]*?)$/i,
              /\d+\.\s*æ–‡æ¡ˆ\s*\([^)]*\)[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 4. ç²—é«”ç™¼ä½ˆæ–‡æ¡ˆæ ¼å¼
            /\*\*ç™¼ä½ˆæ–‡æ¡ˆ\*\*[ï¼š:]\s*([\s\S]*?)$/i,
            /\*\*æ–‡æ¡ˆ\*\*[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 5. æ··åˆæ ¼å¼
            /\d+\.\s*\*\*ç™¼ä½ˆæ–‡æ¡ˆ\*\*[ï¼š:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*æ–‡æ¡ˆ\*\*[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 6. Markdown æ¨™é¡Œæ ¼å¼
            /###\s*ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
            /###\s*æ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              /##\s*ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              /##\s*æ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 7. è¡Œé¦–ç™¼ä½ˆæ–‡æ¡ˆæ ¼å¼ï¼ˆ--- åˆ†éš”å¾Œï¼‰
            /^ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              /^æ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i,
              
              // 8. ç‰¹æ®Šç™¼ä½ˆæ–‡æ¡ˆæ¨¡å¼
              /^.*é‚„åœ¨.*ç¹ç‘£.*å·¥ä½œ.*AIæ™ºèƒ½é«”.*æ•‘æ˜Ÿ.*$/i,
              /^.*è‡ªå‹•åŒ–.*æå‡æ•ˆç‡.*å®¢è£½åŒ–.*$/i,
              /^.*æœªä¾†è¶¨å‹¢.*é»æ“Š.*ä¸»é .*é€£çµ.*$/i,
              /^.*å…è²».*é ˜å–.*AI.*å…¥é–€.*æŒ‡å—.*$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // æª¢æŸ¥æ˜¯å¦ç‚ºã€Œå°šæœªç”Ÿæˆã€
              if (match[1].trim() === 'å°šæœªç”Ÿæˆ' || match[1].trim().includes('å°šæœªç”Ÿæˆ')) {
                console.log('âš ï¸ ç™¼ä½ˆæ–‡æ¡ˆæ¨™è¨˜ç‚ºã€Œå°šæœªç”Ÿæˆã€');
                  return 'AI æœªç”Ÿæˆç™¼ä½ˆæ–‡æ¡ˆå…§å®¹';
              } else {
                  const copy = cleanMarkdownFormat(match[1].trim());
                  console.log('âœ… æ‰¾åˆ°ç™¼ä½ˆæ–‡æ¡ˆ:', copy.substring(0, 100) + '...');
                  return copy;
                }
              }
            }
            
            return '';
          }
          
          // æå–ç™¼ä½ˆæ–‡æ¡ˆ
          sections.copy = extractCopy(scriptContent);
          
          // æœ€çµ‚èª¿è©¦è¼¸å‡º
          console.log('=== è¶…ç´šæ™ºèƒ½è§£æçµæœ ===');
          console.log('æå–æ–¹æ³•:', extractionMethod);
          console.log('ä¸»é¡Œæ¨™é¡Œ:', sections.title ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
          console.log('è…³æœ¬å…§å®¹:', sections.script ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
          console.log('ç•«é¢æ„Ÿ:', sections.visual ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
          console.log('ç™¼ä½ˆæ–‡æ¡ˆ:', sections.copy ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
          
          // å¦‚æœä»»ä½•æ¬„ä½ç‚ºç©ºï¼Œå˜—è©¦æœ€å¾Œçš„å¼·åˆ¶æå–
          if (!sections.title || !sections.script || !sections.visual || !sections.copy) {
            console.log('ğŸ”„ å•Ÿå‹•æœ€å¾Œçš„å¼·åˆ¶æå–æ©Ÿåˆ¶...');
            
            // å¼·åˆ¶æå–ä¸»é¡Œæ¨™é¡Œ
            if (!sections.title) {
              const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
              for (const line of lines) {
                if (line.length > 10 && line.length < 100 && !line.includes('ï¼š') && !line.includes(':')) {
                  sections.title = cleanMarkdownFormat(line.trim());
                    console.log('å¼·åˆ¶æå–ä¸»é¡Œæ¨™é¡Œ:', sections.title);
                  break;
                }
              }
            }
            
            // å¼·åˆ¶æå–è…³æœ¬å…§å®¹
            if (!sections.script) {
              const scriptMatch = scriptContent.match(/(?:Hook|Value|CTA)[\s\S]*?(?=ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$)/i);
              if (scriptMatch) {
                sections.script = cleanMarkdownFormat(scriptMatch[0].trim());
                console.log('å¼·åˆ¶æå–è…³æœ¬å…§å®¹:', sections.script.substring(0, 100) + '...');
              }
            }
            
            // å¼·åˆ¶æå–ç•«é¢æ„Ÿ
            if (!sections.visual) {
              const visualMatch = scriptContent.match(/ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=ç™¼ä½ˆæ–‡æ¡ˆ|$)/i);
              if (visualMatch && visualMatch[1]) {
                if (visualMatch[1].trim() === 'å°šæœªç”Ÿæˆ' || visualMatch[1].trim().includes('å°šæœªç”Ÿæˆ')) {
                  sections.visual = 'AI æœªç”Ÿæˆç•«é¢æ„Ÿå…§å®¹';
                } else {
                  sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
                }
                  console.log('å¼·åˆ¶æå–ç•«é¢æ„Ÿ:', sections.visual.substring(0, 100) + '...');
              }
            }
            
            // å¼·åˆ¶æå–ç™¼ä½ˆæ–‡æ¡ˆ
            if (!sections.copy) {
              const copyMatch = scriptContent.match(/ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i);
              if (copyMatch && copyMatch[1]) {
                if (copyMatch[1].trim() === 'å°šæœªç”Ÿæˆ' || copyMatch[1].trim().includes('å°šæœªç”Ÿæˆ')) {
                  sections.copy = 'AI æœªç”Ÿæˆç™¼ä½ˆæ–‡æ¡ˆå…§å®¹';
                } else {
                  sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
                }
                  console.log('å¼·åˆ¶æå–ç™¼ä½ˆæ–‡æ¡ˆ:', sections.copy.substring(0, 100) + '...');
              }
            }
          }
          
        } catch (error) {
          console.error('è§£æAIå…§å®¹æ™‚å‡ºéŒ¯:', error);
        }
        
        console.log('=== æœ€çµ‚è§£æçµæœ ===');
        console.log('ä¸»é¡Œæ¨™é¡Œ:', sections.title ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
        console.log('è…³æœ¬å…§å®¹:', sections.script ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
        console.log('ç•«é¢æ„Ÿ:', sections.visual ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
        console.log('ç™¼ä½ˆæ–‡æ¡ˆ:', sections.copy ? 'âœ… æœ‰å…§å®¹' : 'âŒ ç„¡å…§å®¹');
        
        // å¦‚æœæ‰€æœ‰å…§å®¹éƒ½ç‚ºç©ºï¼Œå˜—è©¦å¼·åˆ¶æå–
        if (!sections.title && !sections.script && !sections.visual && !sections.copy) {
          console.log('âš ï¸ æ‰€æœ‰å…§å®¹éƒ½ç‚ºç©ºï¼Œå˜—è©¦å¼·åˆ¶æå–...');
          
          // å¼·åˆ¶æå–ä¸»é¡Œæ¨™é¡Œ
          const titleMatch = aiText.match(/ä¸»é¡Œæ¨™é¡Œ[ï¼š:]\s*([^\n]+)/i);
          if (titleMatch && titleMatch[1]) {
            sections.title = cleanMarkdownFormat(titleMatch[1].trim());
            console.log('å¼·åˆ¶æå–ä¸»é¡Œæ¨™é¡Œ:', sections.title);
          }
          
          // å¼·åˆ¶æå–è…³æœ¬å…§å®¹
          const scriptMatch = aiText.match(/è…³æœ¬å…§å®¹[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç•«é¢æ„Ÿ|ç™¼ä½ˆæ–‡æ¡ˆ|$))/i);
          if (scriptMatch && scriptMatch[1]) {
            sections.script = cleanMarkdownFormat(scriptMatch[1].trim());
            console.log('å¼·åˆ¶æå–è…³æœ¬å…§å®¹:', sections.script.substring(0, 100) + '...');
          }
          
          // å¼·åˆ¶æå–ç•«é¢æ„Ÿ
          const visualMatch = aiText.match(/ç•«é¢æ„Ÿ[ï¼š:]\s*([\s\S]*?)(?=\n\s*(?:ç™¼ä½ˆæ–‡æ¡ˆ|$))/i);
          if (visualMatch && visualMatch[1]) {
            sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
            console.log('å¼·åˆ¶æå–ç•«é¢æ„Ÿ:', sections.visual.substring(0, 100) + '...');
          }
          
          // å¼·åˆ¶æå–ç™¼ä½ˆæ–‡æ¡ˆ
          const copyMatch = aiText.match(/ç™¼ä½ˆæ–‡æ¡ˆ[ï¼š:]\s*([\s\S]*?)$/i);
          if (copyMatch && copyMatch[1]) {
            sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
            console.log('å¼·åˆ¶æå–ç™¼ä½ˆæ–‡æ¡ˆ:', sections.copy.substring(0, 100) + '...');
          }
        }
        
        console.log('å®Œæ•´è§£æçµæœ:', sections);
        return sections;
      }
    </script>
  </body>
  </html>




