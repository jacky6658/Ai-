<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>AIJobçŸ­å½±éŸ³æ™ºèƒ½é«”</title>
    <style>
      :root { 
        color-scheme: light; 
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --safe-area-inset-left: env(safe-area-inset-left);
        --safe-area-inset-right: env(safe-area-inset-right);
      }
      body { 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
        background:#f7f7f8; /* æ¨¡æ“¬ ChatGPT çš„æ·ºç°è‰²èƒŒæ™¯ */
        color:#1a1a1a; 
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        overflow-x: hidden;
      }
      
      /* é é¢å®¹å™¨ */
      .app-container {
        display: flex;
        min-height: 100vh;
      }
      
      /* ä¸»å…§å®¹å€åŸŸ */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: margin-right 0.3s ease;
      }
      
      .main-content.sidebar-open {
        margin-right: 300px;
      }
      
      /* é ‚éƒ¨å°èˆªæ¬„ */
      .top-navbar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding-top: calc(16px + var(--safe-area-inset-top));
        min-height: 60px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .navbar-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }
      
      .navbar-title {
        font-size: 30px;
        font-weight: 600;
        color: #1f2937;
        margin-right: auto;
      }
      
      .clickable-title {
        cursor: pointer;
        transition: color 0.2s ease;
      }
      
      .clickable-title:hover {
        color: #3b82f6;
      }
      
      .navbar-tabs {
        display: flex;
        gap: 8px;
      }
      
      .navbar-tab {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: #6b7280;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
      }
      
      .navbar-tab.active {
        background: #3b82f6;
        color: white;
      }
      
      .navbar-tab:hover:not(.active) {
        background: #f3f4f6;
      }
      
      .navbar-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }
      
      .logout-btn {
        padding: 6px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
      }
      
      .logout-btn:hover {
        background: #dc2626;
      }
      
      /* é é¢å…§å®¹å€åŸŸ */
      .page-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* é¦–é æ¨£å¼ */
      .homepage {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        text-align: center;
      }
      
      .homepage-title {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
      }
      
      .homepage-subtitle {
        font-size: 18px;
        color: #6b7280;
        margin-bottom: 48px;
        max-width: 600px;
        line-height: 1.6;
      }
      
      .mode-cards {
        display: flex;
        gap: 24px;
        max-width: 800px;
      }
      
      .mode-card {
        flex: 1;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 32px 24px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        user-select: none;
      }
      
      .mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
      }
      
      .mode-card-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      
      .mode-card-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
      }
      
      .mode-card-desc {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* æ¨¡å¼1ï¼šä¸€éµç”Ÿæˆé é¢ */
      .mode1-page {
        display: flex;
        gap: 24px;
        height: calc(100vh - 120px);
      }
      
      .mode1-left {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .mode1-right {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* æ¨¡å¼2ï¼šAIé¡§å•å°è©±é é¢ */
      .mode2-page {
        /* èˆŠæ¨£å¼ï¼Œå°‡è¢«æ–°æ¨£å¼è¦†è“‹ */
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        min-height: 600px;
        position: relative;
      }
      
      /* èªªæ˜æŒ‰éˆ• */
      .instructions-toggle-btn {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.2s ease;
        z-index: 1000;
      }
      
      .instructions-toggle-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      
      .btn-icon {
        font-size: 16px;
      }
      
      .btn-text {
        font-size: 13px;
      }
      
      /* æŠ½å±œèƒŒæ™¯é®ç½© */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .drawer-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      /* èªªæ˜æŠ½å±œ */
      .instructions-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1001;
        display: flex;
        flex-direction: column;
      }
      
      .instructions-drawer.open {
        right: 0;
      }
      
      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      
      .drawer-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }
      
      .drawer-close-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .drawer-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .drawer-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      
      .drawer-content p {
        margin: 0 0 16px 0;
        font-size: 14px;
        line-height: 1.6;
        color: #374151;
      }
      
      .drawer-content p:last-child {
        margin-bottom: 0;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        font-size: 13px;
        color: #6b7280;
      }
      
      .chat-container {
        /* èˆŠæ¨£å¼ï¼Œå°‡è¢«æ–°æ¨£å¼è¦†è“‹ */
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      /* å´é‚Šæ¬„æ¨£å¼ */
      .sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e5e7eb;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
      }
      
      .sidebar.open {
        right: 0;
      }
      
      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .sidebar-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
      
      .sidebar-menu {
        padding: 20px 0;
      }
      
      .sidebar-item {
        display: block;
        width: 100%;
        padding: 12px 20px;
        border: none;
        background: none;
        text-align: left;
        color: #6b7280;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .sidebar-item:hover {
        background: #f3f4f6;
        color: #1f2937;
      }
      
      .sidebar-item.active {
        background: #3b82f6;
        color: white;
      }
      
      
      /* å´é‚Šæ¬„é é¢æ¨£å¼ */
      .sidebar-page-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .sidebar-page-container {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90%;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      
      .sidebar-page-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
      }
      
      .sidebar-page-header h2 {
        margin: 0;
        font-size: 20px;
      }
      
      /* --- AI é¡§å•æ¨¡å¼ (Mode 2) UI/UX å„ªåŒ–æ¨£å¼ --- */
      
      /* é é¢å…§å®¹å€åŸŸ - èª¿æ•´ padding å’Œå±…ä¸­ */
      .page-content {
        flex: 1;
        padding: 0; /* ç§»é™¤ paddingï¼Œè®“ chat-container è™•ç† */
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center; /* è®“å…§å®¹å±…ä¸­ */
        padding-bottom: 120px; /* ç‚ºè¼¸å…¥æ¡†ç•™å‡ºç©ºé–“ */
      }
      
      /* æ¨¡å¼2ï¼šAIé¡§å•å°è©±é é¢ - é™åˆ¶æœ€å¤§å¯¬åº¦ */
      .mode2-page {
        width: 100%;
        max-width: 800px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œæ¨¡æ“¬ ChatGPT é«”é©— */
        padding: 0 20px;
        margin: 0 auto;
      }
      
      /* èŠå¤©è¨Šæ¯å®¹å™¨ */
      .chat-container {
        width: 100%;
        padding-top: 20px;
        padding-bottom: 20px;
      }
      
      /* è¨Šæ¯è¡Œ - ç§»é™¤åŸæœ‰çš„æ°£æ³¡æ¨£å¼ï¼Œæ”¹ç‚ºå¡Šç‹€ */
      .msg {
        display: flex;
        padding: 20px 0;
        border-bottom: 1px solid #e5e7eb; /* è¨Šæ¯é–“éš”ç·š */
      }
      
      /* ç”¨æˆ¶è¨Šæ¯ */
      .msg.user {
        background: white; /* ç”¨æˆ¶è¨Šæ¯èƒŒæ™¯ */
      }
      
      /* AI è¨Šæ¯ */
      .msg.assistant {
        background: #f7f7f8; /* AI è¨Šæ¯èƒŒæ™¯ */
        border-top: 1px solid #e5e7eb;
      }
      
      /* é ­åƒ */
      .msg-avatar {
        width: 30px;
        height: 30px;
        min-width: 30px;
        border-radius: 4px;
        background: #10a37f;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        font-weight: bold;
        margin-right: 15px;
      }
      
      .msg.user .msg-avatar {
        background: #3b82f6; /* ç”¨æˆ¶é ­åƒé¡è‰² */
      }
      
      /* è¨Šæ¯æ°£æ³¡ (æ›´åƒå…§å®¹å€å¡Š) */
      .msg-bubble {
        flex: 1;
        padding: 0; /* ç§»é™¤æ°£æ³¡å…§é‚Šè· */
        margin: 0;
        line-height: 1.6;
        color: #374151;
      }
      
      /* è¨Šæ¯å…§å®¹çš„æ¨£å¼é‡ç½® */
      .msg-bubble p:first-child {
        margin-top: 0;
      }
      .msg-bubble p:last-child {
        margin-bottom: 0;
      }
      
      /* Markdown æ¸²æŸ“æ¨£å¼ */
      .msg-bubble pre {
        background: #202123; /* ä»£ç¢¼å¡ŠèƒŒæ™¯ */
        color: #f8f8f2;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
        position: relative;
        margin: 15px 0;
      }
      
      .msg-bubble pre code {
        display: block;
        padding: 0;
        background: none;
      }
      
      .msg-bubble table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px 0;
      }
      
      .msg-bubble th, .msg-bubble td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      
      .msg-bubble th {
        background-color: #f2f2f2;
      }
      
      .msg-bubble blockquote {
        border-left: 4px solid #ccc;
        padding-left: 15px;
        margin: 15px 0;
        color: #666;
      }
      
      .msg-bubble ul, .msg-bubble ol {
        margin: 15px 0;
        padding-left: 20px;
      }

      /* è¼¸å…¥å€åŸŸ */
      .chat-input-area {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        flex-direction: column; /* å…è¨±å¿«é€ŸæŒ‰éˆ•åœ¨ä¸Šæ–¹ */
        align-items: center;
        padding: 10px 0; /* èª¿æ•´ padding */
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }

      /* å¿«é€ŸæŒ‰éˆ•å®¹å™¨ */
      .quick-replies-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        padding: 15px 20px;
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
      }

      /* å¿«é€ŸæŒ‰éˆ•æ¨£å¼ (è† å›Š/æ¨™ç±¤é¢¨æ ¼) */
      .quick-reply-btn {
        padding: 8px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 20px; /* è† å›Šå½¢ç‹€ */
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        user-select: none;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .quick-reply-btn:hover {
        background: #f3f4f6;
        border-color: #ccc;
      }
      
      .input-wrapper {
        width: 100%;
        max-width: 800px;
        display: flex;
        align-items: flex-end;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 8px 12px;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin: 0 20px; /* ç¢ºä¿åœ¨å°è¢å¹•ä¸Šæœ‰é‚Šè· */
      }
      
      .chat-input {
        flex-grow: 1;
        border: none;
        resize: none; /* ç¦ç”¨ç€è¦½å™¨è‡ªå¸¶çš„æ‹–æ‹½èª¿æ•´å¤§å° */
        outline: none;
        padding: 5px 0;
        font-size: 16px;
        line-height: 1.5;
        max-height: 200px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
        overflow-y: auto;
      }
      
      .send-btn {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        padding: 8px;
        margin-left: 10px;
        font-size: 24px;
        transition: color 0.2s;
      }
      
      .send-btn:disabled {
        color: #ccc;
        cursor: not-allowed;
      }
      
      /* AI æ€è€ƒä¸­å‹•ç•« */
      .ai-loading {
        display: flex;
        align-items: center;
        font-style: italic;
        color: #6b7280;
      }
      
      .ai-loading-dots {
        display: flex;
        margin-left: 10px;
      }
      
      .ai-loading-dot {
        width: 6px;
        height: 6px;
        margin: 0 2px;
        background-color: #3b82f6;
        border-radius: 50%;
        animation: dot-flashing 1s infinite alternate;
      }
      
      .ai-loading-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .ai-loading-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes dot-flashing {
        0% {
          opacity: 0.2;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
    
    <!-- å¼•å…¥ marked.js ç”¨æ–¼å°ˆæ¥­ Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ highlight.js ç”¨æ–¼ä»£ç¢¼èªæ³•é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- å¼•å…¥ highlight.js æ”¯æ´çš„èªè¨€ (å¯æ ¹æ“šéœ€æ±‚å¢æ¸›) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <!-- å¼•å…¥ Font Awesome åœ–æ¨™åº« (ç”¨æ–¼ç™¼é€æŒ‰éˆ•ç­‰) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  </head>
  <body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="login-page">
      <div class="login-container">
        <div class="app-logo">AIJobçŸ­å½±éŸ³æ™ºèƒ½é«”</div>
        <div class="app-subtitle">æ‚¨çš„å€‹äººåŒ–çŸ­å½±éŸ³å‰µä½œå°ˆå®¶</div>
        <div class="login-prompt">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</div>
        <button id="loginBtn" class="login-btn">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png" alt="Google Logo" class="google-logo">
          ä½¿ç”¨ Google ç™»å…¥
        </button>
      </div>
    </div>
    
    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼é é¢ -->
    <div id="mainApp" class="main-app" style="display: none;">
      <div class="app-container">
        <!-- å´é‚Šæ¬„ -->
        <div id="sidebar" class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-title">æ­·å²ç´€éŒ„</div>
            <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
          </div>
          <div id="sidebarMenu" class="sidebar-menu">
            <!-- æ­·å²ç´€éŒ„é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
          </div>
        </div>
        
        <div class="main-content">
          <!-- é ‚éƒ¨å°èˆªæ¬„ -->
          <div class="top-navbar">
            <div class="navbar-left">
              <div id="navbarTitle" class="navbar-title clickable-title" onclick="showPage('homepage')">AIJobçŸ­å½±éŸ³æ™ºèƒ½é«”</div>
              <div class="navbar-tabs">
                <button class="navbar-tab" data-page="homepage" onclick="showPage('homepage')">é¦–é </button>
                <button class="navbar-tab" data-page="mode1" onclick="showPage('mode1')">ä¸€éµç”Ÿæˆ</button>
                <button class="navbar-tab active" data-page="mode2" onclick="showPage('mode2')">AIé¡§å•</button>
                <button class="navbar-tab" data-page="mode3" onclick="showPage('mode3')">æˆ‘çš„è…³æœ¬</button>
                <button class="navbar-tab" data-page="userDB" onclick="showPage('userDB')">ç”¨æˆ¶è³‡æ–™åº«</button>
              </div>
            </div>
            <div class="navbar-right">
              <div id="userInfo" class="user-info">
                <img id="userAvatar" src="" alt="Avatar" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
                <span id="userName"></span>
              </div>
              <button id="logoutBtn" class="logout-btn">ç™»å‡º</button>
              <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
              </button>
            </div>
          </div>
          
          <!-- é é¢å…§å®¹ -->
          <div class="page-content">
            <!-- é¦–é  -->
            <div id="homepage" class="homepage" style="display: none;">
              <div class="homepage-title">æ­¡è¿ä½¿ç”¨ AIJobçŸ­å½±éŸ³æ™ºèƒ½é«”</div>
              <div class="homepage-subtitle">æ‚¨çš„å€‹äººåŒ–çŸ­å½±éŸ³å‰µä½œå°ˆå®¶ï¼Œé¸æ“‡ä¸€å€‹æ¨¡å¼é–‹å§‹å‰µä½œå§ï¼</div>
              <div class="mode-cards">
                <div class="mode-card" onclick="showPage('mode1')">
                  <div class="mode-card-icon">âš¡ï¸</div>
                  <div class="mode-card-title">ä¸€éµç”Ÿæˆ</div>
                  <div class="mode-card-desc">å¿«é€Ÿè¼¸å…¥ä¸»é¡Œï¼ŒAIç«‹å³ç”Ÿæˆå®Œæ•´çš„çŸ­å½±éŸ³è…³æœ¬ã€æ–‡æ¡ˆå’Œé—œéµå­—ã€‚</div>
                </div>
                <div class="mode-card" onclick="showPage('mode2')">
                  <div class="mode-card-icon">ğŸ’¬</div>
                  <div class="mode-card-title">AIé¡§å•</div>
                  <div class="mode-card-desc">èˆ‡AIé€²è¡Œå°è©±å¼äº’å‹•ï¼Œå¾å¸³è™Ÿå®šä½ã€é¸é¡Œåˆ°è…³æœ¬å‰µä½œï¼Œæä¾›å…¨ç¨‹æŒ‡å°ã€‚</div>
                </div>
                <div class="mode-card" onclick="showPage('mode3')">
                  <div class="mode-card-icon">ğŸ—‚ï¸</div>
                  <div class="mode-card-title">æˆ‘çš„è…³æœ¬</div>
                  <div class="mode-card-desc">æŸ¥çœ‹ã€ç·¨è¼¯å’Œç®¡ç†æ‰€æœ‰å·²ç”Ÿæˆçš„çŸ­å½±éŸ³è…³æœ¬ã€‚</div>
                </div>
              </div>
            </div>
            
            <!-- æ¨¡å¼1ï¼šä¸€éµç”Ÿæˆé é¢ -->
            <div id="mode1Page" class="mode1-page" style="display: none;">
              <div class="mode1-left">
                <div class="section-title">
                  <i class="fas fa-cog"></i>
                  ç”Ÿæˆè¨­å®š
                </div>
                <!-- è¨­å®šè¡¨å–® -->
                <div class="form-group">
                  <label for="platformSelect">ç›®æ¨™å¹³å°</label>
                  <select id="platformSelect" class="input-field">
                    <option value="tiktok">TikTok æŠ–éŸ³</option>
                    <option value="youtube">YouTube Shorts</option>
                    <option value="instagram">Instagram Reels</option>
                    <option value="facebook">Facebook Reels</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="topicInput">ä¸»é¡Œ/é—œéµå­—</label>
                  <input type="text" id="topicInput" class="input-field" placeholder="ä¾‹å¦‚ï¼šå¤å­£ç¾ç™½ä¿é¤Šã€æœ€æ–°AIæŠ€è¡“" />
                </div>
                <div class="form-group">
                  <label for="styleSelect">é¢¨æ ¼</label>
                  <select id="styleSelect" class="input-field">
                    <option value="funny">å¹½é»˜é¢¨è¶£</option>
                    <option value="professional">å°ˆæ¥­çŸ¥è­˜</option>
                    <option value="lifestyle">ç”Ÿæ´»åˆ†äº«</option>
                    <option value="review">ç”¢å“è©•æ¸¬</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="durationSelect">å½±ç‰‡é•·åº¦</label>
                  <select id="durationSelect" class="input-field">
                    <option value="15">15 ç§’å…§</option>
                    <option value="30">30 ç§’å…§</option>
                    <option value="60">60 ç§’å…§</option>
                  </select>
                </div>
                <button id="generateScriptBtn" class="primary-btn" onclick="generateScript()">
                  <i class="fas fa-magic"></i>
                  ä¸€éµç”Ÿæˆè…³æœ¬
                </button>
              </div>
              
              <div class="mode1-right">
                <div class="section-title">
                  <i class="fas fa-file-alt"></i>
                  ç”Ÿæˆçµæœ
                </div>
                <div id="scriptResult" class="result-block">
                  <!-- è…³æœ¬çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                  <p class="placeholder-text">é»æ“Šã€Œä¸€éµç”Ÿæˆè…³æœ¬ã€å¾Œï¼Œçµæœå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</p>
                </div>
                <div class="result-actions">
                  <button id="saveScriptBtn" class="secondary-btn" onclick="saveScript()" style="display: none;">
                    <i class="fas fa-save"></i>
                    å„²å­˜è…³æœ¬
                  </button>
                  <button id="copyScriptBtn" class="secondary-btn" onclick="copyResult('scriptResult')" style="display: none;">
                    <i class="fas fa-copy"></i>
                    è¤‡è£½çµæœ
                  </button>
                </div>
              </div>
            </div>
            
            <!-- æ¨¡å¼2ï¼šAIé¡§å•å°è©±é é¢ (é‡æ§‹å¾Œ) -->
            <div id="mode2Page" class="mode2-page">
              <div id="chat-container" class="chat-container">
                <!-- èŠå¤©è¨Šæ¯å°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- è¼¸å…¥å€åŸŸ -->
      <div class="chat-input-area">
        <!-- å¿«é€ŸæŒ‰éˆ•å®¹å™¨ -->
        <div id="quick-replies" class="quick-replies-container">
          <!-- å¿«é€ŸæŒ‰éˆ•å°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
        </div>

        <div class="input-wrapper">
          <textarea id="chat-input" class="chat-input" placeholder="å‘AIé¡§å•æå•..." rows="1"></textarea>
          <button id="send-btn" class="send-btn" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast"></div>
    
    <!-- æˆæ¬Šå½ˆçª—è¦†è“‹å±¤ -->
    <div id="popupOverlay" class="popup-overlay" style="display: none;">
      <div class="popup-content">
        <p>æ­£åœ¨é€²è¡Œ Google ç™»å…¥...</p>
      </div>
    </div>
    
    <!-- ç”¨æˆ¶è³‡æ–™åº«å´é‚Šé é¢ -->
    <div id="userDBPage" class="sidebar-page-overlay" style="display: none;">
      <div class="sidebar-page-container">
        <div class="sidebar-page-header">
          <h2>ç”¨æˆ¶è³‡æ–™åº«</h2>
          <button class="drawer-close-btn" onclick="closeUserDBPage()">Ã—</button>
        </div>
        <div class="sidebar-page-content">
          <div class="tabs-container">
            <button class="result-tab active" data-tab="positioning" onclick="switchTab('positioning')">å¸³è™Ÿå®šä½</button>
            <button class="result-tab" data-tab="topics" onclick="switchTab('topics')">è…³æœ¬é¸é¡Œ</button>
            <button class="result-tab" data-tab="scripts" onclick="switchTab('scripts')">æˆ‘çš„è…³æœ¬</button>
            <button class="result-tab" data-tab="memory" onclick="switchTab('memory')">AIè¨˜æ†¶</button>
          </div>
          
          <div id="tabContent">
            <!-- å¸³è™Ÿå®šä½ Tab -->
            <div id="positioningTab" class="tab-content active">
              <div class="section-title">
                <i class="fas fa-bullseye"></i>
                å¸³è™Ÿå®šä½åˆ†æ
              </div>
              <div class="form-group">
                <label for="positioningInput">è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿå®šä½æè¿°</label>
                <textarea id="positioningInput" class="input-field" rows="3" placeholder="ä¾‹å¦‚ï¼šå°ˆæ³¨æ–¼åˆ†äº« 3C ç§‘æŠ€ç”¢å“çš„é–‹ç®±èˆ‡è©•æ¸¬ï¼Œé¢¨æ ¼åå‘å¹½é»˜é¢¨è¶£ã€‚"></textarea>
              </div>
              <button class="primary-btn" onclick="analyzePositioning()">
                <i class="fas fa-search"></i>
                é–‹å§‹åˆ†æ
              </button>
              
              <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-chart-line"></i>
                åˆ†æçµæœ
              </div>
              <div id="positioningResult" class="result-block">
                <p class="placeholder-text">åˆ†æçµæœå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</p>
              </div>
              
              <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-history"></i>
                æ­·å²å®šä½è¨˜éŒ„
              </div>
              <div id="positioningHistory" class="history-list">
                <!-- æ­·å²è¨˜éŒ„å°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
              </div>
            </div>
            
            <!-- è…³æœ¬é¸é¡Œ Tab -->
            <div id="topicsTab" class="tab-content" style="display: none;">
              <div class="section-title">
                <i class="fas fa-lightbulb"></i>
                è…³æœ¬é¸é¡Œå»ºè­°
              </div>
              <div class="form-group">
                <label for="topicPlatformSelect">ç›®æ¨™å¹³å°</label>
                <select id="topicPlatformSelect" class="input-field">
                  <option value="tiktok">TikTok æŠ–éŸ³</option>
                  <option value="youtube">YouTube Shorts</option>
                  <option value="instagram">Instagram Reels</option>
                  <option value="facebook">Facebook Reels</option>
                </select>
              </div>
              <div class="form-group">
                <label for="topicTopicInput">ä¸»é¡Œ/é—œéµå­—</label>
                <input type="text" id="topicTopicInput" class="input-field" placeholder="ä¾‹å¦‚ï¼šå¤å­£ç¾ç™½ä¿é¤Šã€æœ€æ–°AIæŠ€è¡“" />
              </div>
              <button class="primary-btn" onclick="selectTopics()">
                <i class="fas fa-search"></i>
                ç²å–é¸é¡Œå»ºè­°
              </button>
              
              <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-list"></i>
                å»ºè­°åˆ—è¡¨
              </div>
              <div id="topicSelectionResult" class="result-block">
                <p class="placeholder-text">é¸é¡Œå»ºè­°å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</p>
              </div>
            </div>
            
            <!-- æˆ‘çš„è…³æœ¬ Tab -->
            <div id="scriptsTab" class="tab-content" style="display: none;">
              <div class="section-title">
                <i class="fas fa-scroll"></i>
                å·²å„²å­˜è…³æœ¬
              </div>
              <div id="myScriptsList" class="history-list">
                <!-- å·²å„²å­˜è…³æœ¬åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
              </div>
            </div>
            
            <!-- AIè¨˜æ†¶ Tab -->
            <div id="memoryTab" class="tab-content" style="display: none;">
              <div class="section-title">
                <i class="fas fa-brain"></i>
                AI é•·çŸ­æœŸè¨˜æ†¶
              </div>
              <div id="memoryContent" class="result-block">
                <p class="placeholder-text">é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¼‰å…¥ AI è¨˜æ†¶ç‹€æ…‹ã€‚</p>
              </div>
              <button class="primary-btn" onclick="loadMemoryStatus()">
                <i class="fas fa-sync-alt"></i>
                è¼‰å…¥è¨˜æ†¶ç‹€æ…‹
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      // å…¨å±€è®Šé‡
      let accessToken = localStorage.getItem('accessToken') || null;
      let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      let isSending = false;
      let lastSubmitAt = 0;
      let chatHistory = []; // ç”¨æ–¼å­˜å„² AI é¡§å•æ¨¡å¼çš„å°è©±æ­·å²
      
      // DOM å…ƒç´ 
      const loginPage = document.getElementById('loginPage');
      const mainApp = document.getElementById('mainApp');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const userNameEl = document.getElementById('userName');
      const userAvatarEl = document.getElementById('userAvatar');
      const toastEl = document.getElementById('toast');
      const popupOverlay = document.getElementById('popupOverlay');
      const sidebar = document.getElementById('sidebar');
      const sidebarMenu = document.getElementById('sidebarMenu');
      const userDBPage = document.getElementById('userDBPage');
      
      // æ¨¡å¼2 (AIé¡§å•) ç›¸é—œ DOM å…ƒç´ 
      const chatEl = document.getElementById('chat-container');
      const inputEl = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const quickRepliesEl = document.getElementById('quick-replies');
      
      // æ¨¡å¼1 (ä¸€éµç”Ÿæˆ) ç›¸é—œ DOM å…ƒç´ 
      const platformSelect = document.getElementById('platformSelect');
      const topicInput = document.getElementById('topicInput');
      const styleSelect = document.getElementById('styleSelect');
      const durationSelect = document.getElementById('durationSelect');
      const scriptResultEl = document.getElementById('scriptResult');
      const saveScriptBtn = document.getElementById('saveScriptBtn');
      const copyScriptBtn = document.getElementById('copyScriptBtn');
      
      // ç”¨æˆ¶è³‡æ–™åº«ç›¸é—œ DOM å…ƒç´ 
      const positioningInput = document.getElementById('positioningInput');
      const topicTopicInput = document.getElementById('topicTopicInput');
      
      // é è¨­çš„å¿«é€ŸæŒ‰éˆ•
      const initialQuickReplies = [
        "è«‹å¹«æˆ‘è¦åŠƒä¸€å€‹ç¾é£ŸçŸ­å½±éŸ³è…³æœ¬",
        "ç›®å‰æœ‰å“ªäº›ç†±é–€çš„çŸ­å½±éŸ³å¹³å°ï¼Ÿ",
        "å¦‚ä½•æå‡æˆ‘çš„çŸ­å½±éŸ³æ›å…‰ç‡ï¼Ÿ",
        "æˆ‘éœ€è¦ä¸€å€‹é—œæ–¼ç§‘æŠ€ç”¢å“çš„è…³æœ¬"
      ];
      
      // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---
      
      // é¡¯ç¤ºé é¢
      function showPage(pageId) {
        document.querySelectorAll('.homepage, .mode1-page, .mode2-page, .mode3-page, .userDB-page').forEach(el => {
          el.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'flex';
        
        // æ›´æ–°å°èˆªæ¨™ç±¤ç‹€æ…‹
        document.querySelectorAll('.navbar-tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.getAttribute('data-page') === pageId) {
            tab.classList.add('active');
          }
        });
        
        // ç‰¹æ®Šè™•ç† AI é¡§å•æ¨¡å¼çš„åˆå§‹åŒ–
        if (pageId === 'mode2') {
          initializeChat();
        }
      }
      
      // ç™»å…¥/ç™»å‡º UI æ›´æ–°
      function updateAuthUI(loggedIn) {
        if (loggedIn) {
          loginPage.style.display = 'none';
          mainApp.style.display = 'block';
          updatePersonalInfo();
          showPage('homepage');
        } else {
          loginPage.style.display = 'flex';
          mainApp.style.display = 'none';
        }
      }
      
      // æ›´æ–°å€‹äººè³‡è¨Š
      function updatePersonalInfo() {
        if (currentUser) {
          userNameEl.textContent = currentUser.name || currentUser.email;
          if (currentUser.picture) {
            userAvatarEl.src = currentUser.picture;
          } else {
            userAvatarEl.src = 'default-avatar.png'; // é è¨­é ­åƒ
          }
        }
      }
      
      // æ¨¡æ“¬ç™»å…¥
      function login() {
        const authUrl = `https://aivideobackend.zeabur.app/api/auth/google/login`;
        const authWindow = window.open(authUrl, '_blank', 'width=500,height=600');
        
        if (authWindow) {
          popupOverlay.style.display = 'flex';
          window.addEventListener('message', handleAuthMessage);
        } else {
          showToast('è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥å®Œæˆç™»å…¥', 5000);
        }
      }
      
      // ç™»å‡º
      function logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('currentUser');
        accessToken = null;
        currentUser = null;
        updateAuthUI(false);
        showToast('ç™»å‡ºæˆåŠŸ', 3000);
      }
      
      // è™•ç†æˆæ¬Šè¨Šæ¯
      function handleAuthMessage(event) {
        // ... (ä¿ç•™åŸæœ‰çš„ handleAuthMessage é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // è™•ç†æˆæ¬Šå›èª¿
      async function handleAuthCallback() {
        // ... (ä¿ç•™åŸæœ‰çš„ handleAuthCallback é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // å½ˆå‡ºæç¤ºæ¡†å‡½æ•¸
      function showToast(message, duration = 3000) {
        // ... (ä¿ç•™åŸæœ‰çš„ showToast é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // å´é‚Šæ¬„æ§åˆ¶
      function toggleSidebar() {
        sidebar.classList.toggle('open');
        document.querySelector('.main-content').classList.toggle('sidebar-open');
      }
      
      // é—œé–‰ç”¨æˆ¶è³‡æ–™åº«é é¢
      function closeUserDBPage() {
        userDBPage.style.display = 'none';
        showPage('homepage'); // è¿”å›é¦–é 
      }
      
      // åˆ‡æ›ç”¨æˆ¶è³‡æ–™åº« Tab
      function switchTab(tabName) {
        // ... (ä¿ç•™åŸæœ‰çš„ switchTab é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // è¤‡è£½çµæœ
      function copyResult(elementId) {
        // ... (ä¿ç•™åŸæœ‰çš„ copyResult é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // ç”Ÿæˆè…³æœ¬ (Mode 1)
      async function generateScript() {
        // ... (ä¿ç•™åŸæœ‰çš„ generateScript é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // å„²å­˜è…³æœ¬
      async function saveScript() {
        // ... (ä¿ç•™åŸæœ‰çš„ saveScript é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // è¼‰å…¥æˆ‘çš„è…³æœ¬
      async function loadMyScripts() {
        // ... (ä¿ç•™åŸæœ‰çš„ loadMyScripts é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // åˆªé™¤è…³æœ¬
      async function deleteScript(scriptId) {
        // ... (ä¿ç•™åŸæœ‰çš„ deleteScript é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // æ ¼å¼åŒ–å°ç£æ™‚é–“
      function formatTaiwanTime(dateString) {
        // ... (ä¿ç•™åŸæœ‰çš„ formatTaiwanTime é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // é‡æ–°ç”Ÿæˆçµæœ
      async function regenerateResult(type) {
        // ... (ä¿ç•™åŸæœ‰çš„ regenerateResult é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // æ›´æ–°çµæœå€å¡Šå…§å®¹
      function updateResultBlock(elementId, content, hasContent) {
        // ... (ä¿ç•™åŸæœ‰çš„ updateResultBlock é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // å¸³è™Ÿå®šä½åŠŸèƒ½
      async function analyzePositioning() {
        // ... (ä¿ç•™åŸæœ‰çš„ analyzePositioning é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // è…³æœ¬é¸é¡ŒåŠŸèƒ½
      async function selectTopics() {
        // ... (ä¿ç•™åŸæœ‰çš„ selectTopics é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // è¼‰å…¥è¨˜æ†¶ç‹€æ…‹
      async function loadMemoryStatus() {
        // ... (ä¿ç•™åŸæœ‰çš„ loadMemoryStatus é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
      }
      
      // --- AI é¡§å•æ¨¡å¼ (Mode 2) é‡æ§‹éƒ¨åˆ† ---
      
      // 1. åˆå§‹åŒ– Markdown æ¸²æŸ“å™¨
      marked.setOptions({
        renderer: new marked.Renderer(),
        gfm: true,
        breaks: true,
        sanitize: true, // å•Ÿç”¨å®‰å…¨æ¨¡å¼
        langPrefix: 'hljs language-', // highlight.js å‰ç¶´
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        }
      });
      
      // 2. å¿«é€ŸæŒ‰éˆ•é‚è¼¯
      function showQuickReplies(replies) {
        quickRepliesEl.innerHTML = ''; // æ¸…ç©ºç¾æœ‰æŒ‰éˆ•
        quickRepliesEl.style.display = 'flex';
        
        replies.forEach(text => {
          const button = document.createElement('button');
          button.className = 'quick-reply-btn';
          button.textContent = text;
          button.addEventListener('click', () => {
            send(text); // é»æ“Šå¾Œç›´æ¥ç™¼é€
            hideQuickReplies();
          });
          quickRepliesEl.appendChild(button);
        });
        
        // ç¢ºä¿æ»¾å‹•åˆ°æœ€åº•éƒ¨
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function hideQuickReplies() {
        quickRepliesEl.innerHTML = '';
        quickRepliesEl.style.display = 'none';
      }
      
      // 3. è¨Šæ¯è¿½åŠ é‚è¼¯ (ä½¿ç”¨ marked.js)
      function append(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        
        // å‰µå»ºé ­åƒå…ƒç´ 
        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.textContent = role === 'user' ? 'ä½ ' : 'ğŸ¤–';
        if (role === 'user' && currentUser && currentUser.picture) {
            avatar.innerHTML = `<img src="${currentUser.picture}" style="width: 100%; height: 100%; border-radius: 4px; object-fit: cover;" alt="ç”¨æˆ¶é ­åƒ">`;
        }
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // æ¸²æŸ“å…§å®¹
        if (text) {
          bubble.innerHTML = marked.parse(text);
          // æ¸²æŸ“å¾Œï¼Œå°ä»£ç¢¼å¡Šé€²è¡Œé«˜äº®
          bubble.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        }
        
        div.appendChild(avatar);
        div.appendChild(bubble);
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
        
        return { container: div, bubble: bubble };
      }
      
      // 4. åŠ©ç†è¨Šæ¯æ›´æ–°é‚è¼¯ (ä¸²æµ)
      function updateAssistantNode(nodeObj, text) {
        if (nodeObj.bubble) {
          // ç§»é™¤è¼‰å…¥å‹•ç•«
          const loadingDiv = nodeObj.bubble.querySelector('.ai-loading');
          if (loadingDiv) {
            loadingDiv.remove();
          }
          
          // ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown
          nodeObj.bubble.innerHTML = marked.parse(text);
          
          // æ¸²æŸ“å¾Œï¼Œå°ä»£ç¢¼å¡Šé€²è¡Œé«˜äº®
          nodeObj.bubble.querySelectorAll('pre code').forEach((block) => {
            if (!block.classList.contains('hljs')) {
                hljs.highlightElement(block);
            }
          });
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }
      
      // 5. è¼¸å…¥æ¡†è‡ªå‹•èª¿æ•´é«˜åº¦å’ŒæŒ‰éˆ•å•Ÿç”¨/ç¦ç”¨é‚è¼¯
      function autoResizeTextarea() {
        // é‡ç½®é«˜åº¦ï¼Œç„¶å¾Œè¨­ç½®ç‚ºæ»¾å‹•é«˜åº¦
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
        
        // æª¢æŸ¥å…§å®¹ä»¥å•Ÿç”¨/ç¦ç”¨æŒ‰éˆ•
        sendBtn.disabled = inputEl.value.trim() === '';
      }
      
      // 6. ç™¼é€è¨Šæ¯ (Mode 2) - æ ¸å¿ƒé‚è¼¯ä¿ç•™
      async function send(message) {
        if (!message || isSending) return;
        
        // éš±è—å¿«é€ŸæŒ‰éˆ•
        hideQuickReplies();
        
        // 1. é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
        append('user', message);
        
        // 2. é¡¯ç¤º AI è¼‰å…¥ç‹€æ…‹
        const assistantNode = append('assistant', '');
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'ai-loading';
        loadingDiv.innerHTML = `
          <span>AIæ­£åœ¨æ€è€ƒä¸­</span>
          <div class="ai-loading-dots">
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
          </div>
        `;
        assistantNode.bubble.appendChild(loadingDiv);
        
        // 3. é–å®šä»‹é¢
        isSending = true;
        sendBtn.disabled = true;
        inputEl.value = '';
        autoResizeTextarea();
        
        // æº–å‚™æ­·å²ç´€éŒ„ (é€™è£¡ä½¿ç”¨ chatHistoryï¼Œç¢ºä¿èˆ‡å¾Œç«¯ API æ ¼å¼ä¸€è‡´)
        chatHistory.push({ role: 'user', content: message });
        
        // --- æ ¸å¿ƒ API å‘¼å«é‚è¼¯ (ä¿ç•™ä¸¦é©æ‡‰æ–°çš„ UI æ›´æ–°) ---
        let fullResponse = '';
        
        try {
          // é€™è£¡çš„ API å‘¼å«é‚è¼¯æ‡‰è©²èˆ‡æ‚¨åŸå§‹çš„ sendMessage é¡ä¼¼ï¼Œä½†ä½¿ç”¨æ–°çš„ chatHistory
          const endpoint = 'https://aivideobackend.zeabur.app/api/chat/stream';
          
          const headers = { 'Content-Type': 'application/json' };
          if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
          }
          
          // æ§‹å»ºè«‹æ±‚é«”
          const body = JSON.stringify({
              message: message,
              history: chatHistory.slice(0, -1), // å‚³éé™¤äº†æœ€æ–°è¨Šæ¯ä¹‹å¤–çš„æ­·å²ç´€éŒ„
              user_id: currentUser ? currentUser.id : null,
              // å…¶ä»–åƒæ•¸ (platform, topic, style, duration) æš«æ™‚ä¸å¾ chat ä»‹é¢å‚³éï¼Œé™¤éæœ‰å°ˆé–€çš„è¨­å®šå€
          });

          const response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder('utf-8');
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value, { stream: true });
            
            // è™•ç† SSE æ ¼å¼çš„æ•¸æ“š
            chunk.split('\n').forEach(line => {
                if (line.startsWith('data:')) {
                    const data = line.substring(5).trim();
                    if (data === '[DONE]') {
                        return;
                    }
                    try {
                        const json = JSON.parse(data);
                        if (json.text) {
                            fullResponse += json.text;
                            updateAssistantNode(assistantNode, fullResponse);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e, data);
                    }
                }
            });
          }
          
        } catch (error) {
          console.error('Chat API Error:', error);
          fullResponse = `æŠ±æ­‰ï¼ŒAIé¡§å•ç›®å‰ç„¡æ³•é€£æ¥æˆ–ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
          updateAssistantNode(assistantNode, fullResponse);
        }
        
        // 4. è§£é–ä»‹é¢
        isSending = false;
        sendBtn.disabled = false;
        
        // 5. å°‡æœ€çµ‚è¨Šæ¯åŠ å…¥æ­·å²ç´€éŒ„
        chatHistory.push({ role: 'assistant', content: fullResponse });

        // 6. é¡¯ç¤ºä¸‹ä¸€çµ„å¿«é€ŸæŒ‰éˆ• (ä¾‹å¦‚ï¼Œèˆ‡æœ¬æ¬¡å›è¦†ç›¸é—œçš„å¾ŒçºŒå•é¡Œ)
        const nextQuickReplies = [
          "å¦‚ä½•å°‡è…³æœ¬è½‰ç‚ºå½±ç‰‡ï¼Ÿ",
          "è«‹æä¾›ä¸€å€‹è…³æœ¬ç¯„ä¾‹",
          "é‚„æœ‰å…¶ä»–é¢¨æ ¼å»ºè­°å—ï¼Ÿ"
        ];
        showQuickReplies(nextQuickReplies);
      }
      
      // 7. AI é¡§å•æ¨¡å¼åˆå§‹åŒ–
      function initializeChat() {
        if (chatEl.children.length === 0) {
            // é¡¯ç¤ºåˆå§‹æ­¡è¿è¨Šæ¯
            const welcomeMessage = "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIçŸ­å½±éŸ³å‰µä½œé¡§å•ã€‚è«‹å•æ‚¨æƒ³è£½ä½œå“ªç¨®ä¸»é¡Œã€å¹³å°æˆ–é¢¨æ ¼çš„çŸ­å½±éŸ³å‘¢ï¼Ÿ";
            append('assistant', welcomeMessage);
            
            // é¡¯ç¤ºåˆå§‹å¿«é€ŸæŒ‰éˆ•
            showQuickReplies(initialQuickReplies);
        }
      }
      
      // --- äº‹ä»¶ç›£è½å™¨ ---
      
      document.addEventListener('DOMContentLoaded', async () => {
        // ... (ä¿ç•™åŸæœ‰çš„ DOMContentLoaded é‚è¼¯)
        // é€™è£¡çš„é‚è¼¯å¾ˆé•·ï¼Œç‚ºäº†ç°¡æ½”ï¼Œå‡è¨­å®ƒå·²ç¶“è¢«ä¿ç•™åœ¨åŸå§‹æ–‡ä»¶ä¸­
        
        // æ›¿æ›èˆŠçš„èŠå¤©è¼¸å…¥äº‹ä»¶
        // å‡è¨­åŸå§‹æ–‡ä»¶ä¸­æœ‰é¡ä¼¼ sendBtn.addEventListener('click', sendMessage); çš„ç¨‹å¼ç¢¼ï¼Œç¾åœ¨å°‡å…¶æ›¿æ›ç‚ºæ–°çš„é‚è¼¯
        
        // æ›¿æ›æˆ–æ–°å¢ AI é¡§å•æ¨¡å¼çš„äº‹ä»¶ç›£è½
        inputEl.addEventListener('input', autoResizeTextarea);
        
        inputEl.addEventListener('keypress', (e) => {
          // æª¢æŸ¥æ˜¯å¦ç‚º Enter éµï¼Œä¸¦ä¸”æ²’æœ‰æŒ‰ Shift éµ (æ¨¡æ“¬ ChatGPT è¡Œç‚º)
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // é˜»æ­¢æ›è¡Œ
            const message = inputEl.value.trim();
            if (message) {
              send(message);
            }
          }
        });
        
        sendBtn.addEventListener('click', () => {
          const message = inputEl.value.trim();
          if (message) {
            send(message);
          }
        });
        
        // åˆå§‹æª¢æŸ¥
        updateAuthUI(accessToken && currentUser);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰èªè­‰å›èª¿
        await handleAuthCallback();
        
        // åˆå§‹é¡¯ç¤ºé¦–é 
        showPage('homepage');
      });
      
    </script>
  </body>
</html>
