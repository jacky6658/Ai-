# AIJob短影音智能體 - 前端

## 專案簡介

這是一個AI驅動的短影音腳本生成平台前端，提供智能化的短影音內容創作工具。

## 功能特色

- 🤖 **AI智能對話**：與AI進行自然對話，生成短影音腳本
- 📝 **結構化輸出**：自動解析AI回應並填入結果區塊
- ⚡ **快速按鈕**：一鍵生成腳本、選題建議、帳號定位
- 🔧 **連線測試**：內建API連線診斷功能
- 📱 **響應式設計**：支援桌面和行動裝置

## 技術架構

- **前端框架**：原生HTML/CSS/JavaScript
- **API通訊**：Fetch API + Server-Sent Events (SSE)
- **部署平台**：Zeabur
- **後端整合**：FastAPI + Google Gemini AI

## 部署資訊

- **前端網域**：aivideonew.zeabur.app
- **後端網域**：aivideobackend.zeabur.app
- **API端點**：https://aivideobackend.zeabur.app/api/chat/stream

## 快速開始

1. 開啟網頁：https://aivideonew.zeabur.app
2. 使用快速按鈕或手動輸入需求
3. AI將生成完整的短影音腳本
4. 查看結果區塊獲取結構化內容

## 檔案結構

```
fronted/
├── index.html          # 主要應用程式檔案
└── README.md          # 專案說明文件
```

## 更新日誌

### 2025-10-21 - 腳本儲存系統與用戶管理功能

#### 🚀 新增功能
- **腳本儲存系統**：完整的腳本儲存、載入、管理功能
- **手風琴效果顯示**：腳本列表支援展開/收起效果
- **腳本內容表格**：結構化顯示腳本內容的詳細表格
- **腳本操作功能**：查看、下載、刪除、重命名腳本
- **台灣時區支援**：所有時間顯示使用台灣時間（Asia/Taipei，UTC+8）

#### 🔧 腳本儲存功能詳情
- **儲存按鈕**：修改為調用 `saveScript()` 函數
- **數據提取**：自動提取腳本內容的結構化數據
- **資料庫整合**：儲存到後端資料庫並獲取編號
- **手風琴UI**：點擊展開/收起腳本內容
- **編號顯示**：自動生成編號（01, 02, 03...）
- **時間戳記**：顯示生成日期（台灣時間）

#### 📊 腳本內容表格
- **時間欄位**：0-3s, 3-7s, 7-15s, 15-25s, 25-30s
- **段落欄位**：Hook, Pain Point, Value 1, Value 2, CTA
- **鏡頭/畫面**：視覺元素描述
- **台詞欄位**：演員口白內容
- **字幕欄位**：可動畫字幕文字
- **音效欄位**：音效與轉場建議

#### 🎛️ 腳本操作按鈕
- **查看完整結果**：查看完整腳本內容
- **下載PDF檔案**：導出PDF格式（開發中）
- **下載CSV檔案**：導出CSV格式（開發中）
- **刪除腳本**：刪除選定的腳本

#### ✏️ 腳本命名功能
- **預設命名**：使用腳本主題作為預設名稱
- **點擊編輯**：點擊名稱可以編輯
- **彈窗修改**：彈出小視窗進行名稱修改

#### 🔐 認證與安全
- **API認證**：所有腳本API都需要用戶認證
- **錯誤處理**：完整的錯誤處理和用戶提示
- **權限控制**：確保用戶只能操作自己的腳本

#### ⚠️ 已知問題
- **腳本儲存**：目前API認證問題導致儲存失敗
- **腳本載入**：401 Unauthorized 錯誤需要修復
- **資料庫鎖定**：偶爾出現 database is locked 錯誤

### 2025-10-21 - 雙層記憶系統整合與智能結果顯示

#### 🚀 新增功能
- **雙層記憶系統整合**：前端整合STM（短期記憶）和LTM（長期記憶）
- **一鍵生成功能**：帳號定位、腳本選題、短影音腳本三階段生成
- **智能結果顯示**：AI對話自動識別並顯示到對應結果區塊
- **階段性驗證**：確保按照正確順序完成帳號定位 → 選題 → 腳本
- **用戶歷史記錄**：個人資料、我的腳本、帳號定位、選題記錄
- **結果管理**：儲存和再生成功能
- **Google OAuth整合**：完整的用戶認證和授權系統
- **左右兩欄佈局**：專業的彈出式用戶資訊視窗

#### 🛠️ 技術修改

**檔案：index.html**

**1. 頁面佈局重構**：
- 將整體佈局改為左右兩欄（5:5比例）
- 左欄：用戶需求設定 + AI對話框 + 快速按鈕 + 輸入框
- 右欄：結果顯示區（帳號定位、腳本選題、短影音腳本）
- 移除底部舊控制面板，功能整合到新佈局

**2. 用戶需求設定**：
- 標題從"短影音設定"改為"用戶需求設定"
- 新增可摺疊功能：手動切換 + 自動摺疊（套用設定後）
- 主題和帳號定位改為選填欄位
- 新增 `settingsApplied` 布林值和 `appliedSettings` 物件追蹤用戶是否明確套用設定

**3. 一鍵生成功能**：
- **三個一鍵生成按鈕**：
  - `generatePositioning()`：一鍵生成帳號定位
  - `generateTopics()`：一鍵生成腳本選題
  - `generateScript()`：一鍵生成短影音腳本
- **階段性驗證**：
  - 選題生成前檢查是否完成帳號定位
  - 腳本生成前檢查是否完成選題
  - 驗證邏輯只檢查明確的預設占位文字，避免過度嚴格
- **結果管理**：
  - `saveResult()`：儲存生成結果
  - `regenerateResult()`：重新生成不同結果
  - 儲存後可供下一階段使用（帳號定位 → 選題 → 腳本）

**4. 智能結果顯示**：
- **`detectAndDisplayResult()` 函數**：
  - 自動識別AI回應類型（帳號定位、選題、腳本）
  - 只顯示明確的摘要/結果（如"📌 你的帳號定位建議："）
  - 一般討論內容保留在對話框
- **`updateResultBlock()` 函數**：
  - 統一處理結果區塊更新
  - 顯示生成內容 + 儲存/再生成按鈕
  - 自動切換到對應的結果標籤

**5. 快速按鈕更新**：
- 從原本的"帳號定位"、"選題推薦"、"腳本生成"
- 改為"我要如何開始？"、"我要怎麼帳號定位"、"什麼是腳本選題"
- 按鈕功能：自動發送對應問題到AI對話

**6. 結果區塊標籤順序**：
- 重新排序為：🎯 帳號定位 → 💡 腳本選題 → 📝 短影音腳本
- 預設顯示帳號定位標籤
- 前端重新整理後保持固定位置

**7. AI對話優化**：
- AI標籤從"AI"改為"AIJob短影音顧問"
- 調整標籤字體大小（11px）和粗細（500）
- 增加聊天框高度（400-600px）
- 增加輸入框高度（60-200px）

**8. 載入動畫修復**：
- 正確顯示"AI回覆中..."載入動畫
- 使用聊天氣泡樣式，包含尾巴效果
- 動畫消失時機：收到第一個AI token時

**9. Markdown格式移除**：
- `cleanMarkdownFormat()` 函數強化
- 移除所有Markdown符號（`**`、`###`等）
- 正確處理換行：`\n\n` → `<p>`，`\n` → `<br>`

**10. 用戶認證整合**：
- Google OAuth登入/登出
- 自動生成用戶ID：`generateUserId()`
- 用戶資訊顯示：頭像 + 姓名，靠右對齊

**11. 用戶歷史記錄**：
- **左右兩欄彈出式視窗設計**：
  - 左欄：導航選單（個人資料、我的腳本、帳號定位、選題記錄）
  - 右欄：對應內容詳細顯示
  - 關閉按鈕
- **歷史資料載入**：
  - `loadUserHistory()`：載入所有用戶歷史資料
  - `updatePersonalInfo()`：顯示個人資料（姓名、信箱、用戶ID）
  - `updateConversationsDisplay()`：顯示對話摘要
  - `updateGenerationsDisplay()`：顯示生成記錄
  - `updateMemoryDisplay()`：顯示記憶資訊
- **內容切換**：
  - `switchDrawerContent()`：點擊選單項目切換顯示內容
  - 高亮當前選中項目

**12. API整合**：
- 所有API調用使用完整後端地址：`http://127.0.0.1:8000`
- 對話API：`/api/chat/stream`
- 一鍵生成API：`/api/generate/positioning`、`/api/generate/topics`、`/api/generate/script`
- 用戶歷史API：`/api/user/profile/{user_id}`、`/api/user/conversations/{user_id}`、`/api/user/generations/{user_id}`

**檔案：CSS樣式**

**1. 整體佈局**：
- `.main-container`：Flexbox左右兩欄佈局
- `.left-panel`：佔50%，包含設定和對話
- `.right-panel`：佔50%，顯示結果區塊
- 響應式設計：小螢幕改為上下堆疊

**2. 用戶需求設定**：
- `.settings-block`：可摺疊區塊樣式
- `.settings-header`：標題 + 展開/摺疊按鈕
- `.settings-content`：設定表單內容
- 摺疊時使用 `max-height: 0` 和 `overflow: hidden`

**3. 聊天對話**：
- `.chat-section`：最小高度600px
- `.chat-messages`：400-600px高度，flex佈局
- `.input-row textarea`：60-200px高度
- `.msg`：聊天氣泡樣式
- `.loading`：載入動畫樣式，包含氣泡尾巴

**4. 結果區塊**：
- `.result-section`：右側結果顯示區
- `.result-tabs`：標籤切換按鈕
- `.result-content`：結果內容區域
- `.result-header`：結果標題
- `.result-body`：結果主體內容
- `.result-actions`：儲存/再生成按鈕區域

**5. 一鍵生成按鈕**：
- `.generate-btn`：綠色按鈕，懸停變深綠
- `.save-btn`：藍色按鈕
- `.regenerate-btn`：橘色按鈕

**6. 用戶抽屜**：
- `.user-drawer-overlay`：全螢幕遮罩
- `.user-drawer`：置中彈出視窗（800x600px）
- `.user-drawer-sidebar`：左側導航（200px）
- `.user-drawer-content`：右側內容區域
- `.user-drawer-menu`：選單項目樣式
- `.content-section`：各類內容顯示區域

**7. 字體大小調整**：
- `.settings-block h3`：20px
- `.apply-btn`：18px
- `.quick-btn`：16px
- `.send-btn`：18px
- `.result-tab`：16px
- `.msg-label`：11px（AIJob短影音顧問）

#### 🎯 測試結果

所有功能已驗證正常：
- ✅ **雙層記憶系統**：STM和LTM整合完成
- ✅ **一鍵生成帳號定位**：基於設定生成專業建議
- ✅ **一鍵生成選題**：根據定位推薦具體選題
- ✅ **一鍵生成腳本**：完整的短影音腳本輸出
- ✅ **階段性驗證**：確保按正確順序生成
- ✅ **智能結果顯示**：AI對話自動識別並顯示到對應區塊
- ✅ **結果管理**：儲存和再生成功能正常
- ✅ **用戶歷史記錄**：個人資料、腳本、定位、選題全部顯示
- ✅ **用戶認證**：Google OAuth登入/登出正常
- ✅ **用戶ID生成**：自動生成並顯示
- ✅ **載入動畫**：AI回覆中...正確顯示
- ✅ **Markdown移除**：輸出為純文字格式
- ✅ **API整合**：所有端點正常響應

#### 🔧 問題修復

1. **一鍵生成驗證邏輯過嚴**：
   - **症狀**：即使完成定位，選題生成仍然被阻擋
   - **原因**：驗證邏輯匹配了一般關鍵字，而非明確的預設文字
   - **解決**：只檢查明確的預設占位文字（如"點擊「一鍵生成帳號定位」按鈕開始分析"）

2. **API請求缺少必要欄位**：
   - **症狀**：422錯誤，`Field required: message`
   - **原因**：一鍵生成函數未傳遞 `message` 欄位
   - **解決**：在 `generatePositioning()`、`generateTopics()`、`generateScript()` 中新增 `message` 欄位

3. **結果標籤切換失效**：
   - **症狀**：點擊標籤後內容未切換
   - **原因**：`switchTab()` 函數的 `data-tab` 值與 `result-content` ID 不匹配
   - **解決**：修正ID映射邏輯（`positioning` → `positioningResult`）

4. **用戶ID未顯示**：
   - **症狀**：個人資料中用戶ID欄位空白
   - **原因**：`updatePersonalInfo()` 未正確讀取 `user_id`
   - **解決**：修正為 `currentUser.user_id`

5. **姓名欄位空白**：
   - **症狀**：個人資料中姓名顯示為 `-`
   - **原因**：未正確讀取用戶姓名
   - **解決**：使用 `currentUser.name || currentUser.displayName || '未設定'`

6. **載入動畫未顯示**：
   - **症狀**：AI回覆時未出現"AI回覆中..."
   - **原因**：載入動畫被過早移除
   - **解決**：改為在收到第一個AI token時才移除載入動畫

7. **AI輸出包含Markdown**：
   - **症狀**：輸出包含 `**` 等符號
   - **原因**：`cleanMarkdownFormat()` 未移除所有Markdown
   - **解決**：強化函數，移除所有Markdown符號並正確處理換行

8. **抽屜內容顯示在底部**：
   - **症狀**：點擊選單項目後內容顯示在抽屜底部
   - **原因**：抽屜設計為滑動側邊欄，而非彈出視窗
   - **解決**：重新設計為置中彈出視窗，左右兩欄佈局

#### 📝 經驗總結

1. **佈局重構**：
   - 左右兩欄佈局比上下堆疊更專業
   - 固定比例（5:5）確保視覺平衡
   - 響應式設計對行動裝置支援很重要

2. **階段性驗證**：
   - 驗證邏輯要精確，避免過度嚴格
   - 只檢查明確的預設文字，而非一般關鍵字
   - 提供清晰的錯誤提示

3. **智能結果顯示**：
   - 不是所有AI回應都要顯示到結果區塊
   - 只顯示明確的摘要/結果
   - 一般討論保留在對話框，保持對話流暢

4. **API整合**：
   - 本地開發使用完整URL（`http://127.0.0.1:8000`）
   - 確保所有必要欄位都傳遞到後端
   - 錯誤處理和載入狀態很重要

5. **用戶體驗**：
   - 載入動畫提升用戶體驗
   - 彈出視窗比側邊欄更直觀
   - 左右兩欄佈局方便資訊瀏覽

#### 🚀 本地開發啟動指令

**前端啟動（推薦使用 VS Code Live Server）**：
```bash
# 方法 1：使用 VS Code Live Server
# 1. 在 VS Code 中打開 frontend/index.html
# 2. 右鍵選擇 "Open with Live Server"

# 方法 2：使用 Python HTTP Server
cd /Users/user/Downloads/ai_web_app/對話式/chatbot/frontend
python3 -m http.server 5173
# 打開瀏覽器訪問：http://localhost:5173
```

**搭配後端使用**：
```bash
# 確保後端在 http://127.0.0.1:8000 運行
# 前端會自動連接後端API
```

#### 📊 功能架構

```
前端頁面結構
├── Header（頂部）
│   ├── 標題：AI 短影音智能體
│   └── 用戶資訊：頭像 + 姓名 + 登入/登出
│
├── Main Container（主容器）
│   ├── Left Panel（左欄 50%）
│   │   ├── 用戶需求設定（可摺疊）
│   │   ├── AI對話框
│   │   ├── 快速按鈕
│   │   └── 輸入框
│   │
│   └── Right Panel（右欄 50%）
│       ├── 結果標籤（帳號定位、選題、腳本）
│       └── 結果內容
│           ├── 生成按鈕
│           ├── 結果顯示
│           └── 儲存/再生成按鈕
│
└── User Drawer（用戶抽屜）
    ├── Left Sidebar（左側導航）
    │   ├── 個人資料
    │   ├── 我的腳本
    │   ├── 帳號定位
    │   └── 選題記錄
    │
    └── Right Content（右側內容）
        └── 對應詳細資訊
```

#### 🎯 一鍵生成流程

```
用戶操作流程

1. 設定基本需求
   ├── 選擇平台（必填）
   ├── 輸入主題（選填）
   ├── 選擇時長（預設30秒）
   ├── 選擇風格（選填）
   └── 點擊「套用設定」

2. 帳號定位
   ├── 點擊「一鍵生成 帳號定位」
   ├── AI分析目標受眾、內容方向、風格調性
   ├── 結果顯示在「帳號定位」標籤
   └── 選擇「儲存」或「再換一個」

3. 腳本選題
   ├── 前置：必須先完成帳號定位
   ├── 點擊「一鍵生成 腳本選題」
   ├── AI推薦3-5個選題方向
   ├── 結果顯示在「腳本選題」標籤
   └── 選擇「儲存」或「再換一個」

4. 短影音腳本
   ├── 前置：必須先完成選題
   ├── 點擊「一鍵生成 短影音腳本」
   ├── AI生成完整腳本（主題、內容、畫面感、文案）
   ├── 結果顯示在「短影音腳本」標籤
   └── 選擇「儲存」或「再換一個」
```

---

## 📝 歷史更新日誌

### 2025-10-20 - AI輸出解析功能開發與問題追蹤

#### 🚨 問題描述
- **症狀**：AI成功生成腳本內容，但結果區塊（📝 短影音腳本結果）無法正確填入內容
- **錯誤類型**：前端解析邏輯問題
- **影響範圍**：結果區塊顯示功能完全失效

#### 🔍 問題診斷
1. **AI輸出格式多樣性**：
   - AI可能輸出 `1. 主題標題:` 格式
   - AI可能輸出 `### 主題標題:` 格式
   - AI可能輸出 `** Hook**`、`** Value 1**` 等Markdown格式

2. **解析邏輯不完整**：
   - 初始解析模式只支援編號格式（1. 2. 3. 4.）
   - 無法識別Markdown標題格式（###）
   - 無法識別腳本結構標記（** Hook**、** Value**、** CTA**）

3. **DOM操作問題**：
   - 解析成功但內容未顯示
   - 可能被其他代碼覆蓋或重置

#### ✅ 解決方案
1. **擴展解析模式**：
   - 添加 `### 主題標題:` 格式支援
   - 添加 `** Hook**`、`** Value 1**` 等腳本結構識別
   - 添加 `** CTA**` 等發佈文案識別

2. **增強調試功能**：
   - 添加詳細的控制台日誌記錄
   - 添加DOM元素狀態檢查
   - 添加延遲內容檢查機制
   - 添加全局測試函數 `window.testDOM()`

3. **安全檢查機制**：
   - 添加DOM元素存在性檢查
   - 防止null元素操作錯誤

#### 🛠️ 技術修改
**檔案：index.html**
- 更新 `requiredMarkers` 陣列，支援多種AI輸出格式
- 增強 `checkAndUpdateResults()` 函數的解析邏輯
- 添加詳細的調試日誌和錯誤處理
- 添加DOM元素安全檢查機制

#### 🎯 測試結果
**目前狀態**：問題已解決
- ✅ AI輸出解析邏輯已大幅改善
- ✅ 調試功能已完整添加
- ✅ 結果區塊內容現在可以正確顯示
- ✅ DOM操作時序問題已修復

#### 📝 經驗總結
1. **AI輸出格式多樣性**：需要建立更靈活的解析機制
2. **調試工具重要性**：詳細日誌對問題診斷至關重要
3. **DOM操作安全性**：必須添加元素存在性檢查
4. **問題追蹤**：需要建立系統性的問題記錄和解決流程

---

### 2025-10-21 - 重大修復：解決AI輸出解析問題

#### 🚨 問題描述
- **症狀**：AI成功生成腳本內容，但結果區塊（📝 短影音腳本結果）無法正確填入內容
- **錯誤類型**：前端解析邏輯過於嚴格，DOM操作時序問題
- **影響範圍**：結果區塊顯示功能完全失效

#### 🔍 問題診斷
1. **解析條件過於嚴格**：
   - 要求同時包含所有4個標記才顯示結果區塊
   - 正則表達式過於複雜，容易匹配失敗
   - 無法處理AI輸出的格式變化

2. **解析邏輯複雜**：
   - 多個正則表達式可能互相干擾
   - 缺乏靈活的內容提取機制
   - 無法處理非標準格式的AI輸出

3. **DOM操作問題**：
   - 解析成功但內容未顯示
   - 可能被其他代碼覆蓋或重置
   - 缺乏DOM元素存在性檢查

#### ✅ 解決方案
1. **簡化解析條件**：
   - 使用關鍵字檢測替代複雜的正則表達式
   - 只要包含腳本相關關鍵字就顯示結果區塊
   - 支援多種AI輸出格式

2. **重構解析邏輯**：
   - 新增 `parseAIContent()` 函數，使用逐行解析
   - 支援標題、腳本、畫面感、發佈文案的靈活識別
   - 添加後備解析機制，處理非標準格式

3. **改善DOM操作**：
   - 添加DOM元素存在性檢查
   - 改善錯誤處理和調試日誌
   - 使用更安全的內容設置方式

#### 🛠️ 技術修改
**檔案：index.html**
- 重寫 `checkAndUpdateResults()` 函數，使用更寬鬆的檢測條件
- 新增 `parseAIContent()` 函數，提供靈活的內容解析
- 改善DOM元素安全檢查和錯誤處理
- 增強調試日誌記錄

#### 🎯 測試結果
修復後所有功能正常：
- ✅ AI輸出解析：支援多種格式
- ✅ 結果區塊顯示：正確填入內容
- ✅ DOM操作：安全可靠
- ✅ 調試功能：詳細日誌記錄

#### 📝 經驗總結
1. **解析靈活性**：使用關鍵字檢測比複雜正則表達式更可靠
2. **逐行解析**：比一次性正則匹配更準確
3. **後備機制**：提供多層解析策略處理各種格式
4. **DOM安全**：必須檢查元素存在性再進行操作

### 2025-10-21 - 精確化腳本內容檢測

#### 🚨 問題描述
- **症狀**：腳本內容檢測過於寬鬆，導致不相關的對話內容被錯誤解析
- **錯誤類型**：關鍵字檢測缺乏精確性
- **影響範圍**：結果區塊可能顯示非腳本內容

#### 🔍 問題診斷
1. **檢測條件過於寬鬆**：
   - 只要包含關鍵字就觸發解析
   - 缺乏結構性驗證
   - 無法區分腳本內容和一般對話

2. **缺乏評分機制**：
   - 沒有綜合判斷標準
   - 無法排除明顯的非腳本內容
   - 缺乏多維度檢測

#### ✅ 解決方案
1. **建立評分系統**：
   - 結構標記：3分（最高權重）
   - 關鍵詞數量：最多3分
   - 短影音指示詞：2分
   - 文本長度：1分
   - 段落數量：1分
   - 非腳本指示詞：-2分（懲罰）

2. **多維度檢測**：
   - 檢查明確的腳本結構標記
   - 驗證短影音相關內容指示詞
   - 排除明顯的非腳本內容
   - 要求總分 >= 3 且無非腳本指示詞

3. **精確化條件**：
   - 必須包含結構標記或足夠的關鍵詞
   - 必須是短影音相關內容
   - 必須排除一般對話內容

#### 🛠️ 技術修改
**檔案：index.html**
- 新增 `detectScriptContent()` 函數，提供精確的腳本內容檢測
- 建立多維度評分系統
- 添加非腳本內容排除機制
- 改善檢測邏輯的準確性

#### 🎯 測試結果
精確化後的功能：
- ✅ 腳本內容檢測：更精確，避免誤判
- ✅ 評分系統：多維度綜合判斷
- ✅ 非腳本排除：有效過濾一般對話
- ✅ 調試功能：詳細的評分日誌

#### 📝 經驗總結
1. **評分機制**：多維度評分比單一條件更可靠
2. **排除策略**：主動排除非目標內容很重要
3. **結構驗證**：檢查結構標記比關鍵字更準確
4. **平衡性**：在靈活性和精確性之間找到平衡

### 2025-10-21 - 修復內容提取精確性問題

#### 🚨 問題描述
- **症狀**：只有「📱 文案」欄位正確顯示，其他三個欄位無法正確填入內容
- **錯誤類型**：解析邏輯不夠精確，無法正確提取「：」之後的內容
- **影響範圍**：結果區塊顯示功能部分失效

#### 🔍 問題診斷
1. **解析邏輯不精確**：
   - 逐行解析方式無法準確識別區塊邊界
   - 正則表達式匹配範圍過大
   - 缺乏精確的內容提取機制

2. **內容提取問題**：
   - 無法正確提取「主題標題：」之後的內容
   - 腳本內容顯示了完整AI回應而非特定區塊
   - 畫面感內容格式不正確

#### ✅ 解決方案
1. **重寫解析邏輯**：
   - 使用精確的正則表達式匹配
   - 明確指定每個區塊的開始和結束標記
   - 使用前瞻斷言確保準確提取

2. **精確內容提取**：
   - 主題標題：`/主題標題[：:]\s*([^\n]+)/i`
   - 腳本內容：`/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i`
   - 畫面感：`/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i`
   - 發佈文案：`/發佈文案[：:]\s*([\s\S]*?)$/i`

3. **後備解析機制**：
   - 如果找不到明確標記，按段落分割
   - 提供多層解析策略處理各種格式
   - 確保在任何情況下都能提取內容

#### 🛠️ 技術修改
**檔案：index.html**
- 重寫 `parseAIContent()` 函數，使用精確的正則表達式
- 添加詳細的調試日誌記錄
- 改善錯誤處理和後備機制
- 確保每個區塊都能正確提取內容

#### 🎯 測試結果
修復後的功能：
- ✅ 主題標題：正確提取「主題標題：」之後的內容
- ✅ 腳本內容：正確提取「腳本內容：」之後的內容
- ✅ 畫面感：正確提取「畫面感：」之後的內容
- ✅ 發佈文案：繼續正確提取「發佈文案：」之後的內容

#### 📝 經驗總結
1. **精確匹配**：使用正則表達式比逐行解析更準確
2. **邊界識別**：明確指定區塊邊界很重要
3. **後備機制**：提供多層解析策略確保穩定性
4. **調試工具**：詳細日誌對問題診斷至關重要

### 2025-10-21 - 強化腳本內容檢測安全性

#### 🚨 問題描述
- **症狀**：需要確保只有真正的腳本內容才會觸發結果區塊顯示
- **錯誤類型**：檢測條件可能過於寬鬆，一般對話內容可能誤觸發
- **影響範圍**：結果區塊可能顯示非腳本內容

#### 🔍 問題診斷
1. **檢測條件不夠嚴格**：
   - 缺乏必要的結構標記驗證
   - 評分標準可能過於寬鬆
   - 非腳本內容排除不夠全面

2. **安全性不足**：
   - 一般對話可能誤觸發結果區塊
   - 缺乏完整的腳本結構驗證
   - 時間標記檢測不夠精確

#### ✅ 解決方案
1. **強化必要條件**：
   - 必須包含明確的腳本結構標記（主題標題、腳本內容、畫面感、發佈文案）
   - 必須包含至少3個結構區塊
   - 必須包含短影音相關指示詞

2. **提高評分標準**：
   - 必要結構標記：5分（最高權重）
   - 完整結構：2分
   - 時間標記：1分
   - 非腳本指示詞：-5分（高懲罰）
   - 總分要求：≥ 6分

3. **擴展非腳本內容排除**：
   - 增加更多一般對話指示詞
   - 包含常見的問候語和回應語
   - 排除明顯的非腳本內容

4. **增加結構完整性檢查**：
   - 檢查是否包含完整的腳本結構
   - 驗證時間標記的存在
   - 確保內容長度和段落數量

#### 🛠️ 技術修改
**檔案：index.html**
- 強化 `detectScriptContent()` 函數的檢測邏輯
- 提高評分標準和判斷條件
- 擴展非腳本內容排除清單
- 增加結構完整性驗證
- 改善調試日誌記錄

#### 🎯 測試結果
**修復成功！** 所有功能正常運作：
- ✅ 腳本內容檢測：更嚴格，避免誤判
- ✅ 結構驗證：必須包含完整的腳本結構
- ✅ 非腳本排除：有效過濾一般對話
- ✅ 安全性：確保只有真正的腳本內容觸發結果區塊
- ✅ **主題標題**：正確提取並顯示
- ✅ **腳本內容**：完整顯示Hook、Value、CTA結構
- ✅ **畫面感**：詳細顯示視覺和音效建議
- ✅ **發佈文案**：完整顯示宣傳文字和標籤

#### 📝 經驗總結
1. **安全性優先**：寧可漏判也不要誤判
2. **結構驗證**：完整的腳本結構是必要條件
3. **多層檢查**：結合多個維度確保準確性
4. **持續優化**：根據實際使用情況調整檢測標準

### 2025-10-21 - 調整檢測邏輯適應不同AI輸出格式

#### 🚨 問題描述
- **症狀**：強化檢測安全性後，某些AI輸出格式無法被識別為腳本內容
- **錯誤類型**：檢測條件過於嚴格，無法處理格式變化
- **影響範圍**：結果區塊無法顯示，即使內容是有效的腳本

#### 🔍 問題診斷
1. **檢測條件過於嚴格**：
   - 要求必須包含「主題標題：」和「腳本內容：」標記
   - 無法處理直接以「Hook (0-10秒)」開始的格式
   - 缺乏對不同AI輸出格式的適應性

2. **格式變化問題**：
   - AI可能直接生成Hook、Value、CTA結構
   - 主題標題可能沒有明確的「：」標記
   - 腳本內容可能分散在不同區塊中

#### ✅ 解決方案
1. **靈活化檢測條件**：
   - 支援Hook、Value、CTA時間標記格式
   - 降低對明確標記的依賴
   - 增加腳本元素數量檢測

2. **改善解析邏輯**：
   - 如果沒有明確標記，使用第一行作為主題標題
   - 自動提取Hook、Value、CTA部分作為腳本內容
   - 保持對「畫面感：」和「發佈文案：」的支援

3. **調整評分標準**：
   - 降低總分要求：從6分降至4分
   - 增加腳本元素權重
   - 保持安全性檢查

#### 🛠️ 技術修改
**檔案：index.html**
- 調整 `detectScriptContent()` 函數的檢測邏輯
- 增加對Hook、Value、CTA格式的支援
- 改善 `parseAIContent()` 函數的解析能力
- 降低檢測門檻，提高適應性

#### 🎯 測試結果
調整後的功能：
- ✅ 腳本內容檢測：更靈活，適應不同格式
- ✅ 結構驗證：支援多種AI輸出格式
- ✅ 解析能力：能處理無明確標記的內容
- ✅ 安全性：保持非腳本內容排除機制

#### 📝 經驗總結
1. **靈活性與安全性平衡**：在保持安全性的同時提高適應性
2. **格式多樣性**：AI輸出格式可能變化，需要靈活處理
3. **漸進式檢測**：先檢測明確標記，再檢測結構元素
4. **持續調整**：根據實際使用情況不斷優化檢測邏輯

### 2025-10-21 - 支援編號格式的AI輸出

#### 🚨 問題描述
- **症狀**：AI生成編號格式（1. 2. 3. 4.）的腳本內容無法被識別
- **錯誤類型**：檢測和解析邏輯不支援編號格式
- **影響範圍**：結果區塊無法顯示編號格式的腳本內容

#### 🔍 問題診斷
1. **檢測邏輯不完整**：
   - 只支援「主題標題：」格式
   - 不支援「1. 主題標題」格式
   - 缺乏對編號格式的檢測

2. **解析模式不匹配**：
   - 正則表達式只匹配冒號格式
   - 無法處理編號+標題的組合
   - 邊界檢測不準確

#### ✅ 解決方案
1. **擴展檢測模式**：
   - 新增編號格式檢測：`/\d+\.\s*主題標題/i`
   - 支援所有四個區塊的編號格式
   - 保持對原有格式的支援

2. **完善解析邏輯**：
   - 主題標題：支援「1. 主題標題：內容」
   - 腳本內容：支援「2. 腳本內容：內容」
   - 畫面感：支援「3. 畫面感：內容」
   - 發佈文案：支援「4. 發佈文案：內容」

3. **改善邊界檢測**：
   - 使用編號作為區塊邊界標記
   - 確保準確提取每個區塊的內容
   - 保持對混合格式的支援

#### 🛠️ 技術修改
**檔案：index.html**
- 擴展 `detectScriptContent()` 函數的檢測模式
- 更新 `parseAIContent()` 函數的解析邏輯
- 新增編號格式的正則表達式匹配
- 改善邊界檢測和內容提取

#### 🎯 測試結果
修復後的功能：
- ✅ 編號格式檢測：支援「1. 2. 3. 4.」格式
- ✅ 內容提取：正確提取編號格式的內容
- ✅ 邊界識別：準確識別區塊邊界
- ✅ 格式兼容：支援多種AI輸出格式

#### 📝 經驗總結
1. **格式多樣性**：AI輸出格式變化多端，需要全面支援
2. **檢測完整性**：必須覆蓋所有可能的格式變化
3. **解析準確性**：邊界檢測對內容提取至關重要
4. **向後兼容**：新功能不能影響原有格式的支援

---

### 2025-10-21 - 全面防禦 AI 格式變化

#### 🚨 問題描述
- **症狀**：AI輸出格式不斷變化，導致解析邏輯失效
- **錯誤類型**：現有正則表達式無法覆蓋所有新格式
- **影響範圍**：結果區塊無法顯示，用戶體驗受損

#### 🔍 問題診斷
1. **AI「學習」能力**：
   - AI可能根據我們的檢測邏輯調整輸出格式
   - 導致每次修復後又出現新的未識別格式

2. **正則表達式覆蓋不足**：
   - 缺乏對表情符號、粗體、混合格式的全面支援
   - 邊界條件判斷不夠靈活

#### ✅ 解決方案
1. **擴展解析模式**：
   - 針對主題標題、腳本內容、畫面感、發佈文案，新增多種正則表達式模式
   - 涵蓋表情符號、標準、編號、粗體、混合等所有已知及潛在格式

2. **優先級匹配**：
   - 在 `parseAIContent()` 函數中，按優先級嘗試匹配不同模式
   - 確保最精確的模式優先被識別

3. **增強邊界檢測**：
   - 調整正則表達式中的lookahead斷言，使其能更準確地識別區塊結束

4. **引入強制提取機制**：
   - 在 `parseAIContent()` 中，如果所有常規模式都失敗，嘗試使用更寬鬆的強制提取模式
   - 確保即使格式異常也能盡力提取內容

#### 🛠️ 技術修改
**檔案：index.html**
- 大幅擴展 `parseAIContent()` 函數中各區塊的 `Patterns` 陣列
- 增加對表情符號、粗體、混合格式的支援
- 調整 `detectScriptContent()` 函數的判斷邏輯，使其更靈活
- 新增 `window.forceExtractContent()` 函數，提供超強力內容提取功能

#### 🎯 測試結果
修復後的功能：
- ✅ 格式兼容性：支援所有已知及潛在的AI輸出格式
- ✅ 內容提取：能更準確、全面地提取各區塊內容
- ✅ 穩定性：減少因AI格式變化導致的解析失敗
- ✅ 調試能力：新增強制提取函數，方便快速診斷問題

#### 📝 經驗總結
1. **持續戰略**：與AI的格式「軍備競賽」是長期過程，需持續優化
2. **模式多樣性**：預設AI會嘗試多種格式，需全面覆蓋
3. **彈性與韌性**：解析邏輯需具備高度彈性，即使部分失敗也能盡力提取
4. **調試工具**：強大的調試工具是快速定位問題的關鍵

---

### 2025-10-21 - 修復腳本內容範圍解析問題

#### 🚨 問題描述
- **症狀**：AI回應包含多個部分，解析邏輯抓錯了範圍
- **錯誤類型**：解析邏輯抓取了前面的介紹內容而非真正的腳本內容
- **影響範圍**：結果區塊顯示錯誤的內容

#### 🔍 問題診斷
1. **AI回應結構複雜**：
   - 前面包含介紹部分（如「✅ 核心主題：AI智能體，提高效率，解放時間。」）
   - 真正的腳本內容在兩個 `---` 之間
   - 解析邏輯沒有區分這兩個部分

2. **範圍識別問題**：
   - 所有解析都基於完整AI回應
   - 沒有提取真正的腳本內容範圍
   - 導致抓取到錯誤的內容

#### ✅ 解決方案
1. **範圍提取機制**：
   - 使用正則表達式 `/---\s*\n([\s\S]*?)\n\s*---/` 提取兩個 `---` 之間的內容
   - 所有後續解析都基於這個提取出的腳本內容範圍

2. **解析範圍限制**：
   - 主題標題：只在腳本內容範圍內尋找「1. 主題標題」
   - 腳本內容：只在腳本內容範圍內尋找「2. 腳本內容」
   - 畫面感：只在腳本內容範圍內尋找「3. 畫面感」
   - 發佈文案：只在腳本內容範圍內尋找「4. 發佈文案」

3. **避免誤抓**：
   - 不會再抓取前面的介紹內容
   - 只解析真正的腳本結構內容

#### 🛠️ 技術修改
**檔案：index.html**
- 在 `parseAIContent()` 函數開始處添加腳本內容範圍提取
- 修改所有解析邏輯使用提取出的腳本內容範圍
- 確保所有正則表達式匹配都基於正確的內容範圍

#### 🎯 測試結果
修復後的功能：
- ✅ 範圍識別：正確提取兩個 `---` 之間的腳本內容
- ✅ 內容準確性：不再抓取前面的介紹內容
- ✅ 解析精度：所有欄位都能正確對應到真正的腳本內容
- ✅ 穩定性：避免因AI回應結構變化導致的解析錯誤

#### 📝 經驗總結
1. **範圍識別**：必須先確定正確的解析範圍
2. **結構理解**：需要理解AI回應的完整結構
3. **精確提取**：基於正確範圍的解析才能得到準確結果
4. **防禦性編程**：預設AI回應可能包含多個部分

---

---

## 🎬 腳本拍攝表格功能（待開發）

### 功能規劃

**目標**：讓用戶能夠在「我的腳本」中匯出腳本拍攝表格，支援 Excel 和 PDF 格式。

### 腳本拍攝表格結構

#### Part A | 優化後完整腳本（Hook、Value、CTA）
- **保留原台詞語氣**
- **補入缺少的元素與節奏調整**

#### Part B | 拍攝腳本表格

| 秒數 | 段落 | 鏡頭／畫面 | 台詞（口白） | 字幕重點 | 音效與背景建議 |
|------|------|------------|--------------|----------|----------------|
| 0-3s | Hook | - | - | - | - |
| 3-7s | Pain Point | - | - | - | - |
| 7-15s | Value 1 | - | - | - | - |
| 15-25s | Value 2 | - | - | - | - |
| 25-30s | CTA | - | - | - | - |

### 待實現功能

#### 1. 資料結構設計
- [ ] 擴充 `positioning_records` 表或新增 `script_details` 表
- [ ] 儲存完整的腳本分段資訊（秒數、段落、鏡頭、台詞、字幕、音效）
- [ ] 關聯到 `generations` 表

#### 2. 後端 API
- [ ] `POST /api/script/parse` - 解析 AI 生成的腳本，自動分段
- [ ] `GET /api/script/{script_id}/export/excel` - 匯出 Excel 格式
- [ ] `GET /api/script/{script_id}/export/pdf` - 匯出 PDF 格式
- [ ] `PUT /api/script/{script_id}/segments` - 更新腳本分段（支援用戶手動調整）

#### 3. 前端介面
- [ ] 在「我的腳本」列表中，每個腳本增加「匯出」按鈕
- [ ] 彈出視窗顯示匯出選項：Excel 或 PDF
- [ ] 預覽腳本拍攝表格（在匯出前）
- [ ] 支援腳本分段的編輯功能（可選）

#### 4. 匯出功能實現

**Excel 匯出**：
```python
# 需要安裝
pip install openpyxl  # Excel 處理
pip install pandas    # 資料處理
```

**PDF 匯出**：
```python
# 需要安裝
pip install reportlab  # PDF 生成
pip install weasyprint # HTML to PDF（更美觀）
```

#### 5. 前端下載邏輯
```javascript
async function exportScript(scriptId, format) {
    const response = await fetch(`http://127.0.0.1:8000/api/script/${scriptId}/export/${format}`);
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `腳本_${scriptId}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
    a.click();
}
```

### 資料庫表格設計（建議）

```sql
CREATE TABLE IF NOT EXISTS script_segments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    script_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    
    -- 時間段
    start_time INTEGER NOT NULL,  -- 開始秒數
    end_time INTEGER NOT NULL,    -- 結束秒數
    
    -- 段落資訊
    segment_type TEXT NOT NULL,   -- Hook, Pain Point, Value 1, Value 2, CTA
    
    -- 內容
    camera_scene TEXT,            -- 鏡頭／畫面
    dialogue TEXT,                -- 台詞（口白）
    subtitle_focus TEXT,          -- 字幕重點
    audio_suggestion TEXT,        -- 音效與背景建議
    
    -- 元數據
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES user_profiles (user_id)
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_script_segments_script_id ON script_segments(script_id);
CREATE INDEX IF NOT EXISTS idx_script_segments_user_id ON script_segments(user_id);
```

### AI 自動分段提示詞（建議）

```
請根據以下腳本，生成詳細的拍攝表格：

【原始腳本】
{user_script}

【要求】
1. 按照 Hook (0-3s) → Pain Point (3-7s) → Value 1 (7-15s) → Value 2 (15-25s) → CTA (25-30s) 結構分段
2. 為每個段落提供：
   - 鏡頭／畫面建議（具體的視覺呈現）
   - 台詞（口白）（完整的說話內容）
   - 字幕重點（需要特別標註的關鍵字）
   - 音效與背景建議（音樂類型、音效、背景聲）

【輸出格式】
JSON 格式，包含 segments 陣列，每個 segment 包含：
- start_time: 開始秒數
- end_time: 結束秒數
- segment_type: 段落類型
- camera_scene: 鏡頭畫面
- dialogue: 台詞
- subtitle_focus: 字幕重點
- audio_suggestion: 音效建議
```

### 實現優先級
- **P1（高優先級）**：基礎匯出功能（Excel 格式）
- **P2（中優先級）**：PDF 格式匯出
- **P3（低優先級）**：腳本分段編輯功能
- **P4（未來功能）**：AI 智能優化建議（根據平台特性調整拍攝建議）

### 用戶操作流程
```
用戶點擊「我的腳本」
  ↓
選擇特定腳本
  ↓
點擊「匯出拍攝表格」按鈕
  ↓
選擇格式（Excel / PDF）
  ↓
[可選] 預覽並編輯分段
  ↓
下載檔案
```

### 注意事項
1. **版權保護**：匯出的檔案應包含水印或版權聲明
2. **資料隱私**：確保只有腳本擁有者可以匯出
3. **檔案命名**：使用有意義的檔案名（包含日期、主題等）
4. **格式美化**：Excel 和 PDF 需要良好的視覺設計
5. **效能考慮**：大量匯出請求需要使用背景任務（Celery）

---

## 📝 更新日誌格式指南

### 為下一個 AI 助理的說明
當有重大更新、問題修復或新功能時，請在「更新日誌」區段添加新的記錄。使用以下格式：

```markdown
### YYYY-MM-DD - 更新標題

#### 🚨 問題描述（如果是修復問題）
- **症狀**：具體的錯誤現象
- **錯誤類型**：錯誤代碼或類型
- **影響範圍**：受影響的功能或用戶

#### 🔍 問題診斷（如果是修復問題）
1. **步驟1**：診斷過程
2. **步驟2**：發現的問題
3. **步驟3**：根本原因分析

#### ✅ 解決方案/新增功能
1. **解決方案1**：具體的修復步驟
2. **解決方案2**：相關的配置調整
3. **解決方案3**：預防措施

#### 🛠️ 技術修改
**檔案：檔案名稱**
- 具體修改內容1
- 具體修改內容2

**檔案：另一個檔案名稱**
- 修改內容描述

#### 🎯 測試結果
修復/新增後的功能驗證：
- ✅ 功能1：測試結果
- ✅ 功能2：測試結果
- ❌ 功能3：已知問題（如有）

#### 📝 經驗總結
1. **技術要點**：重要的技術經驗
2. **最佳實踐**：推薦的做法
3. **注意事項**：需要特別注意的地方
```

### 📋 更新日誌撰寫要點
- **詳細記錄**：包含足夠的技術細節，便於未來參考
- **問題診斷**：記錄完整的問題分析過程
- **解決步驟**：提供可重現的修復步驟
- **測試驗證**：記錄修復後的測試結果
- **經驗提煉**：總結重要的技術經驗和最佳實踐

### 🎯 特殊情況處理

#### 腳本儲存系統相關更新
當更新腳本儲存相關功能時，請特別注意：
- **API端點**：記錄新增或修改的API端點
- **資料庫變更**：記錄資料庫結構的變更
- **認證問題**：記錄認證相關的修復
- **變數定義**：記錄新增的全局變數

#### 前端JavaScript錯誤修復
當修復JavaScript錯誤時，請記錄：
- **錯誤類型**：ReferenceError, TypeError, 401 Unauthorized等
- **錯誤位置**：具體的函數和行號
- **修復方法**：變數定義、函數實現、API調用修復等
- **測試驗證**：修復後的測試結果

#### 用戶界面更新
當更新UI相關功能時，請記錄：
- **CSS修改**：樣式變更和新增
- **HTML結構**：DOM元素的新增或修改
- **交互功能**：按鈕、表單、彈窗等交互元素
- **響應式設計**：移動端適配相關修改

## 開發指南

### 本地開發
1. 使用Live Server或其他本地伺服器開啟 `index.html`
2. 確保後端API可正常連線
3. 使用瀏覽器開發者工具進行調試

### 調試工具
- 使用 `window.testDOM()` 函數測試DOM元素
- 檢查控制台日誌獲取詳細調試資訊
- 使用「🔧 測試連線」按鈕診斷API狀態

### 常見問題
1. **API連線失敗**：檢查後端服務狀態和環境變數
2. **結果區塊空白**：檢查控制台日誌和DOM元素狀態
3. **解析失敗**：確認AI輸出格式是否符合預期

---

## 版權
2025 AIJob學院版權所有